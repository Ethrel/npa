// ==UserScript==
// @name        Neptune's Pride Agent
// @description HUD and reporting for Neptune's Pride.
// @match       https://neptunespride4.appspot.com/*
// @version     2.2.10
// @updateURL   https://raw.githubusercontent.com/anicolao/npa/futuresquish/ios/npa_np4.js
// ==/UserScript==
/*! For license information please see intel.js.LICENSE.txt */
!function(){var e={441:function(e,t,n){var r;!function(i,s,o){if(i){for(var a,c={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},u={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},l={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},h={option:"alt",command:"meta",return:"enter",escape:"esc",plus:"+",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},d=1;d<20;++d)c[111+d]="f"+d;for(d=0;d<=9;++d)c[d+96]=d.toString();w.prototype.bind=function(e,t,n){var r=this;return e=e instanceof Array?e:[e],r._bindMultiple.call(r,e,t,n),r},w.prototype.unbind=function(e,t){return this.bind.call(this,e,(function(){}),t)},w.prototype.trigger=function(e,t){var n=this;return n._directMap[e+":"+t]&&n._directMap[e+":"+t]({},e),n},w.prototype.reset=function(){var e=this;return e._callbacks={},e._directMap={},e},w.prototype.stopCallback=function(e,t){if((" "+t.className+" ").indexOf(" mousetrap ")>-1)return!1;if(v(t,this.target))return!1;if("composedPath"in e&&"function"==typeof e.composedPath){var n=e.composedPath()[0];n!==e.target&&(t=n)}return"INPUT"==t.tagName||"SELECT"==t.tagName||"TEXTAREA"==t.tagName||t.isContentEditable},w.prototype.handleKey=function(){var e=this;return e._handleKey.apply(e,arguments)},w.addKeycodes=function(e){for(var t in e)e.hasOwnProperty(t)&&(c[t]=e[t]);a=null},w.init=function(){var e=w(s);for(var t in e)"_"!==t.charAt(0)&&(w[t]=function(t){return function(){return e[t].apply(e,arguments)}}(t))},w.init(),i.Mousetrap=w,e.exports&&(e.exports=w),void 0===(r=function(){return w}.call(t,n,t,e))||(e.exports=r)}function f(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)}function p(e){if("keypress"==e.type){var t=String.fromCharCode(e.which);return e.shiftKey||(t=t.toLowerCase()),t}return c[e.which]?c[e.which]:u[e.which]?u[e.which]:String.fromCharCode(e.which).toLowerCase()}function g(e){return"shift"==e||"ctrl"==e||"alt"==e||"meta"==e}function m(e,t,n){return n||(n=function(){if(!a)for(var e in a={},c)e>95&&e<112||c.hasOwnProperty(e)&&(a[c[e]]=e);return a}()[e]?"keydown":"keypress"),"keypress"==n&&t.length&&(n="keydown"),n}function y(e,t){var n,r,i,s=[];for(n=function(e){return"+"===e?["+"]:(e=e.replace(/\+{2}/g,"+plus")).split("+")}(e),i=0;i<n.length;++i)r=n[i],h[r]&&(r=h[r]),t&&"keypress"!=t&&l[r]&&(r=l[r],s.push("shift")),g(r)&&s.push(r);return{key:r,modifiers:s,action:t=m(r,s,t)}}function v(e,t){return null!==e&&e!==s&&(e===t||v(e.parentNode,t))}function w(e){var t=this;if(e=e||s,!(t instanceof w))return new w(e);t.target=e,t._callbacks={},t._directMap={};var n,r={},i=!1,o=!1,a=!1;function c(e){e=e||{};var t,n=!1;for(t in r)e[t]?n=!0:r[t]=0;n||(a=!1)}function u(e,n,i,s,o,a){var c,u,l,h,d=[],f=i.type;if(!t._callbacks[e])return[];for("keyup"==f&&g(e)&&(n=[e]),c=0;c<t._callbacks[e].length;++c)if(u=t._callbacks[e][c],(s||!u.seq||r[u.seq]==u.level)&&f==u.action&&("keypress"==f&&!i.metaKey&&!i.ctrlKey||(l=n,h=u.modifiers,l.sort().join(",")===h.sort().join(",")))){var p=!s&&u.combo==o,m=s&&u.seq==s&&u.level==a;(p||m)&&t._callbacks[e].splice(c,1),d.push(u)}return d}function l(e,n,r,i){t.stopCallback(n,n.target||n.srcElement,r,i)||!1===e(n,r)&&(function(e){e.preventDefault?e.preventDefault():e.returnValue=!1}(n),function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}(n))}function h(e){"number"!=typeof e.which&&(e.which=e.keyCode);var n=p(e);n&&("keyup"!=e.type||i!==n?t.handleKey(n,function(e){var t=[];return e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),t}(e),e):i=!1)}function d(e,s,o,h,f){t._directMap[e+":"+o]=s;var g,m=(e=e.replace(/\s+/g," ")).split(" ");m.length>1?function(e,t,s,o){function u(t){return function(){a=t,++r[e],clearTimeout(n),n=setTimeout(c,1e3)}}function h(t){l(s,t,e),"keyup"!==o&&(i=p(t)),setTimeout(c,10)}r[e]=0;for(var f=0;f<t.length;++f){var g=f+1===t.length?h:u(o||y(t[f+1]).action);d(t[f],g,o,e,f)}}(e,m,s,o):(g=y(e,o),t._callbacks[g.key]=t._callbacks[g.key]||[],u(g.key,g.modifiers,{type:g.action},h,e,f),t._callbacks[g.key][h?"unshift":"push"]({callback:s,modifiers:g.modifiers,action:g.action,seq:h,level:f,combo:e}))}t._handleKey=function(e,t,n){var r,i=u(e,t,n),s={},h=0,d=!1;for(r=0;r<i.length;++r)i[r].seq&&(h=Math.max(h,i[r].level));for(r=0;r<i.length;++r)if(i[r].seq){if(i[r].level!=h)continue;d=!0,s[i[r].seq]=1,l(i[r].callback,n,i[r].combo,i[r].seq)}else d||l(i[r].callback,n,i[r].combo);var f="keypress"==n.type&&o;n.type!=a||g(e)||f||c(s),o=d&&"keydown"==n.type},t._bindMultiple=function(e,t,n){for(var r=0;r<e.length;++r)d(e[r],t,n)},f(e,"keypress",h),f(e,"keydown",h),f(e,"keyup",h)}}("undefined"!=typeof window?window:null,"undefined"!=typeof window?document:null)}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),function(){"use strict";var e=" M src/galaxy.ts\n M src/intel.ts\n M src/timetravel.ts";function t(){var t=e.length>0?"⚠":"",n=e.length>0?"".concat("22 Feb 2024 01:24"," "):"";return"Neptune's Pride Agent v".concat("2.2.54"," (").concat(n).concat(t).concat("dd8d3aa",")")}var r=n(441),i="Error";function s(e){i=e,navigator.clipboard.write([new ClipboardItem({"text/plain":new Blob([i],{type:"text/plain"}),"text/html":new Blob([Crux.format(i.replaceAll("\n","<br/>"),NeptunesPride.universe.hyperlinkedMessageInserts)],{type:"text/html"})})])}function o(){return i}var a={},c={};function u(e,t,n,i){var s;n&&(t.help=n),t.button=i||e,a[e]=t,c[i]=e,r.bind(e,(s=t,function(){return s(),!1}))}function l(){return Object.keys(a)}function h(e){return a[e]}let d,f;const p=new WeakMap,g=new WeakMap,m=new WeakMap,y=new WeakMap,v=new WeakMap;let w={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return g.get(e);if("objectStoreNames"===t)return e.objectStoreNames||m.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return _(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e}};function b(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(f||(f=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(T(this),e),_(p.get(this))}:function(...e){return _(t.apply(T(this),e))}:function(e,...n){const r=t.call(T(this),e,...n);return m.set(r,e.sort?e.sort():[e]),_(r)}:(e instanceof IDBTransaction&&function(e){if(g.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)}));g.set(e,t)}(e),n=e,(d||(d=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,w):e);var t,n}function _(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{t(_(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&p.set(t,e)})).catch((()=>{})),v.set(t,e),t}(e);if(y.has(e))return y.get(e);const t=b(e);return t!==e&&(y.set(e,t),v.set(t,e)),t}const T=e=>v.get(e);function E(e,t,{blocked:n,upgrade:r,blocking:i,terminated:s}={}){const o=indexedDB.open(e,t),a=_(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(_(o.result),e.oldVersion,e.newVersion,_(o.transaction),e)})),n&&o.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),a.then((e=>{s&&e.addEventListener("close",(()=>s())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}const k=["get","getKey","getAll","getAllKeys","count"],x=["put","add","delete","clear"],S=new Map;function N(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(S.get(t))return S.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=x.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!k.includes(n))return;const s=async function(e,...t){const s=this.transaction(e,i?"readwrite":"readonly");let o=s.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),i&&s.done]))[0]};return S.set(t,s),s}var I;I=w,w={...I,get:(e,t,n)=>N(e,t)||I.get(e,t,n),has:(e,t)=>!!N(e,t)||I.has(e,t)};const C=function(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},A={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let t=0;t<e.length;t+=3){const i=e[t],s=t+1<e.length,o=s?e[t+1]:0,a=t+2<e.length,c=a?e[t+2]:0,u=i>>2,l=(3&i)<<4|o>>4;let h=(15&o)<<2|c>>6,d=63&c;a||(d=64,s||(h=64)),r.push(n[u],n[l],n[h],n[d])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(C(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){const i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){const s=e[n++];t[r++]=String.fromCharCode((31&i)<<6|63&s)}else if(i>239&&i<365){const s=((7&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))}else{const s=e[n++],o=e[n++];t[r++]=String.fromCharCode((15&i)<<12|(63&s)<<6|63&o)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let t=0;t<e.length;){const i=n[e.charAt(t++)],s=t<e.length?n[e.charAt(t)]:0;++t;const o=t<e.length?n[e.charAt(t)]:64;++t;const a=t<e.length?n[e.charAt(t)]:64;if(++t,null==i||null==s||null==o||null==a)throw Error();const c=i<<2|s>>4;if(r.push(c),64!==o){const e=s<<4&240|o>>2;if(r.push(e),64!==a){const e=o<<6&192|a;r.push(e)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},P=function(e){return function(e){const t=C(e);return A.encodeByteArray(t,!0)}(e).replace(/\./g,"")},D=()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n.g)return n.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&function(e){try{return A.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};class M{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),"function"==typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,n))}}}class R extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,R.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,O.prototype.create)}}class O{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){const n=t[0]||{},r=`${this.service}/${e}`,i=this.errors[e],s=i?function(e,t){return e.replace(L,((e,n)=>{const r=t[n];return null!=r?String(r):`<${n}?>`}))}(i,n):"Error",o=`${this.serviceName}: ${s} (${r}).`;return new R(r,o,n)}}const L=/\{\$([^}]+)}/g;function F(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const i of n){if(!r.includes(i))return!1;const n=e[i],s=t[i];if(V(n)&&V(s)){if(!F(n,s))return!1}else if(n!==s)return!1}for(const e of r)if(!n.includes(e))return!1;return!0}function V(e){return null!==e&&"object"==typeof e}function U(e){return e&&e._delegate?e._delegate:e}class B{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const j="[DEFAULT]";class q{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const e=new M;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:t});n&&e.resolve(n)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const n=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),r=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(r)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(e){if(r)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:j})}catch(e){}for(const[e,t]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const e=this.getOrInitializeService({instanceIdentifier:n});t.resolve(e)}catch(e){}}}}clearInstance(e=j){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(e=j){return this.instances.has(e)}getOptions(e=j){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const r=this.getOrInitializeService({instanceIdentifier:n,options:t});for(const[e,t]of this.instancesDeferred.entries())n===this.normalizeInstanceIdentifier(e)&&t.resolve(r);return r}onInit(e,t){var n;const r=this.normalizeInstanceIdentifier(t),i=null!==(n=this.onInitCallbacks.get(r))&&void 0!==n?n:new Set;i.add(e),this.onInitCallbacks.set(r,i);const s=this.instances.get(r);return s&&e(s,r),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const n=this.onInitCallbacks.get(t);if(n)for(const r of n)try{r(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let n=this.instances.get(e);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:(r=e,r===j?void 0:r),options:t}),this.instances.set(e,n),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(n,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,n)}catch(e){}var r;return n||null}normalizeInstanceIdentifier(e=j){return this.component?this.component.multipleInstances?e:j:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class ${constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new q(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const H=[];var K,G;(G=K||(K={}))[G.DEBUG=0]="DEBUG",G[G.VERBOSE=1]="VERBOSE",G[G.INFO=2]="INFO",G[G.WARN=3]="WARN",G[G.ERROR=4]="ERROR",G[G.SILENT=5]="SILENT";const z={debug:K.DEBUG,verbose:K.VERBOSE,info:K.INFO,warn:K.WARN,error:K.ERROR,silent:K.SILENT},W=K.INFO,Q={[K.DEBUG]:"log",[K.VERBOSE]:"log",[K.INFO]:"info",[K.WARN]:"warn",[K.ERROR]:"error"},X=(e,t,...n)=>{if(t<e.logLevel)return;const r=(new Date).toISOString(),i=Q[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)};class Y{constructor(e){this.name=e,this._logLevel=W,this._logHandler=X,this._userLogHandler=null,H.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in K))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?z[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,K.DEBUG,...e),this._logHandler(this,K.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,K.VERBOSE,...e),this._logHandler(this,K.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,K.INFO,...e),this._logHandler(this,K.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,K.WARN,...e),this._logHandler(this,K.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,K.ERROR,...e),this._logHandler(this,K.ERROR,...e)}}let J,Z;const ee=new WeakMap,te=new WeakMap,ne=new WeakMap,re=new WeakMap,ie=new WeakMap;let se={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return te.get(e);if("objectStoreNames"===t)return e.objectStoreNames||ne.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return ae(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e}};function oe(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Z||(Z=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(ce(this),e),ae(ee.get(this))}:function(...e){return ae(t.apply(ce(this),e))}:function(e,...n){const r=t.call(ce(this),e,...n);return ne.set(r,e.sort?e.sort():[e]),ae(r)}:(e instanceof IDBTransaction&&function(e){if(te.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)}));te.set(e,t)}(e),n=e,(J||(J=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,se):e);var t,n}function ae(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{t(ae(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&ee.set(t,e)})).catch((()=>{})),ie.set(t,e),t}(e);if(re.has(e))return re.get(e);const t=oe(e);return t!==e&&(re.set(e,t),ie.set(t,e)),t}const ce=e=>ie.get(e),ue=["get","getKey","getAll","getAllKeys","count"],le=["put","add","delete","clear"],he=new Map;function de(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(he.get(t))return he.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=le.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!ue.includes(n))return;const s=async function(e,...t){const s=this.transaction(e,i?"readwrite":"readonly");let o=s.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),i&&s.done]))[0]};return he.set(t,s),s}se=(e=>({...e,get:(t,n,r)=>de(t,n)||e.get(t,n,r),has:(t,n)=>!!de(t,n)||e.has(t,n)}))(se);class fe{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null})).filter((e=>e)).join(" ")}}const pe="@firebase/app",ge="0.9.3",me=new Y("@firebase/app"),ye={[pe]:"fire-core","@firebase/app-compat":"fire-core-compat","@firebase/analytics":"fire-analytics","@firebase/analytics-compat":"fire-analytics-compat","@firebase/app-check":"fire-app-check","@firebase/app-check-compat":"fire-app-check-compat","@firebase/auth":"fire-auth","@firebase/auth-compat":"fire-auth-compat","@firebase/database":"fire-rtdb","@firebase/database-compat":"fire-rtdb-compat","@firebase/functions":"fire-fn","@firebase/functions-compat":"fire-fn-compat","@firebase/installations":"fire-iid","@firebase/installations-compat":"fire-iid-compat","@firebase/messaging":"fire-fcm","@firebase/messaging-compat":"fire-fcm-compat","@firebase/performance":"fire-perf","@firebase/performance-compat":"fire-perf-compat","@firebase/remote-config":"fire-rc","@firebase/remote-config-compat":"fire-rc-compat","@firebase/storage":"fire-gcs","@firebase/storage-compat":"fire-gcs-compat","@firebase/firestore":"fire-fst","@firebase/firestore-compat":"fire-fst-compat","fire-js":"fire-js",firebase:"fire-js-all"},ve=new Map,we=new Map;function be(e,t){try{e.container.addComponent(t)}catch(n){me.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function _e(e){const t=e.name;if(we.has(t))return me.debug(`There were multiple attempts to register component ${t}.`),!1;we.set(t,e);for(const t of ve.values())be(t,e);return!0}const Te=new O("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call Firebase App.initializeApp()","bad-app-name":"Illegal App name: '{$appName}","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}."});class Ee{constructor(e,t,n){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new B("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Te.create("app-deleted",{appName:this._name})}}function ke(e,t,n){var r;let i=null!==(r=ye[e])&&void 0!==r?r:e;n&&(i+=`-${n}`);const s=i.match(/\s|\//),o=t.match(/\s|\//);if(s||o){const e=[`Unable to register library "${i}" with version "${t}":`];return s&&e.push(`library name "${i}" contains illegal characters (whitespace or "/")`),s&&o&&e.push("and"),o&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void me.warn(e.join(" "))}_e(new B(`${i}-version`,(()=>({library:i,version:t})),"VERSION"))}const xe="firebase-heartbeat-store";let Se=null;function Ne(){return Se||(Se=function(e,t,{blocked:n,upgrade:r,blocking:i,terminated:s}={}){const o=indexedDB.open(e,t),a=ae(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(ae(o.result),e.oldVersion,e.newVersion,ae(o.transaction))})),n&&o.addEventListener("blocked",(()=>n())),a.then((e=>{s&&e.addEventListener("close",(()=>s())),i&&e.addEventListener("versionchange",(()=>i()))})).catch((()=>{})),a}("firebase-heartbeat-database",1,{upgrade:(e,t)=>{0===t&&e.createObjectStore(xe)}}).catch((e=>{throw Te.create("idb-open",{originalErrorMessage:e.message})}))),Se}async function Ie(e,t){try{const n=(await Ne()).transaction(xe,"readwrite"),r=n.objectStore(xe);return await r.put(t,Ce(e)),n.done}catch(e){if(e instanceof R)me.warn(e.message);else{const t=Te.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});me.warn(t.message)}}}function Ce(e){return`${e.name}!${e.options.appId}`}class Ae{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new De(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){const e=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),t=Pe();if(null===this._heartbeatsCache&&(this._heartbeatsCache=await this._heartbeatsCachePromise),this._heartbeatsCache.lastSentHeartbeatDate!==t&&!this._heartbeatsCache.heartbeats.some((e=>e.date===t)))return this._heartbeatsCache.heartbeats.push({date:t,agent:e}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null===this._heartbeatsCache||0===this._heartbeatsCache.heartbeats.length)return"";const e=Pe(),{heartbeatsToSend:t,unsentEntries:n}=function(e,t=1024){const n=[];let r=e.slice();for(const i of e){const e=n.find((e=>e.agent===i.agent));if(e){if(e.dates.push(i.date),Me(n)>t){e.dates.pop();break}}else if(n.push({agent:i.agent,dates:[i.date]}),Me(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}(this._heartbeatsCache.heartbeats),r=P(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}}function Pe(){return(new Date).toISOString().substring(0,10)}class De{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!function(){try{return"object"==typeof indexedDB}catch(e){return!1}}()&&new Promise(((e,t)=>{try{let n=!0;const r="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(r);i.onsuccess=()=>{i.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},i.onupgradeneeded=()=>{n=!1},i.onerror=()=>{var e;t((null===(e=i.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){return await async function(e){try{return(await Ne()).transaction(xe).objectStore(xe).get(Ce(e))}catch(e){if(e instanceof R)me.warn(e.message);else{const t=Te.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});me.warn(t.message)}}}(this.app)||{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return Ie(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return Ie(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...e.heartbeats]})}}}function Me(e){return P(JSON.stringify({version:2,heartbeats:e})).length}function Re(){return!!/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}_e(new B("platform-logger",(e=>new fe(e)),"PRIVATE")),_e(new B("heartbeat",(e=>new Ae(e)),"PRIVATE")),ke(pe,ge,""),ke(pe,ge,"esm2017"),ke("fire-js",""),ke("firebase","9.17.1","app");var Oe,Le="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},Fe={},Ve=Ve||{},Ue=Le||self;function Be(){}function je(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function qe(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var $e="closure_uid_"+(1e9*Math.random()>>>0),He=0;function Ke(e,t,n){return e.call.apply(e.bind,arguments)}function Ge(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function ze(e,t,n){return(ze=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?Ke:Ge).apply(null,arguments)}function We(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function Qe(e,t){function n(){}n.prototype=t.prototype,e.X=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.Wb=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}function Xe(){this.s=this.s,this.o=this.o}Xe.prototype.s=!1,Xe.prototype.na=function(){var e;!this.s&&(this.s=!0,this.M(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,$e)&&e[$e]||(e[$e]=++He))},Xe.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const Ye=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function Je(e){const t=e.length;if(0<t){const n=Array(t);for(let r=0;r<t;r++)n[r]=e[r];return n}return[]}function Ze(e,t){for(let t=1;t<arguments.length;t++){const n=arguments[t];if(je(n)){const t=e.length||0,r=n.length||0;e.length=t+r;for(let i=0;i<r;i++)e[t+i]=n[i]}else e.push(n)}}function et(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}et.prototype.h=function(){this.defaultPrevented=!0};var tt=function(){if(!Ue.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{Ue.addEventListener("test",Be,t),Ue.removeEventListener("test",Be,t)}catch(e){}return e}();function nt(e){return/^[\s\xa0]*$/.test(e)}var rt=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function it(e,t){return e<t?-1:e>t?1:0}function st(){var e=Ue.navigator;return e&&(e=e.userAgent)?e:""}function ot(e){return-1!=st().indexOf(e)}function at(e){return at[" "](e),e}at[" "]=Be;var ct,ut,lt=ot("Opera"),ht=ot("Trident")||ot("MSIE"),dt=ot("Edge"),ft=dt||ht,pt=ot("Gecko")&&!(-1!=st().toLowerCase().indexOf("webkit")&&!ot("Edge"))&&!(ot("Trident")||ot("MSIE"))&&!ot("Edge"),gt=-1!=st().toLowerCase().indexOf("webkit")&&!ot("Edge");function mt(){var e=Ue.document;return e?e.documentMode:void 0}e:{var yt="",vt=(ut=st(),pt?/rv:([^\);]+)(\)|;)/.exec(ut):dt?/Edge\/([\d\.]+)/.exec(ut):ht?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(ut):gt?/WebKit\/(\S+)/.exec(ut):lt?/(?:Version)[ \/]?(\S+)/.exec(ut):void 0);if(vt&&(yt=vt?vt[1]:""),ht){var wt=mt();if(null!=wt&&wt>parseFloat(yt)){ct=String(wt);break e}}ct=yt}var bt,_t={};function Tt(){return function(e){var t=_t;return Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=function(){let e=0;const t=rt(String(ct)).split("."),n=rt("9").split("."),r=Math.max(t.length,n.length);for(let o=0;0==e&&o<r;o++){var i=t[o]||"",s=n[o]||"";do{if(i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==i[0].length&&0==s[0].length)break;e=it(0==i[1].length?0:parseInt(i[1],10),0==s[1].length?0:parseInt(s[1],10))||it(0==i[2].length,0==s[2].length)||it(i[2],s[2]),i=i[3],s=s[3]}while(0==e)}return 0<=e}()}()}Ue.document&&ht?bt=mt()||parseInt(ct,10)||void 0:bt=void 0;var Et=bt;function kt(e,t){if(et.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(pt){e:{try{at(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:xt[e.pointerType]||"",this.state=e.state,this.i=e,e.defaultPrevented&&kt.X.h.call(this)}}Qe(kt,et);var xt={2:"touch",3:"pen",4:"mouse"};kt.prototype.h=function(){kt.X.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var St="closure_listenable_"+(1e6*Math.random()|0),Nt=0;function It(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=i,this.key=++Nt,this.ba=this.ea=!1}function Ct(e){e.ba=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function At(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function Pt(e){const t={};for(const n in e)t[n]=e[n];return t}const Dt="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Mt(e,t){let n,r;for(let t=1;t<arguments.length;t++){for(n in r=arguments[t],r)e[n]=r[n];for(let t=0;t<Dt.length;t++)n=Dt[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function Rt(e){this.src=e,this.g={},this.h=0}function Ot(e,t){var n=t.type;if(n in e.g){var r,i=e.g[n],s=Ye(i,t);(r=0<=s)&&Array.prototype.splice.call(i,s,1),r&&(Ct(t),0==e.g[n].length&&(delete e.g[n],e.h--))}}function Lt(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.ba&&s.listener==t&&s.capture==!!n&&s.ha==r)return i}return-1}Rt.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var o=Lt(e,t,r,i);return-1<o?(t=e[o],n||(t.ea=!1)):((t=new It(t,this.src,s,!!r,i)).ea=n,e.push(t)),t};var Ft="closure_lm_"+(1e6*Math.random()|0),Vt={};function Ut(e,t,n,r,i){if(r&&r.once)return jt(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)Ut(e,t[s],n,r,i);return null}return n=Wt(n),e&&e[St]?e.N(t,n,qe(r)?!!r.capture:!!r,i):Bt(e,t,n,!1,r,i)}function Bt(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var o=qe(i)?!!i.capture:!!i,a=Gt(e);if(a||(e[Ft]=a=new Rt(e)),(n=a.add(t,n,r,o,s)).proxy)return n;if(r=function(){const e=Kt;return function t(n){return e.call(t.src,t.listener,n)}}(),n.proxy=r,r.src=e,r.listener=n,e.addEventListener)tt||(i=o),void 0===i&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(Ht(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function jt(e,t,n,r,i){if(Array.isArray(t)){for(var s=0;s<t.length;s++)jt(e,t[s],n,r,i);return null}return n=Wt(n),e&&e[St]?e.O(t,n,qe(r)?!!r.capture:!!r,i):Bt(e,t,n,!0,r,i)}function qt(e,t,n,r,i){if(Array.isArray(t))for(var s=0;s<t.length;s++)qt(e,t[s],n,r,i);else r=qe(r)?!!r.capture:!!r,n=Wt(n),e&&e[St]?(e=e.i,(t=String(t).toString())in e.g&&-1<(n=Lt(s=e.g[t],n,r,i))&&(Ct(s[n]),Array.prototype.splice.call(s,n,1),0==s.length&&(delete e.g[t],e.h--))):e&&(e=Gt(e))&&(t=e.g[t.toString()],e=-1,t&&(e=Lt(t,n,r,i)),(n=-1<e?t[e]:null)&&$t(n))}function $t(e){if("number"!=typeof e&&e&&!e.ba){var t=e.src;if(t&&t[St])Ot(t.i,e);else{var n=e.type,r=e.proxy;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Ht(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=Gt(t))?(Ot(n,e),0==n.h&&(n.src=null,t[Ft]=null)):Ct(e)}}}function Ht(e){return e in Vt?Vt[e]:Vt[e]="on"+e}function Kt(e,t){if(e.ba)e=!0;else{t=new kt(t,this);var n=e.listener,r=e.ha||e.src;e.ea&&$t(e),e=n.call(r,t)}return e}function Gt(e){return(e=e[Ft])instanceof Rt?e:null}var zt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Wt(e){return"function"==typeof e?e:(e[zt]||(e[zt]=function(t){return e.handleEvent(t)}),e[zt])}function Qt(){Xe.call(this),this.i=new Rt(this),this.P=this,this.I=null}function Xt(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t)t=new et(t,e);else if(t instanceof et)t.target=t.target||e;else{var i=t;Mt(t=new et(r,e),i)}if(i=!0,n)for(var s=n.length-1;0<=s;s--){var o=t.g=n[s];i=Yt(o,r,!0,t)&&i}if(i=Yt(o=t.g=e,r,!0,t)&&i,i=Yt(o,r,!1,t)&&i,n)for(s=0;s<n.length;s++)i=Yt(o=t.g=n[s],r,!1,t)&&i}function Yt(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var o=t[s];if(o&&!o.ba&&o.capture==n){var a=o.listener,c=o.ha||o.src;o.ea&&Ot(e.i,o),i=!1!==a.call(c,r)&&i}}return i&&!r.defaultPrevented}Qe(Qt,Xe),Qt.prototype[St]=!0,Qt.prototype.removeEventListener=function(e,t,n,r){qt(this,e,t,n,r)},Qt.prototype.M=function(){if(Qt.X.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)Ct(n[r]);delete t.g[e],t.h--}}this.I=null},Qt.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Qt.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var Jt=Ue.JSON.stringify;function Zt(){var e=an;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}var en,tn=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}((()=>new nn),(e=>e.reset()));class nn{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function rn(e){Ue.setTimeout((()=>{throw e}),0)}function sn(e,t){en||function(){var e=Ue.Promise.resolve(void 0);en=function(){e.then(cn)}}(),on||(en(),on=!0),an.add(e,t)}var on=!1,an=new class{constructor(){this.h=this.g=null}add(e,t){const n=tn.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function cn(){for(var e;e=Zt();){try{e.h.call(e.g)}catch(e){rn(e)}var t=tn;t.j(e),100>t.h&&(t.h++,e.next=t.g,t.g=e)}on=!1}function un(e,t){Qt.call(this),this.h=e||1,this.g=t||Ue,this.j=ze(this.lb,this),this.l=Date.now()}function ln(e){e.ca=!1,e.R&&(e.g.clearTimeout(e.R),e.R=null)}function hn(e,t,n){if("function"==typeof e)n&&(e=ze(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=ze(e.handleEvent,e)}return 2147483647<Number(t)?-1:Ue.setTimeout(e,t||0)}function dn(e){e.g=hn((()=>{e.g=null,e.i&&(e.i=!1,dn(e))}),e.j);const t=e.h;e.h=null,e.m.apply(null,t)}Qe(un,Qt),(Oe=un.prototype).ca=!1,Oe.R=null,Oe.lb=function(){if(this.ca){var e=Date.now()-this.l;0<e&&e<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-e):(this.R&&(this.g.clearTimeout(this.R),this.R=null),Xt(this,"tick"),this.ca&&(ln(this),this.start()))}},Oe.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},Oe.M=function(){un.X.M.call(this),ln(this),delete this.g};class fn extends Xe{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:dn(this)}M(){super.M(),this.g&&(Ue.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function pn(e){Xe.call(this),this.h=e,this.g={}}Qe(pn,Xe);var gn=[];function mn(e,t,n,r){Array.isArray(n)||(n&&(gn[0]=n.toString()),n=gn);for(var i=0;i<n.length;i++){var s=Ut(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function yn(e){At(e.g,(function(e,t){this.g.hasOwnProperty(t)&&$t(e)}),e),e.g={}}function vn(){this.g=!0}function wn(e,t,n,r){e.info((function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(2>r.length)){var i=r[1];if(Array.isArray(i)&&!(1>i.length)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var o=1;o<i.length;o++)i[o]=""}}}return Jt(n)}catch(e){return t}}(e,n)+(r?" "+r:"")}))}pn.prototype.M=function(){pn.X.M.call(this),yn(this)},pn.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},vn.prototype.Aa=function(){this.g=!1},vn.prototype.info=function(){};var bn={},_n=null;function Tn(){return _n=_n||new Qt}function En(e){et.call(this,bn.Pa,e)}function kn(e){const t=Tn();Xt(t,new En(t))}function xn(e,t){et.call(this,bn.STAT_EVENT,e),this.stat=t}function Sn(e){const t=Tn();Xt(t,new xn(t,e))}function Nn(e,t){et.call(this,bn.Qa,e),this.size=t}function In(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return Ue.setTimeout((function(){e()}),t)}bn.Pa="serverreachability",Qe(En,et),bn.STAT_EVENT="statevent",Qe(xn,et),bn.Qa="timingevent",Qe(Nn,et);var Cn={NO_ERROR:0,mb:1,zb:2,yb:3,tb:4,xb:5,Ab:6,Ma:7,TIMEOUT:8,Db:9},An={rb:"complete",Nb:"success",Na:"error",Ma:"abort",Fb:"ready",Gb:"readystatechange",TIMEOUT:"timeout",Bb:"incrementaldata",Eb:"progress",ub:"downloadprogress",Vb:"uploadprogress"};function Pn(){}function Dn(e){return e.h||(e.h=e.i())}function Mn(){}Pn.prototype.h=null;var Rn,On={OPEN:"a",qb:"b",Na:"c",Cb:"d"};function Ln(){et.call(this,"d")}function Fn(){et.call(this,"c")}function Vn(){}function Un(e,t,n,r){this.l=e,this.j=t,this.m=n,this.U=r||1,this.S=new pn(this),this.O=jn,e=ft?125:void 0,this.T=new un(e),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new Bn}function Bn(){this.i=null,this.g="",this.h=!1}Qe(Ln,et),Qe(Fn,et),Qe(Vn,Pn),Vn.prototype.g=function(){return new XMLHttpRequest},Vn.prototype.i=function(){return{}},Rn=new Vn;var jn=45e3,qn={},$n={};function Hn(e,t,n){e.K=1,e.v=ur(ir(t)),e.s=n,e.P=!0,Kn(e,null)}function Kn(e,t){e.F=Date.now(),Qn(e),e.A=ir(e.v);var n=e.A,r=e.U;Array.isArray(r)||(r=[String(r)]),Tr(n.i,"t",r),e.C=0,n=e.l.H,e.h=new Bn,e.g=_i(e.l,n?t:null,!e.s),0<e.N&&(e.L=new fn(ze(e.La,e,e.g),e.N)),mn(e.S,e.g,"readystatechange",e.ib),t=e.H?Pt(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.da(e.A,e.u,e.s,t)):(e.u="GET",e.g.da(e.A,e.u,null,t)),kn(),function(e,t,n,r,i,s){e.info((function(){if(e.g)if(s)for(var o="",a=s.split("&"),c=0;c<a.length;c++){var u=a[c].split("=");if(1<u.length){var l=u[0];u=u[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+u+"&":o+(l+"=redacted&")}}else o=null;else o=s;return"XMLHTTP REQ ("+r+") [attempt "+i+"]: "+t+"\n"+n+"\n"+o}))}(e.j,e.u,e.A,e.m,e.U,e.s)}function Gn(e){return!!e.g&&"GET"==e.u&&2!=e.K&&e.l.Da}function zn(e,t,n){let r,i=!0;for(;!e.I&&e.C<n.length;){if(r=Wn(e,n),r==$n){4==t&&(e.o=4,Sn(14),i=!1),wn(e.j,e.m,null,"[Incomplete Response]");break}if(r==qn){e.o=4,Sn(15),wn(e.j,e.m,n,"[Invalid Chunk]"),i=!1;break}wn(e.j,e.m,r,null),er(e,r)}Gn(e)&&r!=$n&&r!=qn&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,Sn(16),i=!1),e.i=e.i&&i,i?0<n.length&&!e.$&&(e.$=!0,(t=e.l).g==e&&t.$&&!t.K&&(t.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),fi(t),t.K=!0,Sn(11))):(wn(e.j,e.m,n,"[Invalid Chunked Response]"),Zn(e),Jn(e))}function Wn(e,t){var n=e.C,r=t.indexOf("\n",n);return-1==r?$n:(n=Number(t.substring(n,r)),isNaN(n)?qn:(r+=1)+n>t.length?$n:(t=t.substr(r,n),e.C=r+n,t))}function Qn(e){e.V=Date.now()+e.O,Xn(e,e.O)}function Xn(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=In(ze(e.gb,e),t)}function Yn(e){e.B&&(Ue.clearTimeout(e.B),e.B=null)}function Jn(e){0==e.l.G||e.I||mi(e.l,e)}function Zn(e){Yn(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,ln(e.T),yn(e.S),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function er(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||Ir(n.h,e)))if(!e.J&&Ir(n.h,e)&&3==n.G){try{var r=n.Fa.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;gi(n),si(n)}di(n),Sn(18)}}else n.Ba=i[1],0<n.Ba-n.T&&37500>i[2]&&n.L&&0==n.A&&!n.v&&(n.v=In(ze(n.cb,n),6e3));if(1>=Nr(n.h)&&n.ja){try{n.ja()}catch(e){}n.ja=void 0}}else vi(n,11)}else if((e.J||n.g==e)&&gi(n),!nt(t))for(i=n.Fa.g.parse(t),t=0;t<i.length;t++){let u=i[t];if(n.T=u[0],u=u[1],2==n.G)if("c"==u[0]){n.I=u[1],n.ka=u[2];const t=u[3];null!=t&&(n.ma=t,n.j.info("VER="+n.ma));const i=u[4];null!=i&&(n.Ca=i,n.j.info("SVER="+n.Ca));const l=u[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.J=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=e.g;if(h){const e=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(e){var s=r.h;s.g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(s.j=s.l,s.g=new Set,s.h&&(Cr(s,s.h),s.h=null))}if(r.D){const e=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;e&&(r.za=e,cr(r.F,r.D,e))}}n.G=3,n.l&&n.l.xa(),n.$&&(n.P=Date.now()-e.F,n.j.info("Handshake RTT: "+n.P+"ms"));var o=e;if((r=n).sa=bi(r,r.H?r.ka:null,r.V),o.J){Ar(r.h,o);var a=o,c=r.J;c&&a.setTimeout(c),a.B&&(Yn(a),Qn(a)),r.g=o}else hi(r);0<n.i.length&&ai(n)}else"stop"!=u[0]&&"close"!=u[0]||vi(n,7);else 3==n.G&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?vi(n,7):ii(n):"noop"!=u[0]&&n.l&&n.l.wa(u),n.A=0)}kn()}catch(e){}}function tr(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(je(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.oa&&"function"==typeof e.oa)return e.oa();if(!e.W||"function"!=typeof e.W){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(je(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.W&&"function"==typeof e.W)return e.W();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(je(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(Oe=Un.prototype).setTimeout=function(e){this.O=e},Oe.ib=function(e){e=e.target;const t=this.L;t&&3==Jr(e)?t.l():this.La(e)},Oe.La=function(e){try{if(e==this.g)e:{const l=Jr(this.g);var t=this.g.Ea();if(this.g.aa(),!(3>l)&&(3!=l||ft||this.g&&(this.h.h||this.g.fa()||Zr(this.g)))){this.I||4!=l||7==t||kn(),Yn(this);var n=this.g.aa();this.Y=n;t:if(Gn(this)){var r=Zr(this.g);e="";var i=r.length,s=4==Jr(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Zn(this),Jn(this);var o="";break t}this.h.i=new Ue.TextDecoder}for(t=0;t<i;t++)this.h.h=!0,e+=this.h.i.decode(r[t],{stream:s&&t==i-1});r.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.fa();if(this.i=200==n,function(e,t,n,r,i,s,o){e.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+i+"]: "+t+"\n"+n+"\n"+s+" "+o}))}(this.j,this.u,this.A,this.m,this.U,l,n),this.i){if(this.Z&&!this.J){t:{if(this.g){var a,c=this.g;if((a=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!nt(a)){var u=a;break t}}u=null}if(!(n=u)){this.i=!1,this.o=3,Sn(12),Zn(this),Jn(this);break e}wn(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,er(this,n)}this.P?(zn(this,l,o),ft&&this.i&&3==l&&(mn(this.S,this.T,"tick",this.hb),this.T.start())):(wn(this.j,this.m,o,null),er(this,o)),4==l&&Zn(this),this.i&&!this.I&&(4==l?mi(this.l,this):(this.i=!1,Qn(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,Sn(12)):(this.o=0,Sn(13)),Zn(this),Jn(this)}}}catch(e){}},Oe.hb=function(){if(this.g){var e=Jr(this.g),t=this.g.fa();this.C<t.length&&(Yn(this),zn(this,e,t),this.i&&4!=e&&Qn(this))}},Oe.cancel=function(){this.I=!0,Zn(this)},Oe.gb=function(){this.B=null;const e=Date.now();0<=e-this.V?(function(e,t){e.info((function(){return"TIMEOUT: "+t}))}(this.j,this.A),2!=this.K&&(kn(),Sn(17)),Zn(this),this.o=2,Jn(this)):Xn(this,this.V-e)};var nr=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function rr(e,t){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof rr){this.h=void 0!==t?t:e.h,sr(this,e.j),this.s=e.s,this.g=e.g,or(this,e.m),this.l=e.l,t=e.i;var n=new vr;n.i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),ar(this,n),this.o=e.o}else e&&(n=String(e).match(nr))?(this.h=!!t,sr(this,n[1]||"",!0),this.s=lr(n[2]||""),this.g=lr(n[3]||"",!0),or(this,n[4]),this.l=lr(n[5]||"",!0),ar(this,n[6]||"",!0),this.o=lr(n[7]||"")):(this.h=!!t,this.i=new vr(null,this.h))}function ir(e){return new rr(e)}function sr(e,t,n){e.j=n?lr(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function or(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.m=t}else e.m=null}function ar(e,t,n){t instanceof vr?(e.i=t,function(e,t){t&&!e.j&&(wr(e),e.i=null,e.g.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(br(this,t),Tr(this,n,e))}),e)),e.j=t}(e.i,e.h)):(n||(t=hr(t,mr)),e.i=new vr(t,e.h))}function cr(e,t,n){e.i.set(t,n)}function ur(e){return cr(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function lr(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function hr(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,dr),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function dr(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}rr.prototype.toString=function(){var e=[],t=this.j;t&&e.push(hr(t,fr,!0),":");var n=this.g;return(n||"file"==t)&&(e.push("//"),(t=this.s)&&e.push(hr(t,fr,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(hr(n,"/"==n.charAt(0)?gr:pr,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",hr(n,yr)),e.join("")};var fr=/[#\/\?@]/g,pr=/[#\?:]/g,gr=/[#\?]/g,mr=/[#\?@]/g,yr=/#/g;function vr(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function wr(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].indexOf("="),i=null;if(0<=r){var s=e[n].substring(0,r);i=e[n].substring(r+1)}else s=e[n];t(s,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(e.i,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function br(e,t){wr(e),t=Er(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function _r(e,t){return wr(e),t=Er(e,t),e.g.has(t)}function Tr(e,t,n){br(e,t),0<n.length&&(e.i=null,e.g.set(Er(e,t),Je(n)),e.h+=n.length)}function Er(e,t){return t=String(t),e.j&&(t=t.toLowerCase()),t}function kr(e){this.l=e||xr,e=Ue.PerformanceNavigationTiming?0<(e=Ue.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(Ue.g&&Ue.g.Ga&&Ue.g.Ga()&&Ue.g.Ga().$b),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(Oe=vr.prototype).add=function(e,t){wr(this),this.i=null,e=Er(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},Oe.forEach=function(e,t){wr(this),this.g.forEach((function(n,r){n.forEach((function(n){e.call(t,n,r,this)}),this)}),this)},Oe.oa=function(){wr(this);const e=Array.from(this.g.values()),t=Array.from(this.g.keys()),n=[];for(let r=0;r<t.length;r++){const i=e[r];for(let e=0;e<i.length;e++)n.push(t[r])}return n},Oe.W=function(e){wr(this);let t=[];if("string"==typeof e)_r(this,e)&&(t=t.concat(this.g.get(Er(this,e))));else{e=Array.from(this.g.values());for(let n=0;n<e.length;n++)t=t.concat(e[n])}return t},Oe.set=function(e,t){return wr(this),this.i=null,_r(this,e=Er(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},Oe.get=function(e,t){return e&&0<(e=this.W(e)).length?String(e[0]):t},Oe.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++){var r=t[n];const s=encodeURIComponent(String(r)),o=this.W(r);for(r=0;r<o.length;r++){var i=s;""!==o[r]&&(i+="="+encodeURIComponent(String(o[r]))),e.push(i)}}return this.i=e.join("&")};var xr=10;function Sr(e){return!!e.h||!!e.g&&e.g.size>=e.j}function Nr(e){return e.h?1:e.g?e.g.size:0}function Ir(e,t){return e.h?e.h==t:!!e.g&&e.g.has(t)}function Cr(e,t){e.g?e.g.add(t):e.h=t}function Ar(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function Pr(e){if(null!=e.h)return e.i.concat(e.h.D);if(null!=e.g&&0!==e.g.size){let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}return Je(e.i)}function Dr(){}function Mr(){this.g=new Dr}function Rr(e,t,n){const r=n||"";try{tr(e,(function(e,n){let i=e;qe(e)&&(i=Jt(e)),t.push(r+n+"="+encodeURIComponent(i))}))}catch(e){throw t.push(r+"type="+encodeURIComponent("_badmap")),e}}function Or(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function Lr(e){this.l=e.ac||null,this.j=e.jb||!1}function Fr(e,t){Qt.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=Vr,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}kr.prototype.cancel=function(){if(this.i=Pr(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},Dr.prototype.stringify=function(e){return Ue.JSON.stringify(e,void 0)},Dr.prototype.parse=function(e){return Ue.JSON.parse(e,void 0)},Qe(Lr,Pn),Lr.prototype.g=function(){return new Fr(this.l,this.j)},Lr.prototype.i=function(e){return function(){return e}}({}),Qe(Fr,Qt);var Vr=0;function Ur(e){e.j.read().then(e.Ta.bind(e)).catch(e.ga.bind(e))}function Br(e){e.readyState=4,e.l=null,e.j=null,e.A=null,jr(e)}function jr(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(Oe=Fr.prototype).open=function(e,t){if(this.readyState!=Vr)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,jr(this)},Oe.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||Ue).fetch(new Request(this.B,t)).then(this.Wa.bind(this),this.ga.bind(this))},Oe.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Br(this)),this.readyState=Vr},Oe.Wa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,jr(this)),this.g&&(this.readyState=3,jr(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ua.bind(this),this.ga.bind(this));else if(void 0!==Ue.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Ur(this)}else e.text().then(this.Va.bind(this),this.ga.bind(this))},Oe.Ta=function(e){if(this.g){if(this.u&&e.value)this.response.push(e.value);else if(!this.u){var t=e.value?e.value:new Uint8Array(0);(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)}e.done?Br(this):jr(this),3==this.readyState&&Ur(this)}},Oe.Va=function(e){this.g&&(this.response=this.responseText=e,Br(this))},Oe.Ua=function(e){this.g&&(this.response=e,Br(this))},Oe.ga=function(){this.g&&Br(this)},Oe.setRequestHeader=function(e,t){this.v.append(e,t)},Oe.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},Oe.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(Fr.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var qr=Ue.JSON.parse;function $r(e){Qt.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Hr,this.K=this.L=!1}Qe($r,Qt);var Hr="",Kr=/^https?$/i,Gr=["POST","PUT"];function zr(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Wr(e),Xr(e)}function Wr(e){e.D||(e.D=!0,Xt(e,"complete"),Xt(e,"error"))}function Qr(e){if(e.h&&void 0!==Ve&&(!e.C[1]||4!=Jr(e)||2!=e.aa()))if(e.v&&4==Jr(e))hn(e.Ha,0,e);else if(Xt(e,"readystatechange"),4==Jr(e)){e.h=!1;try{const a=e.aa();e:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break e;default:t=!1}var n;if(!(n=t)){var r;if(r=0===a){var i=String(e.H).match(nr)[1]||null;if(!i&&Ue.self&&Ue.self.location){var s=Ue.self.location.protocol;i=s.substr(0,s.length-1)}r=!Kr.test(i?i.toLowerCase():"")}n=r}if(n)Xt(e,"complete"),Xt(e,"success");else{e.m=6;try{var o=2<Jr(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.aa()+"]",Wr(e)}}finally{Xr(e)}}}function Xr(e,t){if(e.g){Yr(e);const n=e.g,r=e.C[0]?Be:null;e.g=null,e.C=null,t||Xt(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Yr(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(Ue.clearTimeout(e.A),e.A=null)}function Jr(e){return e.g?e.g.readyState:0}function Zr(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case Hr:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function ei(e){let t="";return At(e,(function(e,n){t+=n,t+=":",t+=e,t+="\r\n"})),t}function ti(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=ei(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):cr(e,t,n))}function ni(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function ri(e){this.Ca=0,this.i=[],this.j=new vn,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.ab=this.U=0,this.Za=ni("failFast",!1,e),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Xa=ni("baseRetryDelayMs",5e3,e),this.bb=ni("retryDelaySeedMs",1e4,e),this.$a=ni("forwardChannelMaxRetries",2,e),this.ta=ni("forwardChannelRequestTimeoutMs",2e4,e),this.ra=e&&e.xmlHttpFactory||void 0,this.Da=e&&e.Zb||!1,this.J=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.I="",this.h=new kr(e&&e.concurrentRequestLimit),this.Fa=new Mr,this.O=e&&e.fastHandshake||!1,this.N=e&&e.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Ya=e&&e.Xb||!1,e&&e.Aa&&this.j.Aa(),e&&e.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&e&&e.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function ii(e){if(oi(e),3==e.G){var t=e.U++,n=ir(e.F);cr(n,"SID",e.I),cr(n,"RID",t),cr(n,"TYPE","terminate"),ui(e,n),(t=new Un(e,e.j,t,void 0)).K=2,t.v=ur(ir(n)),n=!1,Ue.navigator&&Ue.navigator.sendBeacon&&(n=Ue.navigator.sendBeacon(t.v.toString(),"")),!n&&Ue.Image&&((new Image).src=t.v,n=!0),n||(t.g=_i(t.l,null),t.g.da(t.v)),t.F=Date.now(),Qn(t)}wi(e)}function si(e){e.g&&(fi(e),e.g.cancel(),e.g=null)}function oi(e){si(e),e.u&&(Ue.clearTimeout(e.u),e.u=null),gi(e),e.h.cancel(),e.m&&("number"==typeof e.m&&Ue.clearTimeout(e.m),e.m=null)}function ai(e){Sr(e.h)||e.m||(e.m=!0,sn(e.Ja,e),e.C=0)}function ci(e,t){var n;n=t?t.m:e.U++;const r=ir(e.F);cr(r,"SID",e.I),cr(r,"RID",n),cr(r,"AID",e.T),ui(e,r),e.o&&e.s&&ti(r,e.o,e.s),n=new Un(e,e.j,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.i=t.D.concat(e.i)),t=li(e,n,1e3),n.setTimeout(Math.round(.5*e.ta)+Math.round(.5*e.ta*Math.random())),Cr(e.h,n),Hn(n,r,t)}function ui(e,t){e.ia&&At(e.ia,(function(e,n){cr(t,n,e)})),e.l&&tr({},(function(e,n){cr(t,n,e)}))}function li(e,t,n){n=Math.min(e.i.length,n);var r=e.l?ze(e.l.Ra,e.l,e):null;e:{var i=e.i;let t=-1;for(;;){const e=["count="+n];-1==t?0<n?(t=i[0].h,e.push("ofs="+t)):t=0:e.push("ofs="+t);let s=!0;for(let o=0;o<n;o++){let n=i[o].h;const a=i[o].g;if(n-=t,0>n)t=Math.max(0,i[o].h-100),s=!1;else try{Rr(a,e,"req"+n+"_")}catch(e){r&&r(a)}}if(s){r=e.join("&");break e}}}return e=e.i.splice(0,n),t.D=e,r}function hi(e){e.g||e.u||(e.Z=1,sn(e.Ia,e),e.A=0)}function di(e){return!(e.g||e.u||3<=e.A||(e.Z++,e.u=In(ze(e.Ia,e),yi(e,e.A)),e.A++,0))}function fi(e){null!=e.B&&(Ue.clearTimeout(e.B),e.B=null)}function pi(e){e.g=new Un(e,e.j,"rpc",e.Z),null===e.o&&(e.g.H=e.s),e.g.N=0;var t=ir(e.sa);cr(t,"RID","rpc"),cr(t,"SID",e.I),cr(t,"CI",e.L?"0":"1"),cr(t,"AID",e.T),cr(t,"TYPE","xmlhttp"),ui(e,t),e.o&&e.s&&ti(t,e.o,e.s),e.J&&e.g.setTimeout(e.J);var n=e.g;e=e.ka,n.K=1,n.v=ur(ir(t)),n.s=null,n.P=!0,Kn(n,e)}function gi(e){null!=e.v&&(Ue.clearTimeout(e.v),e.v=null)}function mi(e,t){var n=null;if(e.g==t){gi(e),fi(e),e.g=null;var r=2}else{if(!Ir(e.h,t))return;n=t.D,Ar(e.h,t),r=1}if(0!=e.G)if(e.pa=t.Y,t.i)if(1==r){n=t.s?t.s.length:0,t=Date.now()-t.F;var i=e.C;Xt(r=Tn(),new Nn(r,n)),ai(e)}else hi(e);else if(3==(i=t.o)||0==i&&0<e.pa||!(1==r&&function(e,t){return!(Nr(e.h)>=e.h.j-(e.m?1:0)||(e.m?(e.i=t.D.concat(e.i),0):1==e.G||2==e.G||e.C>=(e.Za?0:e.$a)||(e.m=In(ze(e.Ja,e,t),yi(e,e.C)),e.C++,0)))}(e,t)||2==r&&di(e)))switch(n&&0<n.length&&(t=e.h,t.i=t.i.concat(n)),i){case 1:vi(e,5);break;case 4:vi(e,10);break;case 3:vi(e,6);break;default:vi(e,2)}}function yi(e,t){let n=e.Xa+Math.floor(Math.random()*e.bb);return e.l||(n*=2),n*t}function vi(e,t){if(e.j.info("Error code "+t),2==t){var n=null;e.l&&(n=null);var r=ze(e.kb,e);n||(n=new rr("//www.google.com/images/cleardot.gif"),Ue.location&&"http"==Ue.location.protocol||sr(n,"https"),ur(n)),function(e,t){const n=new vn;if(Ue.Image){const r=new Image;r.onload=We(Or,n,r,"TestLoadImage: loaded",!0,t),r.onerror=We(Or,n,r,"TestLoadImage: error",!1,t),r.onabort=We(Or,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=We(Or,n,r,"TestLoadImage: timeout",!1,t),Ue.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=e}else t(!1)}(n.toString(),r)}else Sn(2);e.G=0,e.l&&e.l.va(t),wi(e),oi(e)}function wi(e){if(e.G=0,e.la=[],e.l){const t=Pr(e.h);0==t.length&&0==e.i.length||(Ze(e.la,t),Ze(e.la,e.i),e.h.i.length=0,Je(e.i),e.i.length=0),e.l.ua()}}function bi(e,t,n){var r=n instanceof rr?ir(n):new rr(n,void 0);if(""!=r.g)t&&(r.g=t+"."+r.g),or(r,r.m);else{var i=Ue.location;r=i.protocol,t=t?t+"."+i.hostname:i.hostname,i=+i.port;var s=new rr(null,void 0);r&&sr(s,r),t&&(s.g=t),i&&or(s,i),n&&(s.l=n),r=s}return n=e.D,t=e.za,n&&t&&cr(r,n,t),cr(r,"VER",e.ma),ui(e,r),r}function _i(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Da&&!e.ra?new $r(new Lr({jb:!0})):new $r(e.ra)).Ka(e.H),t}function Ti(){}function Ei(){if(ht&&!(10<=Number(Et)))throw Error("Environmental error: no available transport.")}function ki(e,t){Qt.call(this),this.g=new ri(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.S=e,(e=t&&t.Yb)&&!nt(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!nt(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new Ni(this)}function xi(e){Ln.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function Si(){Fn.call(this),this.status=1}function Ni(e){this.g=e}(Oe=$r.prototype).Ka=function(e){this.L=e},Oe.da=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():Rn.g(),this.C=this.u?Dn(this.u):Dn(Rn),this.g.onreadystatechange=ze(this.Ha,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void zr(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const e of r.keys())n.set(e,r.get(e))}r=Array.from(n.keys()).find((e=>"content-type"==e.toLowerCase())),i=Ue.FormData&&e instanceof Ue.FormData,!(0<=Ye(Gr,t))||r||i||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[e,t]of n)this.g.setRequestHeader(e,t);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Yr(this),0<this.B&&((this.K=function(e){return ht&&Tt()&&"number"==typeof e.timeout&&void 0!==e.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=ze(this.qa,this)):this.A=hn(this.qa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){zr(this,e)}},Oe.qa=function(){void 0!==Ve&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Xt(this,"timeout"),this.abort(8))},Oe.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Xt(this,"complete"),Xt(this,"abort"),Xr(this))},Oe.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Xr(this,!0)),$r.X.M.call(this)},Oe.Ha=function(){this.s||(this.F||this.v||this.l?Qr(this):this.fb())},Oe.fb=function(){Qr(this)},Oe.aa=function(){try{return 2<Jr(this)?this.g.status:-1}catch(e){return-1}},Oe.fa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},Oe.Sa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),qr(t)}},Oe.Ea=function(){return this.m},Oe.Oa=function(){return"string"==typeof this.j?this.j:String(this.j)},(Oe=ri.prototype).ma=8,Oe.G=1,Oe.Ja=function(e){if(this.m)if(this.m=null,1==this.G){if(!e){this.U=Math.floor(1e5*Math.random()),e=this.U++;const i=new Un(this,this.j,e,void 0);let s=this.s;if(this.S&&(s?(s=Pt(s),Mt(s,this.S)):s=this.S),null!==this.o||this.N||(i.H=s,s=null),this.O)e:{for(var t=0,n=0;n<this.i.length;n++){var r=this.i[n];if(void 0===(r="__data__"in r.g&&"string"==typeof(r=r.g.__data__)?r.length:void 0))break;if(4096<(t+=r)){t=n;break e}if(4096===t||n===this.i.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=li(this,i,t),cr(n=ir(this.F),"RID",e),cr(n,"CVER",22),this.D&&cr(n,"X-HTTP-Session-Id",this.D),ui(this,n),s&&(this.N?t="headers="+encodeURIComponent(String(ei(s)))+"&"+t:this.o&&ti(n,this.o,s)),Cr(this.h,i),this.Ya&&cr(n,"TYPE","init"),this.O?(cr(n,"$req",t),cr(n,"SID","null"),i.Z=!0,Hn(i,n,null)):Hn(i,n,t),this.G=2}}else 3==this.G&&(e?ci(this,e):0==this.i.length||Sr(this.h)||ci(this))},Oe.Ia=function(){if(this.u=null,pi(this),this.$&&!(this.K||null==this.g||0>=this.P)){var e=2*this.P;this.j.info("BP detection timer enabled: "+e),this.B=In(ze(this.eb,this),e)}},Oe.eb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,Sn(10),si(this),pi(this))},Oe.cb=function(){null!=this.v&&(this.v=null,si(this),di(this),Sn(19))},Oe.kb=function(e){e?(this.j.info("Successfully pinged google.com"),Sn(2)):(this.j.info("Failed to ping google.com"),Sn(1))},(Oe=Ti.prototype).xa=function(){},Oe.wa=function(){},Oe.va=function(){},Oe.ua=function(){},Oe.Ra=function(){},Ei.prototype.g=function(e,t){return new ki(e,t)},Qe(ki,Qt),ki.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;Sn(0),e.V=t,e.ia=n||{},e.L=e.Y,e.F=bi(e,null,e.V),ai(e)},ki.prototype.close=function(){ii(this.g)},ki.prototype.u=function(e){var t=this.g;if("string"==typeof e){var n={};n.__data__=e,e=n}else this.v&&((n={}).__data__=Jt(e),e=n);t.i.push(new class{constructor(e,t){this.h=e,this.g=t}}(t.ab++,e)),3==t.G&&ai(t)},ki.prototype.M=function(){this.g.l=null,delete this.j,ii(this.g),delete this.g,ki.X.M.call(this)},Qe(xi,Ln),Qe(Si,Fn),Qe(Ni,Ti),Ni.prototype.xa=function(){Xt(this.g,"a")},Ni.prototype.wa=function(e){Xt(this.g,new xi(e))},Ni.prototype.va=function(e){Xt(this.g,new Si)},Ni.prototype.ua=function(){Xt(this.g,"b")},Ei.prototype.createWebChannel=Ei.prototype.g,ki.prototype.send=ki.prototype.u,ki.prototype.open=ki.prototype.m,ki.prototype.close=ki.prototype.close,Cn.NO_ERROR=0,Cn.TIMEOUT=8,Cn.HTTP_ERROR=6,An.COMPLETE="complete",Mn.EventType=On,On.OPEN="a",On.CLOSE="b",On.ERROR="c",On.MESSAGE="d",Qt.prototype.listen=Qt.prototype.N,$r.prototype.listenOnce=$r.prototype.O,$r.prototype.getLastError=$r.prototype.Oa,$r.prototype.getLastErrorCode=$r.prototype.Ea,$r.prototype.getStatus=$r.prototype.aa,$r.prototype.getResponseJson=$r.prototype.Sa,$r.prototype.getResponseText=$r.prototype.fa,$r.prototype.send=$r.prototype.da,$r.prototype.setWithCredentials=$r.prototype.Ka;var Ii=Fe.createWebChannelTransport=function(){return new Ei},Ci=Fe.getStatEventTarget=function(){return Tn()},Ai=Fe.ErrorCode=Cn,Pi=Fe.EventType=An,Di=Fe.Event=bn,Mi=Fe.Stat={sb:0,vb:1,wb:2,Pb:3,Ub:4,Rb:5,Sb:6,Qb:7,Ob:8,Tb:9,PROXY:10,NOPROXY:11,Mb:12,Ib:13,Jb:14,Hb:15,Kb:16,Lb:17,ob:18,nb:19,pb:20},Ri=Fe.FetchXmlHttpFactory=Lr,Oi=Fe.WebChannel=Mn,Li=Fe.XhrIo=$r;const Fi="@firebase/firestore";class Vi{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Vi.UNAUTHENTICATED=new Vi(null),Vi.GOOGLE_CREDENTIALS=new Vi("google-credentials-uid"),Vi.FIRST_PARTY=new Vi("first-party-uid"),Vi.MOCK_USER=new Vi("mock-user");let Ui="9.17.1";const Bi=new Y("@firebase/firestore");function ji(){return Bi.logLevel}function qi(e,...t){if(Bi.logLevel<=K.DEBUG){const n=t.map(Ki);Bi.debug(`Firestore (${Ui}): ${e}`,...n)}}function $i(e,...t){if(Bi.logLevel<=K.ERROR){const n=t.map(Ki);Bi.error(`Firestore (${Ui}): ${e}`,...n)}}function Hi(e,...t){if(Bi.logLevel<=K.WARN){const n=t.map(Ki);Bi.warn(`Firestore (${Ui}): ${e}`,...n)}}function Ki(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function Gi(e="Unexpected state"){const t=`FIRESTORE (${Ui}) INTERNAL ASSERTION FAILED: `+e;throw $i(t),new Error(t)}function zi(e,t){e||Gi()}function Wi(e,t){return e}const Qi={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Xi extends R{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Yi{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class Ji{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class Zi{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(Vi.UNAUTHENTICATED)))}shutdown(){}}class es{constructor(e){this.t=e,this.currentUser=Vi.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let i=new Yi;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Yi,e.enqueueRetryable((()=>r(this.currentUser)))};const s=()=>{const t=i;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{qi("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),s()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(qi("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Yi)}}),0),s()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(qi("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(zi("string"==typeof t.accessToken),new Ji(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return zi(null===e||"string"==typeof e),new Vi(e)}}class ts{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r,this.type="FirstParty",this.user=Vi.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(zi(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);const e=this.I();return e&&this.p.set("Authorization",e),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class ns{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r}getToken(){return Promise.resolve(new ts(this.h,this.l,this.m,this.g))}start(e,t){e.enqueueRetryable((()=>t(Vi.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class rs{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class is{constructor(e){this.T=e,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(e,t){const n=e=>{null!=e.error&&qi("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.A;return this.A=e.token,qi("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{qi("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.T.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.T.getImmediate({optional:!0});e?r(e):qi("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(zi("string"==typeof e.token),this.A=e.token,new rs(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function ss(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class os{static R(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const r=ss(40);for(let i=0;i<r.length;++i)n.length<20&&r[i]<t&&(n+=e.charAt(r[i]%e.length))}return n}}function as(e,t){return e<t?-1:e>t?1:0}function cs(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}class us{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new Xi(Qi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new Xi(Qi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Xi(Qi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new Xi(Qi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return us.fromMillis(Date.now())}static fromDate(e){return us.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new us(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?as(this.nanoseconds,e.nanoseconds):as(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ls{constructor(e){this.timestamp=e}static fromTimestamp(e){return new ls(e)}static min(){return new ls(new us(0,0))}static max(){return new ls(new us(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class hs{constructor(e,t,n){void 0===t?t=0:t>e.length&&Gi(),void 0===n?n=e.length-t:n>e.length-t&&Gi(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===hs.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof hs?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class ds extends hs{construct(e,t,n){return new ds(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new Xi(Qi.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new ds(t)}static emptyPath(){return new ds([])}}const fs=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ps extends hs{construct(e,t,n){return new ps(e,t,n)}static isValidIdentifier(e){return fs.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ps.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new ps(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const i=()=>{if(0===n.length)throw new Xi(Qi.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Xi(Qi.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Xi(Qi.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(s=!s,r++):"."!==t||s?(n+=t,r++):(i(),r++)}if(i(),s)throw new Xi(Qi.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new ps(t)}static emptyPath(){return new ps([])}}class gs{constructor(e){this.path=e}static fromPath(e){return new gs(ds.fromString(e))}static fromName(e){return new gs(ds.fromString(e).popFirst(5))}static empty(){return new gs(ds.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ds.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ds.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new gs(new ds(e.slice()))}}function ms(e){return new ys(e.readTime,e.key,-1)}class ys{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ys(ls.min(),gs.empty(),-1)}static max(){return new ys(ls.max(),gs.empty(),-1)}}function vs(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=gs.comparator(e.documentKey,t.documentKey),0!==n?n:as(e.largestBatchId,t.largestBatchId))}class ws{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function bs(e){if(e.code!==Qi.FAILED_PRECONDITION||"The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab."!==e.message)throw e;qi("LocalStore","Unexpectedly lost primary lease")}class _s{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&Gi(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new _s(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof _s?t:_s.resolve(t)}catch(e){return _s.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):_s.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):_s.reject(t)}static resolve(e){return new _s(((t,n)=>{t(e)}))}static reject(e){return new _s(((t,n)=>{n(e)}))}static waitFor(e){return new _s(((t,n)=>{let r=0,i=0,s=!1;e.forEach((e=>{++r,e.next((()=>{++i,s&&i===r&&t()}),(e=>n(e)))})),s=!0,i===r&&t()}))}static or(e){let t=_s.resolve(!1);for(const n of e)t=t.next((e=>e?_s.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new _s(((n,r)=>{const i=e.length,s=new Array(i);let o=0;for(let a=0;a<i;a++){const c=a;t(e[c]).next((e=>{s[c]=e,++o,o===i&&n(s)}),(e=>r(e)))}}))}static doWhile(e,t){return new _s(((n,r)=>{const i=()=>{!0===e()?t().next((()=>{i()}),r):n()};i()}))}}function Ts(e){return"IndexedDbTransactionError"===e.name}class Es{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ut(e),this.ct=e=>t.writeSequenceNumber(e))}ut(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ct&&this.ct(e),e}}Es.at=-1;class ks{constructor(e,t,n,r,i,s,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class xs{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new xs("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof xs&&e.projectId===this.projectId&&e.database===this.database}}function Ss(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Ns(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Is(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function Cs(e){return null==e}function As(e){return 0===e&&1/e==-1/0}class Ps{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new Ps(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Ps(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return as(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Ps.EMPTY_BYTE_STRING=new Ps("");const Ds=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ms(e){if(zi(!!e),"string"==typeof e){let t=0;const n=Ds.exec(e);if(zi(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:Rs(e.seconds),nanos:Rs(e.nanos)}}function Rs(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Os(e){return"string"==typeof e?Ps.fromBase64String(e):Ps.fromUint8Array(e)}function Ls(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Fs(e){const t=e.mapValue.fields.__previous_value__;return Ls(t)?Fs(t):t}function Vs(e){const t=Ms(e.mapValue.fields.__local_write_time__.timestampValue);return new us(t.seconds,t.nanos)}const Us={fields:{__type__:{stringValue:"__max__"}}};function Bs(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ls(e)?4:eo(e)?9007199254740991:10:Gi()}function js(e,t){if(e===t)return!0;const n=Bs(e);if(n!==Bs(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Vs(e).isEqual(Vs(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=Ms(e.timestampValue),r=Ms(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return Os(e.bytesValue).isEqual(Os(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return Rs(e.geoPointValue.latitude)===Rs(t.geoPointValue.latitude)&&Rs(e.geoPointValue.longitude)===Rs(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Rs(e.integerValue)===Rs(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=Rs(e.doubleValue),r=Rs(t.doubleValue);return n===r?As(n)===As(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return cs(e.arrayValue.values||[],t.arrayValue.values||[],js);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(Ss(n)!==Ss(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!js(n[e],r[e])))return!1;return!0}(e,t);default:return Gi()}}function qs(e,t){return void 0!==(e.values||[]).find((e=>js(e,t)))}function $s(e,t){if(e===t)return 0;const n=Bs(e),r=Bs(t);if(n!==r)return as(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return as(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=Rs(e.integerValue||e.doubleValue),r=Rs(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Hs(e.timestampValue,t.timestampValue);case 4:return Hs(Vs(e),Vs(t));case 5:return as(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Os(e),r=Os(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=as(n[e],r[e]);if(0!==t)return t}return as(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=as(Rs(e.latitude),Rs(t.latitude));return 0!==n?n:as(Rs(e.longitude),Rs(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=$s(n[e],r[e]);if(t)return t}return as(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Us&&t===Us)return 0;if(e===Us)return 1;if(t===Us)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){const t=as(r[e],s[e]);if(0!==t)return t;const o=$s(n[r[e]],i[s[e]]);if(0!==o)return o}return as(r.length,s.length)}(e.mapValue,t.mapValue);default:throw Gi()}}function Hs(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return as(e,t);const n=Ms(e),r=Ms(t),i=as(n.seconds,r.seconds);return 0!==i?i:as(n.nanos,r.nanos)}function Ks(e){return Gs(e)}function Gs(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Ms(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Os(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,gs.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=Gs(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const i of t)r?r=!1:n+=",",n+=`${i}:${Gs(e.fields[i])}`;return n+"}"}(e.mapValue):Gi();var t,n}function zs(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Ws(e){return!!e&&"integerValue"in e}function Qs(e){return!!e&&"arrayValue"in e}function Xs(e){return!!e&&"nullValue"in e}function Ys(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Js(e){return!!e&&"mapValue"in e}function Zs(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return Ns(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Zs(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Zs(e.arrayValue.values[n]);return t}return Object.assign({},e)}function eo(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}class to{constructor(e,t){this.position=e,this.inclusive=t}}function no(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],o=e.position[i];if(r=s.field.isKeyField()?gs.comparator(gs.fromName(o.referenceValue),n.key):$s(o,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function ro(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!js(e.position[n],t.position[n]))return!1;return!0}class io{}class so extends io{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new fo(e,t,n):"array-contains"===t?new yo(e,n):"in"===t?new vo(e,n):"not-in"===t?new wo(e,n):"array-contains-any"===t?new bo(e,n):new so(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new po(e,n):new go(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison($s(t,this.value)):null!==t&&Bs(this.value)===Bs(t)&&this.matchesComparison($s(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return Gi()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class oo extends io{constructor(e,t){super(),this.filters=e,this.op=t,this.ht=null}static create(e,t){return new oo(e,t)}matches(e){return ao(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ht||(this.ht=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ht}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const e=this.lt((e=>e.isInequality()));return null!==e?e.field:null}lt(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function ao(e){return"and"===e.op}function co(e){return function(e){for(const t of e.filters)if(t instanceof oo)return!1;return!0}(e)&&ao(e)}function uo(e){if(e instanceof so)return e.field.canonicalString()+e.op.toString()+Ks(e.value);if(co(e))return e.filters.map((e=>uo(e))).join(",");{const t=e.filters.map((e=>uo(e))).join(",");return`${e.op}(${t})`}}function lo(e,t){return e instanceof so?function(e,t){return t instanceof so&&e.op===t.op&&e.field.isEqual(t.field)&&js(e.value,t.value)}(e,t):e instanceof oo?function(e,t){return t instanceof oo&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&lo(n,t.filters[r])),!0)}(e,t):void Gi()}function ho(e){return e instanceof so?function(e){return`${e.field.canonicalString()} ${e.op} ${Ks(e.value)}`}(e):e instanceof oo?function(e){return e.op.toString()+" {"+e.getFilters().map(ho).join(" ,")+"}"}(e):"Filter"}class fo extends so{constructor(e,t,n){super(e,t,n),this.key=gs.fromName(n.referenceValue)}matches(e){const t=gs.comparator(e.key,this.key);return this.matchesComparison(t)}}class po extends so{constructor(e,t){super(e,"in",t),this.keys=mo(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class go extends so{constructor(e,t){super(e,"not-in",t),this.keys=mo(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function mo(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>gs.fromName(e.referenceValue)))}class yo extends so{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Qs(t)&&qs(t.arrayValue,this.value)}}class vo extends so{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&qs(this.value.arrayValue,t)}}class wo extends so{constructor(e,t){super(e,"not-in",t)}matches(e){if(qs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!qs(this.value.arrayValue,t)}}class bo extends so{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Qs(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>qs(this.value.arrayValue,e)))}}class _o{constructor(e,t="asc"){this.field=e,this.dir=t}}function To(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class Eo{constructor(e,t){this.comparator=e,this.root=t||xo.EMPTY}insert(e,t){return new Eo(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,xo.BLACK,null,null))}remove(e){return new Eo(this.comparator,this.root.remove(e,this.comparator).copy(null,null,xo.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new ko(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new ko(this.root,e,this.comparator,!1)}getReverseIterator(){return new ko(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new ko(this.root,e,this.comparator,!0)}}class ko{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class xo{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:xo.RED,this.left=null!=r?r:xo.EMPTY,this.right=null!=i?i:xo.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new xo(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return xo.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return xo.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,xo.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,xo.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Gi();if(this.right.isRed())throw Gi();const e=this.left.check();if(e!==this.right.check())throw Gi();return e+(this.isRed()?0:1)}}xo.EMPTY=null,xo.RED=!0,xo.BLACK=!1,xo.EMPTY=new class{constructor(){this.size=0}get key(){throw Gi()}get value(){throw Gi()}get color(){throw Gi()}get left(){throw Gi()}get right(){throw Gi()}copy(e,t,n,r,i){return this}insert(e,t,n){return new xo(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class So{constructor(e){this.comparator=e,this.data=new Eo(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new No(this.data.getIterator())}getIteratorFrom(e){return new No(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof So))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new So(this.comparator);return t.data=e,t}}class No{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}class Io{constructor(e){this.fields=e,e.sort(ps.comparator)}static empty(){return new Io([])}unionWith(e){let t=new So(ps.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new Io(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return cs(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class Co{constructor(e){this.value=e}static empty(){return new Co({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Js(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Zs(t)}setAll(e){let t=ps.emptyPath(),n={},r=[];e.forEach(((e,i)=>{if(!t.isImmediateParentOf(i)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=Zs(e):r.push(i.lastSegment())}));const i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){const t=this.field(e.popLast());Js(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return js(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];Js(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){Ns(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Co(Zs(this.value))}}function Ao(e){const t=[];return Ns(e.fields,((e,n)=>{const r=new ps([e]);if(Js(n)){const e=Ao(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new Io(t)}class Po{constructor(e,t,n,r,i,s,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=o}static newInvalidDocument(e){return new Po(e,0,ls.min(),ls.min(),ls.min(),Co.empty(),0)}static newFoundDocument(e,t,n,r){return new Po(e,1,t,ls.min(),n,r,0)}static newNoDocument(e,t){return new Po(e,2,t,ls.min(),ls.min(),Co.empty(),0)}static newUnknownDocument(e,t){return new Po(e,3,t,ls.min(),ls.min(),Co.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(ls.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Co.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Co.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ls.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Po&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Po(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Do{constructor(e,t=null,n=[],r=[],i=null,s=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=o,this.ft=null}}function Mo(e,t=null,n=[],r=[],i=null,s=null,o=null){return new Do(e,t,n,r,i,s,o)}function Ro(e){const t=Wi(e);if(null===t.ft){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>uo(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),Cs(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Ks(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Ks(e))).join(",")),t.ft=e}return t.ft}function Oo(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!To(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!lo(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!ro(e.startAt,t.startAt)&&ro(e.endAt,t.endAt)}function Lo(e){return gs.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class Fo{constructor(e,t=null,n=[],r=[],i=null,s="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=o,this.endAt=a,this.dt=null,this._t=null,this.startAt,this.endAt}}function Vo(e){return new Fo(e)}function Uo(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Bo(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function jo(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function qo(e){return null!==e.collectionGroup}function $o(e){const t=Wi(e);if(null===t.dt){t.dt=[];const e=jo(t),n=Bo(t);if(null!==e&&null===n)e.isKeyField()||t.dt.push(new _o(e)),t.dt.push(new _o(ps.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.dt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.dt.push(new _o(ps.keyField(),e))}}}return t.dt}function Ho(e){const t=Wi(e);if(!t._t)if("F"===t.limitType)t._t=Mo(t.path,t.collectionGroup,$o(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const n of $o(t)){const t="desc"===n.dir?"asc":"desc";e.push(new _o(n.field,t))}const n=t.endAt?new to(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new to(t.startAt.position,t.startAt.inclusive):null;t._t=Mo(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t._t}function Ko(e,t){t.getFirstInequalityField(),jo(e);const n=e.filters.concat([t]);return new Fo(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Go(e,t,n){return new Fo(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function zo(e,t){return Oo(Ho(e),Ho(t))&&e.limitType===t.limitType}function Wo(e){return`${Ro(Ho(e))}|lt:${e.limitType}`}function Qo(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>ho(e))).join(", ")}]`),Cs(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Ks(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Ks(e))).join(",")),`Target(${t})`}(Ho(e))}; limitType=${e.limitType})`}function Xo(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):gs.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of $o(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=no(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,$o(e),t)||e.endAt&&!function(e,t,n){const r=no(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,$o(e),t))}(e,t)}function Yo(e){return(t,n)=>{let r=!1;for(const i of $o(e)){const e=Jo(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}function Jo(e,t,n){const r=e.field.isKeyField()?gs.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?$s(r,i):Gi()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return Gi()}}function Zo(e,t){if(e.wt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:As(t)?"-0":t}}function ea(e){return{integerValue:""+e}}function ta(e,t){return function(e){return"number"==typeof e&&Number.isInteger(e)&&!As(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}(t)?ea(t):Zo(e,t)}class na{constructor(){this._=void 0}}function ra(e,t,n){return e instanceof oa?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof aa?ca(e,t):e instanceof ua?la(e,t):function(e,t){const n=sa(e,t),r=da(n)+da(e.gt);return Ws(n)&&Ws(e.gt)?ea(r):Zo(e.yt,r)}(e,t)}function ia(e,t,n){return e instanceof aa?ca(e,t):e instanceof ua?la(e,t):n}function sa(e,t){return e instanceof ha?Ws(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class oa extends na{}class aa extends na{constructor(e){super(),this.elements=e}}function ca(e,t){const n=fa(t);for(const t of e.elements)n.some((e=>js(e,t)))||n.push(t);return{arrayValue:{values:n}}}class ua extends na{constructor(e){super(),this.elements=e}}function la(e,t){let n=fa(t);for(const t of e.elements)n=n.filter((e=>!js(e,t)));return{arrayValue:{values:n}}}class ha extends na{constructor(e,t){super(),this.yt=e,this.gt=t}}function da(e){return Rs(e.integerValue||e.doubleValue)}function fa(e){return Qs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class pa{constructor(e,t){this.field=e,this.transform=t}}class ga{constructor(e,t){this.version=e,this.transformResults=t}}class ma{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new ma}static exists(e){return new ma(void 0,e)}static updateTime(e){return new ma(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function ya(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class va{}function wa(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Ca(e.key,ma.none()):new ka(e.key,e.data,ma.none());{const n=e.data,r=Co.empty();let i=new So(ps.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new xa(e.key,r,new Io(i.toArray()),ma.none())}}function ba(e,t,n){e instanceof ka?function(e,t,n){const r=e.value.clone(),i=Na(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof xa?function(e,t,n){if(!ya(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Na(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(Sa(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function _a(e,t,n,r){return e instanceof ka?function(e,t,n,r){if(!ya(e.precondition,t))return n;const i=e.value.clone(),s=Ia(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof xa?function(e,t,n,r){if(!ya(e.precondition,t))return n;const i=Ia(e.fieldTransforms,r,t),s=t.data;return s.setAll(Sa(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return ya(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Ta(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=sa(r.transform,e||null);null!=i&&(null===n&&(n=Co.empty()),n.set(r.field,i))}return n||null}function Ea(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&cs(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof aa&&t instanceof aa||e instanceof ua&&t instanceof ua?cs(e.elements,t.elements,js):e instanceof ha&&t instanceof ha?js(e.gt,t.gt):e instanceof oa&&t instanceof oa}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class ka extends va{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class xa extends va{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function Sa(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function Na(e,t,n){const r=new Map;zi(e.length===n.length);for(let i=0;i<n.length;i++){const s=e[i],o=s.transform,a=t.data.field(s.field);r.set(s.field,ia(o,a,n[i]))}return r}function Ia(e,t,n){const r=new Map;for(const i of e){const e=i.transform,s=n.data.field(i.field);r.set(i.field,ra(e,s,t))}return r}class Ca extends va{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Aa extends va{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Pa{constructor(e){this.count=e}}var Da,Ma;function Ra(e){if(void 0===e)return $i("GRPC error has no .code"),Qi.UNKNOWN;switch(e){case Da.OK:return Qi.OK;case Da.CANCELLED:return Qi.CANCELLED;case Da.UNKNOWN:return Qi.UNKNOWN;case Da.DEADLINE_EXCEEDED:return Qi.DEADLINE_EXCEEDED;case Da.RESOURCE_EXHAUSTED:return Qi.RESOURCE_EXHAUSTED;case Da.INTERNAL:return Qi.INTERNAL;case Da.UNAVAILABLE:return Qi.UNAVAILABLE;case Da.UNAUTHENTICATED:return Qi.UNAUTHENTICATED;case Da.INVALID_ARGUMENT:return Qi.INVALID_ARGUMENT;case Da.NOT_FOUND:return Qi.NOT_FOUND;case Da.ALREADY_EXISTS:return Qi.ALREADY_EXISTS;case Da.PERMISSION_DENIED:return Qi.PERMISSION_DENIED;case Da.FAILED_PRECONDITION:return Qi.FAILED_PRECONDITION;case Da.ABORTED:return Qi.ABORTED;case Da.OUT_OF_RANGE:return Qi.OUT_OF_RANGE;case Da.UNIMPLEMENTED:return Qi.UNIMPLEMENTED;case Da.DATA_LOSS:return Qi.DATA_LOSS;default:return Gi()}}(Ma=Da||(Da={}))[Ma.OK=0]="OK",Ma[Ma.CANCELLED=1]="CANCELLED",Ma[Ma.UNKNOWN=2]="UNKNOWN",Ma[Ma.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ma[Ma.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ma[Ma.NOT_FOUND=5]="NOT_FOUND",Ma[Ma.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ma[Ma.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ma[Ma.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ma[Ma.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ma[Ma.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ma[Ma.ABORTED=10]="ABORTED",Ma[Ma.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ma[Ma.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ma[Ma.INTERNAL=13]="INTERNAL",Ma[Ma.UNAVAILABLE=14]="UNAVAILABLE",Ma[Ma.DATA_LOSS=15]="DATA_LOSS";class Oa{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){Ns(this.inner,((t,n)=>{for(const[t,r]of n)e(t,r)}))}isEmpty(){return Is(this.inner)}size(){return this.innerSize}}const La=new Eo(gs.comparator);function Fa(){return La}const Va=new Eo(gs.comparator);function Ua(...e){let t=Va;for(const n of e)t=t.insert(n.key,n);return t}function Ba(e){let t=Va;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function ja(){return $a()}function qa(){return $a()}function $a(){return new Oa((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Ha=new Eo(gs.comparator),Ka=new So(gs.comparator);function Ga(...e){let t=Ka;for(const n of e)t=t.add(n);return t}const za=new So(as);function Wa(){return za}class Qa{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Xa.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Qa(ls.min(),r,Wa(),Fa(),Ga())}}class Xa{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Xa(n,t,Ga(),Ga(),Ga())}}class Ya{constructor(e,t,n,r){this.It=e,this.removedTargetIds=t,this.key=n,this.Tt=r}}class Ja{constructor(e,t){this.targetId=e,this.Et=t}}class Za{constructor(e,t,n=Ps.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class ec{constructor(){this.At=0,this.Rt=rc(),this.bt=Ps.EMPTY_BYTE_STRING,this.Pt=!1,this.vt=!0}get current(){return this.Pt}get resumeToken(){return this.bt}get Vt(){return 0!==this.At}get St(){return this.vt}Dt(e){e.approximateByteSize()>0&&(this.vt=!0,this.bt=e)}Ct(){let e=Ga(),t=Ga(),n=Ga();return this.Rt.forEach(((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:Gi()}})),new Xa(this.bt,this.Pt,e,t,n)}xt(){this.vt=!1,this.Rt=rc()}Nt(e,t){this.vt=!0,this.Rt=this.Rt.insert(e,t)}kt(e){this.vt=!0,this.Rt=this.Rt.remove(e)}Ot(){this.At+=1}Mt(){this.At-=1}Ft(){this.vt=!0,this.Pt=!0}}class tc{constructor(e){this.$t=e,this.Bt=new Map,this.Lt=Fa(),this.qt=nc(),this.Ut=new So(as)}Kt(e){for(const t of e.It)e.Tt&&e.Tt.isFoundDocument()?this.Gt(t,e.Tt):this.Qt(t,e.key,e.Tt);for(const t of e.removedTargetIds)this.Qt(t,e.key,e.Tt)}jt(e){this.forEachTarget(e,(t=>{const n=this.Wt(t);switch(e.state){case 0:this.zt(t)&&n.Dt(e.resumeToken);break;case 1:n.Mt(),n.Vt||n.xt(),n.Dt(e.resumeToken);break;case 2:n.Mt(),n.Vt||this.removeTarget(t);break;case 3:this.zt(t)&&(n.Ft(),n.Dt(e.resumeToken));break;case 4:this.zt(t)&&(this.Ht(t),n.Dt(e.resumeToken));break;default:Gi()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Bt.forEach(((e,n)=>{this.zt(n)&&t(n)}))}Jt(e){const t=e.targetId,n=e.Et.count,r=this.Yt(t);if(r){const e=r.target;if(Lo(e))if(0===n){const n=new gs(e.path);this.Qt(t,n,Po.newNoDocument(n,ls.min()))}else zi(1===n);else this.Xt(t)!==n&&(this.Ht(t),this.Ut=this.Ut.add(t))}}Zt(e){const t=new Map;this.Bt.forEach(((n,r)=>{const i=this.Yt(r);if(i){if(n.current&&Lo(i.target)){const t=new gs(i.target.path);null!==this.Lt.get(t)||this.te(r,t)||this.Qt(r,t,Po.newNoDocument(t,e))}n.St&&(t.set(r,n.Ct()),n.xt())}}));let n=Ga();this.qt.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Yt(e);return!t||2===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.Lt.forEach(((t,n)=>n.setReadTime(e)));const r=new Qa(e,t,this.Ut,this.Lt,n);return this.Lt=Fa(),this.qt=nc(),this.Ut=new So(as),r}Gt(e,t){if(!this.zt(e))return;const n=this.te(e,t.key)?2:0;this.Wt(e).Nt(t.key,n),this.Lt=this.Lt.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ee(t.key).add(e))}Qt(e,t,n){if(!this.zt(e))return;const r=this.Wt(e);this.te(e,t)?r.Nt(t,1):r.kt(t),this.qt=this.qt.insert(t,this.ee(t).delete(e)),n&&(this.Lt=this.Lt.insert(t,n))}removeTarget(e){this.Bt.delete(e)}Xt(e){const t=this.Wt(e).Ct();return this.$t.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ot(e){this.Wt(e).Ot()}Wt(e){let t=this.Bt.get(e);return t||(t=new ec,this.Bt.set(e,t)),t}ee(e){let t=this.qt.get(e);return t||(t=new So(as),this.qt=this.qt.insert(e,t)),t}zt(e){const t=null!==this.Yt(e);return t||qi("WatchChangeAggregator","Detected inactive target",e),t}Yt(e){const t=this.Bt.get(e);return t&&t.Vt?null:this.$t.ne(e)}Ht(e){this.Bt.set(e,new ec),this.$t.getRemoteKeysForTarget(e).forEach((t=>{this.Qt(e,t,null)}))}te(e,t){return this.$t.getRemoteKeysForTarget(e).has(t)}}function nc(){return new Eo(gs.comparator)}function rc(){return new Eo(gs.comparator)}const ic={asc:"ASCENDING",desc:"DESCENDING"},sc={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},oc={and:"AND",or:"OR"};class ac{constructor(e,t){this.databaseId=e,this.wt=t}}function cc(e,t){return e.wt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function uc(e,t){return e.wt?t.toBase64():t.toUint8Array()}function lc(e,t){return cc(e,t.toTimestamp())}function hc(e){return zi(!!e),ls.fromTimestamp(function(e){const t=Ms(e);return new us(t.seconds,t.nanos)}(e))}function dc(e,t){return function(e){return new ds(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function fc(e){const t=ds.fromString(e);return zi(Pc(t)),t}function pc(e,t){return dc(e.databaseId,t.path)}function gc(e,t){const n=fc(t);if(n.get(1)!==e.databaseId.projectId)throw new Xi(Qi.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Xi(Qi.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new gs(vc(n))}function mc(e,t){return dc(e.databaseId,t)}function yc(e){return new ds(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function vc(e){return zi(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function wc(e,t,n){return{name:pc(e,t),fields:n.value.mapValue.fields}}function bc(e,t){return{documents:[mc(e,t.path)]}}function _c(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=mc(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=mc(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const i=function(e){if(0!==e.length)return Cc(oo.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const s=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Nc(e.field),direction:kc(e.dir)}}(e)))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);const o=function(e,t){return e.wt||Cs(t)?t:{value:t}}(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Tc(e){let t=function(e){const t=fc(e);return 4===t.length?ds.emptyPath():vc(t)}(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let i=null;if(r>0){zi(1===r);const e=n.from[0];e.allDescendants?i=e.collectionId:t=t.child(e.collectionId)}let s=[];n.where&&(s=function(e){const t=Ec(e);return t instanceof oo&&co(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new _o(Ic(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,Cs(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new to(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new to(n,t)}(n.endAt)),function(e,t,n,r,i,s,o,a){return new Fo(e,t,n,r,i,s,o,a)}(t,i,o,s,a,"F",c,u)}function Ec(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Ic(e.unaryFilter.field);return so.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Ic(e.unaryFilter.field);return so.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Ic(e.unaryFilter.field);return so.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=Ic(e.unaryFilter.field);return so.create(i,"!=",{nullValue:"NULL_VALUE"});default:return Gi()}}(e):void 0!==e.fieldFilter?function(e){return so.create(Ic(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Gi()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return oo.create(e.compositeFilter.filters.map((e=>Ec(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return Gi()}}(e.compositeFilter.op))}(e):Gi()}function kc(e){return ic[e]}function xc(e){return sc[e]}function Sc(e){return oc[e]}function Nc(e){return{fieldPath:e.canonicalString()}}function Ic(e){return ps.fromServerFormat(e.fieldPath)}function Cc(e){return e instanceof so?function(e){if("=="===e.op){if(Ys(e.value))return{unaryFilter:{field:Nc(e.field),op:"IS_NAN"}};if(Xs(e.value))return{unaryFilter:{field:Nc(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ys(e.value))return{unaryFilter:{field:Nc(e.field),op:"IS_NOT_NAN"}};if(Xs(e.value))return{unaryFilter:{field:Nc(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Nc(e.field),op:xc(e.op),value:e.value}}}(e):e instanceof oo?function(e){const t=e.getFilters().map((e=>Cc(e)));return 1===t.length?t[0]:{compositeFilter:{op:Sc(e.op),filters:t}}}(e):Gi()}function Ac(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Pc(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class Dc{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&ba(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=_a(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=_a(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=qa();return this.mutations.forEach((r=>{const i=e.get(r.key),s=i.overlayedDocument;let o=this.applyToLocalView(s,i.mutatedFields);o=t.has(r.key)?null:o;const a=wa(s,o);null!==a&&n.set(r.key,a),s.isValidDocument()||s.convertToNoDocument(ls.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),Ga())}isEqual(e){return this.batchId===e.batchId&&cs(this.mutations,e.mutations,((e,t)=>Ea(e,t)))&&cs(this.baseMutations,e.baseMutations,((e,t)=>Ea(e,t)))}}class Mc{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){zi(e.mutations.length===n.length);let r=Ha;const i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new Mc(e,t,n,r)}}class Rc{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Oc{constructor(e,t,n,r,i=ls.min(),s=ls.min(),o=Ps.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=o}withSequenceNumber(e){return new Oc(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new Oc(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new Oc(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Lc{constructor(e){this.ie=e}}function Fc(e){const t=Tc({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Go(t,t.limit,"L"):t}class Vc{constructor(){}ue(e,t){this.ce(e,t),t.ae()}ce(e,t){if("nullValue"in e)this.he(t,5);else if("booleanValue"in e)this.he(t,10),t.le(e.booleanValue?1:0);else if("integerValue"in e)this.he(t,15),t.le(Rs(e.integerValue));else if("doubleValue"in e){const n=Rs(e.doubleValue);isNaN(n)?this.he(t,13):(this.he(t,15),As(n)?t.le(0):t.le(n))}else if("timestampValue"in e){const n=e.timestampValue;this.he(t,20),"string"==typeof n?t.fe(n):(t.fe(`${n.seconds||""}`),t.le(n.nanos||0))}else if("stringValue"in e)this.de(e.stringValue,t),this._e(t);else if("bytesValue"in e)this.he(t,30),t.we(Os(e.bytesValue)),this._e(t);else if("referenceValue"in e)this.me(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.he(t,45),t.le(n.latitude||0),t.le(n.longitude||0)}else"mapValue"in e?eo(e)?this.he(t,Number.MAX_SAFE_INTEGER):(this.ge(e.mapValue,t),this._e(t)):"arrayValue"in e?(this.ye(e.arrayValue,t),this._e(t)):Gi()}de(e,t){this.he(t,25),this.pe(e,t)}pe(e,t){t.fe(e)}ge(e,t){const n=e.fields||{};this.he(t,55);for(const e of Object.keys(n))this.de(e,t),this.ce(n[e],t)}ye(e,t){const n=e.values||[];this.he(t,50);for(const e of n)this.ce(e,t)}me(e,t){this.he(t,37),gs.fromName(e).path.forEach((e=>{this.he(t,60),this.pe(e,t)}))}he(e,t){e.le(t)}_e(e){e.le(2)}}Vc.Ie=new Vc;class Uc{constructor(){this.Je=new Bc}addToCollectionParentIndex(e,t){return this.Je.add(t),_s.resolve()}getCollectionParents(e,t){return _s.resolve(this.Je.getEntries(t))}addFieldIndex(e,t){return _s.resolve()}deleteFieldIndex(e,t){return _s.resolve()}getDocumentsMatchingTarget(e,t){return _s.resolve(null)}getIndexType(e,t){return _s.resolve(0)}getFieldIndexes(e,t){return _s.resolve([])}getNextCollectionGroupToUpdate(e){return _s.resolve(null)}getMinOffset(e,t){return _s.resolve(ys.min())}getMinOffsetFromCollectionGroup(e,t){return _s.resolve(ys.min())}updateCollectionGroup(e,t,n){return _s.resolve()}updateIndexEntries(e,t){return _s.resolve()}}class Bc{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new So(ds.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new So(ds.comparator)).toArray()}}new Uint8Array(0);class jc{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new jc(e,jc.DEFAULT_COLLECTION_PERCENTILE,jc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}jc.DEFAULT_COLLECTION_PERCENTILE=10,jc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,jc.DEFAULT=new jc(41943040,jc.DEFAULT_COLLECTION_PERCENTILE,jc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),jc.DISABLED=new jc(-1,0,0);class qc{constructor(e){this.bn=e}next(){return this.bn+=2,this.bn}static Pn(){return new qc(0)}static vn(){return new qc(-1)}}class $c{constructor(){this.changes=new Oa((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Po.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?_s.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Hc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Kc{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&_a(n.mutation,e,Io.empty(),us.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,Ga()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=Ga()){const r=ja();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Ua();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=ja();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,Ga())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let i=Fa();const s=$a(),o=$a();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof xa)?i=i.insert(t.key,t):void 0!==o?(s.set(t.key,o.mutation.getFieldMask()),_a(o.mutation,t,o.mutation.getFieldMask(),us.now())):s.set(t.key,Io.empty())})),this.recalculateAndSaveOverlays(e,i).next((e=>(e.forEach(((e,t)=>s.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new Hc(t,null!==(n=s.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=$a();let r=new Eo(((e,t)=>e-t)),i=Ga();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const i of e)i.keys().forEach((e=>{const s=t.get(e);if(null===s)return;let o=n.get(e)||Io.empty();o=i.applyToLocalView(s,o),n.set(e,o);const a=(r.get(i.batchId)||Ga()).add(e);r=r.insert(i.batchId,a)}))})).next((()=>{const s=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,c=r.value,u=qa();c.forEach((e=>{if(!i.has(e)){const r=wa(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}})),s.push(this.documentOverlayCache.saveOverlays(e,a,u))}return _s.waitFor(s)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return gs.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):qo(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((i=>{const s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):_s.resolve(ja());let o=-1,a=i;return s.next((t=>_s.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),i.get(t)?_s.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,i))).next((()=>this.computeViews(e,a,t,Ga()))).next((e=>({batchId:o,changes:Ba(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new gs(t)).next((e=>{let t=Ua();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const r=t.collectionGroup;let i=Ua();return this.indexManager.getCollectionParents(e,r).next((s=>_s.forEach(s,(s=>{const o=function(e,t){return new Fo(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,s.child(r));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{i=i.insert(e,t)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(e,t,n){let r;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((i=>(r=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,r)))).next((e=>{r.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,Po.newInvalidDocument(r)))}));let n=Ua();return e.forEach(((e,i)=>{const s=r.get(e);void 0!==s&&_a(s.mutation,i,Io.empty(),us.now()),Xo(t,i)&&(n=n.insert(e,i))})),n}))}}class Gc{constructor(e){this.yt=e,this.Zn=new Map,this.ts=new Map}getBundleMetadata(e,t){return _s.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){var n;return this.Zn.set(t.id,{id:(n=t).id,version:n.version,createTime:hc(n.createTime)}),_s.resolve()}getNamedQuery(e,t){return _s.resolve(this.ts.get(t))}saveNamedQuery(e,t){return this.ts.set(t.name,function(e){return{name:e.name,query:Fc(e.bundledQuery),readTime:hc(e.readTime)}}(t)),_s.resolve()}}class zc{constructor(){this.overlays=new Eo(gs.comparator),this.es=new Map}getOverlay(e,t){return _s.resolve(this.overlays.get(t))}getOverlays(e,t){const n=ja();return _s.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.oe(e,t,r)})),_s.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.es.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.es.delete(n)),_s.resolve()}getOverlaysForCollection(e,t,n){const r=ja(),i=t.length+1,s=new gs(t.child("")),o=this.overlays.getIteratorFrom(s);for(;o.hasNext();){const e=o.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return _s.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new Eo(((e,t)=>e-t));const s=this.overlays.getIterator();for(;s.hasNext();){const e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=ja(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=ja(),a=i.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return _s.resolve(o)}oe(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.es.get(r.largestBatchId).delete(n.key);this.es.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Rc(t,n));let i=this.es.get(t);void 0===i&&(i=Ga(),this.es.set(t,i)),this.es.set(t,i.add(n.key))}}class Wc{constructor(){this.ns=new So(Qc.ss),this.rs=new So(Qc.os)}isEmpty(){return this.ns.isEmpty()}addReference(e,t){const n=new Qc(e,t);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.cs(new Qc(e,t))}hs(e,t){e.forEach((e=>this.removeReference(e,t)))}ls(e){const t=new gs(new ds([])),n=new Qc(t,e),r=new Qc(t,e+1),i=[];return this.rs.forEachInRange([n,r],(e=>{this.cs(e),i.push(e.key)})),i}fs(){this.ns.forEach((e=>this.cs(e)))}cs(e){this.ns=this.ns.delete(e),this.rs=this.rs.delete(e)}ds(e){const t=new gs(new ds([])),n=new Qc(t,e),r=new Qc(t,e+1);let i=Ga();return this.rs.forEachInRange([n,r],(e=>{i=i.add(e.key)})),i}containsKey(e){const t=new Qc(e,0),n=this.ns.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Qc{constructor(e,t){this.key=e,this._s=t}static ss(e,t){return gs.comparator(e.key,t.key)||as(e._s,t._s)}static os(e,t){return as(e._s,t._s)||gs.comparator(e.key,t.key)}}class Xc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this.gs=new So(Qc.ss)}checkEmpty(e){return _s.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const i=this.ws;this.ws++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const s=new Dc(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.gs=this.gs.add(new Qc(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return _s.resolve(s)}lookupMutationBatch(e,t){return _s.resolve(this.ys(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.ps(n),i=r<0?0:r;return _s.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}getHighestUnacknowledgedBatchId(){return _s.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return _s.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Qc(t,0),r=new Qc(t,Number.POSITIVE_INFINITY),i=[];return this.gs.forEachInRange([n,r],(e=>{const t=this.ys(e._s);i.push(t)})),_s.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new So(as);return t.forEach((e=>{const t=new Qc(e,0),r=new Qc(e,Number.POSITIVE_INFINITY);this.gs.forEachInRange([t,r],(e=>{n=n.add(e._s)}))})),_s.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;gs.isDocumentKey(i)||(i=i.child(""));const s=new Qc(new gs(i),0);let o=new So(as);return this.gs.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e._s)),!0)}),s),_s.resolve(this.Is(o))}Is(e){const t=[];return e.forEach((e=>{const n=this.ys(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){zi(0===this.Ts(t.batchId,"removed")),this.mutationQueue.shift();let n=this.gs;return _s.forEach(t.mutations,(r=>{const i=new Qc(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.gs=n}))}An(e){}containsKey(e,t){const n=new Qc(t,0),r=this.gs.firstAfterOrEqual(n);return _s.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,_s.resolve()}Ts(e,t){return this.ps(e)}ps(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ys(e){const t=this.ps(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Yc{constructor(e){this.Es=e,this.docs=new Eo(gs.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Es(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return _s.resolve(n?n.document.mutableCopy():Po.newInvalidDocument(t))}getEntries(e,t){let n=Fa();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Po.newInvalidDocument(e))})),_s.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Fa();const s=t.path,o=new gs(s.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||vs(ms(o),n)<=0||(r.has(o.key)||Xo(t,o))&&(i=i.insert(o.key,o.mutableCopy()))}return _s.resolve(i)}getAllFromCollectionGroup(e,t,n,r){Gi()}As(e,t){return _s.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Jc(this)}getSize(e){return _s.resolve(this.size)}}class Jc extends $c{constructor(e){super(),this.Yn=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.Yn.addEntry(e,r)):this.Yn.removeEntry(n)})),_s.waitFor(t)}getFromCache(e,t){return this.Yn.getEntry(e,t)}getAllFromCache(e,t){return this.Yn.getEntries(e,t)}}class Zc{constructor(e){this.persistence=e,this.Rs=new Oa((e=>Ro(e)),Oo),this.lastRemoteSnapshotVersion=ls.min(),this.highestTargetId=0,this.bs=0,this.Ps=new Wc,this.targetCount=0,this.vs=qc.Pn()}forEachTarget(e,t){return this.Rs.forEach(((e,n)=>t(n))),_s.resolve()}getLastRemoteSnapshotVersion(e){return _s.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return _s.resolve(this.bs)}allocateTargetId(e){return this.highestTargetId=this.vs.next(),_s.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.bs&&(this.bs=t),_s.resolve()}Dn(e){this.Rs.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.vs=new qc(t),this.highestTargetId=t),e.sequenceNumber>this.bs&&(this.bs=e.sequenceNumber)}addTargetData(e,t){return this.Dn(t),this.targetCount+=1,_s.resolve()}updateTargetData(e,t){return this.Dn(t),_s.resolve()}removeTargetData(e,t){return this.Rs.delete(t.target),this.Ps.ls(t.targetId),this.targetCount-=1,_s.resolve()}removeTargets(e,t,n){let r=0;const i=[];return this.Rs.forEach(((s,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Rs.delete(s),i.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),_s.waitFor(i).next((()=>r))}getTargetCount(e){return _s.resolve(this.targetCount)}getTargetData(e,t){const n=this.Rs.get(t)||null;return _s.resolve(n)}addMatchingKeys(e,t,n){return this.Ps.us(t,n),_s.resolve()}removeMatchingKeys(e,t,n){this.Ps.hs(t,n);const r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((t=>{i.push(r.markPotentiallyOrphaned(e,t))})),_s.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Ps.ls(t),_s.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Ps.ds(t);return _s.resolve(n)}containsKey(e,t){return _s.resolve(this.Ps.containsKey(t))}}class eu{constructor(e,t){this.Vs={},this.overlays={},this.Ss=new Es(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=e(this),this.Cs=new Zc(this),this.indexManager=new Uc,this.remoteDocumentCache=function(e){return new Yc(e)}((e=>this.referenceDelegate.xs(e))),this.yt=new Lc(t),this.Ns=new Gc(this.yt)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new zc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Vs[e.toKey()];return n||(n=new Xc(t,this.referenceDelegate),this.Vs[e.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(e,t,n){qi("MemoryPersistence","Starting transaction:",e);const r=new tu(this.Ss.next());return this.referenceDelegate.ks(),n(r).next((e=>this.referenceDelegate.Os(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Ms(e,t){return _s.or(Object.values(this.Vs).map((n=>()=>n.containsKey(e,t))))}}class tu extends ws{constructor(e){super(),this.currentSequenceNumber=e}}class nu{constructor(e){this.persistence=e,this.Fs=new Wc,this.$s=null}static Bs(e){return new nu(e)}get Ls(){if(this.$s)return this.$s;throw Gi()}addReference(e,t,n){return this.Fs.addReference(n,t),this.Ls.delete(n.toString()),_s.resolve()}removeReference(e,t,n){return this.Fs.removeReference(n,t),this.Ls.add(n.toString()),_s.resolve()}markPotentiallyOrphaned(e,t){return this.Ls.add(t.toString()),_s.resolve()}removeTarget(e,t){this.Fs.ls(t.targetId).forEach((e=>this.Ls.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Ls.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}ks(){this.$s=new Set}Os(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return _s.forEach(this.Ls,(n=>{const r=gs.fromPath(n);return this.qs(e,r).next((e=>{e||t.removeEntry(r,ls.min())}))})).next((()=>(this.$s=null,t.apply(e))))}updateLimboDocument(e,t){return this.qs(e,t).next((e=>{e?this.Ls.delete(t.toString()):this.Ls.add(t.toString())}))}xs(e){return 0}qs(e,t){return _s.or([()=>_s.resolve(this.Fs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ms(e,t)])}}class ru{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Si=n,this.Di=r}static Ci(e,t){let n=Ga(),r=Ga();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new ru(e,t.fromCache,n,r)}}class iu{constructor(){this.xi=!1}initialize(e,t){this.Ni=e,this.indexManager=t,this.xi=!0}getDocumentsMatchingQuery(e,t,n,r){return this.ki(e,t).next((i=>i||this.Oi(e,t,r,n))).next((n=>n||this.Mi(e,t)))}ki(e,t){if(Uo(t))return _s.resolve(null);let n=Ho(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Go(t,null,"F"),n=Ho(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const i=Ga(...r);return this.Ni.getDocuments(e,i).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const s=this.Fi(t,r);return this.$i(t,s,i,n.readTime)?this.ki(e,Go(t,null,"F")):this.Bi(e,s,t,n)}))))})))))}Oi(e,t,n,r){return Uo(t)||r.isEqual(ls.min())?this.Mi(e,t):this.Ni.getDocuments(e,n).next((i=>{const s=this.Fi(t,i);return this.$i(t,s,n,r)?this.Mi(e,t):(ji()<=K.DEBUG&&qi("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Qo(t)),this.Bi(e,s,t,function(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,i=ls.fromTimestamp(1e9===r?new us(n+1,0):new us(n,r));return new ys(i,gs.empty(),t)}(r,-1)))}))}Fi(e,t){let n=new So(Yo(e));return t.forEach(((t,r)=>{Xo(e,r)&&(n=n.add(r))})),n}$i(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Mi(e,t){return ji()<=K.DEBUG&&qi("QueryEngine","Using full collection scan to execute query:",Qo(t)),this.Ni.getDocumentsMatchingQuery(e,t,ys.min())}Bi(e,t,n,r){return this.Ni.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class su{constructor(e,t,n,r){this.persistence=e,this.Li=t,this.yt=r,this.qi=new Eo(as),this.Ui=new Oa((e=>Ro(e)),Oo),this.Ki=new Map,this.Gi=e.getRemoteDocumentCache(),this.Cs=e.getTargetCache(),this.Ns=e.getBundleCache(),this.Qi(n)}Qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Kc(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.qi)))}}async function ou(e,t){const n=Wi(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((i=>(r=i,n.Qi(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const i=[],s=[];let o=Ga();for(const e of r){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({ji:e,removedBatchIds:i,addedBatchIds:s})))}))}))}function au(e){const t=Wi(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Cs.getLastRemoteSnapshotVersion(e)))}function cu(e,t){const n=Wi(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}async function uu(e,t,n){const r=Wi(e),i=r.qi.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,(e=>r.persistence.referenceDelegate.removeTarget(e,i)))}catch(e){if(!Ts(e))throw e;qi("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.qi=r.qi.remove(t),r.Ui.delete(i.target)}function lu(e,t,n){const r=Wi(e);let i=ls.min(),s=Ga();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=Wi(e),i=r.Ui.get(n);return void 0!==i?_s.resolve(r.qi.get(i)):r.Cs.getTargetData(t,n)}(r,e,Ho(t)).next((t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,r.Cs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{s=e}))})).next((()=>r.Li.getDocumentsMatchingQuery(e,t,n?i:ls.min(),n?s:Ga()))).next((e=>(function(e,t,n){let r=e.Ki.get(t)||ls.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Ki.set(t,r)}(r,function(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}(t),e),{documents:e,Hi:s})))))}class hu{constructor(){this.activeTargetIds=Wa()}er(e){this.activeTargetIds=this.activeTargetIds.add(e)}nr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}tr(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class du{constructor(){this.Lr=new hu,this.qr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Lr.er(e),this.qr[e]||"not-current"}updateQueryState(e,t,n){this.qr[e]=t}removeLocalQueryTarget(e){this.Lr.nr(e)}isLocalQueryTarget(e){return this.Lr.activeTargetIds.has(e)}clearQueryState(e){delete this.qr[e]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(e){return this.Lr.activeTargetIds.has(e)}start(){return this.Lr=new hu,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class fu{Ur(e){}shutdown(){}}class pu{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}Ur(e){this.Wr.push(e)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){qi("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Wr)e(0)}jr(){qi("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Wr)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const gu={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class mu{constructor(e){this.Hr=e.Hr,this.Jr=e.Jr}Yr(e){this.Xr=e}Zr(e){this.eo=e}onMessage(e){this.no=e}close(){this.Jr()}send(e){this.Hr(e)}so(){this.Xr()}io(e){this.eo(e)}ro(e){this.no(e)}}class yu extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.oo=t+"://"+e.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get co(){return!1}ao(e,t,n,r,i){const s=this.ho(e,t);qi("RestConnection","Sending: ",s,n);const o={};return this.lo(o,r,i),this.fo(e,s,o,n).then((e=>(qi("RestConnection","Received: ",e),e)),(t=>{throw Hi("RestConnection",`${e} failed with error: `,t,"url: ",s,"request:",n),t}))}_o(e,t,n,r,i,s){return this.ao(e,t,n,r,i)}lo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+Ui,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}ho(e,t){const n=gu[e];return`${this.oo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}fo(e,t,n,r){return new Promise(((i,s)=>{const o=new Li;o.setWithCredentials(!0),o.listenOnce(Pi.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case Ai.NO_ERROR:const t=o.getResponseJson();qi("Connection","XHR received:",JSON.stringify(t)),i(t);break;case Ai.TIMEOUT:qi("Connection",'RPC "'+e+'" timed out'),s(new Xi(Qi.DEADLINE_EXCEEDED,"Request time out"));break;case Ai.HTTP_ERROR:const n=o.getStatus();if(qi("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(Qi).indexOf(t)>=0?t:Qi.UNKNOWN}(t.status);s(new Xi(e,t.message))}else s(new Xi(Qi.UNKNOWN,"Server responded with status "+o.getStatus()))}else s(new Xi(Qi.UNAVAILABLE,"Connection failed."));break;default:Gi()}}finally{qi("Connection",'RPC "'+e+'" completed.')}}));const a=JSON.stringify(r);o.send(t,"POST",a,n,15)}))}wo(e,t,n){const r=[this.oo,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=Ii(),s=Ci(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new Ri({})),this.lo(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;const a=r.join("");qi("Connection","Creating WebChannel: "+a,o);const c=i.createWebChannel(a,o);let u=!1,l=!1;const h=new mu({Hr:e=>{l?qi("Connection","Not sending because WebChannel is closed:",e):(u||(qi("Connection","Opening WebChannel transport."),c.open(),u=!0),qi("Connection","WebChannel sending:",e),c.send(e))},Jr:()=>c.close()}),d=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return d(c,Oi.EventType.OPEN,(()=>{l||qi("Connection","WebChannel transport opened.")})),d(c,Oi.EventType.CLOSE,(()=>{l||(l=!0,qi("Connection","WebChannel transport closed"),h.io())})),d(c,Oi.EventType.ERROR,(e=>{l||(l=!0,Hi("Connection","WebChannel transport errored:",e),h.io(new Xi(Qi.UNAVAILABLE,"The operation could not be completed")))})),d(c,Oi.EventType.MESSAGE,(e=>{var t;if(!l){const n=e.data[0];zi(!!n);const r=n,i=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(i){qi("Connection","WebChannel received error:",i);const e=i.status;let t=function(e){const t=Da[e];if(void 0!==t)return Ra(t)}(e),n=i.message;void 0===t&&(t=Qi.INTERNAL,n="Unknown error status: "+e+" with message "+i.message),l=!0,h.io(new Xi(t,n)),c.close()}else qi("Connection","WebChannel received:",n),h.ro(n)}})),d(s,Di.STAT_EVENT,(e=>{e.stat===Mi.PROXY?qi("Connection","Detected buffering proxy"):e.stat===Mi.NOPROXY&&qi("Connection","Detected no buffering proxy")})),setTimeout((()=>{h.so()}),0),h}}function vu(){return"undefined"!=typeof document?document:null}function wu(e){return new ac(e,!0)}class bu{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Hs=e,this.timerId=t,this.mo=n,this.yo=r,this.po=i,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(e){this.cancel();const t=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),r=Math.max(0,t-n);r>0&&qi("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Io} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.To=this.Hs.enqueueAfterDelay(this.timerId,r,(()=>(this.Eo=Date.now(),e()))),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class _u{constructor(e,t,n,r,i,s,o,a){this.Hs=e,this.vo=n,this.Vo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new bu(e,t)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.No()&&await this.close(0)}Mo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.vo,6e4,(()=>this.$o())))}Bo(e){this.Lo(),this.stream.send(e)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}qo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(e,t){this.Lo(),this.qo(),this.xo.cancel(),this.So++,4!==e?this.xo.reset():t&&t.code===Qi.RESOURCE_EXHAUSTED?($i(t.toString()),$i("Using maximum backoff delay to prevent overloading the backend."),this.xo.Ao()):t&&t.code===Qi.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Uo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}Uo(){}auth(){this.state=1;const e=this.Ko(this.So),t=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.So===t&&this.Go(e,n)}),(t=>{e((()=>{const e=new Xi(Qi.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Qo(e)}))}))}Go(e,t){const n=this.Ko(this.So);this.stream=this.jo(e,t),this.stream.Yr((()=>{n((()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.Vo,1e4,(()=>(this.ko()&&(this.state=3),Promise.resolve()))),this.listener.Yr())))})),this.stream.Zr((e=>{n((()=>this.Qo(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Oo(){this.state=5,this.xo.Ro((async()=>{this.state=0,this.start()}))}Qo(e){return qi("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Ko(e){return t=>{this.Hs.enqueueAndForget((()=>this.So===e?t():(qi("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Tu extends _u{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.yt=i}jo(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.xo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:Gi()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(e,t){return e.wt?(zi(void 0===t||"string"==typeof t),Ps.fromBase64String(t||"")):(zi(void 0===t||t instanceof Uint8Array),Ps.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?Qi.UNKNOWN:Ra(e.code);return new Xi(t,e.message||"")}(o);n=new Za(r,i,s,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const i=gc(e,r.document.name),s=hc(r.document.updateTime),o=r.document.createTime?hc(r.document.createTime):ls.min(),a=new Co({mapValue:{fields:r.document.fields}}),c=Po.newFoundDocument(i,s,o,a),u=r.targetIds||[],l=r.removedTargetIds||[];n=new Ya(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const i=gc(e,r.document),s=r.readTime?hc(r.readTime):ls.min(),o=Po.newNoDocument(i,s),a=r.removedTargetIds||[];n=new Ya([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const i=gc(e,r.document),s=r.removedTargetIds||[];n=new Ya([],s,i,null)}else{if(!("filter"in t))return Gi();{t.filter;const e=t.filter;e.targetId;const r=e.count||0,i=new Pa(r),s=e.targetId;n=new Ja(s,i)}}return n}(this.yt,e),n=function(e){if(!("targetChange"in e))return ls.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?ls.min():t.readTime?hc(t.readTime):ls.min()}(e);return this.listener.Wo(t,n)}zo(e){const t={};t.database=yc(this.yt),t.addTarget=function(e,t){let n;const r=t.target;return n=Lo(r)?{documents:bc(e,r)}:{query:_c(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=uc(e,t.resumeToken):t.snapshotVersion.compareTo(ls.min())>0&&(n.readTime=cc(e,t.snapshotVersion.toTimestamp())),n}(this.yt,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Gi()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.yt,e);n&&(t.labels=n),this.Bo(t)}Ho(e){const t={};t.database=yc(this.yt),t.removeTarget=e,this.Bo(t)}}class Eu extends _u{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.yt=i,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}Uo(){this.Jo&&this.Xo([])}jo(e,t){return this.connection.wo("Write",e,t)}onMessage(e){if(zi(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Jo){this.xo.reset();const t=function(e,t){return e&&e.length>0?(zi(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?hc(e.updateTime):hc(t);return n.isEqual(ls.min())&&(n=hc(t)),new ga(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=hc(e.commitTime);return this.listener.Zo(n,t)}return zi(!e.writeResults||0===e.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const e={};e.database=yc(this.yt),this.Bo(e)}Xo(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>function(e,t){let n;if(t instanceof ka)n={update:wc(e,t.key,t.value)};else if(t instanceof Ca)n={delete:pc(e,t.key)};else if(t instanceof xa)n={update:wc(e,t.key,t.data),updateMask:Ac(t.fieldMask)};else{if(!(t instanceof Aa))return Gi();n={verify:pc(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof oa)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof aa)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof ua)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof ha)return{fieldPath:t.field.canonicalString(),increment:n.gt};throw Gi()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:lc(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Gi()}(e,t.precondition)),n}(this.yt,e)))};this.Bo(t)}}class ku extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.yt=r,this.nu=!1}su(){if(this.nu)throw new Xi(Qi.FAILED_PRECONDITION,"The client has already been terminated.")}ao(e,t,n){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,i])=>this.connection.ao(e,t,n,r,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===Qi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Xi(Qi.UNKNOWN,e.toString())}))}_o(e,t,n,r){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,s])=>this.connection._o(e,t,n,i,s,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===Qi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Xi(Qi.UNKNOWN,e.toString())}))}terminate(){this.nu=!0}}class xu{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve()))))}hu(e){"Online"===this.state?this.cu("Unknown"):(this.iu++,this.iu>=1&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.cu("Offline")))}set(e){this.lu(),this.iu=0,"Online"===e&&(this.ou=!1),this.cu(e)}cu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}au(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?($i(t),this.ou=!1):qi("OnlineStateTracker",t)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class Su{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=i,this.mu.Ur((e=>{n.enqueueAndForget((async()=>{Ou(this)&&(qi("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=Wi(e);t._u.add(4),await Iu(t),t.gu.set("Unknown"),t._u.delete(4),await Nu(t)}(this))}))})),this.gu=new xu(n,r)}}async function Nu(e){if(Ou(e))for(const t of e.wu)await t(!0)}async function Iu(e){for(const t of e.wu)await t(!1)}function Cu(e,t){const n=Wi(e);n.du.has(t.targetId)||(n.du.set(t.targetId,t),Ru(n)?Mu(n):Ju(n).ko()&&Pu(n,t))}function Au(e,t){const n=Wi(e),r=Ju(n);n.du.delete(t),r.ko()&&Du(n,t),0===n.du.size&&(r.ko()?r.Fo():Ou(n)&&n.gu.set("Unknown"))}function Pu(e,t){e.yu.Ot(t.targetId),Ju(e).zo(t)}function Du(e,t){e.yu.Ot(t),Ju(e).Ho(t)}function Mu(e){e.yu=new tc({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ne:t=>e.du.get(t)||null}),Ju(e).start(),e.gu.uu()}function Ru(e){return Ou(e)&&!Ju(e).No()&&e.du.size>0}function Ou(e){return 0===Wi(e)._u.size}function Lu(e){e.yu=void 0}async function Fu(e){e.du.forEach(((t,n)=>{Pu(e,t)}))}async function Vu(e,t){Lu(e),Ru(e)?(e.gu.hu(t),Mu(e)):e.gu.set("Unknown")}async function Uu(e,t,n){if(e.gu.set("Online"),t instanceof Za&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.du.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.du.delete(r),e.yu.removeTarget(r))}(e,t)}catch(n){qi("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Bu(e,n)}else if(t instanceof Ya?e.yu.Kt(t):t instanceof Ja?e.yu.Jt(t):e.yu.jt(t),!n.isEqual(ls.min()))try{const t=await au(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.yu.Zt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const i=e.du.get(r);i&&e.du.set(r,i.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.du.get(t);if(!n)return;e.du.set(t,n.withResumeToken(Ps.EMPTY_BYTE_STRING,n.snapshotVersion)),Du(e,t);const r=new Oc(n.target,t,1,n.sequenceNumber);Pu(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){qi("RemoteStore","Failed to raise snapshot:",t),await Bu(e,t)}}async function Bu(e,t,n){if(!Ts(t))throw t;e._u.add(1),await Iu(e),e.gu.set("Offline"),n||(n=()=>au(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{qi("RemoteStore","Retrying IndexedDB access"),await n(),e._u.delete(1),await Nu(e)}))}function ju(e,t){return t().catch((n=>Bu(e,n,t)))}async function qu(e){const t=Wi(e),n=Zu(t);let r=t.fu.length>0?t.fu[t.fu.length-1].batchId:-1;for(;$u(t);)try{const e=await cu(t.localStore,r);if(null===e){0===t.fu.length&&n.Fo();break}r=e.batchId,Hu(t,e)}catch(e){await Bu(t,e)}Ku(t)&&Gu(t)}function $u(e){return Ou(e)&&e.fu.length<10}function Hu(e,t){e.fu.push(t);const n=Zu(e);n.ko()&&n.Yo&&n.Xo(t.mutations)}function Ku(e){return Ou(e)&&!Zu(e).No()&&e.fu.length>0}function Gu(e){Zu(e).start()}async function zu(e){Zu(e).eu()}async function Wu(e){const t=Zu(e);for(const n of e.fu)t.Xo(n.mutations)}async function Qu(e,t,n){const r=e.fu.shift(),i=Mc.from(r,t,n);await ju(e,(()=>e.remoteSyncer.applySuccessfulWrite(i))),await qu(e)}async function Xu(e,t){t&&Zu(e).Yo&&await async function(e,t){if(function(e){switch(e){default:return Gi();case Qi.CANCELLED:case Qi.UNKNOWN:case Qi.DEADLINE_EXCEEDED:case Qi.RESOURCE_EXHAUSTED:case Qi.INTERNAL:case Qi.UNAVAILABLE:case Qi.UNAUTHENTICATED:return!1;case Qi.INVALID_ARGUMENT:case Qi.NOT_FOUND:case Qi.ALREADY_EXISTS:case Qi.PERMISSION_DENIED:case Qi.FAILED_PRECONDITION:case Qi.ABORTED:case Qi.OUT_OF_RANGE:case Qi.UNIMPLEMENTED:case Qi.DATA_LOSS:return!0}}(n=t.code)&&n!==Qi.ABORTED){const n=e.fu.shift();Zu(e).Mo(),await ju(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await qu(e)}var n}(e,t),Ku(e)&&Gu(e)}async function Yu(e,t){const n=Wi(e);n.asyncQueue.verifyOperationInProgress(),qi("RemoteStore","RemoteStore received new credentials");const r=Ou(n);n._u.add(3),await Iu(n),r&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n._u.delete(3),await Nu(n)}function Ju(e){return e.pu||(e.pu=function(e,t,n){const r=Wi(e);return r.su(),new Tu(t,r.connection,r.authCredentials,r.appCheckCredentials,r.yt,n)}(e.datastore,e.asyncQueue,{Yr:Fu.bind(null,e),Zr:Vu.bind(null,e),Wo:Uu.bind(null,e)}),e.wu.push((async t=>{t?(e.pu.Mo(),Ru(e)?Mu(e):e.gu.set("Unknown")):(await e.pu.stop(),Lu(e))}))),e.pu}function Zu(e){return e.Iu||(e.Iu=function(e,t,n){const r=Wi(e);return r.su(),new Eu(t,r.connection,r.authCredentials,r.appCheckCredentials,r.yt,n)}(e.datastore,e.asyncQueue,{Yr:zu.bind(null,e),Zr:Xu.bind(null,e),tu:Wu.bind(null,e),Zo:Qu.bind(null,e)}),e.wu.push((async t=>{t?(e.Iu.Mo(),await qu(e)):(await e.Iu.stop(),e.fu.length>0&&(qi("RemoteStore",`Stopping write stream with ${e.fu.length} pending writes`),e.fu=[]))}))),e.Iu}class el{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Yi,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,o=new el(e,t,s,r,i);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Xi(Qi.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function tl(e,t){if($i("AsyncQueue",`${t}: ${e}`),Ts(e))return new Xi(Qi.UNAVAILABLE,`${t}: ${e}`);throw e}class nl{constructor(e){this.comparator=e?(t,n)=>e(t,n)||gs.comparator(t.key,n.key):(e,t)=>gs.comparator(e.key,t.key),this.keyedMap=Ua(),this.sortedSet=new Eo(this.comparator)}static emptySet(e){return new nl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof nl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new nl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class rl{constructor(){this.Tu=new Eo(gs.comparator)}track(e){const t=e.doc.key,n=this.Tu.get(t);n?0!==e.type&&3===n.type?this.Tu=this.Tu.insert(t,e):3===e.type&&1!==n.type?this.Tu=this.Tu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Tu=this.Tu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Tu=this.Tu.remove(t):1===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):Gi():this.Tu=this.Tu.insert(t,e)}Eu(){const e=[];return this.Tu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class il{constructor(e,t,n,r,i,s,o,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach((e=>{s.push({type:0,doc:e})})),new il(e,t,nl.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&zo(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class sl{constructor(){this.Au=void 0,this.listeners=[]}}class ol{constructor(){this.queries=new Oa((e=>Wo(e)),zo),this.onlineState="Unknown",this.Ru=new Set}}function al(e,t){const n=Wi(e);let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.Pu(e)&&(r=!0);i.Au=e}}r&&ul(n)}function cl(e,t,n){const r=Wi(e),i=r.queries.get(t);if(i)for(const e of i.listeners)e.onError(n);r.queries.delete(t)}function ul(e){e.Ru.forEach((e=>{e.next()}))}class ll{constructor(e,t,n){this.query=e,this.vu=t,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new il(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Vu?this.Du(e)&&(this.vu.next(e),t=!0):this.Cu(e,this.onlineState)&&(this.xu(e),t=!0),this.Su=e,t}onError(e){this.vu.error(e)}bu(e){this.onlineState=e;let t=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,e)&&(this.xu(this.Su),t=!0),t}Cu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Nu||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Du(e){if(e.docChanges.length>0)return!0;const t=this.Su&&this.Su.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}xu(e){e=il.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Vu=!0,this.vu.next(e)}}class hl{constructor(e){this.key=e}}class dl{constructor(e){this.key=e}}class fl{constructor(e,t){this.query=e,this.qu=t,this.Uu=null,this.hasCachedResults=!1,this.current=!1,this.Ku=Ga(),this.mutatedKeys=Ga(),this.Gu=Yo(e),this.Qu=new nl(this.Gu)}get ju(){return this.qu}Wu(e,t){const n=t?t.zu:new rl,r=t?t.Qu:this.Qu;let i=t?t.mutatedKeys:this.mutatedKeys,s=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),l=Xo(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Hu(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Gu(l,a)>0||c&&this.Gu(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(s=s.add(l),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))})),null!==this.query.limit)for(;s.size>this.query.limit;){const e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{Qu:s,zu:n,$i:o,mutatedKeys:i}}Hu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.Qu;this.Qu=e.Qu,this.mutatedKeys=e.mutatedKeys;const i=e.zu.Eu();i.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Gi()}};return n(e)-n(t)}(e.type,t.type)||this.Gu(e.doc,t.doc))),this.Ju(n);const s=t?this.Yu():[],o=0===this.Ku.size&&this.current?1:0,a=o!==this.Uu;return this.Uu=o,0!==i.length||a?{snapshot:new il(this.query,e.Qu,r,i,e.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),Xu:s}:{Xu:s}}bu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new rl,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Xu:[]}}Zu(e){return!this.qu.has(e)&&!!this.Qu.has(e)&&!this.Qu.get(e).hasLocalMutations}Ju(e){e&&(e.addedDocuments.forEach((e=>this.qu=this.qu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.qu=this.qu.delete(e))),this.current=e.current)}Yu(){if(!this.current)return[];const e=this.Ku;this.Ku=Ga(),this.Qu.forEach((e=>{this.Zu(e.key)&&(this.Ku=this.Ku.add(e.key))}));const t=[];return e.forEach((e=>{this.Ku.has(e)||t.push(new dl(e))})),this.Ku.forEach((n=>{e.has(n)||t.push(new hl(n))})),t}tc(e){this.qu=e.Hi,this.Ku=Ga();const t=this.Wu(e.documents);return this.applyChanges(t,!0)}ec(){return il.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.Uu,this.hasCachedResults)}}class pl{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class gl{constructor(e){this.key=e,this.nc=!1}}class ml{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.sc={},this.ic=new Oa((e=>Wo(e)),zo),this.rc=new Map,this.oc=new Set,this.uc=new Eo(gs.comparator),this.cc=new Map,this.ac=new Wc,this.hc={},this.lc=new Map,this.fc=qc.vn(),this.onlineState="Unknown",this.dc=void 0}get isPrimaryClient(){return!0===this.dc}}async function yl(e,t){const n=function(e){const t=Wi(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=wl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Ml.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=_l.bind(null,t),t.sc.Wo=al.bind(null,t.eventManager),t.sc.wc=cl.bind(null,t.eventManager),t}(e);let r,i;const s=n.ic.get(t);if(s)r=s.targetId,n.sharedClientState.addLocalQueryTarget(r),i=s.view.ec();else{const e=await function(e,t){const n=Wi(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Cs.getTargetData(e,t).next((i=>i?(r=i,_s.resolve(r)):n.Cs.allocateTargetId(e).next((i=>(r=new Oc(t,i,0,e.currentSequenceNumber),n.Cs.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.qi.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.qi=n.qi.insert(e.targetId,e),n.Ui.set(t,e.targetId)),e}))}(n.localStore,Ho(t));n.isPrimaryClient&&Cu(n.remoteStore,e);const s=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,i=await async function(e,t,n,r,i){e._c=(t,n,r)=>async function(e,t,n,r){let i=t.view.Wu(n);i.$i&&(i=await lu(e.localStore,t.query,!1).then((({documents:e})=>t.view.Wu(e,i))));const s=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s);return Il(e,t.targetId,o.Xu),o.snapshot}(e,t,n,r);const s=await lu(e.localStore,t,!0),o=new fl(t,s.Hi),a=o.Wu(s.documents),c=Xa.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=o.applyChanges(a,e.isPrimaryClient,c);Il(e,n,u.Xu);const l=new pl(t,n,o);return e.ic.set(t,l),e.rc.has(n)?e.rc.get(n).push(t):e.rc.set(n,[t]),u.snapshot}(n,t,r,"current"===s,e.resumeToken)}return i}async function vl(e,t){const n=Wi(e),r=n.ic.get(t),i=n.rc.get(r.targetId);if(i.length>1)return n.rc.set(r.targetId,i.filter((e=>!zo(e,t)))),void n.ic.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await uu(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Au(n.remoteStore,r.targetId),Sl(n,r.targetId)})).catch(bs)):(Sl(n,r.targetId),await uu(n.localStore,r.targetId,!0))}async function wl(e,t){const n=Wi(e);try{const e=await function(e,t){const n=Wi(e),r=t.snapshotVersion;let i=n.qi;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const s=n.Gi.newChangeBuffer({trackRemovals:!0});i=n.qi;const o=[];t.targetChanges.forEach(((s,a)=>{const c=i.get(a);if(!c)return;o.push(n.Cs.removeMatchingKeys(e,s.removedDocuments,a).next((()=>n.Cs.addMatchingKeys(e,s.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?u=u.withResumeToken(Ps.EMPTY_BYTE_STRING,ls.min()).withLastLimboFreeSnapshotVersion(ls.min()):s.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(s.resumeToken,r)),i=i.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,s)&&o.push(n.Cs.updateTargetData(e,u))}));let a=Fa(),c=Ga();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(function(e,t,n){let r=Ga(),i=Ga();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Fa();return n.forEach(((n,s)=>{const o=e.get(n);s.isFoundDocument()!==o.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(ls.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!o.isValidDocument()||s.version.compareTo(o.version)>0||0===s.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):qi("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",s.version)})),{Wi:r,zi:i}}))}(e,s,t.documentUpdates).next((e=>{a=e.Wi,c=e.zi}))),!r.isEqual(ls.min())){const t=n.Cs.getLastRemoteSnapshotVersion(e).next((t=>n.Cs.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return _s.waitFor(o).next((()=>s.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,c))).next((()=>a))})).then((e=>(n.qi=i,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.cc.get(t);r&&(zi(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.nc=!0:e.modifiedDocuments.size>0?zi(r.nc):e.removedDocuments.size>0&&(zi(r.nc),r.nc=!1))})),await Pl(n,e,t)}catch(e){await bs(e)}}function bl(e,t,n){const r=Wi(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ic.forEach(((n,r)=>{const i=r.view.bu(t);i.snapshot&&e.push(i.snapshot)})),function(e,t){const n=Wi(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const e of n.listeners)e.bu(t)&&(r=!0)})),r&&ul(n)}(r.eventManager,t),e.length&&r.sc.Wo(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function _l(e,t,n){const r=Wi(e);r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.cc.get(t),s=i&&i.key;if(s){let e=new Eo(gs.comparator);e=e.insert(s,Po.newNoDocument(s,ls.min()));const n=Ga().add(s),i=new Qa(ls.min(),new Map,new So(as),e,n);await wl(r,i),r.uc=r.uc.remove(s),r.cc.delete(t),Al(r)}else await uu(r.localStore,t,!1).then((()=>Sl(r,t,n))).catch(bs)}async function Tl(e,t){const n=Wi(e),r=t.batch.batchId;try{const e=await function(e,t){const n=Wi(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),i=n.Gi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const i=n.batch,s=i.keys();let o=_s.resolve();return s.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const s=n.docVersions.get(e);zi(null!==s),t.version.compareTo(s)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,i)))}(n,e,t,i).next((()=>i.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Ga();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);xl(n,r,null),kl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Pl(n,e)}catch(e){await bs(e)}}async function El(e,t,n){const r=Wi(e);try{const e=await function(e,t){const n=Wi(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(zi(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);xl(r,t,n),kl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Pl(r,e)}catch(n){await bs(n)}}function kl(e,t){(e.lc.get(t)||[]).forEach((e=>{e.resolve()})),e.lc.delete(t)}function xl(e,t,n){const r=Wi(e);let i=r.hc[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.hc[r.currentUser.toKey()]=i}}function Sl(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.rc.get(t))e.ic.delete(r),n&&e.sc.wc(r,n);e.rc.delete(t),e.isPrimaryClient&&e.ac.ls(t).forEach((t=>{e.ac.containsKey(t)||Nl(e,t)}))}function Nl(e,t){e.oc.delete(t.path.canonicalString());const n=e.uc.get(t);null!==n&&(Au(e.remoteStore,n),e.uc=e.uc.remove(t),e.cc.delete(n),Al(e))}function Il(e,t,n){for(const r of n)r instanceof hl?(e.ac.addReference(r.key,t),Cl(e,r)):r instanceof dl?(qi("SyncEngine","Document no longer in limbo: "+r.key),e.ac.removeReference(r.key,t),e.ac.containsKey(r.key)||Nl(e,r.key)):Gi()}function Cl(e,t){const n=t.key,r=n.path.canonicalString();e.uc.get(n)||e.oc.has(r)||(qi("SyncEngine","New document in limbo: "+n),e.oc.add(r),Al(e))}function Al(e){for(;e.oc.size>0&&e.uc.size<e.maxConcurrentLimboResolutions;){const t=e.oc.values().next().value;e.oc.delete(t);const n=new gs(ds.fromString(t)),r=e.fc.next();e.cc.set(r,new gl(n)),e.uc=e.uc.insert(n,r),Cu(e.remoteStore,new Oc(Ho(Vo(n.path)),r,2,Es.at))}}async function Pl(e,t,n){const r=Wi(e),i=[],s=[],o=[];r.ic.isEmpty()||(r.ic.forEach(((e,a)=>{o.push(r._c(a,t,n).then((e=>{if((e||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){i.push(e);const t=ru.Ci(a.targetId,e);s.push(t)}})))})),await Promise.all(o),r.sc.Wo(i),await async function(e,t){const n=Wi(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>_s.forEach(t,(t=>_s.forEach(t.Si,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>_s.forEach(t.Di,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!Ts(e))throw e;qi("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.qi.get(t),r=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(r);n.qi=n.qi.insert(t,i)}}}(r.localStore,s))}async function Dl(e,t){const n=Wi(e);if(!n.currentUser.isEqual(t)){qi("SyncEngine","User change. New user:",t.toKey());const e=await ou(n.localStore,t);n.currentUser=t,function(e,t){e.lc.forEach((e=>{e.forEach((e=>{e.reject(new Xi(Qi.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.lc.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Pl(n,e.ji)}}function Ml(e,t){const n=Wi(e),r=n.cc.get(t);if(r&&r.nc)return Ga().add(r.key);{let e=Ga();const r=n.rc.get(t);if(!r)return e;for(const t of r){const r=n.ic.get(t);e=e.unionWith(r.view.ju)}return e}}function Rl(e){const t=Wi(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Tl.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=El.bind(null,t),t}class Ol{constructor(){this.synchronizeTabs=!1}async initialize(e){this.yt=wu(e.databaseInfo.databaseId),this.sharedClientState=this.gc(e),this.persistence=this.yc(e),await this.persistence.start(),this.localStore=this.Ic(e),this.gcScheduler=this.Tc(e,this.localStore),this.indexBackfillerScheduler=this.Ec(e,this.localStore)}Tc(e,t){return null}Ec(e,t){return null}Ic(e){return function(e,t,n,r){return new su(e,t,n,r)}(this.persistence,new iu,e.initialUser,this.yt)}yc(e){return new eu(nu.Bs,this.yt)}gc(e){return new du}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Ll{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>bl(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Dl.bind(null,this.syncEngine),await async function(e,t){const n=Wi(e);t?(n._u.delete(2),await Nu(n)):t||(n._u.add(2),await Iu(n),n.gu.set("Unknown"))}(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new ol}createDatastore(e){const t=wu(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new yu(r));var r;return function(e,t,n,r){return new ku(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>bl(this.syncEngine,e,0),s=pu.C()?new pu:new fu,new Su(t,n,r,i,s);var t,n,r,i,s}createSyncEngine(e,t){return function(e,t,n,r,i,s,o){const a=new ml(e,t,n,r,i,s);return o&&(a.dc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=Wi(e);qi("RemoteStore","RemoteStore shutting down."),t._u.add(5),await Iu(t),t.mu.shutdown(),t.gu.set("Unknown")}(this.remoteStore)}}function Fl(e,t,n){if(!n)throw new Xi(Qi.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Vl(e){if(!gs.isDocumentKey(e))throw new Xi(Qi.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Ul(e){if(gs.isDocumentKey(e))throw new Xi(Qi.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Bl(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":Gi()}function jl(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new Xi(Qi.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Bl(e);throw new Xi(Qi.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}const ql=new Map;class $l{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Xi(Qi.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Xi(Qi.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,function(e,t,n,r){if(!0===t&&!0===r)throw new Xi(Qi.INVALID_ARGUMENT,"experimentalForceLongPolling and experimentalAutoDetectLongPolling cannot be used together.")}(0,e.experimentalForceLongPolling,0,e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Hl{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new $l({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Xi(Qi.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Xi(Qi.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new $l(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Zi;switch(e.type){case"gapi":const t=e.client;return new ns(t,e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Xi(Qi.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=ql.get(e);t&&(qi("ComponentProvider","Removing Datastore"),ql.delete(e),t.terminate())}(this),Promise.resolve()}}class Kl{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new zl(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Kl(this.firestore,e,this._key)}}class Gl{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Gl(this.firestore,e,this._query)}}class zl extends Gl{constructor(e,t,n){super(e,t,Vo(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Kl(this.firestore,null,new gs(e))}withConverter(e){return new zl(this.firestore,e,this._path)}}function Wl(e,t,...n){if(e=U(e),Fl("collection","path",t),e instanceof Hl){const r=ds.fromString(t,...n);return Ul(r),new zl(e,null,r)}{if(!(e instanceof Kl||e instanceof zl))throw new Xi(Qi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(ds.fromString(t,...n));return Ul(r),new zl(e.firestore,null,r)}}function Ql(e,t,...n){if(e=U(e),1===arguments.length&&(t=os.R()),Fl("doc","path",t),e instanceof Hl){const r=ds.fromString(t,...n);return Vl(r),new Kl(e,null,new gs(r))}{if(!(e instanceof Kl||e instanceof zl))throw new Xi(Qi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(ds.fromString(t,...n));return Vl(r),new Kl(e.firestore,e instanceof zl?e.converter:null,new gs(r))}}class Xl{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Rc(this.observer.next,e)}error(e){this.observer.error?this.Rc(this.observer.error,e):$i("Uncaught Error in snapshot listener:",e.toString())}bc(){this.muted=!0}Rc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Yl{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=Vi.UNAUTHENTICATED,this.clientId=os.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{qi("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(qi("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Xi(Qi.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new Yi;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=tl(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Jl(e,t){e.asyncQueue.verifyOperationInProgress();const n=await async function(e){return e.offlineComponents||(qi("FirestoreClient","Using default OfflineComponentProvider"),await async function(e,t){e.asyncQueue.verifyOperationInProgress(),qi("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await ou(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}(e,new Ol)),e.offlineComponents}(e);qi("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>Yu(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Yu(t.remoteStore,n))),e.onlineComponents=t}async function Zl(e){return e.onlineComponents||(qi("FirestoreClient","Using default OnlineComponentProvider"),await Jl(e,new Ll)),e.onlineComponents}async function eh(e){const t=await Zl(e),n=t.eventManager;return n.onListen=yl.bind(null,t.syncEngine),n.onUnlisten=vl.bind(null,t.syncEngine),n}class th{constructor(){this.Bc=Promise.resolve(),this.Lc=[],this.qc=!1,this.Uc=[],this.Kc=null,this.Gc=!1,this.Qc=!1,this.jc=[],this.xo=new bu(this,"async_queue_retry"),this.Wc=()=>{const e=vu();e&&qi("AsyncQueue","Visibility state changed to "+e.visibilityState),this.xo.Po()};const e=vu();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Wc)}get isShuttingDown(){return this.qc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.zc(),this.Hc(e)}enterRestrictedMode(e){if(!this.qc){this.qc=!0,this.Qc=e||!1;const t=vu();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Wc)}}enqueue(e){if(this.zc(),this.qc)return new Promise((()=>{}));const t=new Yi;return this.Hc((()=>this.qc&&this.Qc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Lc.push(e),this.Jc())))}async Jc(){if(0!==this.Lc.length){try{await this.Lc[0](),this.Lc.shift(),this.xo.reset()}catch(e){if(!Ts(e))throw e;qi("AsyncQueue","Operation failed with retryable error: "+e)}this.Lc.length>0&&this.xo.Ro((()=>this.Jc()))}}Hc(e){const t=this.Bc.then((()=>(this.Gc=!0,e().catch((e=>{this.Kc=e,this.Gc=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw $i("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Gc=!1,e))))));return this.Bc=t,t}enqueueAfterDelay(e,t,n){this.zc(),this.jc.indexOf(e)>-1&&(t=0);const r=el.createAndSchedule(this,e,t,n,(e=>this.Yc(e)));return this.Uc.push(r),r}zc(){this.Kc&&Gi()}verifyOperationInProgress(){}async Xc(){let e;do{e=this.Bc,await e}while(e!==this.Bc)}Zc(e){for(const t of this.Uc)if(t.timerId===e)return!0;return!1}ta(e){return this.Xc().then((()=>{this.Uc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.Uc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Xc()}))}ea(e){this.jc.push(e)}Yc(e){const t=this.Uc.indexOf(e);this.Uc.splice(t,1)}}function nh(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const e of["next","error","complete"])if(e in n&&"function"==typeof n[e])return!0;return!1}(e)}class rh extends Hl{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new th,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||sh(this),this._firestoreClient.terminate()}}function ih(e){return e._firestoreClient||sh(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function sh(e){var t;const n=e._freezeSettings(),r=function(e,t,n,r){return new ks(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new Yl(e._authCredentials,e._appCheckCredentials,e._queue,r)}class oh{constructor(e){this._byteString=e}static fromBase64String(e){try{return new oh(Ps.fromBase64String(e))}catch(e){throw new Xi(Qi.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new oh(Ps.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class ah{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Xi(Qi.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ps(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class ch{constructor(e){this._methodName=e}}class uh{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new Xi(Qi.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new Xi(Qi.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return as(this._lat,e._lat)||as(this._long,e._long)}}const lh=/^__.*__$/;class hh{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new xa(e,this.data,this.fieldMask,t,this.fieldTransforms):new ka(e,this.data,t,this.fieldTransforms)}}function dh(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Gi()}}class fh{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.yt=n,this.ignoreUndefinedProperties=r,void 0===i&&this.na(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get sa(){return this.settings.sa}ia(e){return new fh(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.yt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ra(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.ua(e),r}ca(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.na(),r}aa(e){return this.ia({path:void 0,oa:!0})}ha(e){return xh(e,this.settings.methodName,this.settings.la||!1,this.path,this.settings.fa)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}na(){if(this.path)for(let e=0;e<this.path.length;e++)this.ua(this.path.get(e))}ua(e){if(0===e.length)throw this.ha("Document fields must not be empty");if(dh(this.sa)&&lh.test(e))throw this.ha('Document fields cannot begin and end with "__"')}}class ph{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.yt=n||wu(e)}da(e,t,n,r=!1){return new fh({sa:e,methodName:t,fa:n,path:ps.emptyPath(),oa:!1,la:r},this.databaseId,this.yt,this.ignoreUndefinedProperties)}}function gh(e){const t=e._freezeSettings(),n=wu(e._databaseId);return new ph(e._databaseId,!!t.ignoreUndefinedProperties,n)}function mh(e,t,n,r,i,s={}){const o=e.da(s.merge||s.mergeFields?2:0,t,n,i);_h("Data must be an object, but it was:",o,r);const a=wh(r,o);let c,u;if(s.merge)c=new Io(o.fieldMask),u=o.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=Th(t,r,n);if(!o.contains(i))throw new Xi(Qi.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);Sh(e,i)||e.push(i)}c=new Io(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new hh(new Co(a),c,u)}class yh extends ch{constructor(e,t){super(e),this.wa=t}_toFieldTransform(e){const t=new ha(e.yt,ta(e.yt,this.wa));return new pa(e.path,t)}isEqual(e){return this===e}}function vh(e,t){if(bh(e=U(e)))return _h("Unsupported field value:",t,e),wh(e,t);if(e instanceof ch)return function(e,t){if(!dh(t.sa))throw t.ha(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.ha(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.oa&&4!==t.sa)throw t.ha("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=vh(i,t.aa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=U(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return ta(t.yt,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=us.fromDate(e);return{timestampValue:cc(t.yt,n)}}if(e instanceof us){const n=new us(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:cc(t.yt,n)}}if(e instanceof uh)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof oh)return{bytesValue:uc(t.yt,e._byteString)};if(e instanceof Kl){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.ha(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:dc(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.ha(`Unsupported field value: ${Bl(e)}`)}(e,t)}function wh(e,t){const n={};return Is(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Ns(e,((e,r)=>{const i=vh(r,t.ra(e));null!=i&&(n[e]=i)})),{mapValue:{fields:n}}}function bh(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof us||e instanceof uh||e instanceof oh||e instanceof Kl||e instanceof ch)}function _h(e,t,n){if(!bh(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Bl(n);throw"an object"===r?t.ha(e+" a custom object"):t.ha(e+" "+r)}}function Th(e,t,n){if((t=U(t))instanceof ah)return t._internalPath;if("string"==typeof t)return kh(e,t);throw xh("Field path arguments must be of type string or ",e,!1,void 0,n)}const Eh=new RegExp("[~\\*/\\[\\]]");function kh(e,t,n){if(t.search(Eh)>=0)throw xh(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new ah(...t.split("."))._internalPath}catch(r){throw xh(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function xh(e,t,n,r,i){const s=r&&!r.isEmpty(),o=void 0!==i;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(s||o)&&(c+=" (found",s&&(c+=` in field ${r}`),o&&(c+=` in document ${i}`),c+=")"),new Xi(Qi.INVALID_ARGUMENT,a+e+c)}function Sh(e,t){return e.some((e=>e.isEqual(t)))}class Nh{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Kl(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Ih(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Ch("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Ih extends Nh{data(){return super.data()}}function Ch(e,t){return"string"==typeof t?kh(e,t):t instanceof ah?t._internalPath:t._delegate._internalPath}class Ah{}class Ph extends Ah{}function Dh(e,t,...n){let r=[];t instanceof Ah&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof Oh)).length,n=e.filter((e=>e instanceof Mh)).length;if(t>1||t>0&&n>0)throw new Xi(Qi.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class Mh extends Ph{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Mh(e,t,n)}_apply(e){const t=this._parse(e);return Bh(e._query,t),new Gl(e.firestore,e.converter,Ko(e._query,t))}_parse(e){const t=gh(e.firestore),n=function(e,t,n,r,i,s,o){let a;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new Xi(Qi.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){Uh(o,s);const t=[];for(const n of o)t.push(Vh(r,e,n));a={arrayValue:{values:t}}}else a=Vh(r,e,o)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||Uh(o,s),a=function(e,t,n,r=!1){return vh(n,e.da(r?4:3,t))}(n,"where",o,"in"===s||"not-in"===s);return so.create(i,s,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function Rh(e,t,n){const r=t,i=Ch("where",e);return Mh._create(i,r,n)}class Oh extends Ah{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Oh(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:oo.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const e of r)Bh(n,e),n=Ko(n,e)}(e._query,t),new Gl(e.firestore,e.converter,Ko(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Lh extends Ph{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Lh(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new Xi(Qi.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Xi(Qi.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new _o(t,n);return function(e,t){if(null===Bo(e)){const n=jo(e);null!==n&&jh(0,n,t.field)}}(e,r),r}(e._query,this._field,this._direction);return new Gl(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Fo(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function Fh(e,t="asc"){const n=t,r=Ch("orderBy",e);return Lh._create(r,n)}function Vh(e,t,n){if("string"==typeof(n=U(n))){if(""===n)throw new Xi(Qi.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!qo(t)&&-1!==n.indexOf("/"))throw new Xi(Qi.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(ds.fromString(n));if(!gs.isDocumentKey(r))throw new Xi(Qi.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return zs(e,new gs(r))}if(n instanceof Kl)return zs(e,n._key);throw new Xi(Qi.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Bl(n)}.`)}function Uh(e,t){if(!Array.isArray(e)||0===e.length)throw new Xi(Qi.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new Xi(Qi.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function Bh(e,t){if(t.isInequality()){const n=jo(e),r=t.field;if(null!==n&&!n.isEqual(r))throw new Xi(Qi.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${r.toString()}'`);const i=Bo(e);null!==i&&jh(0,r,i)}const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new Xi(Qi.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Xi(Qi.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function jh(e,t,n){if(!n.isEqual(t))throw new Xi(Qi.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class qh{convertValue(e,t="none"){switch(Bs(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Rs(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Os(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Gi()}}convertObject(e,t){const n={};return Ns(e.fields,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new uh(Rs(e.latitude),Rs(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=Fs(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Vs(e));default:return null}}convertTimestamp(e){const t=Ms(e);return new us(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=ds.fromString(e);zi(Pc(n));const r=new xs(n.get(1),n.get(3)),i=new gs(n.popFirst(5));return r.isEqual(t)||$i(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function $h(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Hh{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Kh extends Nh{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Gh(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Ch("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Gh extends Kh{data(e={}){return super.data(e)}}class zh{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Hh(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Gh(this._firestore,this._userDataWriter,n.key,n,new Hh(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Xi(Qi.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new Gh(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Hh(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Gh(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Hh(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),s=n.indexOf(t.doc.key)),{type:Wh(t.type),doc:r,oldIndex:i,newIndex:s}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Wh(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Gi()}}class Qh extends qh{constructor(e){super(),this.firestore=e}convertBytes(e){return new oh(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Kl(this.firestore,null,t)}}function Xh(e,t){const n=jl(e.firestore,rh),r=Ql(e),i=$h(e.converter,t);return Jh(n,[mh(gh(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,ma.exists(!1))]).then((()=>r))}function Yh(e,...t){var n,r,i;e=U(e);let s={includeMetadataChanges:!1},o=0;"object"!=typeof t[o]||nh(t[o])||(s=t[o],o++);const a={includeMetadataChanges:s.includeMetadataChanges};if(nh(t[o])){const e=t[o];t[o]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[o+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[o+2]=null===(i=e.complete)||void 0===i?void 0:i.bind(e)}let c,u,l;if(e instanceof Kl)u=jl(e.firestore,rh),l=Vo(e._key.path),c={next:n=>{t[o]&&t[o](function(e,t,n){const r=n.docs.get(t._key),i=new Qh(e);return new Kh(e,i,t._key,r,new Hh(n.hasPendingWrites,n.fromCache),t.converter)}(u,e,n))},error:t[o+1],complete:t[o+2]};else{const n=jl(e,Gl);u=jl(n.firestore,rh),l=n._query;const r=new Qh(u);c={next:e=>{t[o]&&t[o](new zh(u,r,n,e))},error:t[o+1],complete:t[o+2]},function(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Xi(Qi.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}(e._query)}return function(e,t,n,r){const i=new Xl(r),s=new ll(t,i,n);return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=Wi(e),r=t.query;let i=!1,s=n.queries.get(r);if(s||(i=!0,s=new sl),i)try{s.Au=await n.onListen(r)}catch(e){const n=tl(e,`Initialization of query '${Qo(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,s),s.listeners.push(t),t.bu(n.onlineState),s.Au&&t.Pu(s.Au)&&ul(n)}(await eh(e),s))),()=>{i.bc(),e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=Wi(e),r=t.query;let i=!1;const s=n.queries.get(r);if(s){const e=s.listeners.indexOf(t);e>=0&&(s.listeners.splice(e,1),i=0===s.listeners.length)}if(i)return n.queries.delete(r),n.onUnlisten(r)}(await eh(e),s)))}}(ih(u),l,a,c)}function Jh(e,t){return function(e,t){const n=new Yi;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Rl(e);try{const e=await function(e,t){const n=Wi(e),r=us.now(),i=t.reduce(((e,t)=>e.add(t.key)),Ga());let s,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Fa(),c=Ga();return n.Gi.getEntries(e,i).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((i=>{s=i;const o=[];for(const e of t){const t=Ta(e,s.get(e.key).overlayedDocument);null!=t&&o.push(new xa(e.key,t,Ao(t.value.mapValue),ma.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(s,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Ba(s)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.hc[e.currentUser.toKey()];r||(r=new Eo(as)),r=r.insert(t,n),e.hc[e.currentUser.toKey()]=r}(r,e.batchId,n),await Pl(r,e.changes),await qu(r.remoteStore)}catch(e){const t=tl(e,"Failed to persist write");n.reject(t)}}(await function(e){return Zl(e).then((e=>e.syncEngine))}(e),t,n))),n.promise}(ih(e),t)}!function(e,t=!0){Ui="9.17.1",_e(new B("firestore",((e,{instanceIdentifier:n,options:r})=>{const i=e.getProvider("app").getImmediate(),s=new rh(new es(e.getProvider("auth-internal")),new is(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Xi(Qi.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new xs(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:t},r),s._setSettings(r),s}),"PUBLIC").setMultipleInstances(!0)),ke(Fi,"3.8.3",e),ke(Fi,"3.8.3","esm2017")}();var Zh=function(){return Zh=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Zh.apply(this,arguments)};function ed(e){if("object"==typeof e&&null!==e){var t=Array.isArray(e)?function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}([],e,!0):Zh({},e);for(var n in t)t[n]=ed(t[n]);return t}return e}function td(e,t){if(e===t)return null;if(void 0===e||"object"!=typeof t||typeof t!=typeof e)return t;var n=e,r=t;if("object"==typeof t&&"object"!=typeof e)throw"type mismatch, ".concat(typeof e," vs ").concat(typeof t);var i={},s=0;return Object.entries(n).forEach((function(e){var t=td(n[e[0]],r[e[0]]);null!==t&&(++s,i[e[0]]=void 0===t?null:t)})),Object.entries(t).filter((function(e){return void 0===n[e[0]]})).forEach((function(e){++s,i[e[0]]=r[e[0]]})),0===s?null:ed(i)}function nd(e,t){if(null===t)return e;if(typeof e!=typeof t)return"object"==typeof t?ed(t):t;if("object"!=typeof t)return t;var n=e;return Object.keys(t).forEach((function(e){var r=t[e];null===r?delete n[e]:n[e]=nd(n[e],r)})),Array.isArray(n)?n.filter((function(e){return null!=e})):n}var rd=function(){return rd=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},rd.apply(this,arguments)},id=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},sd=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},od=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};function ad(e){if("object"!=typeof e)return!1;if(null===e)return!0;for(var t in e)if(ad(e[t]))return!0;return!1}function cd(e,t){var n=ed(e);ad(n)&&console.error("nulls before");var r=nd(e,t);if(ad(r))throw console.error("nulls after",n),"nulls";return r}var ud={},ld={},hd={};function dd(e){var t;return console.log("Count scans for key ".concat(e)),void 0===e&&console.error("undefined key"),(null===(t=ld[e])||void 0===t?void 0:t.length)||0}function fd(e){return id(this,void 0,void 0,(function(){return sd(this,(function(t){return[2,E(e,1,{upgrade:function(t){t.createObjectStore(e,{keyPath:"timestamp"}).createIndex("timestamp","timestamp",{unique:!0})}})]}))}))}function pd(e,t,n,r){return id(this,void 0,void 0,(function(){var i,s,o,a;return sd(this,(function(c){switch(c.label){case 0:return i="diffCache"===r?":diffcache":"",[4,fd(s="".concat(t,":").concat(n).concat(i))];case 1:return o=c.sent(),a=o.transaction(s,"readwrite"),[4,Promise.all(od(od([],e.map((function(e){var t=rd({},e);t.prev=void 0,t.next=void 0,a.store.put(t)})),!0),[a.done],!1))];case 2:return c.sent(),[2]}}))}))}function gd(e,t,n){return id(this,void 0,void 0,(function(){var r,i;return sd(this,(function(s){switch(s.label){case 0:return r="diffCache"===n?":diffcache":"",[4,fd(i="".concat(e,":").concat(t).concat(r))];case 1:return[2,s.sent().getAllFromIndex(i,"timestamp")]}}))}))}function md(e,t,n){return id(this,void 0,void 0,(function(){var r,i,s,o,a;return sd(this,(function(c){switch(c.label){case 0:return r="diffCache"===n?":diffcache":"",[4,fd(i="".concat(e,":").concat(t).concat(r))];case 1:return[4,(s=c.sent()).getAllKeys(i)];case 2:return o=c.sent(),console.log({k0:o[0],kl:o.slice(-1)[0]}),(a=o.slice(-1)[0])?[2,s.getFromIndex(i,"timestamp",a)]:[2,void 0]}}))}))}var yd=function(e,t,n){n||(n="(default)");const r=function(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}(e,"firestore");if(r.isInitialized(n)){const e=r.getImmediate({identifier:n});if(F(r.getOptions(n),t))return e;throw new Xi(Qi.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Xi(Qi.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:t,instanceIdentifier:n})}(function(e,t={}){let n=e;"object"!=typeof t&&(t={name:t});const r=Object.assign({name:"[DEFAULT]",automaticDataCollectionEnabled:!1},t),i=r.name;if("string"!=typeof i||!i)throw Te.create("bad-app-name",{appName:String(i)});if(n||(n=(()=>{var e;return null===(e=D())||void 0===e?void 0:e.config})()),!n)throw Te.create("no-options");const s=ve.get(i);if(s){if(F(n,s.options)&&F(r,s.config))return s;throw Te.create("duplicate-app",{appName:i})}const o=new $(i);for(const e of we.values())o.addComponent(e);const a=new Ee(n,r,o);return ve.set(i,a),a}({apiKey:"AIzaSyCzwCKesO-Me1dVpo-5jZxoo559SoGGstk",authDomain:"npaserver.firebaseapp.com",projectId:"npaserver",storageBucket:"npaserver.appspot.com",messagingSenderId:"560331767449",appId:"1:560331767449:web:5595a4f5c3e02ed49bc208"}),{experimentalForceLongPolling:Re()});function vd(e,t){var n;return id(this,void 0,void 0,(function(){var r,i,s,o,a;return sd(this,(function(c){switch(c.label){case 0:if(ld[t]&&0!==ld[t].length)return[3,5];c.label=1;case 1:return c.trys.push([1,4,,5]),r=hd,i=t,[4,gd(e,t,"diffCache")];case 2:return r[i]=c.sent(),console.log("Restored diff cache from db: ".concat(null===(n=hd[t])||void 0===n?void 0:n.length)),s=ld,o=t,[4,gd(e,t,"scanCache")];case 3:return s[o]=c.sent(),console.log("Restored scan cache from db: ".concat(ld[t].length)),console.log("Done restores."),[3,5];case 4:return Id(a=c.sent()),console.error(a),[3,5];case 5:return[2]}}))}))}function wd(e,t){var n=NeptunesPride.gameNumber;Xh(Wl(yd,"newkey"),t?{game_id:n,api_key:e,notifications:t}:{game_id:n,api_key:e})}function bd(e){for(var t,n=ld[e].length,r=n-1;r>=0&&void 0===(null===(t=xd(e,r))||void 0===t?void 0:t.tick);)r--;r+1<n&&(r++,ld[e]=ld[e].slice(0,r),console.log("trimInvalidEntries: ".concat(e," ").concat(n," -> ").concat(r)),r>0&&(ld[e][r-1].eof=!0))}function _d(e){var t,n,r;return id(this,void 0,void 0,(function(){var i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,w,b;return sd(this,(function(_){switch(_.label){case 0:return void 0!==ld[e]?(console.log("Already watching ".concat(e)),[2]):[4,vd(i=NeptunesPride.gameNumber,e)];case 1:if(_.sent(),s=(null===(t=ld[e])||void 0===t?void 0:t.length)||0,console.log("Fetched ".concat(s," entries from ").concat(e)),o=0,s>0){for(a=function(t){var n=ld[e][t];return 0===t?(void 0!==n.apis||void 0!==n.cached)&&n.forward:!(!n.apis&&!n.error)||!(!n.cached||!n.back)||n.back&&n.forward},c=0,c=0;c<s&&a(c);++c);if((c-=1)>=0){if(c<s-1)console.error("Valid entries ".concat(c,"/").concat(s," for ").concat(e)),ld[e]=ld[e].slice(0,c+1);else if(console.log("All valid entries ".concat(c,"/").concat(s," for ").concat(e)),s>0){for(ld[e][0].apis||ld[e][0].cached?console.log("Valid: 0th entry has an apis or cached state",ld[e][0]):console.error("Invalid: 0th entry missing an apis string",ld[e][0]),console.log("Validating ".concat(s," entries...")),u="",l={},s>0&&(u=ld[e][0].apis,l=ld[e][0].cached),h=!1,d=-1,g=0;g<s;++g)g>0&&(ld[e][g].prev=ld[e][g-1]),(m=xd(e,g))&&void 0!==(null==m?void 0:m.tick)?h&&console.error("Invalid: found good scan data @ index ".concat(g," for ").concat(e," after endOfKeyData @ ").concat(d)):ld[e][g].error?h||(h=!0,d=g,console.log("Valid: End of ".concat(e," @ ").concat(d))):console.error("Invalid: cannot find good scan data @ index ".concat(g," for ").concat(e));for(console.log("Validated ".concat(s," entries for ").concat(e)),console.log("Reverse validating ".concat(e,"...")),f=-1,p=-1,g=d>=0?d:s-1;g>=0;--g)g<s&&(ld[e][g].next=ld[e][g+1]),(m=xd(e,g))&&void 0!==(null==m?void 0:m.tick)?m.tick>f&&(f=m.tick):console.error("Invalid: cannot find good scan data @ index ".concat(g," for ").concat(e)),0===g&&(p=null==m?void 0:m.tick,ud[e]={puid:m.player_uid,firstTick:p,lastTick:f},null!==td(void 0!==l?l:JSON.parse(u),m)?(Id("error_invalidindex_".concat(g,"_").concat(i,":").concat(e)),console.error("Invalid: index ".concat(g," doesn't match ").concat(u))):console.log("Valid: index ".concat(g," matches!")))}o=ld[e][c].timestamp}else console.error("No valid entries found for ".concat(e)),ld[e]=[]}else ld[e]=[];return y=[],ld[e].forEach((function(t,n){t.apis&&Ed(t);var r=n-1;if(r>=0&&void 0===t.error&&void 0===t.back){var i=ld[e][r].cached;Td(ld[e][r],t),i!==ld[e][r].cached&&y.push(ld[e][r])}r>=0&&void 0===t.prev&&(t.prev=ld[e][r],ld[e][r].next=t)})),y.length&&(console.log("Storing ".concat(y.length," freshly computed diffs")),pd(y,i,e,"scanCache")),console.log("getServerScans: ".concat(o," ").concat(e," ").concat(s)),bd(e),v="scandiffblocks/".concat(i,"/").concat(e),w=(null===(r=null===(n=hd[e])||void 0===n?void 0:n.slice(-1)[0])||void 0===r?void 0:r.timestamp)||0,console.log("Reading diff database for ".concat(i,":").concat(e," from time ").concat(w)),Yh(Dh(Wl(yd,v),Rh("last_timestamp",">",w),Fh("last_timestamp")),(function(t){var n=t.docChanges();n.forEach((function(e,t){var n=e.doc,r=n.data(),i=Math.round(JSON.stringify(n.data()).length/1024);console.log("Block ".concat(t,": "),{i:t,last_timestamp:r.last_timestamp,diffTimestamp:w,truth:r.last_timestamp>w,startTick:JSON.parse(r.initial_scan).scanning_data.tick,size:i})})),n.forEach((function(t,n){var r,s,o,a;console.log("Processing block #".concat(n," for ").concat(e));var c=t.doc.data(),u={};null===(r=hd[e])||void 0===r||r.forEach((function(e){return u[e.timestamp]=!0}));var l=Object.keys(c).map((function(e){return+e})).sort(),h=Object.keys(c).filter((function(e){return!u[e]&&+e})).map((function(e){return+e})).sort();console.log("Missing count: ".concat(h.length," vs ").concat(l.length));for(var d=0,f=0;d<h.length&&f<l.length;)h[d]!==l[f]?h[d]<l[f]?(console.error("impossible skip on missing ".concat(d)),d++):h[d]>l[f]?(f++,console.log("skip all @ ".concat(f))):console.error("not reached"):(d++,f++);console.log("remaining in missing: ".concat(h.length-d)),console.log("remaining in all: ".concat(l.length-f));for(var p=h[0]||0,g=(null===(s=hd[e])||void 0===s?void 0:s.length)-1,m=(null===(o=hd[e][g])||void 0===o?void 0:o.timestamp)||0;g>0&&hd[e][g].timestamp>p;)g--,console.error("Discarding gap-making diff @ ".concat(g));++g!==(null===(a=hd[e])||void 0===a?void 0:a.length)&&(console.error("After discarding gap-making diff len ".concat(hd[e].length," => ").concat(g)),hd[e]=hd[e].slice(0,g));var y=Object.keys(c).filter((function(e){return+e>m})).map((function(e){return+e})).sort();console.log("Timestamp count ".concat(y.length," vs missing ").concat(h.length));var v=hd[e]?hd[e].length:0;if(void 0===hd[e]||0===hd[e].length){var w=JSON.parse(c.initial_scan).scanning_data;hd[e]=[{cached:w,timestamp:(null==c?void 0:c.initial_timestamp)||w.start_time}]}y.forEach((function(t,n){if(1!==hd[e].length||0!==n){for(var r=JSON.parse(c[t]).scanning_data,s=hd[e].length-1,o=s,a=!1;ld[e].length>s;){var u=ld[e][s+1];if(t<=u.timestamp)break;console.log("last ".concat(s," < len ").concat(ld[e].length)),console.log("Timestamp index ".concat(n," @ ").concat(t," after ").concat(u.timestamp)),a=!0,s++}a&&(console.error("Patched hole of size ".concat(s-o)),Id("error_patch_holesize_".concat(s-o)));var l=rd(rd({},hd[e][s]),{forward:r});hd[e][s]=l;var h=ld[e][s];l.timestamp!==h.timestamp&&(Id("error_inproc_ts_".concat(i,":").concat(e)),console.error("inproc TS mismatch for ".concat(e,":").concat(s,": ").concat(l.timestamp," vs ").concat(h.timestamp),l,h)),l.forward&&null!==td(l.forward,h.forward)&&(Id("error_inproc_forward_".concat(i,":").concat(e)),console.error("inproc Index ".concat(e,":").concat(s," doesn't match on forward"),{df:l.forward,sf:h.forward}));var d=cd(window.structuredClone(hd[e][s].cached),r),f=td(d,hd[e][s].cached);hd[e].push({cached:d,back:f,timestamp:t}),s>0&&(hd[e][s].cached=void 0)}else console.log("Skip initial {} -> state patch")})),pd(hd[e].slice(Math.max(v-1,0)),i,e,"diffCache"),console.log("Diff update received: ",t,hd,ld),function(e,t){var n;function r(e,t){var n=td(e,t);return null===n||JSON.stringify(e)!=JSON.stringify(t)?n:null}console.log("Validating diff cache for ".concat(t,"...")),null===(n=hd[t])||void 0===n||n.forEach((function(n,i){return function(n,i,s){var o=ld[t][i];if(void 0!==n)if(void 0!==o){if(n.timestamp!==o.timestamp&&(0===i?console.log("Expected Timestamp mismatch for ".concat(i,": ").concat(n.timestamp," vs ").concat(o.timestamp),n,o):("error_timestamps_".concat(e,":").concat(t,"_").concat(i,"_").concat(n.timestamp,"_v_").concat(o.timestamp),console.error("Timestamp mismatch for ".concat(i,": ").concat(n.timestamp," vs ").concat(o.timestamp),n,o))),n.forward&&null!==(a=r(n.forward,o.forward))&&("error_forward_".concat(e,":").concat(t),console.error("Index ".concat(i," doesn't match on forward"),{nullDiff:a,df:n.forward,sf:o.forward})),n.back&&null!==(a=r(n.back,o.back))&&("error_back_".concat(e,":").concat(t),console.error("Index ".concat(i," doesn't match on back"),a,n.back,o.back)),n.cached){var a,c=o.cached;if(void 0===c){c=window.structuredClone(ld[t][0].cached);for(var u=0;u<i;++u)c=cd(c,ld[t][u].forward)}null!==(a=r(n.cached,c))?("error_cached_".concat(e,":").concat(t),console.error("Index ".concat(i," doesn't match on cached or computed "),a)):console.log("Index ".concat(i," matches on cached!"))}}else console.error("Missing scanCacheEntry for ".concat(t,":").concat(i));else console.error("Missing entry for ".concat(t,":").concat(i))}(n,i)})),console.log("Validating diff cache for ".concat(t,"...completed"))}(i,e)}))}),(function(t){Id("error_scandiffs_query_".concat(i,":").concat(e," ").concat(t)),console.log("scandiffs query ".concat(v," failing: ")),console.error(t)})),b="scans/".concat(i,"/").concat(i,":").concat(e),[2,Yh(Dh(Wl(yd,b),Rh("timestamp",">",o),Fh("timestamp")),(function(t){var n=[];t.docChanges().forEach((function(t){if("added"===t.type||"modified"===t.type&&t.doc){var r=t.doc.data();Ed(r);var s=n.length-1;if(n.push(r),s>=0&&void 0===r.error)Td(n[s],r);else if(-1===s&&void 0===r.error){var o=ld[e].length-1;o>=0&&(Td(ld[e][o],r),pd(ld[e].slice(-1),i,e,"scanCache"))}}})),pd(n,i,e,"scanCache"),console.log("Added ".concat(n.length," scans for ").concat(i,":").concat(e)),ld[e]=ld[e].concat(n),bd(e)}),(function(t){Id("scans query ".concat(i,":").concat(e," failing: ").concat(t)),console.log("scans query ".concat(i,":").concat(e," failing: ")),console.error(t)}))]}}))}))}function Td(e,t){var n=Ed(e),r=Ed(t),i=td(n,r),s=td(r,n);t.prev=e,e.next=t,t.back=s,e.forward=i,void 0!==e.back&&(e.cached=void 0)}function Ed(e){var t,n;if(void 0===e.cached&&void 0===e.error)if(void 0!==e.apis){var r=JSON.parse(e.apis);r.error&&(e.error=r.error),e.cached=JSON.parse(e.apis).scanning_data,e.apis=void 0}else if(null===(t=null==e?void 0:e.next)||void 0===t?void 0:t.cached){var i=e.next.cached;e.next.next?e.next.cached=void 0:i=window.structuredClone(i),void 0===e.next.back&&(Id("error_undefined_back__old"),console.error("Patching with undefined back")),e.cached=cd(i,e.next.back)}else(null===(n=null==e?void 0:e.prev)||void 0===n?void 0:n.cached)?(i=e.prev.cached,e.prev.prev?e.prev.cached=void 0:i=window.structuredClone(i),void 0===e.prev.forward&&(Id("error_undefined_forward_old"),console.error("Patching with undefined forward")),e.cached=cd(i,e.prev.forward)):(Id("error_multijump_old"),console.error("multi jump NIY"));return void 0===e.cached&&void 0===e.error&&console.error("parseScans returning undefined for",e),e.cached}var kd={};function xd(e,t){return Ed(ld[e][t])}function Sd(e,t){var n=Ed(ld[e][t]);try{if(hd[e])if(hd[e].length>t){var r=function(e,t){var n=kd[e]||0;if(kd[e]=t,hd[e][t].cached)return hd[e][t].cached;for(;t>n;){var r=hd[e][n].cached,i=hd[e][n].forward;0===n?r=window.structuredClone(r):hd[e][n].cached=void 0,i||(console.error("Patching with undefined forward"),Id("error_undefined_forward")),hd[e][++n].cached=cd(r,i)}for(;t<n;){r=hd[e][n].cached;var s=hd[e][n].back;n===hd[e].length-1?r=window.structuredClone(r):hd[e][n].cached=void 0,s||(console.error("Patching with undefined back"),Id("error_undefined_back")),hd[e][--n].cached=cd(r,s)}return hd[e][t].cached}(e,t);if(null!==td(n,r)){if(console.error("getScan return values won't match ".concat(n.tick," vs ").concat(r.tick),n,r),Id("getScan_failure_api_".concat(e)),void 0===n)return console.error("getScan returning newRet"),r}else console.log("Success on ".concat(e," @ ").concat(t,"!"))}else console.error("Position ".concat(t," is off the end of diffCache ").concat(hd[e].length));else Id("error_missing_diffcache_".concat(e)),console.error("No diffcache yet fetching ".concat(e," @ ").concat(t))}catch(e){console.error(e),Id(e)}return n}function Nd(e){var n,r,i,s,o,a=NeptunesPride.gameNumber||NeptunesPride.gameId,c=Wl(yd,"error"),u=(null===(n=null==e?void 0:e.error)||void 0===n?void 0:n.stack)||(null===(r=null==e?void 0:e.reason)||void 0===r?void 0:r.stack)||"no stack trace",l=(null===(i=null==e?void 0:e.error)||void 0===i?void 0:i.message)||(null===(s=null==e?void 0:e.reason)||void 0===s?void 0:s.message)||(null===(o=null==e?void 0:e.reason)||void 0===o?void 0:o.code)||"no message",h=t(),d=(new Date).getTime();"no stack trace"===u?(console.error("No stack",e),Id("".concat(l)),Id("".concat(l,":").concat(JSON.stringify(e)))):Xh(c,{gameid:a,stack:u,message:l,version:h,timestamp:d}).catch((function(e){console.error("Failed to write error for game ".concat(a))}))}function Id(e){var n=Ql(Wl(yd,"info"),"counters"),r={},i=t(),s=i.match(/v[0-9]\.[^ ]*/)+(-1!==i.indexOf("⚠")?"-dev":""),o="".concat(s,"_").concat(e);console.log("INCREMENT ".concat(o)),r[o]=new yh("increment",1),function(e,t,n){e=jl(e,Kl);const r=jl(e.firestore,rh),i=$h(e.converter,t,n);return Jh(r,[mh(gh(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,ma.none())])}(n,r,{merge:!0}).catch((function(e){console.error("Error trying to increment ".concat(o),{e:e,d:n,data:r})}))}function Cd(e,t){return function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))}(this,void 0,void 0,(function(){var n;return function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}(this,(function(r){switch(r.label){case 0:return[4,fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},redirect:"follow",referrerPolicy:"no-referrer",body:new URLSearchParams(t).toString()})];case 1:return n=r.sent(),Id(e),[2,n.json()]}}))}))}var Ad=function(){return Ad=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Ad.apply(this,arguments)},Pd=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},Dd=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},Md=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},Rd={game_event:[],game_diplomacy:[]},Od={};function Ld(e){return"".concat(NeptunesPride.gameNumber,":").concat(e)}function Fd(e,t){return Pd(this,void 0,void 0,(function(){var n,r,i=this;return Dd(this,(function(s){switch(s.label){case 0:return[4,E(Ld(t),1,{upgrade:function(e){e.createObjectStore(t,{keyPath:"key"}).createIndex("date","date",{unique:!1})}})];case 1:return n=s.sent(),r=n.transaction(t,"readwrite"),[4,Promise.all(Md(Md([],e.map((function(e){return 0===(null==e?void 0:e.comment_count)?r.store.add(e):r.store.put(e).then((function(){return Pd(i,void 0,void 0,(function(){var t,n,r;return Dd(this,(function(i){return e.comment_count&&("read"===e.status?void 0===(null===(n=Rd[e.key])||void 0===n?void 0:n.length)?Kd(e.comment_count,e.key):(t=Rd[e.key].length,Kd(e.comment_count-t+1,e.key)):console.log("Avoid caching comments for ".concat(e.key," since it is unread: ").concat(null===(r=null==e?void 0:e.payload)||void 0===r?void 0:r.subject))),[2]}))}))}))})),!0),[r.done],!1))];case 2:return s.sent(),[2]}}))}))}function Vd(e){return Pd(this,void 0,void 0,(function(){return Dd(this,(function(t){switch(t.label){case 0:return[4,E(Ld(e),1,{upgrade:function(t){t.createObjectStore(e,{keyPath:"key"}).createIndex("date","date",{unique:!1})}})];case 1:return[2,t.sent().getAllFromIndex(e,"date")]}}))}))}function Ud(e,t){t.forEach((function(t){var n,r;(t.body||(null===(n=t.payload)||void 0===n?void 0:n.body))&&(t.body||(null===(r=t.payload)||void 0===r?void 0:r.body)).split(/[^\w\d]+/).forEach((function(n){n&&(void 0===Od[n]&&(Od[n]=[]),Od[n].push({group:e,message:t}))}))}))}function Bd(e){var t;return Pd(this,void 0,void 0,(function(){var n,r,i;return Dd(this,(function(s){switch(s.label){case 0:if(void 0===(null===(t=Rd[e])||void 0===t?void 0:t.length)&&(Rd[e]=[]),0!==Rd[e].length)return[3,4];s.label=1;case 1:return s.trys.push([1,3,,4]),n=Rd,r=e,[4,Vd(e)];case 2:return n[r]=s.sent(),Ud(e,Rd[e]),console.log("Restored message cache for ".concat(e," from db: ").concat(Rd[e].length)),"game_diplomacy"===e&&(Id("loading_diplomacy_from_db"),Rd[e].forEach((function(e){return Bd(e.key)}))),[3,4];case 3:return i=s.sent(),console.error(i),[3,4];case 4:return[2]}}))}))}function jd(e,t){return Pd(this,void 0,void 0,(function(){var n,r,i,s,o,a,c,u,l,h,d,f,p,g;return Dd(this,(function(m){switch(m.label){case 0:return void 0===(n=t.report.messages)?(Id("incoming_undefined"),Id(JSON.stringify(t.report)),[2,!1]):(n=n.map((function(e){return Ad(Ad({},e),{date:-Date.parse((null==e?void 0:e.activity)||e.created)})})),[4,Bd(e)]);case 1:if(m.sent(),Rd[e].length>0){for(r=-1,i=0,s=Rd[e].length,o=Rd[e][i],a=function(t){var a=n[t];if(a.key===o.key){i++;var u=t;if(function(e,t){if("game_event"!==e.group&&(null==e?void 0:e.status)&&e.status!==(null==t?void 0:t.status))return Id("status_changed_from_".concat(e.status,"_to_").concat(t.status)),!1;var n=(null==e?void 0:e.comment_count)===(null==t?void 0:t.comment_count);return Id("isUnchanged_".concat(n)),n}(a,o)||i>=s){var l={};for(Rd[e].forEach((function(e){return l[e.key]=!0}));t>0&&n[t-1].created===a.created;){var h=n[t-1];if(!l[h.key])break;t--,Id("decrement_i_".concat(u-t))}r=t;for(var d=!0,f=t;f<n.length;++f)d&&(d=l[n[f].key]);Id("overlaps_found_".concat(d));var p=!1;for(f=0;f<t;++f)p||(p=!0===l[n[f].key]);return Id("collisions_found_".concat(p)),c=t,"break"}Rd[e]=Rd[e].slice(1),o=Rd[e][0],t=0}c=t},u=0;u<n.length&&(l=a(u),u=c,"break"!==l);++u);if(n.length>Rd[e].length&&(Id("would_force_restore"),console.log("Incoming messages forced restore: ".concat(n.length)),h={},Rd[e].forEach((function(e){h[e.key]=!0})),d=[],n.forEach((function(e,t){h[e.key]||d.push(e)})),console.log("Forcibly adding ".concat(d.length," missing keys")),Id("Force store ".concat(d.length)),Fd(d,e),Rd[e]=d.concat(Rd[e]),Id("Force messageCache len ".concat(Rd[e].length))),r>=0)console.log("Incoming messages total: ".concat(n.length)),n=n.slice(0,r),console.log("Incoming messages new: ".concat(n.length)),"game_diplomacy"===e&&(f=n.map((function(e){return e.key})),p=[],Rd[e].forEach((function(e,t){-1!==f.indexOf(e.key)&&p.push(t)})),p=p.reverse(),console.log("Removing ".concat(p.length," old messages")),p.forEach((function(t){return Rd[e].splice(t,1)})));else if(r<0)return(g=2*n.length)>4096||g<=0?(Id("invalid_size_".concat(g)),[2,!1]):(console.log("Missing some events for ".concat(e,", double fetch to ").concat(g)),"game_event"===e||"game_diplomacy"===e?(Id("recursive_rrm"),[2,Hd(g,e)]):(Id("call_rmc"),[2,Kd(g,e)]))}try{Id("prestore"),Fd(n,e),Id("poststore"),Ud(e,n),Rd[e]=n.concat(Rd[e]),Id("postcache"),console.log("Return full message set for ".concat(e," of ").concat(Rd[e].length))}catch(e){Id("ERROR ".concat(e)),console.error(e)}return[2,!0]}}))}))}function qd(){return""===NeptunesPride.gameVersion&&"NP4"===NeptunesPride.templates.NP4}var $d=function(){return qd()?"game_api":"proteus"!==NeptunesPride.gameVersion?"trequest_osric":"prequest"};function Hd(e,t){return Pd(this,void 0,void 0,(function(){var n,r,i,s;return Dd(this,(function(o){switch(o.label){case 0:return qd()?(console.error("requestRecentMessages NIY for NP4"),[2]):(console.log("requestRecentMessages"),n="/".concat($d(),"/fetch_game_messages"),Id("requestRecentMessages ".concat(e," ").concat(t)),r={type:"fetch_game_messages",count:Rd[t].length>0?e:1e5,offset:0,group:t,version:NeptunesPride.version,game_number:NeptunesPride.gameNumber},Id(t),i=jd,s=[t],[4,Cd(n,r)]);case 1:return[2,i.apply(void 0,s.concat([o.sent()]))]}}))}))}function Kd(e,t){return Pd(this,void 0,void 0,(function(){var n,r,i,s;return Dd(this,(function(o){switch(o.label){case 0:return console.log("reqeustMessageComments ".concat(e," for ").concat(t)),n="/".concat($d(),"/fetch_game_message_comments"),r={type:"fetch_game_message_comments",count:e,offset:0,message_key:t,version:NeptunesPride.version,game_number:NeptunesPride.gameNumber},i=jd,s=[t],[4,Cd(n,r)];case 1:return[2,i.apply(void 0,s.concat([o.sent()]))]}}))}))}var Gd={game_event:0,game_diplomacy:0};function zd(e){return Pd(this,void 0,void 0,(function(){var t;return Dd(this,(function(n){return(t=(new Date).getTime())-Gd[e]<1e4?[2,!0]:(Gd[e]=t,console.log("updateMessageCache"),[2,Hd(4,e)])}))}))}function Wd(e){return Pd(this,void 0,void 0,(function(){return Dd(this,(function(t){switch(t.label){case 0:return[4,zd("game_event")];case 1:return t.sent(),[2,Rd.game_event.filter((function(t){return e<-t.date})).length>0]}}))}))}var Qd,Xd=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},Yd=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},Jd=function(){function e(e){this.properties=[],this.storename=e,this.dbPromise=E(e,1,{upgrade:function(t){t.createObjectStore(e)}})}return e.prototype.get=function(e){return Xd(this,void 0,void 0,(function(){return Yd(this,(function(t){switch(t.label){case 0:return[4,this.dbPromise];case 1:return[2,t.sent().get(this.storename,e)]}}))}))},e.prototype.set=function(e,t){return Xd(this,void 0,void 0,(function(){return Yd(this,(function(n){switch(n.label){case 0:return[4,this.dbPromise];case 1:return[2,n.sent().put(this.storename,t,e)]}}))}))},e.prototype.del=function(e){return Xd(this,void 0,void 0,(function(){return Yd(this,(function(t){switch(t.label){case 0:return[4,this.dbPromise];case 1:return[2,t.sent().delete(this.storename,e)]}}))}))},e.prototype.clear=function(){return Xd(this,void 0,void 0,(function(){return Yd(this,(function(e){switch(e.label){case 0:return[4,this.dbPromise];case 1:return[2,e.sent().clear(this.storename)]}}))}))},e.prototype.keys=function(){return Xd(this,void 0,void 0,(function(){return Yd(this,(function(e){switch(e.label){case 0:return[4,this.dbPromise];case 1:return[2,e.sent().getAllKeys(this.storename)]}}))}))},e.prototype.newSetting=function(e,t,n,r){var i=null;this.get(t).then((function(e){i=void 0!==e?e:n}));var s={get:function(){return null===i&&console.error("Getter retuning ".concat(i," for ").concat(t)),i},set:function(e){return i=e,this.set(t,e),i}};Object.defineProperty(this,t,s),this.properties.push({name:t,displayName:e,type:typeof n,allowableValues:r})},e.prototype.getProperties=function(){return this.properties},e}(),Zd=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},ef=null,tf={},nf=function(e,t){var n=+e.x-+t.x,r=+e.y-+t.y;return n*n+r*r};function rf(e,t,n,r){r===ef&&void 0!==tf[n.uid]||(function(e){var t=Object.keys(e.stars).map((function(t){return e.stars[t]})),n=Zd([],t,!0);t.forEach((function(e){var t=Zd([],n.sort((function(t,n){return nf(e,n)-nf(e,t)})),!0).reverse();tf[e.uid]=t}))}(r),ef=r);for(var i=t*t,s=tf[n.uid],o=0;s&&o<s.length;++o){var a=s[o];if(a.puid===e)return nf(a,n)<=i}return!1}function sf(e,t){if(qd()){var n=e.tech;return"scanning"===t&&NeptunesPride.universe.galaxy.config.noScn?sf(e,"propulsion"):n[NeptunesPride.universe.techNames.indexOf(t)]}return e.tech[t]}function of(e){return qd()?NeptunesPride.universe.calcScanValue(e):e.tech.scanning.value}function af(e,t){return NeptunesPride.universe.distance(e.x,e.y,t.x,t.y)}function cf(e){return qd()?e.level*e.cost:"proteus"!==NeptunesPride.gameVersion?e.brr*e.level:e.brr*e.level*e.level*e.level}function uf(e,t){for(var n=function(e){var n="".concat(e.replace(/[A-Z]/g,"_$&").toLowerCase());e!==n&&Object.defineProperty(t,n,{get:function(){return this[e]},set:function(t){return this[e]=t}})},r=0,i=Object.getOwnPropertyNames(t);r<i.length;r++)n(i[r])}!function(e){e[e.Nothing=0]="Nothing",e[e.CollectAll=1]="CollectAll",e[e.DropAll=2]="DropAll",e[e.Collect=3]="Collect",e[e.Drop=4]="Drop",e[e.CollectAllBut=5]="CollectAllBut",e[e.DropAllBut=6]="DropAllBut",e[e.Garrison=7]="Garrison"}(Qd||(Qd={}));var lf=function(e){var t=e.toLowerCase();return function(e){return-1!==e.indexOf(t)}},hf=function(e,t){return function(n){return e(n)||t(n)}},df=function(){function e(e,t){this.c=t,this.a=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}([],e,!0);for(var n=this.parent(this.a.length);n>=0;--n)this.heapify(n)}return e.prototype.size=function(){return this.a.length},e.prototype.peek=function(){return this.a[0]},e.prototype.extract=function(){var e=this.a[0],t=this.a.splice(-1)[0];return this.size()>0&&(this.a[0]=t,this.heapify(0)),e},e.prototype.parent=function(e){return Math.floor(e-1>>1)},e.prototype.left=function(e){return 1+(e<<1)},e.prototype.right=function(e){return 2+(e<<1)},e.prototype.heapify=function(e){var t=this.left(e),n=this.right(e),r=this.c,i=this.a,s=e;if(void 0!==i[t]&&r(i[s],i[t])<=0&&(s=t),void 0!==i[n]&&r(i[s],i[n])<=0&&(s=n),s!==e){var o=i[e];i[e]=i[s],i[s]=o,this.heapify(s)}},e}(),ff=function(e){return e.split(/[^\w]/)[3]},pf=function(){function e(e){this.apikey=ff(e),dd(this.apikey)>0?(this.currentScanRecord=ld[this.apikey][0],this.currentScanData=ed(this.currentScanRecord.cached)):this.currentScanRecord=void 0}return e.prototype.getScanRecord=function(){return this.currentScanRecord},e.prototype.getScanData=function(){return this.currentScanData},e.prototype.hasNext=function(){var e;return void 0!==(null===(e=this.currentScanRecord)||void 0===e?void 0:e.next)},e.prototype.next=function(){var e,t,n=nd(this.currentScanData,null===(e=this.currentScanRecord)||void 0===e?void 0:e.forward);this.currentScanData=n,this.currentScanRecord=null===(t=this.currentScanRecord)||void 0===t?void 0:t.next},e.prototype.timestamp=function(){var e;return null===(e=this.currentScanRecord)||void 0===e?void 0:e.timestamp},e}(),gf=function(){function e(e,t){var n=e.map((function(e){return new pf(e)})).filter((function(e){return e.hasNext()}));for(this.scanIteratorHeap=new df(n,(function(e,n){var r=e.getScanData(),i=n.getScanData();if(void 0===r)return r;if(void 0===i)return i;var s=0;return t===i.player_uid?s=.5:t===r.player_uid&&(s=-.5),i.tick-r.tick-s}));void 0===this.getScanData()&&this.scanIteratorHeap.size();)this.scanIteratorHeap.extract()}return e.prototype.getScanRecord=function(){var e;return null===(e=this.scanIteratorHeap.peek())||void 0===e?void 0:e.getScanRecord()},e.prototype.getScanData=function(){var e;return null===(e=this.scanIteratorHeap.peek())||void 0===e?void 0:e.getScanData()},e.prototype.hasNext=function(){var e=this.scanIteratorHeap;return e.size()>1||e.size()>0&&e.peek().hasNext()},e.prototype.next=function(){if(this.hasNext()){var e=this.scanIteratorHeap;for(e.peek().next();void 0===this.getScanData()&&e.size()>0;)e.extract();return this.getScanData()}},e.prototype.timestamp=function(){return this.scanIteratorHeap.peek().timestamp()},e}(),mf={knownAlliances:void 0,combatHandicap:0},yf=function(e){return(void 0!==e?e:mf.combatHandicap>0?"Enemy WS":"My WS")+(mf.combatHandicap>0?"+":"")+mf.combatHandicap};function vf(e,t){return e.tick+t}function wf(e){return NeptunesPride.universe.galaxy.tick+e}var bf=function(){for(var e=[],t=0;t<Rd.game_event.length;++t){var n=Rd.game_event[t];if("war_declared"===n.payload.template){var r=n.payload.tick,i=n.payload.attacker,s=n.payload.defender;e.push({tick:r,p0:i,p1:s,war:"war_declared"}),r+=24,e.push({tick:r,p0:i,p1:s,war:"war"})}else"peace_accepted"===n.payload.template&&(r=n.payload.tick,i=n.payload.from_puid,s=n.payload.to_puid,e.push({tick:r,p0:i,p1:s,war:"peace_agreement"}))}return e},_f=function(e,t,n,r){var i,s;if(void 0===mf.knownAlliances&&NeptunesPride.gameConfig.alliances,NeptunesPride.gameConfig.alliances&&r>0)for(var o=bf().sort((function(e,t){return t.tick-e.tick})),a=wf(0),c=wf(r),u=0;u<o.length;++u){var l=o[u];if(l.tick<=a)break;if(!(l.tick>=c)){if(l.p1==t&&l.p0==n&&"war"===l.war)return!1;if(l.p0==t&&l.p1==n&&"war"===l.war)return!1}}var h=e[t],d=e[n],f=(null==h?void 0:h.war)||(null==d?void 0:d.war)||{};return t==n||(!f[t]||!f[n])&&(0==f[t]||0==f[n]||(null===(s=null===(i=mf.knownAlliances)||void 0===i?void 0:i[t])||void 0===s?void 0:s[n]))},Tf={},Ef=function(e){var t=NeptunesPride.universe.galaxy;return xf(t,e)};function kf(e){return sf(e,"weapons").level}var xf=function(e,t,n){var r,i,s,o;console.log("NEW ComputeCombatOutcomes called");var a=e.players,c=e.fleets,u=e.stars,l=[];for(var h in Tf={},c)if((b=c[h]).o&&b.o.length>0){var d=b.o[0][1],f=b.etaFirst;if(void 0!==n&&e.tick+f>n)continue;var p=null===(r=u[d])||void 0===r?void 0:r.n;if(!p)continue;l.push([f,"[[{0}]] [[{1}]] {2} → [[{3}]] [[Tick #{4}]]".format(b.puid,b.n,b.st,p,vf(e,f)),b])}l=l.sort((function(e,t){return e[0]-t[0]}));var g={},m=[],y=[],v=void 0===t?{}:t;for(var w in l){var b=l[w][2];0!==y.length&&y[y.length-1]===l[w][0]||y.push(l[w][0]);var _=[l[w][0],b.o[0][1]].toString();void 0!==g[_]?g[_].push(b):g[_]=[b]}var T=function(t){var n=[],r=g[t],l=t.split(","),h=parseInt(l[0]),d=l[1];if(!v[d]){var f=(A=a[u[d].puid])?kf(A):0,p=u[d],y=f||0;"1"===u[d].v&&(y=Math.max.apply(Math,function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}([y],null==p?void 0:p.alliedDefenders.map((function(e){return kf(a[e])})),!1)));for(var w=p.st,b={},_={},T=p.st,E=0,k=p.fleetsInOrbit;E<k.length;E++)T+=(D=k[E]).st;for(var x=0,S=p.fleetsInOrbit;x<S.length;x++)if((D=S[x]).o.length>0){var N=D.o[0][0];if(N>=h)if(b[D.uid]=D.st,w+=D.st,void 0===_[N-1])_[N-1]={leaving:D.st,origShips:T};else{var I=_[N-1].leaving+D.st;_[N-1]={leaving:I,origShips:T}}}else b[D.uid]=D.st,w+=D.st;v[d]={last_updated:0,ships:w,st:p.st,puid:p.puid,c:p.c||0,departures:_,weapons:y,production:p.shipsPerTick,fleetStrength:b}}if(-1==v[d].puid){var C=1e4,A=-1;for(var P in r){var D=r[P],M=af(u[d],D);(M<C||-1==A)&&(A=D.puid,C=M)}v[d].puid=A}for(var P in r)D=r[P],_f(e.players,D.puid,v[d].puid,0)&&(y=Math.max(v[d].weapons,kf(a[D.puid])),v[d].weapons=y);n.push("[[Tick #{0}]]: [[{1}]] [[{2}]] {3} ships".format(vf(e,h),v[d].puid,u[d].n,v[d].ships));var R=h-v[d].last_updated-1;if(R>0){var O=v[d].ships,L=v[d].last_updated;for(_=v[d].departures,P=L;P<L+R;++P)if(_[P]){var F=O/_[P].origShips,V=Math.ceil(_[P].leaving*F);v[d].ships-=V,n.push("  {0} depart".format(V))}if(v[d].ships<O&&(O=v[d].ships),v[d].last_updated=h-1,v[d].production){var U=v[d].c;v[d].ships+=v[d].production*R+U,v[d].st+=Math.trunc(v[d].production*R+U),v[d].c=v[d].ships-Math.trunc(v[d].ships),v[d].ships-=v[d].c,n.push("  {0}+{3} + {2}/h = {1}+{4}".format(O,v[d].ships,v[d].production,U,v[d].c))}}for(var P in r)if(D=r[P],_f(e.players,D.puid,v[d].puid,0)||-1==v[d].puid){O=v[d].ships,-1==v[d].puid?v[d].ships=D.st:v[d].ships+=D.st,v[d].fleetStrength[D.uid]=D.st;var B="  {0} + {2} on [[{3}]] = {1}".format(O,v[d].ships,D.st,D.n);n.push(B),B=B.substring(2)}for(var P in r)if(D=r[P],_f(e.players,D.puid,v[d].puid,0)){var j="{0} ships on {1}".format(Math.floor(v[d].ships),u[d].n);Tf[D.uid]={eta:"[[Tick #".concat(vf(e,D.etaFirst),"]]"),outcome:j,strength:D.st}}var q=0,$=0;for(var P in r)if(D=r[P],!_f(e.players,D.puid,v[d].puid,0)){var H=$;$+=D.st,n.push("  [[{4}]]! {0} + {2} on [[{3}]] = {1}".format(H,$,D.st,D.n,D.puid)),v[d].fleetStrength[D.uid]=D.st;var K=kf(a[D.puid]);K>q&&(q=K)}for(var G=$,z=v[d].ships;$>0;){var W=v[d].weapons,Q=v[d].ships;for(n.push("  Combat! [[{0}]] defending".format(v[d].puid)),n.push("    Defenders {0} ships, WS {1}".format(Q,W)),n.push("    Attackers {0} ships, WS {1}".format($,q)),"proteus"!==NeptunesPride.gameVersion&&(W+=1),v[d].puid!==e.player_uid?mf.combatHandicap>0?(W+=mf.combatHandicap,n.push("    Defenders WS{0} = {1}".format(yf(""),W))):mf.combatHandicap<0&&(q-=mf.combatHandicap,n.push("    Attackers WS{0} = {1}".format(yf(""),q))):mf.combatHandicap>0?(q+=mf.combatHandicap,n.push("    Attackers WS{0} = {1}".format(yf(""),q))):mf.combatHandicap<0&&(W-=mf.combatHandicap,n.push("    Defenders WS{0} = {1}".format(yf(""),W))),e.player_uid===v[d].puid&&(Q=Math.trunc(Q));Q>0&&$>0&&!(($-=W)<=0);)Q-=q;var X=0,Y={},J=-1,Z=v[d].puid;if($>0){var ee=$;Q+=q-1;do{Q-=q,ee-=W}while(ee>0);n.push("  Attackers win with {0} ships remaining".format($,-Q)),n.push("  +{1} defenders needed to survive".format($,-Q));var te=Object.keys(v[d].fleetStrength).map((function(e){return[e,v[d].fleetStrength[e]]}));te.sort((function(e,t){return t[1]-e[1]}));var ne=0;for(P=0;P<te.length;++P){var re=te[P][0];if(void 0!==(D=c[re]))if(_f(e.players,D.puid,v[d].puid,h))v[d].fleetStrength[D.uid]=0;else{var ie=D.puid;if((ne+=(he=$*v[d].fleetStrength[re]/G)-(de=Math.floor(he)))>0&&(ne-=1,de++),v[d].fleetStrength[re]=de,X+=v[d].fleetStrength[re],Y[ie]?Y[ie]+=v[d].fleetStrength[re]:Y[ie]=v[d].fleetStrength[re],Y[ie]>J&&(J=Y[ie],Z=ie),n.push("    [[{0}]] has {1} on [[{2}]]".format(D.puid,v[d].fleetStrength[re],D.n)),v[d].fleetStrength[re]){var se="";(null===(i=Tf[D.uid])||void 0===i?void 0:i.outcome)&&(se=Tf[D.uid].outcome+"\n"),j="".concat(se,"Wins! {0} land\n+{1} to defend").format(v[d].fleetStrength[re],-Q),Tf[D.uid]={eta:"[[Tick #".concat(vf(e,D.etaFirst),"]]"),outcome:j,strength:v[d].fleetStrength[re]}}}else console.error("Failed to find fleet ".concat(re))}for(var oe in"proteus"===NeptunesPride.gameVersion&&v[d].puid!=Z&&(v[d].c=0,v[d].production=0),v[d].puid=Z,v[d].weapons=kf(a[Z]),v[d].ships=0,v[d].st=0,$=X,v[d].fleetStrength)if(void 0!==(D=c[oe])){var ae=D.puid;if(_f(e.players,Z,ae,h)){$-=v[d].fleetStrength[oe],v[d].ships+=v[d].fleetStrength[oe];var ce=kf(a[ae]),ue=v[d].weapons;v[d].weapons=Math.max(ce,ue)}}else console.error("failed to find fleet ".concat(oe))}else{var le=Q;$+=W-1;do{$-=W,le-=q}while(le>0);for(n.push("  +{0} more attackers needed".format(-$)),v[d].ships=Q,te=Object.keys(v[d].fleetStrength).map((function(e){return[e,v[d].fleetStrength[e]]})),te.push(["star",v[d].st]),te.sort((function(e,t){return t[1]-e[1]})),ne=0,P=0;P<te.length;++P){var he,de,fe=te[P][0],pe="star"!==fe?c[fe]:e.stars[d];void 0!==pe?_f(e.players,pe.puid,v[d].puid,h)?((ne+=(he=Q*("star"===fe?v[d].st:v[d].fleetStrength[fe])/z)-(de=Math.floor(he)))>0&&(ne-=1,de++),"star"===fe?v[d].st=de:v[d].fleetStrength[fe]=de,n.push("    [[{0}]] has {1} on [[{2}]]".format(pe.puid,de,pe.n))):v[d].fleetStrength[pe.uid]=0:console.error("failed to find fleet or star ".concat(fe))}for(var P in r)D=r[P],_f(e.players,D.puid,v[d].puid,h)&&(j="{0} ships on {1}".format(Math.floor(v[d].ships),u[d].n),Tf[D.uid]={eta:"[[Tick #".concat(vf(e,D.etaFirst),"]]"),outcome:j,strength:0});for(var ge in v[d].fleetStrength)void 0!==(D=c[ge])?(se="",(null===(s=Tf[D.uid])||void 0===s?void 0:s.outcome)&&(se=Tf[D.uid].outcome+"\n"),j="".concat(se,"Loses! {0} live\n+{1} to win").format(Q,-$),_f(e.players,null==D?void 0:D.puid,null===(o=v[d])||void 0===o?void 0:o.puid,h)&&(j="".concat(se,"Wins! ").concat(Q," remain")),-1===se.indexOf("Loses")&&(Tf[D.uid]={eta:"[[Tick #".concat(vf(e,D.etaFirst),"]]"),outcome:j,strength:0})):console.error("failed to find fleet ".concat(ge))}G=$}n.push("  [[{0}]] [[{1}]] {2} ships".format(v[d].puid,u[d].n,v[d].ships)),m.push(n)};for(var E in g)T(E);return m},Sf=function(){return Sf=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Sf.apply(this,arguments)},Nf=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};function If(){for(var e=NeptunesPride.universe,t=NeptunesPride.universe.galaxy.players,n=0;n<Rd.game_event.length;++n){var r=Rd.game_event[n].payload;e.galaxy.tick>=r.tick&&r.template.startsWith("goodbye_to_player")&&(t[r.uid].exitTick=r.tick,t[r.uid].modTick=(e.galaxy.tick-r.tick)%4)}var i=["💡","👁","⏳","⏳"];for(var s in e.galaxy.players){var o=e.galaxy.players[s];o.alias=o.rawAlias.split(" ")[0],o.rawAlias=o.alias,1!==o.ai&&1!==o.ready||(o.alias+="".concat(" ").concat(i[o.modTick]," "))}}function Cf(e){return"1"===e.v||1===e.v}var Af=function(){return Af=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Af.apply(this,arguments)},Pf=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},Df=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},Mf=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};!function(){var e,n,r,i,a,d=this;window.addEventListener("error",Nd),window.addEventListener("unhandledrejection",Nd);var f=t(),p=f.replace(/^.*v2/,"v2");console.log(f);var g=new Jd("global_settings");g.newSetting("IBB API Key","ibbApiKey","");var m=["color","shape"];g.newSetting("Alliances by:","allianceDiscriminator",m[0],m);var y=["relative","eta","tickrel","tick"];function v(e,t){var n;(null===(n=null===NeptunesPride||void 0===NeptunesPride?void 0:NeptunesPride.np)||void 0===n?void 0:n.on)?NeptunesPride.np.on(e,t):(console.log("NP not initialied yet, defer trigger for ".concat(e)),window.setTimeout((function(){return v(e,t)}),100))}g.newSetting("Time Base","relativeTimes",y[0],y),g.newSetting("Territory Display","territoryOn",!0,[!0,!1]),g.newSetting("Recolor me","whitePlayer",!1,[!1,!0]),g.newSetting("Territory Style","territoryBrightness",1,[0,1,2,3]),g.newSetting("Auto Ruler Power","autoRulerPower",1),g.newSetting("Custom Colors","customColors","#3b55ce #79fffe #13ca91 #fec763 #ff8b8b #ffaa01 #fea0fe #ce96fb"),String.prototype.format||(String.prototype.format=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.replace(/{(\d+)}/g,(function(t,n){return"number"==typeof e[n]?Math.trunc(1e3*e[n])/1e3:void 0!==e[n]?e[n]:t}))});var w=function(){for(var e=NeptunesPride.universe,t=0;t<64;++t)if(e.hyperlinkedMessageInserts[t]){var n=NeptunesPride.universe.galaxy.players[t];e.hyperlinkedMessageInserts["".concat(t)]=e.hyperlinkedMessageInserts[t]=n.hyperlinkedBox+n.hyperlinkedRawAlias,e.hyperlinkedMessageInserts["#".concat(t)]=n.hyperlinkedBox}},b="planets",_=!1,T=!1,E=null,k=null,x=function(){return NeptunesPride.npui.trigger("show_screen","new_fleet")},S=function(e){NeptunesPride.npui.trigger("show_screen",["new_fleet",Af({kind:"npa_options"},e)])},N=function(e,t,n){var r,i,o;if((null===(r=NeptunesPride.npui.npaMenu)||void 0===r?void 0:r.isShowing)&&x(),_&&E&&e!==E.getValue()&&(E.setValue(e),E.onChange()),null!==k){var a=k.getValue().toLowerCase(),c=hf(lf(a),function(e){var t=NeptunesPride.universe.galaxy.players,n=[];for(var r in t)-1!==t[r].alias.toLowerCase().indexOf(e)&&(n.push(lf("(".concat(r,")"))),n.push(lf("(#".concat(r,")"))));return n.reduce(hf,(function(){return!1}))}(a));a&&(n?(i=n,o=c,n=function(e){return i(e)&&o(e)}):n=c)}b=e,s(function(e,t,n){return e=e.filter((function(e){return!Array.isArray(e)||void 0===t||(void 0!==n&&(e=e.map(n)),e.filter(t).length>0)})),e.flat().join("\n")}(t,n,(function(e){return Crux.format(e,{}).toLowerCase()})))};function I(){var e=NeptunesPride.universe.galaxy.players,t=NeptunesPride.universe.galaxy.stars,n=[];for(var r in e){var i=[];for(var s in i.push(["[[{0}]]".format(r)]),t){var o=t[s];o.puid==r&&o.shipsPerTick>=0&&0!==o.v&&i.push(["  [[#{5}]] [[{0}]] {1}/{2}/{3} {4} ships".format(o.n,o.e,o.i,o.s,o.totalDefenses,r)])}i.length>1&&(n=n.concat(i))}N("stars",n)}function C(){var e,t,n,r,i,s,o,a,c,u,l,h,d=[],f=[],p=NeptunesPride.universe.galaxy.tick,g=Math.max(p-NeptunesPride.gameConfig.productionTicks,1),m=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid;Ce={},d.push("Star ownership changes from [[Tick #".concat(g,"]] to [[Tick #").concat(p,"]]:")),f.push("Exploration report from [[Tick #".concat(g,"]] to [[Tick #").concat(p,"]]:"));for(var y={},v=null,w=new gf(F(),m);w.hasNext()&&g<=p;){w.next();var b=w.getScanData();if(!(b.tick<g)){if(b.tick===g){var _=b.stars;null===v&&(v=ed(_));var T=b.tick;for(var E in _){var k=function(e){return-1!==e&&void 0!==e?"[[".concat(e,"]]"):"Abandoned"},x=function(e){return void 0===e||-1===e};if((null===(e=v[E])||void 0===e?void 0:e.puid)===(null===(t=_[E])||void 0===t?void 0:t.puid)||x(null===(n=v[E])||void 0===n?void 0:n.puid)&&!y[E])(null===(o=v[E])||void 0===o?void 0:o.puid)!==(null===(a=_[E])||void 0===a?void 0:a.puid)&&(I=k(null===(c=_[E])||void 0===c?void 0:c.puid),x(null===(u=_[E])||void 0===u?void 0:u.puid)||f.push("[[Tick #".concat(T,"]]  ").concat(I," [[").concat(_[E].n,"]]")));else{-1===(null===(r=_[E])||void 0===r?void 0:r.puid)&&(y[E]=!0);var S=k(null===(i=v[E])||void 0===i?void 0:i.puid),I=k(null===(s=_[E])||void 0===s?void 0:s.puid);d.push("[[Tick #".concat(T,"]] ").concat(S," →  ").concat(I," [[").concat(_[E].n,"]]"))}(null===(l=v[E])||void 0===l?void 0:l.puid)!==(null===(h=_[E])||void 0===h?void 0:h.puid)&&(v[E]=Af({},_[E]))}}g++}}1===d.length&&1===f.length&&d.push("No API data found"),1===d.length&&(d=f),N("ownership",d.map((function(e){return[e]})))}function A(){var e=[];e.push("Trading Activity:");for(var t=new gf(F()),n=function(){t.next();var n=t.getScanData(),r={},i=null,s={},o=function(e,t){var o;i!==n.stars&&(i=n.stars,s={});var a="".concat(e,"->").concat(t);if(void 0!==s[a])return s[a];var c=parseInt(e),u=parseInt(t),l=of(n.players[c]),h=function(e,t){return e.puid===c&&t.puid===u&&af(e,t)<=l};if(null===(o=null==r?void 0:r[c])||void 0===o?void 0:o[u]){var d=r[c][u],f=d[0],p=d[1];if(h(n.stars[f],m=n.stars[p]))return s[a]=!0,!0}for(var g in n.stars){var m;if((m=n.stars[g]).puid===c)for(var y in n.stars){var v=n.stars[y];if(v.puid===u&&h(m,v))return void 0===r[c]&&(r[c]={}),r[c][u]=[g,y],s[a]=!0,!0}}return s[a]=!1,!1},a=t.getScanRecord();if(void 0!==a.back&&void 0===a.back.tick){var c=a.back.players;for(var u in c){var l=c[u];if(l.tech)for(var h in l.tech){var d=Be(h),f=n.players[u].tech[h].level,p="";for(var g in n.players)g!==u&&n.players[g].tech[h].level>=f&&(He()&&!o(g,u)||(p+=" [[#".concat(g,"]]")));e.push("[[Tick #".concat(n.tick,"]] [[").concat(u,"]] ← ").concat(d).concat(f," from ").concat(p))}}}};t.hasNext();)n();1===e.length&&e.push("No trade activity data found"),N("tradeactivity",e.map((function(e){return[e]})))}function P(){var e=[];e.push("Probable Combat Activity:");for(var t=new gf(F());t.hasNext();){t.next();var n=t.getScanData(),r=t.getScanRecord();if(void 0!==r.back){var i=r.back.players,s="",o=0;for(var a in i){var c=i[a];if(c.total_strength){var u=c.total_strength;n.players[a].total_strength<u&&(s+="[[#".concat(a,"]] "),o++)}}s&&(o<=2&&(s=s.replaceAll("#","").replaceAll("] [","] vs [")),e.push("[[Tick #".concat(n.tick,"]] ").concat(s)))}}1===e.length&&e.push("No combat activity data found"),N("combatactivity",e.map((function(e){return[e]})))}function D(){var e,t=[];if((null==tt?void 0:tt.length)&&"0"!=NeptunesPride.gameConfig.alliances){t.push("Formal Alliances: ");for(var n=tt.map((function(e){return new pf(e)})),r=[],i=0;i<n.length;++i)for(var s=n[i];s.hasNext();){s.next();var o=s.getScanData();if(null==o?void 0:o.fleets)for(var a in o.fleets){var c=o.fleets[a];if(void 0!==(null==c?void 0:c.ouid)){var u=o.stars[c.ouid];if(u){if(u.puid!==c.puid&&-1!==u.puid){r[u.puid]||(r[u.puid]=[]),r[c.puid]||(r[c.puid]=[]);var l=(null===(e=r[u.puid])||void 0===e?void 0:e[c.puid])||1e5,h=Math.min(o.tick,l);r[u.puid][c.puid]=h,r[c.puid][u.puid]=h}}else console.error("Orbit star missing for ".concat(c.n))}}}var d=bf();for(var i in r)for(var f in r[i])if(i<f){var p=+i,g=+f,m=r[i][f];d.push({tick:m,p0:p,p1:g,war:"peace"})}for(d=d.sort((function(e,t){if(e.tick===t.tick){if(e.war<t.war)return-1;if(t.war<e.war)return 1}return e.tick-t.tick})),i=0;i<d.length;++i){var y=d[i],v=(p=y.p0,g=y.p1,y.war),w="&#9774;&#65039;";"war"===v?(void 0!==r[p]&&(r[p][g]=void 0),w="&#129686;"):"war_declared"===v?w="&#9888;&#65039;":"peace_agreement"===v&&(w="&#129309"),t.push("[[Tick #".concat(y.tick,"]] ").concat(w," [[").concat(p,"]] ⇔ [[").concat(g,"]]"))}mf.knownAlliances=r}else"0"!=NeptunesPride.gameConfig.alliances?t.push("No API keys to detect Formal Alliances."):t.push("No formal alliances in this game");N("fa",t.map((function(e){return[e]})))}function M(e,t,n){var r=NeptunesPride.universe,i=e.map((function(e){var t=Af(Af({},e),{originalStar:e,player:r.player,uce:0,uci:0,ucs:0,ucg:0,totaluce:0,totaluci:0,totalucs:0,totalucg:0});if(t.originalStar.uce=t.uce=r.calcUCE(t),t.originalStar.uci=t.uci=r.calcUCI(t),t.originalStar.ucs=t.ucs=r.calcUCS(t),t.originalStar.ucg=t.ucg=r.calcUCG(t),0===t.uce||0===t.uci||0===t.ucs)throw"Cost unset on star ".concat(t.n);return t})),s=function(e,t){return"I"===n?e.uci-t.uci:"S"===n?e.ucs-t.ucs:e.uce-t.uce};"terra"===t&&((i=i.map((function(e){return Af(Af({},e),{r:e.r+5})}))).forEach((function(e){return e.uce=r.calcUCE(e)})),i.forEach((function(e){return e.uci=r.calcUCI(e)})),i.forEach((function(e){return e.ucs=r.calcUCS(e)})),i.forEach((function(e){return e.ucg=r.calcUCG(e)}))),i=i.sort(s);for(var o=0;i[0].uce<=r.player.cash&&0<i.length;)"E"===n&&(i[0].totaluce+=i[0].uce,r.upgradeEconomy(i[0])),"I"===n&&(i[0].totaluci+=i[0].uci,r.upgradeIndustry(i[0])),"S"===n&&(i[0].totalucs+=i[0].ucs,r.upgradeScience(i[0])),o++,i=i.sort(s);return"bank"===t&&(r.player.cash+=75),{count:o,allMyStars:i}}function R(e,t){var n=NeptunesPride.universe,r=n.galaxy,i=Af({},n.player).uid,s=Object.keys(r.stars).map((function(e){return Af({},r.stars[e])})).filter((function(e){return e.puid===i}));return M(s,e,t).count}function O(){var e,t;return Pf(this,void 0,void 0,(function(){var n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,w,b,_,T,E,k,x,S,I,C,A,P,D,O,L,F,V,U,B,j,q,$,H,K,G,z,W,Q,X;return Df(this,(function(Y){switch(Y.label){case 0:return n=[],r=NeptunesPride.universe,i=Af({},r.player),s=i.uid,o=null==i?void 0:i.cash,a=(null==i?void 0:i.cash)||1e3,r.player.cash=a,c=r.player.total_economy,u=r.player.total_industry,l=r.player.total_science,h=function(e,t){r.player.cash=e;var n=R(t,"E");r.player.cash=e;var i=R(t,"I");return r.player.cash=e,{e:n,i:i,s:R(t,"S")}},n.push("--- Economists Report for [[".concat(s,"]] ($").concat(a,") ---")),n.push(":--|--:|--:"),n.push("Technology|New Income (Balance)|Buys one of E/I/S"),d=R("none","E"),r.player.cash,f=10*d,p=10*r.player.total_economy+r.player.cash+75*r.player.tech.banking.level,g=h(p,"none"),m=g.e,y=g.i,v=g.s,n.push(["No Tech|$".concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(v)]),r.player.cash=a,r.player.total_economy=c,d=R("bank","E"),r.player.cash,f=10*d+75,p=10*r.player.total_economy+r.player.cash+75*r.player.tech.banking.level,z=h(p,"bank"),m=z.e,y=z.i,v=z.s,n.push(["Banking|$".concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(v)]),w=qe(r.player.tech.banking.level+1),r.player.cash=a-w,r.player.total_economy=c,d=R("bank","E"),r.player.cash,f=10*d+75,p=10*r.player.total_economy+r.player.cash+75*r.player.tech.banking.level,W=h(p,"bank"),m=W.e,y=W.i,v=W.s,n.push(["Buy it ($".concat(w,")|$").concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(v)]),r.player.cash=a,r.player.total_economy=c,d=R("terra","E"),r.player.cash,f=10*d,p=10*r.player.total_economy+r.player.cash+75*r.player.tech.banking.level,Q=h(p,"terra"),m=Q.e,y=Q.i,v=Q.s,n.push(["Terraforming|$".concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(v)]),b=qe(r.player.tech.terraforming.level+1),r.player.cash=a-b,r.player.total_economy=c,d=R("terra","E"),r.player.cash,f=10*d,p=10*r.player.total_economy+r.player.cash+75*r.player.tech.banking.level,X=h(p,"terra"),m=X.e,y=X.i,v=X.s,n.push(["Buy it ($".concat(b,")|$").concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(v)]),n.push("--- Economists Report for [[".concat(s,"]] (").concat(a,") ---")),r.player.cash=o,[4,Je()];case 1:(_=Y.sent()).players,T=_.apiKeys,E=_.playerIndexes,k=[],Ef(x={}),S=0,I={},C=0,Y.label=2;case 2:return C<E.length?(A=E[C],[4,Te.get(T[C])]):[3,6];case 3:return P=Y.sent(),[4,Xe(P)];case 4:if(D=Y.sent())for(O=D.players[A],I[O.uid]={cash:O.cash,totaluce:0},S+=O.cash,L=0,F=Object.values(D.stars);L<F.length;L++)V=F[L],U=V.puid,void 0!==(null===(e=x[V.uid])||void 0===e?void 0:e.puid)&&U===O.uid&&(U=+(null===(t=x[V.uid])||void 0===t?void 0:t.puid)),U===O.uid&&k.push(V);Y.label=5;case 5:return++C,[3,2];case 6:for($ in r.player.cash=S,B=M(k,"none","E"),j=B.allMyStars,console.log("allMyStars",j,B.count),n.push("--- Communal Transfers ---"),n.push(":--|--:|--:|--:"),n.push("Empire|Current|Needed|Transfer"),j.forEach((function(e){I[e.originalStar.puid].totaluce+=e.totaluce})),q=I[r.player.uid].totaluce,I)H=I[$].cash,K=I[$].totaluce,n.push("[[".concat($,"]]|[[cash:").concat($,":").concat(H,"]]|").concat(K,"|[[transfer:").concat($,":").concat(H,":").concat(K,":").concat(r.player.uid,":").concat(q,"]]"));return n.push("--- Communal Transfers ---"),n.push("--- Communal Economy ---"),n.push(":--|:--|--:|--:|--:"),n.push("P|Star|E|+E|$E"),G=[],j.forEach((function(e){var t=e.e-e.originalStar.e;if(t){e.originalStar;for(var r=0;r<t;r++)G.push(e.uid);n.push(["[[#".concat(e.originalStar.puid,"]]|[[").concat(e.n,"]]|").concat(e.originalStar.e,"|").concat(t,"|").concat(e.totaluce)])}})),n.push("--- Communal Economy ---"),n.push("[[upgrade:e:".concat(G.join(":"),"]]")),console.log("Reset player's cash to ".concat(o)),r.player.cash=o,r.player.total_economy=c,r.player.total_industry=u,r.player.total_science=l,N("economists",n),[2]}}))}))}u("`",x,"Bring up the NP Agent UI.<p>The Agent UI will show you the last report you put on the clipboard or viewed.","Open NPA UI"),u("ctrl+`",S,"Bring up the NP Agent Options.<p>The Agent Options lets you customize advanced settings.<p>In particular, if you want to upload screenshots, get an API key from api.imgbb.com and put it in the settings.","Open Options"),u("ctrl+a",(function(e){NeptunesPride.npui.trigger("show_screen",["new_fleet",Af({kind:"npa_colours"},e)])}),"Configure colours and alliances.<p>You can set the colour of every player in the game to a different value than the default, and if you wish you can use the same colour for multiple players to configure who you think is allied with who in order to get better reports and a map that reflects the alliances in your game.","Colours"),u("*",I,"Generate a report on all stars in your scanning range, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","stars"),u(";",C,"Generate a report changes in star ownership and copy to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","ownership"),u("ctrl+;",A,"Generate a report on all definite trade activity between empires.","tradeactivity"),u("ctrl+'",P,"Generate a report on all probable combat between empires.","combatactivity"),u("ctrl+7",D,"Generate a report of observed Formal Alliance pairs.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","fa"),u("ctrl+4",O,"Your economists are keen to tell you about banking vs terraforming.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","economists");var L=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h;return Df(this,(function(d){switch(d.label){case 0:return b="generals",[4,zd("game_event")];case 1:if(e=d.sent(),t=[],n=[],e){for(o in r={},i={},s={},NeptunesPride.universe.galaxy.players)r[a=o]=0,i[a]=0,s[a]=0;for(n.push("--- Combat history ---"),n.push(":--|:--|:--|--:|--:|--:|--:"),n.push("Tick|[[:star:]]|[[:carrier:]]|Kills|Losses|$|E"),c=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid,u=function(e){var t=Rd.game_event[e];if("combat_mk_ii"===t.payload.template){var o=t.payload.tick,a=t.payload.star.puid,u=t.payload.star.name,l=+t.payload.looter,h=0,d=0,f=0,p=0,g=t.payload.star.puid===c;t.payload.loot>0&&(i[l]+=t.payload.loot,l===c&&(h+=t.payload.loot));var m=function(){var e=0;return Object.keys(t.payload.defenders).forEach((function(n){var i=t.payload.defenders[n].ss-t.payload.defenders[n].es;r[t.payload.defenders[n].puid]+=i,e+=i})),e};g?(d+=t.payload.loot/10,p+=t.payload.star.ss-t.payload.star.es,p+=m()):(f+=t.payload.star.ss-t.payload.star.es,f+=m()),void 0!==t.payload.star.puid&&(r[+t.payload.star.puid]+=t.payload.star.ss=t.payload.star.es),s[+t.payload.star.puid]+=t.payload.loot/10;var y=Object.keys(t.payload.attackers),v={};y.forEach((function(e){var n="[[#".concat(t.payload.attackers[e].puid,"]]");void 0===v[n]&&(v[n]=0),v[n]+=t.payload.attackers[e].ss;var i=t.payload.attackers[e].ss-t.payload.attackers[e].es;r[+t.payload.attackers[e].puid]+=i,g?f+=i:t.payload.attackers[e].puid===c&&(p+=i)}));var w=Object.keys(v).map((function(e){return"".concat(e)})).join("");n.push(["[[Tick #".concat(o,"]]|[[#").concat(a,"]][[").concat(u,"]]|").concat(w,"|").concat(f,"|").concat(p,"|").concat(h,"|").concat(d)])}},l=0;l<Rd.game_event.length;++l)u(l);for(h in n.push("--- Combat history ---"),t.push("--- Combat Summary ---"),t.push(":--|--:|--:"),t.push("Empire|Losses|$|E"),r)t.push(["[[".concat(h,"]]|").concat(r[h],"|").concat(i[h],"|").concat(s[h])]);t.push("--- Combat Summary ---\n")}else console.error("Updating message cache failed"),n.push("Message cache stale!");return N("generals",Mf(Mf([],t,!0),n,!0)),[2]}}))}))};function F(){var e=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid;return tt.filter((function(t){var n;return(null===(n=ud[ff(t)])||void 0===n?void 0:n.puid)===e}))}function V(){var e,t,n=[],r=NeptunesPride.universe.galaxy.tick;n.push("Activity report up to [[Tick #".concat(r,"]]:"));var i={},s=0,o=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid,a=null,c=NeptunesPride.universe.galaxy.players;for(var u in c)i[u]=["--- [[".concat(u,"]] ---")],i[u].push(":--|---|---|---|--:|--:"),i[u].push("Time|E|I|S|Fleets|Stars");var l=(null===(e=NeptunesPride.universe.selectedSpaceObject)||void 0===e?void 0:e.puid)>=0?null===(t=NeptunesPride.universe.selectedSpaceObject)||void 0===t?void 0:t.puid:NeptunesPride.universe.player.uid,h=(new Date).getTime();Ce={};var d=F();do{var f=d.map((function(e){return Pe(s,e,s?"forwards":"back")})).filter((function(e){return e&&e.tick===s}));if(console.log("Got ".concat(f.length," scans for tick #").concat(s),f),f.length>0){var p=f.filter((function(e){return e.player_uid===o})),g=p.length>0?p[0]:f[0],m=Af(Af({},g.players),{tick:g.tick});null===a&&(a=m);var y=function(e,t,n){if(e.total_economy>t.total_economy)return!0;if(e.total_fleets>t.total_fleets)return!0;var r=e.total_stars===t.total_stars||n;return!!(e.total_industry>t.total_industry&&r)||!!(e.total_science>t.total_science&&r)};for(var v in c)y(m[v],a[v],m.tick===a.tick)&&i[v].push("[[Tick #".concat(g.tick,"]]|").concat(m[v].total_economy,"|").concat(m[v].total_industry,"|").concat(m[v].total_science,"|").concat(m[v].total_fleets,"|").concat(m[v].total_stars));a=m}s++}while(s<=r);for(var u in i){if(3===i[u].length&&i[u].push("No activity: AFK?"),i[u].length>15){var w=i[u],b=w.slice(0,3),_=w.length,T=_-5,E=w.slice(T,_);i[u]=Mf(Mf([],b,!0),E,!0)}i[u].push("--- [[".concat(u,"]] ---")),0===c[u].conceded&&l!==u&&n.push(i[u])}var k=(new Date).getTime();n.push("Time required ".concat(k-h,"ms")),N("activity",n)}u("ctrl+w",L,"The generals report summarizes the state of your military operations. Use it to assess how you're faring against your enemies.","generals"),u("shift+;",V,"Generate a report of current player activity.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","activity"),u("x",(function(){var e=NeptunesPride.universe,t=NeptunesPride.npui;if(e.selectedStar&&-1!==e.selectedStar.puid){var n=e.selectedStar;e.player=e.galaxy.players[n.puid];for(var r=100001;e.galaxy.fleets[r];)r++;var i={l:0,lx:n.x,ly:n.y,x:n.x,y:n.y,ouid:n.uid,n:"Fake Enemy Fleet ".concat(r-1e5),o:[],puid:n.puid,st:n.st,uid:r,w:!1};n.st=0,NeptunesPride.np.onNewFleetResponse(null,i)}else if(e.selectedFleet){var s=e.selectedFleet;e.player=e.galaxy.players[s.puid],t.trigger("start_edit_waypoints",{fleet:s})}}),"Set fleet orders for an enemy fleet. These orders won't really happen but you can use them to explore attack or defense options your opponents have. First, select an enemy star, then press x to create and set orders for the fleet. Youcan then also route any other fleets that player controls.","Route Enemy");var U=function(e,t){return t<10&&(t="0".concat(t)),e<12?(0==e&&(e=12),"{0}:{1} AM".format(e,t)):"{0}:{1} PM".format(e>12?e-12:e,t)},B=0,j=function(e){void 0!==e.players[1].shape&&ue&&(ue=ue.map((function(t,n){if(void 0!==e.players[n]){var r=e.players[n].color;return void 0===r||e.players[n].colorStyle?e.players[n].colorStyle||e.players[n].originalColor:ce[r]}return ue[n]}))),void 0!==e.players[1].shape&&le&&(le=le.map((function(t,n){return void 0!==e.players[n]?e.players[n].shape:le[n]}))),null==ue||ue.forEach((function(e,t){if(NeptunesPride.universe.galaxy.players[t]){if(g.whitePlayer&&t===NeptunesPride.universe.player.uid)return;me(t,e)}}))},q=function(e,t){B=t.tick,j(t),Ie=-1};function $(){var e=NeptunesPride.universe.galaxy;return e.tick_rate||e.tickRate}function H(e){var t=void 0!==e?e:NeptunesPride.universe.galaxy;return t.tick_fragment||t.tickFragment}v("order:full_universe",q),void 0!==(null===(n=null===(e=null===NeptunesPride||void 0===NeptunesPride?void 0:NeptunesPride.universe)||void 0===e?void 0:e.galaxy)||void 0===n?void 0:n.tick)&&q(0,NeptunesPride.universe.galaxy);var K=function(e,t){var n=NeptunesPride.universe,r=0,i=H(),s=n.locTimeCorrection;return n.galaxy.paused||(r=(new Date).valueOf()-n.now.valueOf()),(t||n.galaxy.turn_based)&&(r=0,i=0,s=0),1e3*e*60*$()-1e3*i*60*$()-r-s},G=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],z=function(){console.log("rebuild",{showingOurOptions:T,showingOurUI:_}),T&&NeptunesPride.np.trigger("refresh_interface"),NeptunesPride.np.trigger("map_rebuild")};function W(){N("combats",Ef())}function Q(){var e,t=null===(e=NeptunesPride.universe.selectedSpaceObject)||void 0===e?void 0:e.n;void 0===t?N("filteredcombats",["Select a fleet or star."]):(t="(".concat(t,")"),N("filteredcombats",Ef(),lf(t)))}function X(){N("onlycombats",Ef(),lf("Combat!"))}function Y(){var e,t=NeptunesPride.universe.galaxy.fleets,n=NeptunesPride.universe.galaxy.stars,r=[];for(var i in t){var s=t[i];if(s.o&&s.o.length>0){var o=s.o[0][1],a=s.etaFirst;if(!(null===(e=n[o])||void 0===e?void 0:e.n))continue;r.push([a,"[[{0}]] [[{1}]] {2} → [[{3}]] {4}".format(s.puid,s.n,s.st,n[o].n,"[[Tick #".concat(wf(a),"]]"))])}}r=r.sort((function(e,t){return e[0]-t[0]})),N("fleets",r.map((function(e){return[e[1]]})))}u("ctrl+8",(function(){if(g.territoryOn){var e=(g.territoryBrightness-1)%4;e<0&&(e=2),g.territoryBrightness=e,z()}else ge()}),"Adjust territory display style.","- Territory Brightness"),u("ctrl+9",(function(){g.territoryOn?(g.territoryBrightness=(g.territoryBrightness+1)%4,z()):ge()}),"Adjust territory display style.","+ Territory Brightness"),u("8",(function(){var e=g.autoRulerPower-1;e<0&&(e=0),g.autoRulerPower=e,z()}),"Decrease number of distances shown by the auto ruler.","- Rulers"),u("9",(function(){g.autoRulerPower+=1,z()}),"Increase number of distances shown by the auto ruler.","+ Rulers"),u(".",(function(){mf.combatHandicap+=1,NeptunesPride.np.trigger("map_rebuild"),NeptunesPride.np.trigger("refresh_interface")}),"Change combat calculation to credit your enemies with +1 weapons. Useful if you suspect they will have achieved the next level of tech before a battle you are investigating.<p>In the lower left of the HUD, an indicator will appear reminding you of the weapons adjustment. If the indicator already shows an advantage for defenders, this hotkey will reduce that advantage first before crediting weapons to your opponent.","+ Handicap"),u(",",(function(){mf.combatHandicap-=1,NeptunesPride.np.trigger("map_rebuild"),NeptunesPride.np.trigger("refresh_interface")}),"Change combat calculation to credit yourself with +1 weapons. Useful when you will have achieved the next level of tech before a battle you are investigating.<p>In the lower left of the HUD, an indicator will appear reminding you of the weapons adjustment. When indicator already shows an advantage for attackers, this hotkey will reduce that advantage first before crediting weapons to you.","- Handicap"),u("&",W,"Generate a detailed fleet report on all carriers in your scanning range, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","combats"),u("D",Q,"Generate a detailed report on fleet movements involving the selected fleet or star, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","filteredcombats"),u("d",X,"Generate a detailed combat report on all visible combats, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","onlycombats"),u("^",Y,"Generate a summary fleet report on all carriers in your scanning range, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","fleets");var J=function(e,t,n){var r=g.getProperties().filter(t),i=r.length,s=Crux.Widget("rel").size(480,50*i).roost(e);r.forEach((function(t,r){return Pf(d,void 0,void 0,(function(){var i,o,a,c,u,l,h,d;return Df(this,(function(f){return i="npa_".concat(t.name),NeptunesPride.templates[i]=t.displayName,o=(null==n?void 0:n.missingKey)===t.name?"txt_warn_bad":"",Crux.Text(i,"pad12 ".concat(o)).grid(0,3*r,20,3).roost(s),c=(a=g)[t.name],t.allowableValues?(u={},l="0",t.allowableValues.forEach((function(e,t){u[t]=e,e===c&&(l="".concat(t))})),h="setting_change_".concat(t.name),Crux.DropDown(l,u,h).grid(15,3*r,15,3).roost(s),e.on(h,(function(e,n){a[t.name]=u[n],z()}))):((d=Crux.TextInput("single").grid(15,3*r,15,3).roost(s)).setValue(c),d.eventKind="text_entry",e.on(d.eventKind,(function(e,n){d.getValue()!==a[t.name]&&("number"===t.type?a[t.name]=+d.getValue()||a[t.name]:"boolean"===t.type?a[t.name]="true"===d.getValue():a[t.name]=d.getValue(),z())}))),[2]}))}))}))},Z=function(){var e=NeptunesPride.universe.player;s("[[colorscheme:".concat(e.alias," Tick #").concat(B,":").concat(ue.join(" "),":").concat(le.join(" "),"]]")),console.log("clip: ",o())},ee=0,te=0;v("set_colorscheme_api",(function(e,t){var n=null==t?void 0:t.split(":");if(n){var r=n[0],i=n[1];Te.set("colorMap",r),Te.set("shapeMap",i),we()}}));var ne=function(){var e=NeptunesPride.npui.map,t=g.ibbApiKey;if(t){var n=e.canvas[0].toDataURL("image/webp",.45),r=n.indexOf(",")+1,i={expiration:2592e3,key:t,image:n.substring(r)};return fetch("https://api.imgbb.com/1/upload",{method:"POST",redirect:"follow",body:new URLSearchParams(i)}).then((function(e){return e.json().then((function(e){var t;if(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.url)s("[[".concat(e.data.url,"]]"));else{var n="Error: ".concat(JSON.stringify(e));Id(n),s(n)}}))}))}S({missingKey:"ibbApiKey"})};u("#",ne,"Create a data: URL of the current map. Paste it into a browser window to view. This is likely to be removed.","Screenshot");var re=function(){var e=NeptunesPride.universe.galaxy.players,t=[];for(var n in e){var r=e[n].home;r?t.push("Player #{0} is [[{0}]] home {2} [[{1}]]".format(n,r.n,n==r.puid?"is":"was")):t.push("Player #{0} is [[{0}]] home unknown".format(n))}N("planets",t.map((function(e){return[e]})))};u("!",re,"Generate a player summary report and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown. It is most useful for discovering player numbers so that you can write [[#]] to reference a player in mail.","planets"),u("$",(function(){var e=NeptunesPride.universe.galaxy.players,t=[],n=["alias","total_stars","shipsPerTick","total_strength","total_economy","total_fleets","total_industry","total_science"];t.push(n.join(","));var r=function(r){var i=n.map((function(t){return e[r][t]}));t.push(i.join(","))};for(var i in e)r(i);s(t.join("\n"))}),"Generate a player summary mean to be made into a spreadsheet.<p>The clipboard should be pasted into a CSV and then imported.","Summary CSV");var ie=function(e,t,n,r){var i=Crux.format(e,{linkTimes:!1}),s=NeptunesPride.npui.map.context;s.fillStyle=r||"#00ff00",s.fillText(i,t,n)},se=function(e,t,n,r,i){var s=Crux.format(t,{linkTimes:!1});e.fillStyle="#000000";for(var o=1;o<4;++o)e.fillText(s,n+o,r+o),e.fillText(s,n-o,r+o),e.fillText(s,n-o,r-o),e.fillText(s,n+o,r-o);e.fillStyle=i||"#00ff00",e.fillText(s,n,r)},oe=function(e,t){var n=NeptunesPride.universe.galaxy.stars,r=NeptunesPride.universe,i=of(r.galaxy.players[e]);for(var s in n){var o=n[s];if(o.puid==e&&r.distance(o.x,o.y,t.x,t.y)<=i)return!0}return!1},ae=!1,ce=["#0000ff","#009fdf","#40c000","#ffc000","#df5f00","#c00000","#c000c0","#6000c0"],ue=ce.flatMap((function(e){return ce})),le=ue.map((function(e,t){return Math.floor(t/8)})),he=function(){for(var e={},t=0;t<document.styleSheets.length;++t)try{for(var n=document.styleSheets[t].cssRules,r=0;r<n.length;++r)if(n[r].type===CSSRule.STYLE_RULE){var i=n[r];e[i.selectorText]=i}}catch(e){console.log(e)}return e}(),de=void 0;function fe(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,b,_,E;return Df(this,(function(k){switch(k.label){case 0:for(l in e=NeptunesPride.npui.map,void 0===de&&((de=new Image).src=e.starSrc.src),(t=document.createElement("canvas")).width=1024,t.height=576,(n=t.getContext("2d")).drawImage(de,0,0),r=NeptunesPride.universe.galaxy.players){if(b=r[l],s=ue[b.uid],parseInt(l)<8)try{he[".bgpc_".concat(b.uid)].style.backgroundColor=s}catch(e){console.error("Underbar style not found")}(o=document.createElement("canvas")).width=o.height=576,a=o.getContext("2d"),d=void 0!==b.shapeIndex?b.shapeIndex:b.shape,i=64*(d-le[b.uid]),a.drawImage(de,i,0),a.globalCompositeOperation="source-in",a.fillStyle=s,h=b.uid,f=d,p=Math.floor(h%8)+1,void 0!==b.shape&&(f=b.shape,p=b.color+1),g=64*f,m=64*p,a.fillRect(g,m,64,64),n.clearRect(g,m,64,64),n.drawImage(o,0,0)}for(l in r)b=r[l],s=ue[b.uid],(o=document.createElement("canvas")).width=o.height=576,(a=o.getContext("2d")).drawImage(e.starSrc,0,0),a.globalCompositeOperation="source-in",a.fillStyle=s,h=b.uid,d=void 0!==b.shapeIndex?b.shapeIndex:b.shape,c=d,f=8,p=Math.floor(h%8)+1,void 0!==b.shape&&(c=b.shape,p=b.color+1),g=64*f,m=64*p,a.fillRect(g,m,64,64),n.clearRect(g+64*c,m,64,64),n.drawImage(o,64*c,0);return u=NeptunesPride.npui.map.createSpritesStars,NeptunesPride.npui.map.createSpritesStars=function(){u(),NeptunesPride.npui.map.sortedStarSprites.forEach((function(e){if(e.gate&&e.puid>=0){var t=NeptunesPride.universe.galaxy.players[e.puid].shape,n=void 0!==t?t:Math.floor(e.puid/8);e.gate.spriteX=512+64*n}}))},e.starSrc.src=t.toDataURL(),[4,e.starSrc.decode()];case 1:for(l in k.sent(),r)b=r[l],h=b.uid,d=void 0!==b.shapeIndex?b.shapeIndex:b.shape,f=d,p=Math.floor(h%8)+1,void 0!==b.shape&&(f=b.shape,p=b.color+1),g=64*f,m=64*p,qd()||(he[".pci_48_".concat(b.uid)].style.background='url("'.concat(e.starSrc.src,'") -').concat(g+8,"px -").concat(m+8,"px"));for(v in(y=NeptunesPride.universe).galaxy.players)b=y.galaxy.players[v],_="style='color: ".concat(ue[b.uid],";'"),E=le[b.uid],b.colourBox="<span class='playericon_font pc_".concat(b.colorIndex,"' ").concat(_,">").concat(E,"</span>"),b.hyperlinkedBox="<a onClick=\"Crux.crux.trigger('show_player_uid', '".concat(b.uid,"' )\">").concat(b.colourBox,"</a>");return w(),console.log("Recreating star and fleet sprites"),T||NeptunesPride.np.trigger("refresh_interface"),z(),window.setTimeout((function(){return NeptunesPride.np.trigger("map_rebuild")}),500),[2]}}))}))}var pe=function(){var e=NeptunesPride.npui.map;function t(e,t,n,r,i){e.save(),e.translate(t,n),e.scale(r,r),e.moveTo(0,0),e.arc(0,0,i,0,2*Math.PI),e.restore()}function n(){var e=NeptunesPride.universe.player;return of(e)/(sf(e,"scanning").level+2)}function r(e){var t=mf.combatHandicap;return of(e)+t*n()}function i(e){var t=mf.combatHandicap,r=function(e){return qd()?NeptunesPride.universe.calcRangeValue(e):e.tech.propulsion.value}(e)+t*n();return r}function s(t){return e.worldToScreenX(Math.abs(t))-e.worldToScreenX(0)}function a(n,o,a){var c=e.worldToScreenX(o.x),u=e.worldToScreenY(o.y),l=r(o.player),h=i(o.player),d=Math.max(l,h),f=!1;return a?h===d&&(f=!0):l===d&&(f=!0),f?(o.x<e.worldViewport.left-h||o.x>e.worldViewport.right+h||o.y<e.worldViewport.top-h||o.y>e.worldViewport.bottom+h||t(n,c,u,1,s(.98*h)),!1):(o.x<e.worldViewport.left-l||o.x>e.worldViewport.right+l||o.y<e.worldViewport.top-l||o.y>e.worldViewport.bottom+l||t(n,c,u,1,s(.98*l)),!0)}function l(n,r){var i;t(n,e.worldToScreenX(r.x),e.worldToScreenY(r.y),((i=e.scale/400)<.35&&(i=.35),i>1&&(i=1),i*e.pixelRatio),24)}var d=function(e,t){var n=e.x-t.x,r=e.y-t.y,i=(null==e?void 0:e.ga)*(null==t?void 0:t.ga)*9||1;if(("proteus"===NeptunesPride.gameVersion||qd())&&i>1){var s=n*n+r*r,o=12*NeptunesPride.universe.galaxy.fleet_speed,a=o*o;return Math.min(s,a)}return(n*n+r*r)/i},m=e.drawStars,w=document.createElement("canvas");e.drawStars=function(){var t,n=NeptunesPride.universe;if((null===(t=n.selectedStar)||void 0===t?void 0:t.player)&&g.territoryOn){var s=e.context,o=n.selectedStar.player.uid,c=!1,u=function(){c=!c,w.width=s.canvas.width,w.height=s.canvas.height;var t=g.territoryBrightness,u=3===t?s:w.getContext("2d");if(null==u)return console.error("Failed to create canvas context for territory"),"break";t%=3;var h=function(){var s;u.beginPath();var h=!1,d=r(n.selectedStar.player),f=i(n.selectedStar.player);for(var p in n.galaxy.stars){var g=n.galaxy.stars[p];if((null===(s=g.player)||void 0===s?void 0:s.uid)==o)h=a(u,g,c);else{var m=c?Math.max(d,f):Math.min(d,f),y=NeptunesPride.universe.galaxy;rf(o,m,g,y)&&l(u,g)}}var v=n.galaxy.players[o],w=ue[v.uid],b=parseInt(w.substring(1,3).toUpperCase(),16)/255,_=parseInt(w.substring(3,5).toUpperCase(),16)/255,T=parseInt(w.substring(5,7).toUpperCase(),16)/255,E=.299*b+.587*_+.114*T,k=Math.max((1-E)/4,.1)*t,x=function(e){return Math.floor(255*e)},S="rgba(".concat(x(b),", ").concat(x(_),", ").concat(x(T),", ").concat(k,")");u.fillStyle=S,u.strokeStyle="".concat(w,"aa"),u.lineWidth=2*e.pixelRatio,0===t?"destination-out"===u.globalCompositeOperation?(u.fillStyle="#fff",u.fill()):(h&&(u.setLineDash([4*e.pixelRatio,6*e.pixelRatio]),u.strokeStyle="".concat(w,"ff")),u.stroke(),u.setLineDash([])):"source-over"===u.globalCompositeOperation&&u.fill(),u.closePath()};u.globalCompositeOperation="source-over",h(),u.globalCompositeOperation="destination-out",h(),u.globalCompositeOperation="source-over",s!==u&&s.drawImage(u.canvas,0,0)};do{if("break"===u())break}while(c)}m()};var x=NeptunesPride.npui.map.drawText;NeptunesPride.npui.map.drawText=function(){var e,t,n=NeptunesPride.universe,r=NeptunesPride.npui.map,s=Object.keys(n.galaxy.players).map((function(e){return n.galaxy.players[e].huid}));NeptunesPride.npui.map.sortedStarSprites.forEach((function(e){-1!==s.indexOf(e.uid)&&-1===e.playerAlias.indexOf("Homeworld")&&(e.playerAlias+=" (Homeworld)")})),x(),r.context.font="".concat(14*r.pixelRatio,"px OpenSansRegular, sans-serif"),r.context.fillStyle="#FF0000",r.context.textAlign="right",r.context.textBaseline="middle";var o=p;0!==mf.combatHandicap&&(o="".concat(yf()," ").concat(o)),se(r.context,o,r.viewportWidth-10,r.viewportHeight-16*r.pixelRatio),void 0===NeptunesPride.originalPlayer&&(NeptunesPride.originalPlayer=null===(e=n.player)||void 0===e?void 0:e.uid);var a="";if(NeptunesPride.originalPlayer!==n.galaxy.player_uid&&void 0!==n.galaxy.player_uid&&(a=n.galaxy.players[n.galaxy.player_uid].alias),n.galaxy.player_uid!=n.player.uid){var c=n.player.alias;a+=" controlling ".concat(c)}if(Ie>-1){var u=NeptunesPride.universe.galaxy.tick;if(Ie===u){var l=NeptunesPride.universe.galaxy.futureTime?"Future Time @ ":"Time Machine @ ";a="".concat(l," [[Tick #").concat(Ie,"#]] ").concat(a)}else a="Time machine @ [[Tick #".concat(u,"#]] MISSING DATA for [[Tick #").concat(Ie,"#]] ").concat(a)}else a="".concat(a," [[Tick #").concat(B,"#a]]");if(n.batchedRequests.length>0&&(a="".concat(n.batchedRequests.length," orders pending (").concat(n.batchedRequestTimeout,"s) ").concat(a)),a&&(r.context.textAlign="right",se(r.context,a,r.viewportWidth-10,r.viewportHeight-32*r.pixelRatio)),n.selectedFleet&&n.selectedFleet.path.length>0){r.context.font="".concat(14*r.pixelRatio,"px OpenSansRegular, sans-serif"),r.context.fillStyle="#FF0000",r.context.textAlign="left",r.context.textBaseline="middle";var h=n.selectedFleet.y-n.selectedFleet.ly,f=n.selectedFleet.x-n.selectedFleet.lx;h=n.selectedFleet.path[0].y-n.selectedFleet.y,f=n.selectedFleet.path[0].x-n.selectedFleet.x;var m=16*r.pixelRatio,y=.056*r.scale*r.pixelRatio,v=Math.atan(h/f);if((A=y*Math.cos(v))>0&&f>0&&(A*=-1),(P=y*Math.sin(v))>0&&h>0&&(P*=-1),A<0&&f<0&&(A*=-1),P<0&&h<0&&(P*=-1),Ef(),null===(t=Tf[n.selectedFleet.uid])||void 0===t?void 0:t.eta){var w=Tf[n.selectedFleet.uid].eta,b=Tf[n.selectedFleet.uid].outcome.split("\n"),_=r.worldToScreenX(n.selectedFleet.x)+A,T=r.worldToScreenY(n.selectedFleet.y)+P;A<0&&(r.context.textAlign="right"),se(r.context,w,_,T);for(var E=0;E<b.length;++E)se(r.context,b[E],_,T+(E+1)*m)}}if(!NeptunesPride.gameConfig.turnBased&&n.timeToTick(1).length<3&&(m=16*r.pixelRatio,r.context.font="".concat(14*r.pixelRatio,"px OpenSansRegular, sans-serif"),r.context.fillStyle="#FF0000",r.context.textAlign="left",r.context.textBaseline="middle",w="Tick < 10s away!","0s"===n.timeToTick(1)&&(w="Tick passed. Click production countdown to refresh."),se(r.context,w,1e3,m)),n.selectedStar&&n.selectedStar.puid!=n.player.uid&&-1!==n.selectedStar.puid){r.context.textAlign="left",r.context.textBaseline="middle";var k=26*r.pixelRatio,S=NeptunesPride.universe.galaxy.fleets;for(var N in S){var I=S[N];if(_f(NeptunesPride.universe.galaxy.players,I.puid,n.player.uid,0)){f=n.selectedStar.x-I.x,h=n.selectedStar.y-I.y;var C=Math.sqrt(f*f+h*h),A=k,P=0;if(_=r.worldToScreenX(I.x)+A,T=r.worldToScreenY(I.y)+P,C>of(n.galaxy.players[n.selectedStar.puid])&&I.path&&I.path.length>0&&(f=I.path[0].x-n.selectedStar.x,h=I.path[0].y-n.selectedStar.y,(C=Math.sqrt(f*f+h*h))<of(n.galaxy.players[n.selectedStar.puid]))){var D=NeptunesPride.universe.galaxy.fleet_speed;I.warpSpeed&&(D*=3),f=I.x-I.path[0].x,h=I.y-I.path[0].y,v=Math.atan(h/f);var M=D*Math.cos(v),R=D*Math.sin(v);M>0&&f>0&&(M*=-1),R>0&&h>0&&(R*=-1),M<0&&f<0&&(M*=-1),R<0&&h<0&&(R*=-1);var O=0;do{var L=O*M+Number(I.x),F=O*R+Number(I.y);f=L-n.selectedStar.x,h=F-n.selectedStar.y,C=Math.sqrt(f*f+h*h),O+=1}while(C>of(n.galaxy.players[n.selectedStar.puid])&&O<=I.etaFirst+1);O-=1;var V="#00ff00";oe(n.selectedStar.puid,I)&&(V="#888888"),se(r.context,"Scan [[Tick #".concat(wf(O),"]]"),_,T,V)}}}}2==n.ruler.stars.length&&(n.ruler.stars[0].puid,n.ruler.stars[1].puid),function(){var e,t,n=NeptunesPride.universe,r=NeptunesPride.npui.map;if((null===(e=n.selectedStar)||void 0===e?void 0:e.alliedDefenders)&&g.autoRulerPower>0&&r.scale>=200){var s=NeptunesPride.gameConfig.turnBased?NeptunesPride.gameConfig.turnJumpTicks:1,o=NeptunesPride.universe.galaxy.fleet_speed,a=o*o,c=n.selectedStar,u=Math.ceil(g.autoRulerPower/2),l=g.autoRulerPower%2==0,h=function(e,t){var n=NeptunesPride.npui.map,r=NeptunesPride.universe.galaxy.stars,i=e,s=e,o=n.sortedStarSprites.map((function(e){return r[e.uid]}));o.sort((function(t,n){return d(e,n)-d(e,t)}));var a=o.length;do{var c=o[a-=1],u=_f(NeptunesPride.universe.galaxy.players,c.puid,e.puid,0);!u&&(i===e||t>0)?(i=c,t--):u&&s===e&&(s=c)}while((i===e||s===e||t>0)&&a>0);for(var l=d(e,i),h=[],f=0;f<o.length;++f)c=r[o[f].uid],d(e,c)<=l&&c!==i&&c!==s&&c!==e&&h.push(c);return[i,s,h]}(c,u),f=h[0],p=h[1],m=h[2],y="#f3172d",v="#888888",w="#00ff00",b=function(e,t,a){var c=Math.sqrt(d(e,t)),u=Math.ceil(c/o),l=r.worldToScreenX((e.x+t.x)/2),h=r.worldToScreenY((e.y+t.y)/2),f=0;-1!==t.puid&&(f=function(r){for(var s=mf.combatHandicap,o=NeptunesPride.universe.galaxy.players[t.puid],a=i(o),c=n.distance(e.x,e.y,t.x,t.y);c>a&&mf.combatHandicap-s<5;)mf.combatHandicap++,a=i(o);var u=mf.combatHandicap-s;return mf.combatHandicap=s,u}(t.puid))>0&&(a=v),r.context.save(),r.context.globalAlpha=1,r.context.strokeStyle=a,r.context.shadowColor="black",r.context.shadowOffsetX=2,r.context.shadowOffsetY=2,r.context.shadowBlur=2,r.context.fillStyle=a,r.context.lineWidth=2*r.pixelRatio,r.context.lineCap="round",r.context.translate(l,h);var p=function(e,t){var n=e.x-t.x,r=e.y-t.y,i=n<0,s=Math.PI*(i?1:0);return{angle:Math.atan2(r,n)+s,flipped:i}}(e,t),g=p.angle,m=p.flipped;r.context.rotate(g);var y=r.worldToScreenX(s*o)-r.worldToScreenX(0),b=(r.worldToScreenX(c)-r.worldToScreenX(0))/2,_=r.worldToScreenX(c-2*o)-r.worldToScreenX(0),T=r.worldToScreenX(c)-r.worldToScreenX(0),E=r.worldToScreenX(c-2*o)-r.worldToScreenX(0);if(_>0&&E>0){r.context.beginPath(),r.context.moveTo(-_/2,0),r.context.lineTo(E/2,0),r.context.stroke(),r.context.beginPath();var k=m?-1:1;if(r.context.moveTo(k*E/2,0),r.context.lineTo(k*E/2-5*k*r.pixelRatio,5*r.pixelRatio),r.context.lineTo(k*E/2-5*k*r.pixelRatio,-5*r.pixelRatio),r.context.closePath(),r.context.fill(),y-b-E/2+1<=1){r.context.beginPath();var x=8*Math.PI/y,S=m?Math.PI:0,N=m?b:-b;r.context.arc(N,0,y,S-x,S+x),r.context.stroke()}}r.context.textAlign="center",r.context.translate(0,-8*r.pixelRatio);var I=a===v?v:w;return ie("[[Tick #".concat(wf(u),"]]"),0,0,I),y-T+1>1?(r.context.translate(0,18*r.pixelRatio),ie("invisible",0,0,I)):-1!==t.puid&&(f>0?(r.context.translate(0,18*r.pixelRatio),ie("range +".concat(f),0,0,I)):(r.context.translate(0,18*r.pixelRatio),ie("".concat("0"!==t.v?t.totalDefenses:"?"," ship").concat(1!==t.totalDefenses?"s":""),0,0,I))),r.context.setLineDash([]),r.context.restore(),u},_=b(c,f,y),T=Math.ceil(Math.sqrt(d(c,p)/a)),E=0,k=1,x=c.totalDefenses,S=NeptunesPride.universe.galaxy.players,N=Math.max.apply(Math,Mf([1,(null===(t=S[c.puid])||void 0===t?void 0:t.tech)?kf(S[c.puid]):0],null==c?void 0:c.alliedDefenders.map((function(e){return kf(S[e])})),!1)),I=!0;-1!==f.puid&&(I=I&&"1"===f.v,E+=f.totalDefenses,k=Math.max(k,kf(S[f.puid]))),_-s>=T?(b(c,p,w),-1!==p.puid&&(I=I&&"1"===p.v,x+=p.totalDefenses,N=Math.max(N,kf(S[p.puid])))):b(c,p,v);for(var C=0;l&&C<m.length;++C){var A=m[C];if(_f(NeptunesPride.universe.galaxy.players,A.puid,c.puid,0)){var P=Math.ceil(Math.sqrt(d(c,A)/a));_-s>=P?(b(c,A,w),-1!==A.puid&&(I=I&&"1"===A.v,x+=A.totalDefenses,N=Math.max(N,kf(S[A.puid])))):b(c,A,v)}else b(c,A,y),-1!==A.puid&&(I=I&&"1"===A.v,E+=A.totalDefenses,k=Math.max(k,kf(S[A.puid])))}for("proteus"!==NeptunesPride.gameVersion&&(N+=1);x>0&&E>0&&!((E-=N)<=0);)x-=k;var D=E<=0?"".concat(x," live"):"".concat(E," land");I||(D+="?");var M=r.worldToScreenX(c.x+.125),R=r.worldToScreenY(c.y)-9*r.pixelRatio;r.context.textAlign="left",ie(D,M,R,"#00ff00");var O=!0;for(E<=0&&(x-=k,O=!1);x>0||E>0;)E-=N,x-=k;var L=18*r.pixelRatio;O?(x=Math.min(-1,x),ie("".concat(-x," needed"),M,R+L,"#00ff00")):(E=Math.min(-1,E),ie("".concat(-E," needed"),M,R+L,"#00ff00"))}}()};var S=-1,N=!1;function M(e){return e.replaceAll(/[^\w\d]/g,"_").toLowerCase()}NeptunesPride.npui.status.on("one_second_tick",(function(){if(-1===S){var e=K(1),t=ge(e,!0,!0,!0).split(" ");S=parseInt(t[t.length-1].replaceAll("s",""))+1}29==(S-=1)&&"relative"===g.relativeTimes&&_?(NeptunesPride.np.trigger("map_rebuild"),NeptunesPride.np.trigger("refresh_interface")):(NeptunesPride.universe.batchedRequests.length>0||N)&&(N=NeptunesPride.universe.batchedRequests.length>0,NeptunesPride.np.trigger("map_rebuild"))})),v("sort_table",(function(e,t){var n=t.split(","),r=n[0],i=parseInt(n[1]),s=document.getElementById("".concat(r,":").concat(i));if(s){var o,a=s.innerHTML.replaceAll(/[↑↓]/g,""),c="↓";o=-1!==s.innerHTML.indexOf("↑")?c:-1!==s.innerHTML.indexOf(c)?"":"↑";for(var u=0;;u++){var l=document.getElementById("".concat(r,":").concat(u));if(!l)break;l.innerHTML=l.innerHTML.replaceAll(/[↑↓]/g,"")}s.innerHTML="".concat(a).concat(o);for(var h=[],d=0;;++d){var f="".concat(r,":row#").concat(d),p=document.getElementById(f);if(!p)break;h.push(p)}var g=h.map((function(e){var t=e.getElementsByTagName("TD")[i],n=parseInt(e.id.split("#")[1]),r=t.innerText;return[r,""!==o?+r:n,e.id,e]}));if(g.length>1){var m=g[0][3],y=function(e){return/^[0-9-]/.test(e)?e.match?+e.match(/^([0-9-]*(\.[0-9]+)?)/)[0]:+e:e},v=0===g.filter((function(e){return isNaN(y(e[1]))})).length;v?o===c?g.sort((function(e,t){return y(t[1])-y(e[1])})):g.sort((function(e,t){return y(e[1])-y(t[1])})):(g.sort(),o===c&&g.reverse());var w=g[g.length-1][3],b=g[0][3].parentNode;b.insertBefore(w,m),g.reduce((function(e,t){return b.insertBefore(t[3],e[3]),e}),g[g.length-1])}}}));var R=["ctrl+a","ctrl+`"];Crux.format=function(e,t){var n,r,i,s,o,a=Crux.formatTime;if(!1===(null==t?void 0:t.linkTimes)&&(a=ye,t.linkTimes=void 0),!e)return"error";n=0,r=0,i=0,s="",o="";for(var c=function(){if(n+=1,r=e.indexOf("[["),i=e.indexOf("]]"),-1===r)return"break";if(s=e.slice(r+2,i),o="[[".concat(s,"]]"),void 0!==t[s])e=e.replace(o,t[s]);else if(/^upgrade:[eisg](:[0-9]+)+$/.test(s)){var c=(S=s.split(":"))[1],u=NeptunesPride.universe.galaxy.stars,l=NeptunesPride.universe.player.uid,d=S.slice(2).map((function(e){return u[+e]})).filter((function(e){return e&&e.puid===l})),f=d.map((function(e){return"Crux.crux.trigger('star_dir_upgrade_".concat(c,"', '").concat(e.uid,"')")})).join(";"),p='<span class="button button_up pad8" style="display: inline-block; margin: 3px 0;" onClick="event.preventDefault();'.concat(f,'"  >Buy ').concat(d.length," ").concat({e:"economy",i:"industry",s:"science",g:"warp gates"}[c],"</span>");e=e.replace(o,p)}else if(/^colorscheme(:[^:]+){3}$/.test(s)){var m=(S=s.split(":"))[1],y=S[2],v=S[3];p='<span class="button button_up pad8" style="display: inline-block; margin: 3px 0;" onClick=\'event.preventDefault();Crux.crux.trigger("set_colorscheme_api", "'.concat(y,":").concat(v,'")\'"  >Import Color Scheme ').concat(m,"</span>"),e=e.replace(o,p)}else if(/^cash:[0-9]+:[0-9]+$/.test(s)){var w=+(S=s.split(":"))[1],b=+S[2],_=void 0!==(null==(G=NeptunesPride.universe.galaxy.players[w])?void 0:G.cash)?G.cash:b;p="".concat(_),e=e.replace(o,p)}else if(/^transfer(:[0-9]+){5}$/.test(s)){w=+(S=s.split(":"))[1],b=+S[2];var T=+S[3],E=+S[4]===NeptunesPride.universe.player.uid?+S[5]:0,k=(_=void 0!==(null==(G=NeptunesPride.universe.galaxy.players[w])?void 0:G.cash)?G.cash:b,Math.max(0,NeptunesPride.universe.player.cash-E)),x=Math.min(k,Math.max(0,T-_));p=w===NeptunesPride.universe.player.uid?T-_:Crux.format("[[sendcash:".concat(w,":").concat(x,":").concat(x,"]]"),t),e=e.replace(o,p)}else if(/^Tick #\d\d*(#a?)?$/.test(s)){var S=s.split("#"),N=parseInt(S[1]),I=N-NeptunesPride.universe.galaxy.tick;if("a"===S[2])e=e.replace(o,"Tick #".concat(N));else{3===S.length&&-1!==g.relativeTimes.indexOf("rel")&&(I+=NeptunesPride.universe.galaxy.tick-B);var C=K(I,!1);e=e.replace(o,a(C,!0))}}else if(/^https:&#x2F;&#x2F;(i\.ibb\.co|i\.imgur\.com)&#x2F;[-#;\.\w&]{3,200}$/.test(s))e=e.replace(o,'<img  width="100%" src=\''.concat(s,"' />"));else if(/^https:&#x2F;&#x2F;www\.youtube\.com&#x2F;watch\?v=[-\w]{6,50}$/.test(s)){var A=s.replace("watch?v=","embed/");console.log({embedURL:A}),e=e.replace(o,'<p align="center"><iframe width="280" height="158" src="'.concat(A,'" title="YouTube video player" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; web-share" allowfullscreen></iframe><br/><a href=').concat(s,' target="_blank">Open Youtube in a new tab</a></p>'))}else if(/^api:\w{6}$/.test(s)){var P='<a onClick=\'Crux.crux.trigger("switch_user_api", "'.concat(s,"\")'> View as ").concat(s,"</a>");P+=' or <a onClick=\'Crux.crux.trigger("merge_user_api", "'.concat(s,"\")'> Merge ").concat(s,"</a>"),e=e.replace(o,P)}else if(/^apiv:\w{6}$/.test(s))P='<a onClick=\'Crux.crux.trigger("switch_user_api", "'.concat(s,"\")'>").concat(s,"</a>"),e=e.replace(o,P);else if(/^apim:\w{6}$/.test(s))P='<a onClick=\'Crux.crux.trigger("merge_user_api", "'.concat(s,"\")'>").concat(s,"</a>"),e=e.replace(o,P);else if(/^viewgame:[0-9]+:.+$/.test(s)){var D=s.split(":"),M='<a onClick=\'Crux.crux.trigger("view_game", "'.concat(s,"\")'>").concat(D[1]," ").concat(D[2],"</a>");e=e.replace(o,M)}else if(/^hotkey:[^:]+$/.test(s)||/^goto:[^:]/.test(s)){var O=(D=s.split(":"))[1],L=h(O),F=(null==L?void 0:L.button)||"Trigger ".concat(s);H[F]&&(F=H[F]);var V="goto"!==D[0]||R.includes(O)?"":';Mousetrap.trigger("`")',U='<span class="button button_up pad8" onClick=\'{Mousetrap.trigger("'.concat(O,'")').concat(V,"}'>").concat(F,"</span>");e=e.replace(o,U)}else if(/^mail:([0-9]+:?)+$/.test(s)){D=s.split(":");var j="NeptunesPride.inbox.clearDraft();".concat(D.slice(1).map((function(e){return"NeptunesPride.inbox.draft.to.push(".concat(e,")")})).join(";")),q='<span class="button button_up icon-button pad8" onClick=\''.concat(j,';Crux.crux.trigger("show_screen", "compose")\'><span class="icon-mail"/></span>');e=e.replace(o,q)}else if(/^footer:-?[\w- \.][\w- \.]*$/.test(s)){var $=(D=s.split(":"))[1];e=e.replace(o,"<b>".concat($,"</b>"))}else if(/^good:-?[\w-\.][\w-\.]*$/.test(s))$=(D=s.split(":"))[1],e=e.replace(o,'<span class="txt_warn_good">'.concat($,"</span>"));else if(/^bad:[\w-\.][\w-\.]*$/.test(s))$=(D=s.split(":"))[1],e=e.replace(o,'<span class="txt_warn_bad">'.concat($,"</span>"));else if(/^sendtech:\d\d*:\w\w*:-?[\w-\.][\w-\.]*$/.test(s)){D=s.split(":");var G=parseInt(D[1]),z=D[2],W=(F=D[3],'<span class="txt_warn_good" onClick=\'{NeptunesPride.sendTech('.concat(G,', "').concat(z,"\")}'>").concat(F,"</span>"));e=e.replace(o,W)}else if(/^sendalltech:\d\d*:-?[\w-\.][\w-\.]*$/.test(s))D=s.split(":"),G=parseInt(D[1]),F=D[2],W='<span class="txt_warn_good" onClick=\'{NeptunesPride.sendAllTech('.concat(G,")}'>").concat(F,"</span>"),e=e.replace(o,W);else if(/^sendcash:\d\d*:\d\d*:-?[\w-\.][\w-\.]*$/.test(s)){D=s.split(":"),G=parseInt(D[1]);var Q=parseInt(D[2]);F=D[3],W='<span class="txt_warn_bad" onClick=\'{NeptunesPride.sendCash('.concat(G,', "').concat(Q,"\")}'>").concat(F,"</span>"),e=e.replace(o,W)}else e=s.startsWith("data:")?e.replace(o,'<div width="100%" class="screenshot"><img class="screenshot" src="'.concat(s,'"/></div>')):e.replace(o,"(".concat(s,")"))};r>=0&&n<1e4&&"break"!==c(););for(var u=e.split(/<br ?\/?>/),l=[],d="",f="",p=!1,m=!1,y=!1,v=0,w=[],b=0;b<u.length;++b){var _=u[b];if(0===_.indexOf("---")&&-1!==_.indexOf("---",3))m=p=!p,d=_.substring(4,_.length-4),f=M(d),p?(l.push('<table id="'.concat(f,'" class="combat_result">')),l.push('<tr><th style="padding: 12px" colspan="10">'.concat(d,"</th></tr>"))):l.push("</table>");else if(p&&m&&(_.startsWith("--")||_.startsWith(":-"))){var T=_.split("|");w=T.map((function(e){return e.startsWith(":")?"left":-1!==e.indexOf(":")?"right":"center"})),m=!1,y=!0}else if(p){(m||y)&&(m=!1,y=!0,v=b+1);var E=b-v,k=E>=0?"id='".concat(f,":row#").concat(E,"'"):"";(T=_.split("|")).length&&-1!==T[0].indexOf("<b>")&&(k=""),l.push("<tr ".concat(k,' class="combat_result_teams_heading">')),T.forEach((function(e,t){var n="",r="";y&&(n='onclick=\'Crux.crux.trigger("sort_table", "'.concat(f,",").concat(t,"\")'"),r="id='".concat(f,":").concat(t,"'")),l.push("<td ".concat(n," ").concat(r,' style="text-align: ').concat(w[t],'" class="equal_cols">').concat(e,"</td>"))})),l.push("</tr>"),y=!1}else l.push(_),b<u.length-1&&l.push("<br>")}return l.join("\n")};var F=NeptunesPride.npui;NeptunesPride.templates.n_p_a="NP Agent",NeptunesPride.templates.npa_report_type="Filter:",NeptunesPride.templates.npa_paste="Intel",NeptunesPride.templates.npa_screenshot="Screenshot";var j=F.NewMessageCommentBox,q={empires:"icon-users",signatures:"icon-users",accounting:"icon-dollar",trading:"icon-right-open",research:"icon-beaker",ownership:"icon-star-1",tradeactivity:"icon-chart-line",combatactivity:"icon-chart-line",activity:"icon-chart-line",planets:"icon-star-1",fleets:"icon-rocket",combats:"icon-rocket",filteredcombats:"icon-rocket",onlycombats:"icon-rocket",stars:"icon-star-1",economists:"icon-dollar",generals:"icon-rocket",fa:"icon-beaker",api:"icon-flash",controls:"icon-help",help:"icon-help"},H={empires:"Empires",signatures:"Tech by Empire",accounting:"Accounting",trading:"Trading",research:"Research",fleets:"Fleets (short)",combats:"Fleets (long)",filteredcombats:"Fleets (filtered)",onlycombats:"All Combats",planets:"Home Planets",stars:"Stars",ownership:"Ownership",tradeactivity:"Trade Activity",combatactivity:"Combat Activity",activity:"Activity",economists:"Economists",generals:"Generals",api:"API Keys",games:"Past Games",fa:"Formal Alliances",controls:"Controls",help:"Help"};v("paste_report",(function(e,t){var n=function(){var e=NeptunesPride.inbox;e.commentDrafts[e.selectedMessage.key]+="\n"+o(),e.trigger("show_screen","diplomacy_detail")};if("screenshot"===t){var r=ne();r&&r.then(n)}else n()})),F.NewMessageCommentBox=function(){var e=j();return Crux.Button("npa_paste","paste_report","intel").grid(9.5,12,4.5,3).roost(e),Crux.Button("npa_screenshot","paste_report","screenshot").grid(13.5,12,7,3).roost(e),e};var he=F.sideMenu.children[F.sideMenu.children.length-1];F.sideMenu.removeChild(he),F.SideMenuItem("icon-eye","n_p_a","show_screen","new_fleet").roost(F.sideMenu),F.SideMenuItem("icon-left-open","main_menu","browse_to","/").roost(F.sideMenu),F.NpaMenuItem=function(e,t,n,r){var i=Crux.Clickable(n,r).addStyle("rel side_menu_item").configStyles("side_menu_item_up","side_menu_item_down","side_menu_item_hover","side_menu_item_disabled").size(292,40);Crux.Text("","pad12 txt_center").addStyle(e).grid(0,-.25,3,2.5).rawHTML("").roost(i),Crux.Text(t,"pad12").grid(2,-.25,18,2.5).roost(i);var s=c[r];return Crux.Text("","pad12 txt_right").grid(0,-.25,18,4).rawHTML("<span float='right'>".concat(s,"</span>")).roost(i),i};var de=function(e,t){console.log("SHOW: ".concat(t)),b=t,F.trigger("show_screen","new_fleet")};F.npaMenu=function(){var e=Crux.Widget("col_accent side_menu").size(292,0);for(var t in e.isShowing=!1,e.pinned=!1,e.rows=11,F.sideMenuItemSize=40,e.spacer=Crux.Widget("rel").size(160,48).roost(e),e.showBtn=Crux.IconButton("icon-menu","hide_side_menu").grid(0,0,3,3).roost(e),e.showBtn=Crux.IconButton("icon-eye","hide_side_menu").grid(2.5,0,3,3).roost(e),Crux.Text("","pad12 txt_right").grid(0,-.25,18,4.5).rawHTML("<span float='right'>Hotkey</span>").roost(e),H){var n=q[t],r="npa_key_".concat(t);NeptunesPride.templates[r]=H[t],F.NpaMenuItem(n,r,"show_report",t).roost(e)}return e.pin=function(){e.show(),e.showBtn.hide(),e.spacer.hide(),e.pinned=!0,e.addStyle("fixed")},e.unPin=function(){e.pinned=!1,e.showBtn.show(),e.spacer.show(),e.removeStyle("fixed"),e.hide()},e.onPopUp=function(){e.pinned||(F.sideMenu.hide(),e.isShowing=!0,e.show(),e.trigger("play_sound","selection_open"),e.trigger("hide_section_menu"),e.trigger("hide_screen"),e.trigger("cancel_fleet_orders"))},e.onPopDown=function(){e.pinned||(e.isShowing=!1,e.hide())},e.on("show_report",de),e.on("show_npa_help",st),e.on("show_npa_menu",e.onPopUp),e.on("hide_side_menu",e.onPopDown),e.onPopDown(),e}().roost(F),F.status.npaMenuBtn=Crux.IconButton("icon-eye","show_npa_menu").grid(2.5,0,3,3).roost(F.status),u("m",(function(){F.npaMenu.isShowing?F.npaMenu.onPopDown():F.npaMenu.onPopUp()}),"Toggle the display of the NPA menu.","NPA Menu");var pe=F.NewFleetScreen;v("show_screen",(function(e,t,n){_="new_fleet"===t&&void 0===n,T="new_fleet"===t&&"npa_options"===(null==n?void 0:n.kind)})),F.NewFleetScreen=function(e){return void 0===e?function(){var e=F.Screen("n_p_a");Crux.Text("","rel pad12 txt_center col_black  section_title").rawHTML(f).roost(e),Crux.IconButton("icon-help","show_screen","help").grid(24.5,0,3,3).roost(e).onClick=st;var t=Crux.Widget("rel  col_accent").size(480,48),n=Crux.Widget("rel").nudge(-24,0);Crux.Text("npa_report_type","pad12").roost(t),E=Crux.DropDown(b,H,"exec_report").grid(15,0,15,3).roost(t),(k=Crux.TextInput("single").grid(5,0,10,3).roost(t)).eventKind="exec_report";var r=Crux.Text("","pad12 rel txt_selectable").size(432).pos(48).rawHTML("Choose a report from the dropdown.");r.roost(n),t.roost(e),n.roost(e);var i=function(e,t){return Pf(this,void 0,void 0,(function(){var e;return Df(this,(function(n){switch(n.label){case 0:return void 0===t&&(t=b),"help"===t?(st(),[2]):(b=t,"planets"!==t?[3,1]:(re(),[3,30]));case 1:return"fleets"!==t?[3,2]:(Y(),[3,30]);case 2:return"combats"!==t?[3,3]:(W(),[3,30]);case 3:return"onlycombats"!==t?[3,4]:(X(),[3,30]);case 4:return"filteredcombats"!==t?[3,5]:(Q(),[3,30]);case 5:return"stars"!==t?[3,6]:(I(),[3,30]);case 6:return"ownership"!==t?[3,7]:(C(),[3,30]);case 7:return"tradeactivity"!==t?[3,8]:(A(),[3,30]);case 8:return"combatactivity"!==t?[3,9]:(P(),[3,30]);case 9:return"fa"!==t?[3,10]:(D(),[3,30]);case 10:return"economists"!==t?[3,12]:[4,O()];case 11:return n.sent(),[3,30];case 12:return"activity"!==t?[3,13]:(V(),[3,30]);case 13:return"trading"!==t?[3,15]:[4,Ke()];case 14:return n.sent(),[3,30];case 15:return"empires"!==t?[3,17]:[4,We()];case 16:return n.sent(),[3,30];case 17:return"signatures"!==t?[3,19]:[4,Qe()];case 18:return n.sent(),[3,30];case 19:return"generals"!==t?[3,21]:[4,L()];case 20:return n.sent(),[3,30];case 21:return"research"!==t?[3,23]:[4,Ze()];case 22:return n.sent(),[3,30];case 23:return"accounting"!==t?[3,25]:[4,et()];case 24:return n.sent(),[3,30];case 25:return"controls"!==t?[3,26]:(dt(),[3,30]);case 26:return"games"!==t?[3,28]:[4,it()];case 27:return n.sent(),[3,30];case 28:return"api"!==t?[3,30]:[4,nt()];case 29:n.sent(),n.label=30;case 30:return e=o().replace(/\n/g,"<br>"),e=NeptunesPride.inbox.hyperlinkMessage(e),r.rawHTML(e),[2]}}))}))};return i(0,b),e.on("exec_report",i),e}():"npa_options"===(null==e?void 0:e.kind)?function(e){var t=NeptunesPride.npui;NeptunesPride.templates.npa_options="NPA Settings ".concat(p.replaceAll(/ .*$/g,""));var n=t.Screen("npa_options");return Crux.IconButton("icon-help","show_screen","help").grid(24.5,0,3,3).roost(n).onClick=st,J(n,(function(e){return!0}),e),n}(e):"npa_colours"===(null==e?void 0:e.kind)?function(e){var t=NeptunesPride.npui;NeptunesPride.templates.npa_colours="Colours and Shapes";var n=t.Screen("npa_colours");Crux.IconButton("icon-help","show_screen","help").grid(24.5,0,3,3).roost(n).onClick=st,J(n,(function(e){return"allianceDiscriminator"===e.name}));var r=NeptunesPride.universe.galaxy,i=Object.keys(r.players).map((function(e){return r.players[e]})),s=i.length,o=g.customColors.split(" "),a=Math.ceil(o.length/10),c=Crux.Widget("rel").size(480,50*(s+a)+48).roost(n);return o.forEach((function(e,t){var n=t%10*3,r=3*Math.floor(t/10),i="text-align: center; vertical-align: middle; border-radius: 5px; width: ".concat(28,"px; height: ").concat(28,"px; background-color: ").concat(e,"; display: inline-block"),s=t===ee?"✓":"";Crux.Text("","pad12").rawHTML("<span onClick=\"Crux.crux.trigger('set_cc', ".concat(t,")\" style='").concat(i,"'>").concat(s,"</span>")).grid(n,r,3,3).roost(c).on("set_cc",(function(e,t){ee!==t&&(ee=t,NeptunesPride.np.trigger("refresh_interface"))}))})),[0,1,2,3,4,5,6,7].forEach((function(e,t){var n=3*t,r=3*a,i=o[ee],s="text-align: center; vertical-align: middle; border-radius: 5px; color: ".concat(i,";");s+="padding: 4px; padding-top: 6px; padding-right: 5px;",s+="background-color: black; ",s+=t===te?"border: 2px solid white; ":"border: 2px solid grey; ",Crux.Text("","pad12").rawHTML("<span class='playericon_font' style='".concat(s,"' onClick=\"Crux.crux.trigger('set_cs', ").concat(t,')">').concat(e,"</span>")).grid(n,r,3,3).roost(c).on("set_cs",(function(e,t){te!==t&&(te=t,NeptunesPride.np.trigger("refresh_interface"))}))})),i.forEach((function(e,t){var r=e.alias,i=ue[e.uid],s=le[e.uid],u=3*t+3*a+3;Crux.Text("","pad12").rawHTML(r).grid(0,u,20,3).roost(c);var l=Crux.TextInput("single").grid(16,u,3,3).roost(c);l.node.addClass("playericon_font"),l.node.css("color",i),l.setValue(s);var h=Crux.TextInput("single").grid(19,u,6,3).roost(c);h.setValue(i),h.eventKind="text_entry";var d=function(){var t=!1;if(/^#[0-9a-fA-F]{6}$/.test(h.getValue())&&h.getValue()!=i){var n=h.getValue();me(e.uid,n),-1===o.indexOf(n)&&-1===ce.indexOf(n)&&(ee=o.length,o.push(n),g.customColors=o.join(" ")),t=!0}if(/^[0-7]$/.test(l.getValue())&&l.getValue()!=s){var r=+l.getValue();console.log("set ".concat(e.uid," to shape ").concat(r)),le[e.uid]=r,t=!0}t&&(fe(),NeptunesPride.np.trigger("refresh_interface"),z(),Te.set("colorMap",ue.join(" ")),Te.set("shapeMap",le.join(" ")),Z())};h.node.on("focus",(function(){var e=o[ee];h.setValue(e),d()})),l.node.on("focus",(function(){var e=te;l.setValue(e),d()})),n.on(h.eventKind,(function(e,t){d()}));var f="reset_cc_".concat(e.uid);Crux.Button(f,f,e).rawHTML("Reset").grid(25,u,5,3).roost(c).on(f,(function(t,n){var r=void 0!==e.shapeIndex?e.shapeIndex:e.shape;!e.prevColor||h.getValue()===e.originalColor&&l.getValue()==r||(h.setValue(e.originalColor),l.setValue(r),d())}))})),Z(),n}():pe(e)};var ge=Crux.formatTime,ye=function(e,t,n){if("relative"===g.relativeTimes)return e<0?"-".concat(ge(-e,t,n)):ge(e,t,n);if("eta"===g.relativeTimes)return NeptunesPride.gameConfig.turnBased?function(e,t){var n=e/(60*$()*1e3),r=Math.ceil(n/NeptunesPride.gameConfig.turnJumpTicks);return"".concat(r," turn").concat(1!==r?"s":"")}(e):function(e,t){var n=(new Date).getTime()+NeptunesPride.universe.locTimeCorrection,r=new Date(n),i=new Date(r.getTime()+e),s=void 0!==t?t:"ETA ",o=s+U(i.getHours(),i.getMinutes());return i.getDay()!=r.getDay()&&(o="".concat(s).concat(G[i.getDay()]," @ ").concat(U(i.getHours(),i.getMinutes()))),o}(e,"");if("tick"===g.relativeTimes){var r=e/(60*$()*1e3);return"Tick #".concat(Math.ceil(r)+NeptunesPride.universe.galaxy.tick)}return"tickrel"===g.relativeTimes?(r=e/(60*$()*1e3),"".concat(Math.ceil(r)," ticks")):void 0};Crux.formatTime=function(e,t,n){var r=ye(e,t,n),i=e/(60*$()*1e3),s=Math.ceil(i)+NeptunesPride.universe.galaxy.tick;return'<a onClick=\'Crux.crux.trigger("warp_time", "'.concat(s,"\")'>").concat(r,"</a>")},u("%",(function(){var e=(y.indexOf(g.relativeTimes)+1)%y.length;g.relativeTimes=y[e],NeptunesPride.np.trigger("refresh_interface"),NeptunesPride.npui.rulerToolbar&&NeptunesPride.np.trigger("show_ruler_toolbar"),NeptunesPride.np.trigger("map_rebuild")}),"Change the display of ETAs from relative times to absolute clock times. Makes predicting important times of day to sign in and check much easier especially for multi-leg fleet movements. Sometimes you will need to refresh the display to see the different times.","Timebase"),window.chrome?(Object.defineProperty(Crux,"touchEnabled",{get:function(){return!1}}),Object.defineProperty(NeptunesPride.npui.map,"ignoreMouseEvents",{get:function(){return!1}})):Re()&&(Crux.crux.onTouchDown=function(){Crux.touchEnabled=!1},Crux.crux.one("touchstart",Crux.crux.onTouchDown));var ve=function(){if(NeptunesPride.gameConfig.turnBased){var e=jQuery(':contains("Submit Turn")');return 9!==e.length&&11!==e.length&&(e=jQuery(':contains("Submitted")')),9===e.length&&e[7]&&e[7].style?(e[7].style.zIndex=0,!0):!(11!==e.length||!e[9]||!e[9].style||(e[9].style.zIndex=0,0))}return!0};ve(),v("refresh_interface",ve);var we=NeptunesPride.universe,be=we.timeToTick;we.timeToTick=function(e,t){var n=t&&"eta"!==g.relativeTimes;return be(e,n)},ae=!0},ge=function(){g.territoryOn=!g.territoryOn,z()};u(")",ge,"Toggle the territory display. Range and scanning for all stars of the selected empire are shown.","Toggle Territory");var me=function(e,t){var n=NeptunesPride.universe.galaxy.players[e];ue[n.uid]=t,"proteus"===NeptunesPride.gameVersion||qd()?(n.originalColor||(n.originalColor=n.colorStyle),n.colorStyle=ue[n.uid]):(n.originalColor||(n.originalColor=n.color),n.prevColor=n.color,n.color=ue[n.uid])},ye=function(){var e=NeptunesPride.universe.player;g.whitePlayer=!g.whitePlayer,g.whitePlayer?me(e.uid,"#ffffff"):"proteus"===NeptunesPride.gameVersion||qd()?me(e.uid,ce[e.color]):void 0!==e.prevColor&&me(e.uid,e.prevColor),fe()};function ve(){if(NeptunesPride.universe.galaxy.tick_rate)console.log("*skip REDEFINE PROPERTIES");else{for(var e in console.log("REDEFINE PROPERTIES"),NeptunesPride.universe.galaxy.players){var t=NeptunesPride.universe.galaxy.players[e];void 0===t.total_stars?uf(t.alias,t):console.log("skip inside for ${p.alias}")}uf(0,NeptunesPride.universe.galaxy),void 0===NeptunesPride.universe.player_achievements&&uf(0,NeptunesPride.universe)}}u("w",ye,"Toggle between my color and white on the map display.","Whiteout"),window.setTimeout((function(){g.whitePlayer&&(g.whitePlayer=!1,ye())}),1e3);var we=function(){var e;(null===(e=NeptunesPride.universe)||void 0===e?void 0:e.galaxy)&&NeptunesPride.npui.map?(function(){var e=NeptunesPride.universe,t=NeptunesPride.universe.galaxy.fleets;for(var n in t){var r=t[n],i='<a onClick=\'Crux.crux.trigger("show_fleet_uid", "'.concat(r.uid,"\")'>").concat(r.n,"</a>");e.hyperlinkedMessageInserts[r.n]=i}e.hyperlinkedMessageInserts[":carrier:"]='<span class="icon-rocket"></span>',e.hyperlinkedMessageInserts[":star:"]='<span class="icon-star-1"></span>',e.hyperlinkedMessageInserts[":mail:"]='<span class="icon-mail"></span>'}(),w(),console.log("Fleet linking complete."),ae?console.log("HUD setup already done; skipping."):(pe(),console.log("HUD setup complete.")),Te.get("colorMap").then((function(e){e.split(" ").forEach((function(e,t){NeptunesPride.universe.galaxy.players[t]&&me(t,e)})),Te.get("shapeMap").then((function(e){le=e.split(" ").map((function(e){return+e})),fe(),NeptunesPride.np.trigger("refresh_interface"),z()}))})).catch((function(e){var t;(null===(t=null===NeptunesPride||void 0===NeptunesPride?void 0:NeptunesPride.universe)||void 0===t?void 0:t.galaxy)&&j(NeptunesPride.universe.galaxy)})),ve(),console.log("hook for all accessors"),v("order:full_universe",ve)):console.log("Game not fully initialized yet; wait.",NeptunesPride.universe)};u("@",we,"Reinitialize Neptune's Pride Agent. Use the @ hotkey if the version is not being shown on the map after dragging.","Reload NPA");var be=void 0,_e=NeptunesPride.gameNumber,Te=new Jd(_e),Ee=NeptunesPride.np.onServerResponse;NeptunesPride.np.onServerResponse=function(e){Ee(e),"order:player_achievements"===e.event?(console.log("Initial load complete. Reinstall."),Id("achievements_init"),we()):"order:full_universe"===e.event?(console.log("Universe received. Reinstall."),NeptunesPride.originalPlayer=NeptunesPride.universe.player.uid,Id("universe_init"),we()):!ae&&NeptunesPride.npui.map&&(console.log("Hooks need loading and map is ready. Reinstall."),Id("".concat(e.event,"_init")),we())};var ke=function(e,t){return Pf(this,void 0,void 0,(function(){var e,n;return Df(this,(function(r){switch(r.label){case 0:return void 0===NeptunesPride.originalPlayer&&(NeptunesPride.originalPlayer=NeptunesPride.universe.player.uid),e=(null==t?void 0:t.split(":")[1])||be,(be=e)?[4,Xe(e)]:[3,2];case 1:if(n=r.sent(),!xe(e,n))return[2];console.log("SCAN: ",{scan:n}),NeptunesPride.np.onFullUniverse(null,n),NeptunesPride.npui.onHideScreen(null,!0),NeptunesPride.np.trigger("select_player",[NeptunesPride.universe.player.uid,!0]),Id("switchuser_init"),we(),r.label=2;case 2:return[2]}}))}))},xe=function(e,t){if(!((null==t?void 0:t.player_uid)>=0))return"badkey"!==be&&Te.keys().then((function(t){var n=t.filter((function(e){return e.startsWith("API:")}));n.forEach((function(t){Te.get(t).then((function(n){n===e&&Te.set(t,"badkey")}))}))})),!1;var n="API:".concat(t.player_uid);return Te.get(n).then((function(t){t&&t===be||Te.set(n,e)})),!0},Se=function(e){var t=NeptunesPride.universe;if(If(),-1!==Ie||(NeptunesPride.universe.galaxy.player_uid,NeptunesPride.originalPlayer&&NeptunesPride.originalPlayer,NeptunesPride.originalPlayer!==t.galaxy.player_uid||e.player_uid!==t.galaxy.player_uid)){for(var n in t.galaxy.players[e.player_uid]=Af(Af({},e.players[e.player_uid]),t.galaxy.players[e.player_uid]),t.galaxy.stars=Af(Af({},e.stars),t.galaxy.stars),e.stars){var r=e.stars[n];("0"!==r.v&&"0"===t.galaxy.stars[n].v||r.puid===e.player_uid)&&(t.galaxy.stars[n]=Af(Af({},t.galaxy.stars[n]),r))}for(var i in t.galaxy.fleets=Af(Af({},e.fleets),t.galaxy.fleets),e.fleets){var s=e.fleets[i];s.puid==e.player_uid&&(t.galaxy.fleets[i]=Af(Af({},t.galaxy.fleets[i]),s))}var o=1-K(1)/(60*$()*1e3);t.galaxy.tick_fragment=o,t.galaxy.tickFragment=o}},Ne=function(e,t){return Pf(this,void 0,void 0,(function(){var e,n;return Df(this,(function(r){switch(r.label){case 0:return void 0===NeptunesPride.originalPlayer&&(NeptunesPride.originalPlayer=NeptunesPride.universe.player.uid),e=(null==t?void 0:t.split(":")[1])||be,(be=e)?[4,Xe(e)]:[3,2];case 1:if(n=r.sent(),!xe(e,n))return[2];Se(n),NeptunesPride.np.onFullUniverse(null,NeptunesPride.universe.galaxy),NeptunesPride.npui.onHideScreen(null,!0),Id("mergeuser_init"),we(),r.label=2;case 2:return[2]}}))}))};u(">",ke,"Switch views to the last user whose API key was used to load data. The HUD shows the current user when it is not your own alias to help remind you that you aren't in control of this user.","Next User"),u("|",Ne,"Merge the latest data from the last user whose API key was used to load data. This is useful after a tick passes and you've reloaded, but you still want the merged scan data from two players onscreen.","Merge User"),v("switch_user_api",ke),v("merge_user_api",Ne),v("view_game",(function(e,t){return Pf(this,void 0,void 0,(function(){var e,n,r,i=this;return Df(this,(function(s){switch(s.label){case 0:return e=null==t?void 0:t.split(":")[1],NeptunesPride.gameNumber=e,[4,rt()];case 1:return n=s.sent(),function(){for(var e in ld)delete ld[e];for(var e in hd)delete hd[e]}(),tt=n[e].map((function(e){return"[[api:".concat(e,"]]")})),r=0,n[e].forEach((function(e){return Pf(i,void 0,void 0,(function(){var t,n;return Df(this,(function(i){switch(i.label){case 0:return[4,_d(e)];case 1:return i.sent(),(t=dd(e))>0?(console.log("".concat(t," scans for ").concat(e," cached")),n=Sd(e,t-1),console.log({lastScan:n}),(null==n?void 0:n.tick)>r&&(r=n.tick,console.log("New maxtick found: ".concat(r)),B=r)):console.log("No scans found for ".concat(e)),[2]}}))}))})),Me(null,"0"),[2]}}))}))}));var Ie=-1,Ce={},Ae=function(e){var t=60*$()*1e3,n=H(e)*t,r=e.now-n;return Af(Af({},e),{now:r,tick_fragment:0,tickFragment:0})},Pe=function(e,t,n){var r=ff(t);if(!dd(r))return null;var i="back"===n?dd(r)-1:0;void 0!==Ce[t]&&(i=Ce[t]);var s=Sd(r,i);if((s=Ae(s)).tick<e)for(;s.tick<e&&"forwards"===n;){if(++i===dd(r))return Ce[t]=void 0,null;s=Sd(r,i),s=Ae(s)}else if(s.tick>e)for(;s.tick>e&&"back"===n;){if(--i<0)return Ce[t]=void 0,null;s=Sd(r,i),s=Ae(s)}return Ce[t]=i,ed(s)},De=function(e){if(Ie>B){if("forwards"===e){var t=Ie-NeptunesPride.universe.galaxy.tick;If();var n=function(e,t){var n,r,i,s,o=Sf(Sf({},e),{futureTime:!0});if(t<=0)return console.error("Future time machine going backwards NIY"),Id("error_back_to_the_future"),o;var a=Sf({},o.stars),c=Sf({},o.fleets),u=Sf({},o.players);qd()&&uf(0,o);for(var l=0;l<t;++l){var h={};for(var d in xf(o,h,o.tick+1),o.tick+=1,o.production_counter+=1,o.now+=60*e.tick_rate*1e3,a){var f=a[d];if(Cf(j=Sf({},f))&&Cf(f)&&j.i>0){var p=o.production_rate,g=j.i*(sf(u[f.puid],"manufacturing").level+5)/p,m=void 0!==j.c?j.c:j.yard;j.st+=g+m,j.c=j.st-Math.floor(j.st),j.st=Math.floor(j.st),j.totalDefenses+=j.st-f.st,a[d]=j}void 0!==(G=h[d])&&(Cf(j)&&(j.st=G.st),j.puid=G.puid,a[d]=j)}for(var y in c){var v=Sf(Sf({},c[y]),{l:c[y].loop});if(c[y].o.length>0&&void 0!==a[c[y].o[0][1]]){var w=c[y].o[0],b=w[0],_=w[1],T=w[2],E=w[3],k=a[_];(null==v?void 0:v.orbiting)&&(Cf(v.orbiting)&&Cf(k)&&(v.warpSpeed=v.orbiting.ga===k.ga?k.ga:0),v.w=v.warpSpeed,v.uid===(null===(r=NeptunesPride.universe.selectedFleet)||void 0===r?void 0:r.uid)&&console.log("Fleet ".concat(v.n," @ warp ").concat(v.w," ETA ").concat(v.etaFirst," to ").concat(_)));var x=[parseFloat(k.x),parseFloat(k.y)],S=x[0],N=x[1],I=[v.x,v.y],C=I[0],A=I[1];if(v.etaFirst>1){if(b>0)v.o=Nf([],v.o,!0),v.o[0]=[b-1,_,T,E];else{var P=[parseFloat(v.x),parseFloat(v.y)],D=P[0],M=P[1],R=[S-D,N-M],O=R[0],L=R[1];v.uid===(null===(i=NeptunesPride.universe.selectedFleet)||void 0===i?void 0:i.uid)&&console.log("Fleet ".concat(v.n," flying @ warp ").concat(v.w," ETA ").concat(v.etaFirst," to ").concat(k.n," @ ").concat(O,",").concat(L," ").concat(o.fleet_speed));var F=(K=o.fleet_speed*(v.warpSpeed?3:1))/Math.sqrt(O*O+L*L),V=[O*F,L*F],U=V[0],B=V[1];v.x=String(D+U),v.y=String(M+B),v.ouid=void 0}v.etaFirst-=1,v.eta-=1}else{var j=Sf({},k);v.x=String(S),v.y=String(N);var q=v.o[0];if(v.o=v.o.slice(1),1===v.l&&v.o.push(q),void 0!==(null==(G=h[_])?void 0:G.fleetStrength[v.uid])&&(v.st=G.fleetStrength[v.uid]),v.ouid=_,v.puid===j.puid&&v.st>0&&Cf(j)){var $=0;switch(T){case Qd.Nothing:break;case Qd.CollectAll:$=-j.st;break;case Qd.Collect:$=-E;break;case Qd.CollectAllBut:$=Math.min(0,-j.st+E);break;case Qd.DropAll:$=v.st;break;case Qd.Drop:$=E;break;case Qd.DropAllBut:$=Math.max(0,v.st-E);break;case Qd.Garrison:$=-j.st+E}$=Math.max(-j.st,$),$=Math.min(v.st-1,$),v.st-=$,j.st+=$}if(v.o.length>0){var H=a[c[y].o[0][1]];Cf(H)&&Cf(k)&&(v.warpSpeed=H.ga===k.ga?H.ga:0),v.w=v.warpSpeed;var K=o.fleet_speed*(v.warpSpeed?3:1);v.etaFirst=b+Math.ceil(af(k,H)/K),v.uid===(null===(s=NeptunesPride.universe.selectedFleet)||void 0===s?void 0:s.uid)&&console.log("Fleet ".concat(v.n," @ warp ").concat(v.w," ETA ").concat(v.etaFirst," to ").concat(H.n))}else v.etaFirst=0;a[_]=j}n=[C,A],v.lx=n[0],v.ly=n[1],c[y]=v}else if(c[y].orbiting){var G;void 0!==(null==(G=h[c[y].ouid])?void 0:G.fleetStrength[v.uid])&&(v.st=G.fleetStrength[v.uid],c[y]=v)}0===c[y].st&&delete c[y]}for(var z in u)if(void 0!==u[z].researching){(X=u[z]=Sf({},u[z])).tech=Sf({},X.tech),uf(X.alias,X);var W=X.tech[X.researching]=Sf({},X.tech[X.researching]);W.research+=X.total_science;var Q=cf(Sf(Sf({},W),{brr:W.brr,level:W.level+(qd()?0:1)}));W.research>=Q&&(W.research-=Q,W.level+=1,X.researching=X.researching_next)}if(o.production_counter>=o.production_rate){for(var z in u){var X;void 0!==u[z].cash&&((X=u[z]=Sf({},u[z])).cashPerDay?X.cash+=X.cashPerDay:X.cash+=10*X.total_economy+75*sf(X,"banking").level)}o.production_counter=0}}return o.stars=a,o.fleets=c,o.players=u,o}(NeptunesPride.universe.galaxy,t);NeptunesPride.np.onFullUniverse(null,n)}else"back"===e&&Me(null,"".concat(B));return NeptunesPride.np.trigger("map_rebuild"),!1}var r=tt.map((function(t){return function(e,t){return Pe(Ie,e,t)}(t,e)})).filter((function(e){return e&&e.tick===Ie}));if(0===r.length)return NeptunesPride.np.trigger("map_rebuild"),!1;var i=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid,s=r.filter((function(e){return e.player_uid===i})),o=s.length>0?s[0]:r[0];NeptunesPride.np.onFullUniverse(null,o),NeptunesPride.gameConfig.name=NeptunesPride.universe.galaxy.name,console.log("RESET game name to ".concat(NeptunesPride.gameConfig.name)),r.forEach((function(e){Se(e)})),NeptunesPride.np.onFullUniverse(null,NeptunesPride.universe.galaxy),Id("timetravel_init"),we()},Me=function(e,t){Ie=parseInt(t);var n=NeptunesPride.universe.galaxy.tick;Ie<n?De("back"):Ie>n&&De("forwards")};v("warp_time",Me),u("ctrl+,",(function(){-1===Ie&&(Ie=NeptunesPride.universe.galaxy.tick),NeptunesPride.gameConfig.turnBased?Ie-=NeptunesPride.gameConfig.turnJumpTicks:Ie-=1,Ie<0&&(Ie=0),De("back")}),"Go back a tick in time.","Time Machine: Back"),u("ctrl+.",(function(){NeptunesPride.gameConfig.turnBased?Ie+=NeptunesPride.gameConfig.turnJumpTicks:(-1===Ie&&(Ie=NeptunesPride.universe.galaxy.tick),Ie+=1),De("forwards")}),"Go forward a tick in time.","Time Machine: Forward"),u("ctrl+m",(function(){-1===Ie&&(Ie=NeptunesPride.universe.galaxy.tick),(Ie-=NeptunesPride.gameConfig.productionTicks)<0&&(Ie=0),De("back")}),"Go back in time a full cycle (".concat(NeptunesPride.gameConfig.productionTicks," ticks)."),"Time Machine: -".concat(NeptunesPride.gameConfig.productionTicks," ticks")),u("ctrl+/",(function(){Ie+=NeptunesPride.gameConfig.productionTicks,De("forwards")}),"Go forward a full cycle (".concat(NeptunesPride.gameConfig.productionTicks," ticks)."),"Time Machine: +".concat(NeptunesPride.gameConfig.productionTicks," ticks"));var Oe="";v("order:api_code",(function(e,t){var n;return Pf(this,void 0,void 0,(function(){var e,r,i,s;return Df(this,(function(o){switch(o.label){case 0:return[4,Xe(t)];case 1:return e=o.sent(),xe(t,e)?(Oe=t,r=null===(n=NeptunesPride.account)||void 0===n?void 0:n.user_id,wd(Oe,r),i=NeptunesPride.universe.player.color,s="Your new API key is ".concat(t,".\n\n[[api:").concat(t,"]]"),NeptunesPride.inbox.trigger("server_request",{type:"create_game_message",from_color:i,to_uids:"",to_aliases:"",to_colors:"",subject:"API Key Generated",body:s})):(console.error("Failed to load our own scan data?"),Oe=""),[2]}}))}))}));var Le=0,Fe=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o;return Df(this,(function(a){switch(a.label){case 0:return(e=(new Date).getTime())-Le<3e5?(console.log("refreshScanData called too recently, STOP"),j(NeptunesPride.universe.galaxy),[2]):(Le=e,[4,Te.keys()]);case 1:t=a.sent(),n=t.filter((function(e){return e.startsWith("API:")})),r=n.map((function(e){return parseInt(e.substring(4))})),i=0,a.label=2;case 2:return i<r.length?[4,Te.get(n[i])]:[3,5];case 3:s=a.sent(),Xe(s),o=r[i],NeptunesPride.originalPlayer&&NeptunesPride.originalPlayer==o&&(Oe=s),NeptunesPride.originalPlayer||NeptunesPride.universe.player.uid!=o||(Oe=s),a.label=4;case 4:return++i,[3,2];case 5:return j(NeptunesPride.universe.galaxy),[2]}}))}))};v("refresh_interface",Fe);var Ve={bank:"Banking",manu:"Manu",prop:"Range",rese:"Exp",scan:"Scan",terr:"Terra",weap:"Weapons",0:"Banking",1:"Exp",2:"Manu",3:"Range",4:"Scan",5:"Weapons",6:"Terra"},Ue={bank:"💰",manu:"🔧",prop:"🚀",rese:"🧪",scan:"📡",terr:"🌎",weap:"⚔️",0:"💰",1:"🧪",2:"🔧",3:"🚀",4:"📡",5:"⚔️",6:"🌎"},Be=function(e){return Ve[e.substring(0,4)]},je=function(e){return console.log("name key [".concat(e,"]")),Ue[e.substring(0,4)]},qe=function(e){return"proteus"===NeptunesPride.gameVersion?e*e*5:e*(NeptunesPride.gameConfig.tradeCost||NeptunesPride.universe.galaxy.config.tradeCost)},$e=function(e,t,n){e.push("--- ".concat(n," ---"));for(var r=":--",i=0;i<t.length;++i)r+="|--";e.push(r);var s=NeptunesPride.universe.player.uid;r="Technology|[[#".concat(s,"]]|[[#").concat(s,"]]");var o={},a={},c=[];for(i=0;i<t.length;++i){var u=t[i];u!==s&&(r+="|[[#".concat(u,"]]"),o[u]=0,a[u]=0,c.push(u))}e.push(r);var l=[],h=NeptunesPride.universe.player.tech;c.forEach((function(e){var t=NeptunesPride.universe.galaxy.players[e],n=t.tech;Object.keys(t.tech).map((function(t,r){l[r]||(l[r]=Be(t),l[r]+="|".concat(h[t].level),l[r]+="|".concat(h[t].research,"/").concat(cf(h[t])));var i=n[t].level;if(i<h[t].level){l[r]+="|[[sendtech:".concat(e,":").concat(t,":").concat(i,"]]");for(var s=i;s<h[t].level;++s)a[e]+=qe(s+1)}else if(i>h[t].level){var c=qe(h[t].level+1);for(l[r]+="|[[sendcash:".concat(e,":").concat(c,":").concat(i,"]]"),s=i;s>h[t].level;--s)o[e]+=qe(s)}else l[r]+="|".concat(i)}))}));var d=Mf(["[[footer:Pay for all]]","",""],c.map((function(e){return o[e]>0?"[[sendcash:".concat(e,":").concat(o[e],":").concat(o[e],"]]"):""})),!0),f=Mf(["[[footer:Send all]]","",""],c.map((function(e){return a[e]>0?"[[sendalltech:".concat(e,":").concat(a[e],"]]"):""})),!0);l.forEach((function(t){return e.push([t])})),e.push([d.join("|")]),e.push([f.join("|")]),e.push("--- ".concat(n," ---"))},He=function(){var e,t;return NeptunesPride.gameConfig.tradeScanned||"proteus"===NeptunesPride.gameVersion||(null===(t=null===(e=NeptunesPride.universe.galaxy)||void 0===e?void 0:e.config)||void 0===t?void 0:t.tradeScanned)},Ke=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c;return Df(this,(function(u){switch(u.label){case 0:return b="trading",[4,Je()];case 1:for(e=u.sent(),t=e.players,n=e.playerIndexes,$e(r=[],n,"Allied Technology"),i=Object.keys(t),s=He()?"Scanned ":"",He()&&(i=i.filter((function(e){return qd()?NeptunesPride.universe.player.scannedPlayers[t[e].uid]:NeptunesPride.universe.player.scannedPlayers.indexOf(t[e].uid)>=0}))),o=0;o<i.length;)a=i.slice(o,o+5),c=a.map((function(e){return t[e].uid})),$e(r,c,"".concat(s,"Players ").concat(o," - ").concat(o-1+a.length)),o+=a.length;return N("trading",r),[2]}}))}))};u("e",Ke,"The trading report lets you review where you are relative to others and provides shortcuts to ease trading of tech as needed.","trading");var Ge=function(e,t,n){var r=[["total_stars","[[:star:]]"],["total_strength","[[:carrier:]]"],["shipsPerTick","[[:carrier:]]/h"],["cashPerDay","$"],["total_economy","E"],["total_industry","I"],["total_science","S"]];qd()||(r=r.filter((function(e){return"cashPerDay"!==e[0]})));var i=[],s=r.map((function(e){return 0}));i.push("--- ".concat(n," ---"));for(var o=":--",a=0;a<r.length;++a)o+="|--";for(i.push(o),o="Empire",a=0;a<r.length;++a)o+="|".concat(r[a][1]);i.push(o);var c=NeptunesPride.universe.player;t.forEach((function(e){var t=["[[".concat(e,"]]")],n=NeptunesPride.universe.galaxy.players[e];r.map((function(e){return e[0]})).forEach((function(e,r){var i=+c[e],o=+n[e];s[r]+=o,o<i?t.push("[[good:".concat(o,"]]")):o>i?t.push("[[bad:".concat(o,"]]")):t.push("".concat(o))})),i.push([t.join("|")])}));var u=s.map((function(e){return Math.trunc(e)}));return i.push([Mf(["[[footer:Total]]"],u,!0).join("|")]),i.push("--- ".concat(n," ---")),e.push(i.flat()),Mf(["".concat(n)],u,!0)},ze=function(){var e=NeptunesPride.universe.galaxy.players,t=Object.keys(NeptunesPride.universe.galaxy.players),n=void 0!==e[0]?0:1,r="color"===g.allianceDiscriminator?ue.slice(n,t.length):le.slice(n,t.length);if("color"===g.allianceDiscriminator&&g.whitePlayer){var i=NeptunesPride.universe.player;r[i.uid]=i.prevColor}var s=r.map((function(e,t){return[e,t+n]})).sort(),o={};return s.forEach((function(t){var n=e[t[1]];(n.total_stars||n.total_strength)&&(void 0===o[t[0]]?o[t[0]]=[t[1]]:o[t[0]].push(t[1]))})),o},We=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,w;return Df(this,(function(_){switch(_.label){case 0:return b="empires",e=[],t=[],n=function(e,n,r){var i=Ge(e,n,r);t.push(i)},[4,Je()];case 1:for(c in r=_.sent(),i=r.players,(s=r.playerIndexes).length>1&&Ge(e,s,"Allied Empires"),o=[],a=ze())1===(u=a[c]).length?o.push(u[0]):-1!==ce.indexOf(c)?o.push.apply(o,u):(l=u.filter((function(e){return 1!==i[e].ai})),h="[[mail:".concat(u.join(":"),"]] Alliance ").concat(u.map((function(e){return"[[#".concat(e,"]]")})).join("")),d=l.length>0?h:"AI",n(e,u,d));return Ge(e,o,"Unallied Empires"),f=Object.keys(NeptunesPride.universe.galaxy.players),p=f.filter((function(e){return i[e].total_strength>0})).map((function(e){return+e})),e.length>0&&(g="--- All Alliances [[Tick #".concat(NeptunesPride.universe.galaxy.tick,"]] ---"),(m=[g]).push(e[0][1]),m.push(e[0][2].replace("Empire","Alliance")),y=NeptunesPride.universe.player,v="[[#".concat(y.uid,"]]"),w=[],t.forEach((function(e){-1!==e[0].indexOf(v)&&w.push.apply(w,e)})),t.forEach((function(e){for(var t=e[0],n=1;n<e.length;++n){var r=e[n],i=w[n],s=r<i?"[[good:".concat(r,"]]"):r>i?"[[bad:".concat(r,"]]"):"".concat(r);t+="|".concat(s)}m.push(t)})),m.push(g),e.push(m.map((function(e){return e.replace(/..mail.*]] Alliance /,"")})))),Ge(e,p,"All Surviving Empires"),N("empires",e),[2]}}))}))};u("ctrl+l",We,"The empires report summarizes all key empire stats. It's meant to be a better leaderboard for seeing how the individual empires are doing.","empires");var Qe=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h;return Df(this,(function(d){switch(d.label){case 0:return b="signatures",e=[],t=function(e,t,n){var r=NeptunesPride.universe.player,i=Object.keys(r.tech).map((function(e){return[e,je(e)]})),s=[];s.push("--- ".concat(n," ---"));for(var o=":--",a=0;a<i.length;++a)o+="|--";for(s.push(o),o="Empire",a=0;a<i.length;++a)o+="|".concat(i[a][1]);s.push(o);var c={levels:{},medians:{},summary:[]};i.map((function(e){return e[0]})).forEach((function(e){return c.levels[e]=[]})),t.forEach((function(e){var t=NeptunesPride.universe.galaxy.players[e].tech;i.map((function(e){return e[0]})).forEach((function(e){c.levels[e].push(t[e].level)}))})),i.map((function(e){return e[0]})).forEach((function(e){c.levels[e].sort((function(e,t){return+e-+t}));var t=Math.ceil(c.levels[e].length/2);c.medians[e]=c.levels[e][t],c.summary.push(c.medians[e])})),t.forEach((function(e){var t=["[[".concat(e,"]]")],n=NeptunesPride.universe.galaxy.players[e].tech;i.map((function(e){return e[0]})).forEach((function(e,r){var i=c.medians[e],s=n[e].level;s<i?t.push("[[bad:".concat(s,"]]")):s>i?t.push("[[good:".concat(s,"]]")):t.push("".concat(s))})),s.push([t.join("|")])})),s.push([Mf(["[[footer:Signature]]"],c.summary,!0).join("|")]),s.push("--- ".concat(n," ---")),e.push(s.flat())},[4,Je()];case 1:for(s in n=d.sent().players,r=[],i=ze())1===(o=i[s]).length?r.push(o[0]):-1!==ce.indexOf(s)?r.push.apply(r,o):(a=o.filter((function(e){return 1!==n[e].ai})),c="[[mail:".concat(o.join(":"),"]] Alliance ").concat(o.map((function(e){return"[[#".concat(e,"]]")})).join("")),u=a.length>0?c:"AI",t(e,o,u));return l=Object.keys(NeptunesPride.universe.galaxy.players),h=l.filter((function(e){return n[e].total_strength>0})).map((function(e){return+e})),t(e,h,"All Empires"),N("signatures",e),[2]}}))}))};u("ctrl+g",Qe,"The group tech report summarizes the technology levels of all empires. Use it to double check alliaces or look for trading partners.","signatures"),NeptunesPride.sendTech=function(e,t){var n=NeptunesPride.universe,r=n.galaxy.players;n.selectedPlayer=r[e];var i=NeptunesPride.npui.EmpireTrade(n.selectedPlayer);i.techSelection.setValue(t),i.onPreTradeTech()},NeptunesPride.sendAllTech=function(e){NeptunesPride.templates.confirm_send_bulktech="Are you sure you want to send<br>[[alias]]<br>[[techs]]?";var t=NeptunesPride.npui,n=NeptunesPride.universe.galaxy.players[e],r=[],i=NeptunesPride.universe.player.tech,s=n.tech;r=Object.keys(n.tech).filter((function(e){return s[e].level<i[e].level})),t.trigger("hide_screen");var o={message:"confirm_send_bulktech",messageTemplateData:{techs:r.map(Be).join(", "),alias:(n.colourBox||n.colorBox)+n.hyperlinkedRawAlias},eventKind:"send_bulktech",eventData:{targetPlayer:n,techs:r},notification:!1,returnScreen:"empire"};t.trigger("show_screen",["confirm",o])},v("send_bulktech",(function(e,t){for(var n=NeptunesPride.universe,r=NeptunesPride.np,i=t.targetPlayer,s=NeptunesPride.universe.player,o=0;o<t.techs.length;++o)for(var a=t.techs[o];i.tech[a].level<s.tech[a].level;){var c=(i.tech[a].level+1)*n.galaxy.trade_cost;if(!(n.player.cash>=c))break;i.tech[a].level+=1,n.player.cash-=c,r.trigger("server_request",{type:"order",order:"share_tech,".concat(i.uid,",").concat(a)})}n.selectPlayer(i),r.trigger("refresh_interface")})),NeptunesPride.sendCash=function(e,t){NeptunesPride.templates.confirm_send_cash="Are you sure you want to send<br>[[alias]]<br>$[[amount]] credits?";var n=NeptunesPride.npui,r=NeptunesPride.universe.galaxy.players[e];n.trigger("hide_screen");var i={message:"confirm_send_cash",messageTemplateData:{amount:t,alias:(r.colourBox||r.colorBox)+r.hyperlinkedRawAlias},eventKind:"send_money",eventData:{targetPlayer:r,amount:t},notification:!1,returnScreen:"empire"};n.trigger("show_screen",["confirm",i])};var Xe=function(e){return Pf(this,void 0,void 0,(function(){var t,n,r,i,s,o;return Df(this,(function(a){switch(a.label){case 0:return t="CACHED_".concat(e),[4,Te.get(t)];case 1:return(n=a.sent())?(r=(new Date).getTime()-n.now,i=(1-H(n))*$()*60*1e3,(s=r<i&&r<3e5)?[4,Wd(n.now)]:[3,3]):[3,4];case 2:s=!a.sent(),a.label=3;case 3:return s?(console.log("Cache hit! ".concat(t)),[2,n]):[3,5];case 4:if(console.log("Cache miss! ".concat(t)),"badkey"===e)return[2,void 0];Id("unexpected_cache_miss_".concat(t)),a.label=5;case 5:return[4,Cd("https://np.ironhelmet.com/api",{game_number:_e,api_version:"0.1",code:e})];case 6:return o=a.sent(),[4,Te.set(t,o.scanning_data)];case 7:return a.sent(),[2,o.scanning_data]}}))}))},Ye=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r;return Df(this,(function(i){switch(i.label){case 0:return[4,Te.keys()];case 1:return e=i.sent(),t=NeptunesPride.universe.galaxy.players,n=e.filter((function(e){return e.startsWith("API:")&&0===t[(n=e,parseInt(n.substring(4)))].conceded;var n})),r=n.map((function(e){return parseInt(e.substring(4))})),[2,{players:t,apiKeys:n,playerIndexes:r}]}}))}))},Je=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h;return Df(this,(function(d){switch(d.label){case 0:return e=NeptunesPride.universe.galaxy,t=e.players[e.player_uid],n=ze(),[4,Ye()];case 1:for(i in r=d.sent(),n)if(-1!==(s=n[i]).indexOf(t.uid)){for(console.log("Alliance should be ".concat(i,": "),s),o=NeptunesPride.universe.galaxy.players,a=[],c=[],u=0;u<r.playerIndexes.length;++u)l=r.playerIndexes[u],h=r.apiKeys[u],-1!==s.indexOf(l)&&(c.push(l),a.push(h));return c.length!==s.length?(console.error("Missing API key for an alliance member.",c,r),[2,r]):[2,{players:o,apiKeys:a,playerIndexes:c}]}return[2,r]}}))}))},Ze=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,w,_,T,E,k,x,S;return Df(this,(function(I){switch(I.label){case 0:return b="research",[4,Je()];case 1:e=I.sent(),t=e.players,n=e.apiKeys,r=e.playerIndexes,(i=[]).push("--- Alliance Research Progress ---"),i.push(":--|:--|--:|--:|--:|--"),i.push("Empire|Tech|ETA|Progress|Sci|⬆S"),s=function(e){var s,o,a,c,u,l,h,d,f,p,g,m,y,v,w,b,_;return Df(this,(function(T){switch(T.label){case 0:return s=r[e],o=t[s],[4,Te.get(n[e])];case 1:return a=T.sent(),[4,Xe(a)];case 2:if(c=T.sent()){for(u=c.players[s],l=u.tech[u.researching],h=l.research,d=cf(l),f=d-h,p=o.total_science,g=function(e){return"proteus"===NeptunesPride.gameVersion?e*u.tech.research.level:e},m=Math.ceil(f/g(p)),y=c.tick+m,v="",w=1;w<10;++w)if((b=Math.ceil(f/g(p+w)))<m){v="".concat(w,'<sub style="font-size: 50%">').concat(m-b,"</sub>");break}_=Be(u.researching),i.push(["[[".concat(s,"]]|").concat(_,"|[[Tick #").concat(y,"]]|").concat(h,"/").concat(d,"|").concat(o.total_science,"|").concat(v)])}return[2]}}))},p=0,I.label=2;case 2:return p<r.length?[5,s(p)]:[3,5];case 3:I.sent(),I.label=4;case 4:return++p,[3,2];case 5:for(i.push("--- Alliance Research Progress ---"),o=NeptunesPride.universe.player,a=Object.keys(o.tech),c={},u=0,l=a;u<l.length;u++)k=l[u],c[k]={level:1,research:0};p=0,I.label=6;case 6:return p<r.length?(g=r[p],t[g],[4,Te.get(n[p])]):[3,10];case 7:return m=I.sent(),[4,Xe(m)];case 8:if(!(y=I.sent()))return[3,9];for(h=y.players[g],w="[[".concat(g,"]]"),d=0,f=a;d<f.length;d++)E=f[d],(k=h.tech[E]).level===c[E].level?c[E].research=Math.max(c[E].research,k.research):k.level>c[E].level&&(c[E].level=k.level,c[E].research=k.research);I.label=9;case 9:return++p,[3,6];case 10:i.push("--- All Alliance Research ---"),i.push(":--|".concat(a.map((function(){return"--:"})).join("|"))),i.push("Empire|".concat(a.map((function(e){return"<sub>L".concat(c[e].level,"</sub> ").concat(je(e))})).join("|"))),p=0,I.label=11;case 11:return p<r.length?(g=r[p],t[g],[4,Te.get(n[p])]):[3,15];case 12:return m=I.sent(),[4,Xe(m)];case 13:if(!(y=I.sent()))return[3,14];for(v=y.players[g],w="[[".concat(g,"]]"),_=0,T=a;_<T.length;_++)E=T[_],k=v.tech[E],x=k.research,k.level===c[E].level?k.research===c[E].research&&(x="[[good:".concat(x,"]]")):x="[[bad:".concat(x,"]]"),w+="| ".concat(x),S=[],v.researching===E&&S.push(1),v.researching_next===E&&S.push(2),S.length>0&&(w+='<sub style="font-size: 50%">'.concat(S.join(","),"</sub>")),k.level<c[E].level&&(w+="<div><sub>(L".concat(k.level,")</sub></div>"));i.push([w]),I.label=14;case 14:return++p,[3,11];case 15:return i.push("--- All Alliance Research ---"),N("research",i),[2]}}))}))};u("E",Ze,"The research report shows you tech progress for allies. The ↑S column tells you how much science is needed to reduce delivery time by at least one tick.","research");var et=function(){var e;return Pf(this,void 0,void 0,(function(){var t,n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v;return Df(this,(function(w){switch(w.label){case 0:return b="accounting",[4,zd("game_event")];case 1:if(t=w.sent(),n=[],r=[],t){for(o in i={},s={},NeptunesPride.universe.galaxy.players)i[a=o]=0,s[a]=0;for(r.push("--- Cash transaction history ---"),r.push(":--|:--"),u=0;u<Rd.game_event.length;++u)"money_sent"===(l=Rd.game_event[u]).payload.template&&(h=l.payload.tick,d=l.payload.from_puid,f=l.payload.to_puid,p=l.payload.amount,d===NeptunesPride.universe.player.uid?i[f]-=p:i[d]+=p,d===NeptunesPride.universe.player.uid?r.push(["[[Tick #".concat(h,"]]|Sent $").concat(p," → [[").concat(f,"]]")]):r.push(["[[Tick #".concat(h,"]]|[[").concat(d,"]] → $").concat(p)]));for(r.push("--- Cash transaction history ---"),r.push("--- Tech transaction history ---"),r.push(":--|:--"),c={},u=0;u<Rd.game_event.length;++u)l=Rd.game_event[u],(null===(e=l.payload.template)||void 0===e?void 0:e.startsWith("peace"))&&(console.log("Peace: ",l.payload),l.payload.price?(f=l.payload.to_puid,d=l.payload.from_puid,p=l.payload.price,c[f]&&(p/=2),d===NeptunesPride.universe.player.uid?i[f]-=p:i[d]+=p,h=l.payload.tick,r.push(["[[Tick #".concat(h,"]]|Alliance Costs $").concat(p," → [[").concat(f,"]]")])):(d=l.payload.from_puid,c[d]=!0,h=l.payload.tick,r.push(["[[Tick #".concat(h,"]]|Alliance accepted by [[").concat(d,"]]")]))),"shared_technology"===l.payload.template&&(h=l.payload.tick,d=l.payload.from_puid,f=l.payload.to_puid,p=l.payload.price,g=l.payload.level,d===NeptunesPride.universe.player.uid?(i[f]-=p,s[f]-=g):(i[d]+=p,s[d]+=g),m=l.payload.name,y=Be(m),d===NeptunesPride.universe.player.uid?r.push(["[[Tick #".concat(h,"]]|").concat(y).concat(g," $").concat(p," → [[").concat(f,"]]")]):r.push(["[[Tick #".concat(h,"]]|[[").concat(d,"]] → ").concat(y).concat(g," $").concat(p)]));for(v in r.push("--- Tech transaction history ---"),n.push("--- Ledger ---"),n.push(":--|--:|--:"),n.push("Empire|Tech Levels|Credits"),i)0!==i[v]&&(i[v]>0?n.push(["[[".concat(v,"]]|").concat(s[v],"|[[sendcash:").concat(v,":").concat(i[v],":").concat(i[v],"]]")]):n.push(["[[".concat(v,"]]|").concat(s[v],"|[[good:").concat(i[v],"]]")]));n.push("--- Ledger ---\n")}else console.error("Updating message cache failed"),r.push("Message cache stale!");return N("accounting",Mf(Mf([],n,!0),r,!0)),[2]}}))}))};u("a",et,"Perform accounting and display status.","accounting");var tt=[],nt=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a;return Df(this,(function(c){switch(c.label){case 0:return b="api",[4,Te.keys()];case 1:e=c.sent(),t=e.filter((function(e){return e.startsWith("API:")})),n=[],(r=[]).push("--- Allied API Keys ---"),r.push(":--|--:|--:"),r.push("Empire|View|Merge"),i=0,c.label=2;case 2:return i<t.length?(s=t[i],o=s.substring(4),[4,Te.get(s)]):[3,5];case 3:a=c.sent(),n.push(a),r.push(["[[".concat(o,"]]|[[apiv:").concat(a,"]]|[[apim:").concat(a,"]]")]),c.label=4;case 4:return++i,[3,2];case 5:return r.push("--- Allied API Keys ---"),r.push("--- All Seen Keys ---"),r.push(":--|--:|--:"),r.push("Empire|Merge|Last?"),tt.forEach((function(e){var t="Unknown",n="❌",i=ff(e);if(dd(i)>0){var s=dd(i)-1,o=Sd(i,s),a=null==o?void 0:o.eof,c=null==o?void 0:o.player_uid;for(n="[[Tick #".concat(null==o?void 0:o.tick,"]]");(void 0===c||a)&&--s>0;){var u=Sd(i,s);a=null==u?void 0:u.eof,void 0!==(c=null==u?void 0:u.player_uid)&&(n="Dead @ [[Tick #".concat(u.tick,"]]"))}t="[[".concat(c,"]]")}var l=e.replace(":","m:");r.push(["".concat(t,"|").concat(l,"|").concat(n)])})),r.push("--- All Seen Keys ---"),N("api",r),[2]}}))}))};u("k",nt,"Show known API keys.","api");var rt=function(){var e;return Pf(this,void 0,void 0,(function(){var t,n,r,i,s,o,a,c,u,l,h;return Df(this,(function(d){switch(d.label){case 0:return[4,indexedDB.databases()];case 1:for(s in t=d.sent(),n={},t.forEach((function(e){if(/^[0-9]+:[0-9A-Za-z]{6}$/.test(e.name)){var t=e.name.match(/^[0-9]+/)[0],r=e.name.match(/[0-9A-Za-z]+$/)[0];n[t]||(n[t]=[]),n[t].push(r)}})),i=[],r=n)i.push(s);o=0,d.label=2;case 2:if(!(o<i.length))return[3,7];if(!((s=i[o])in r))return[3,6];c=0,u=n[a=s],d.label=3;case 3:return c<u.length?(l=u[c],void 0!==n[a].name?[3,5]:[4,md(+a,l,"scanCache")]):[3,6];case 4:h=d.sent(),n[a].name=null===(e=null==h?void 0:h.cached)||void 0===e?void 0:e.name,d.label=5;case 5:return c++,[3,3];case 6:return o++,[3,2];case 7:return[2,n]}}))}))},it=function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r;return Df(this,(function(i){switch(i.label){case 0:return b="games",(e=[]).push("Past Games: "),[4,rt()];case 1:for(n in t=i.sent())r=t[n].name,e.push("[[viewgame:".concat(n,":").concat(r,"]]"));return N("games",e),[2]}}))}))};u("ctrl+g",it,"Show past games.","games"),u("(",(function(){return Pf(this,void 0,void 0,(function(){var e,t,n,r;return Df(this,(function(i){switch(i.label){case 0:return[4,Te.keys()];case 1:e=i.sent(),t=e.filter((function(e){return e.startsWith("API:")})),n=0,i.label=2;case 2:return n<t.length?(r=t[n],[4,Te.get(r)]):[3,5];case 3:be=i.sent(),Ne(),i.label=4;case 4:return++n,[3,2];case 5:return[2]}}))}))}),"Merge all data from known API keys.","Merge All");var st=function(){var e=["<H1>".concat(f,"</H1>")];e.push(" Neptune's Pride Agent is meant to help you focus on"),e.push(" diplomacy and spend less time doing tedious calculations"),e.push(" or manually sharing information."),e.push("<h1>Hotkey Reference</h1>"),l().forEach((function(t){var n=h(t),r=Crux.format("[[goto:".concat(t,"]]"),{});"?"===t&&(r=Crux.format("[[hotkey:".concat(t,"]]"),{})),e.push("<h2>Hotkey: ".concat(t," ").concat(r,"</h2>")),n.help?e.push(n.help):e.push("<p>No documentation yet.<p><code>".concat(n.toLocaleString(),"</code>"))})),NeptunesPride.universe.helpHTML=e.join(""),NeptunesPride.np.trigger("show_screen","help")};u("?",st,"Display this help screen.","help");var ot,at,ct,ut,lt,ht,dt=function(){var e=[];e.push("--- Controls ---"),e.push(":--|--|--:"),e.push("Button||Hotkey");var t=document.createElement("div");l().forEach((function(n){var r="[[goto:".concat(n,"]]");"?"===n&&(r="[[hotkey:".concat(n,"]]")),"<"===n?n="&lt;":">"===n?n="&gt;":"&"===n?n="&amp;":1===n.length?n="&#".concat(n.charCodeAt(0),";"):(console.log({key:n}),t.innerText=n,n=t.innerHTML);var i="".concat(r,"||").concat(n);e.push([i])})),e.push("--- Controls ---"),N("controls",e)};u("~",dt,"Generate NPA Buttons.","controls"),ot=document.body,at=NeptunesPride,ct=function(){return Oe},ut=0,lt=null,ht=function(){lt=null},ot.addEventListener("keyup",(function(e){var t=e.target;if("textarea"===t.type){var n=e.key;if("]"!=n&&ht(),"]"===n||":"===n){if(ut<=0){if((ut=t.value.lastIndexOf("[[",t.selectionStart-1)+2)<=1)return void(ut=0);var r=t.value.indexOf("[[",ut),i=t.value.indexOf("]]",ut);if(i>-1&&(-1==r||i<r))return void(ut=0)}var s=ut,o=t.selectionStart;"]"===n&&(o-=1);var a=t.value.substring(s,o),c=a.match(/^[0-9][0-9]*$/);if(null==c?void 0:c.length){var u=Number(a),l=t.selectionEnd,h="".concat(u,"]] ").concat(at.universe.galaxy.players[u].alias);t.value=t.value.substring(0,s)+h+t.value.substring(l,t.value.length),t.selectionStart=s+h.length,t.selectionEnd=s+h.length,ut=0}else if("]"===n){if(null===lt){lt=[];var d=function(e){return e.toLocaleLowerCase().substring(0,a.length)==a.toLocaleLowerCase()};for(var f in at.universe.galaxy.stars){var p=at.universe.galaxy.stars[f];d(p.n)&&lt.push({matchPriority:1,matchText:p.n,completion:"[[".concat(p.n,"]]")})}for(var g in at.universe.galaxy.players){var m=at.universe.galaxy.players[g];d(m.alias)&&lt.push({matchPriority:0,matchText:m.alias,completion:"[[".concat(g,"]] ").concat(m.alias)})}lt.sort((function(e,t){return e.matchPriority===t.matchPriority?e.matchText<t.matchText?-1:e.matchText>t.matchText?1:0:e.matchPriority-t.matchPriority}))}if(lt.length>0){var y=lt.shift();return l=t.selectionEnd,t.value=t.value.substring(0,s-2)+y.completion+t.value.substring(l,t.value.length),t.selectionStart=s-2+y.completion.length,t.selectionEnd=s-2+y.completion.length,void lt.push(y)}}ut=0,(null==(c=a.match(/api:/))?void 0:c.length)&&ct()&&(h="api:".concat(ct(),"]]"),l=t.selectionEnd,t.value=t.value.substring(0,s)+h+t.value.substring(l,t.value.length),t.selectionStart=s+h.length,t.selectionEnd=s+h.length)}else if(t.selectionStart>1){s=t.selectionStart-2;var v=t.value.substring(s,s+2);ut="[["===v?t.selectionStart:0}}})),ot.addEventListener("blur",ht),Bd("game_event").then((function(){return zd("game_event")})).then((function(){return zd("game_diplomacy")})).then((function(){window.setTimeout((function(){return Pf(d,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c=this;return Df(this,(function(u){switch(u.label){case 0:return[4,Te.keys()];case 1:e=u.sent(),t=e.filter((function(e){return e.startsWith("API:")})),tt=(null===(a=Od.api)||void 0===a?void 0:a.flatMap((function(e){var t;return(e.message.body||(null===(t=e.message.payload)||void 0===t?void 0:t.body)).match(/\[\[api:\w\w\w\w\w\w\]\]/)})).filter((function(e){return e})).filter((function(e,t,n){return n.indexOf(e)===t})))||[],console.log("Probable API Keys: ",tt),n=0,r=t,u.label=2;case 2:return n<r.length?(i=r[n],[4,Te.get(i)]):[3,5];case 3:s=u.sent(),o="[[api:".concat(s,"]]"),-1===tt.indexOf(o)&&tt.push(o),u.label=4;case 4:return n++,[3,2];case 5:return console.log("Probable API Keys II: ",tt),tt.forEach((function(e){return Pf(c,void 0,void 0,(function(){var t;return Df(this,(function(n){switch(n.label){case 0:return[4,_d(t=ff(e))];case 1:return n.sent(),dd(t)>0?(console.log("Scans for ".concat(t," cached")),[2]):(console.log("Scans for ".concat(t," not cached yet, register for them")),wd(t),[2])}}))}))})),[2]}}))}))}),1e3)})),void 0!==(null===(i=null===(r=NeptunesPride.universe)||void 0===r?void 0:r.player)||void 0===i?void 0:i.uid)&&(console.log("Universe already loaded, refresh scan data."),Fe().then((function(){Oe?(console.log("Loading scan data for key ".concat(Oe)),_d(Oe)):console.log("API Key unknown. No scan history.")})));var ft=window.setTimeout;window.setTimeout=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return-1!==(null==e?void 0:e.toLocaleString().indexOf("autocompleteTrigger"))?(console.log("SAT duplicate code detected. Ignore it."),0):ft(e,t,n)},(null===(a=NeptunesPride.universe)||void 0===a?void 0:a.galaxy)&&NeptunesPride.npui.map?(console.log("Universe already loaded. Hyperlink fleets & load hooks."),Id("loaded_init"),we()):console.log("Universe not loaded. Rely on onServerResponse."),console.log("Neptune's Pride Agent injection fini.")}()}()}();
