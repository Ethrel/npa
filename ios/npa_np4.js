// ==UserScript==
// @name        Neptune's Pride Agent
// @description HUD and reporting for Neptune's Pride.
// @match       https://neptunespride4.appspot.com/*
// @version     2.2.11
// @updateURL   https://raw.githubusercontent.com/anicolao/npa/futuresquish/ios/npa_np4.js
// ==/UserScript==
/*! For license information please see intel.js.LICENSE.txt */
!function(){var e={441:function(e,t,n){var r;!function(i,s,o){if(i){for(var a,c={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},u={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},l={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},h={option:"alt",command:"meta",return:"enter",escape:"esc",plus:"+",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},d=1;d<20;++d)c[111+d]="f"+d;for(d=0;d<=9;++d)c[d+96]=d.toString();w.prototype.bind=function(e,t,n){var r=this;return e=e instanceof Array?e:[e],r._bindMultiple.call(r,e,t,n),r},w.prototype.unbind=function(e,t){return this.bind.call(this,e,(function(){}),t)},w.prototype.trigger=function(e,t){var n=this;return n._directMap[e+":"+t]&&n._directMap[e+":"+t]({},e),n},w.prototype.reset=function(){var e=this;return e._callbacks={},e._directMap={},e},w.prototype.stopCallback=function(e,t){if((" "+t.className+" ").indexOf(" mousetrap ")>-1)return!1;if(v(t,this.target))return!1;if("composedPath"in e&&"function"==typeof e.composedPath){var n=e.composedPath()[0];n!==e.target&&(t=n)}return"INPUT"==t.tagName||"SELECT"==t.tagName||"TEXTAREA"==t.tagName||t.isContentEditable},w.prototype.handleKey=function(){var e=this;return e._handleKey.apply(e,arguments)},w.addKeycodes=function(e){for(var t in e)e.hasOwnProperty(t)&&(c[t]=e[t]);a=null},w.init=function(){var e=w(s);for(var t in e)"_"!==t.charAt(0)&&(w[t]=function(t){return function(){return e[t].apply(e,arguments)}}(t))},w.init(),i.Mousetrap=w,e.exports&&(e.exports=w),void 0===(r=function(){return w}.call(t,n,t,e))||(e.exports=r)}function f(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)}function p(e){if("keypress"==e.type){var t=String.fromCharCode(e.which);return e.shiftKey||(t=t.toLowerCase()),t}return c[e.which]?c[e.which]:u[e.which]?u[e.which]:String.fromCharCode(e.which).toLowerCase()}function g(e){return"shift"==e||"ctrl"==e||"alt"==e||"meta"==e}function m(e,t,n){return n||(n=function(){if(!a)for(var e in a={},c)e>95&&e<112||c.hasOwnProperty(e)&&(a[c[e]]=e);return a}()[e]?"keydown":"keypress"),"keypress"==n&&t.length&&(n="keydown"),n}function y(e,t){var n,r,i,s=[];for(n=function(e){return"+"===e?["+"]:(e=e.replace(/\+{2}/g,"+plus")).split("+")}(e),i=0;i<n.length;++i)r=n[i],h[r]&&(r=h[r]),t&&"keypress"!=t&&l[r]&&(r=l[r],s.push("shift")),g(r)&&s.push(r);return{key:r,modifiers:s,action:t=m(r,s,t)}}function v(e,t){return null!==e&&e!==s&&(e===t||v(e.parentNode,t))}function w(e){var t=this;if(e=e||s,!(t instanceof w))return new w(e);t.target=e,t._callbacks={},t._directMap={};var n,r={},i=!1,o=!1,a=!1;function c(e){e=e||{};var t,n=!1;for(t in r)e[t]?n=!0:r[t]=0;n||(a=!1)}function u(e,n,i,s,o,a){var c,u,l,h,d=[],f=i.type;if(!t._callbacks[e])return[];for("keyup"==f&&g(e)&&(n=[e]),c=0;c<t._callbacks[e].length;++c)if(u=t._callbacks[e][c],(s||!u.seq||r[u.seq]==u.level)&&f==u.action&&("keypress"==f&&!i.metaKey&&!i.ctrlKey||(l=n,h=u.modifiers,l.sort().join(",")===h.sort().join(",")))){var p=!s&&u.combo==o,m=s&&u.seq==s&&u.level==a;(p||m)&&t._callbacks[e].splice(c,1),d.push(u)}return d}function l(e,n,r,i){t.stopCallback(n,n.target||n.srcElement,r,i)||!1===e(n,r)&&(function(e){e.preventDefault?e.preventDefault():e.returnValue=!1}(n),function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}(n))}function h(e){"number"!=typeof e.which&&(e.which=e.keyCode);var n=p(e);n&&("keyup"!=e.type||i!==n?t.handleKey(n,function(e){var t=[];return e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),t}(e),e):i=!1)}function d(e,s,o,h,f){t._directMap[e+":"+o]=s;var g,m=(e=e.replace(/\s+/g," ")).split(" ");m.length>1?function(e,t,s,o){function u(t){return function(){a=t,++r[e],clearTimeout(n),n=setTimeout(c,1e3)}}function h(t){l(s,t,e),"keyup"!==o&&(i=p(t)),setTimeout(c,10)}r[e]=0;for(var f=0;f<t.length;++f){var g=f+1===t.length?h:u(o||y(t[f+1]).action);d(t[f],g,o,e,f)}}(e,m,s,o):(g=y(e,o),t._callbacks[g.key]=t._callbacks[g.key]||[],u(g.key,g.modifiers,{type:g.action},h,e,f),t._callbacks[g.key][h?"unshift":"push"]({callback:s,modifiers:g.modifiers,action:g.action,seq:h,level:f,combo:e}))}t._handleKey=function(e,t,n){var r,i=u(e,t,n),s={},h=0,d=!1;for(r=0;r<i.length;++r)i[r].seq&&(h=Math.max(h,i[r].level));for(r=0;r<i.length;++r)if(i[r].seq){if(i[r].level!=h)continue;d=!0,s[i[r].seq]=1,l(i[r].callback,n,i[r].combo,i[r].seq)}else d||l(i[r].callback,n,i[r].combo);var f="keypress"==n.type&&o;n.type!=a||g(e)||f||c(s),o=d&&"keydown"==n.type},t._bindMultiple=function(e,t,n){for(var r=0;r<e.length;++r)d(e[r],t,n)},f(e,"keypress",h),f(e,"keydown",h),f(e,"keyup",h)}}("undefined"!=typeof window?window:null,"undefined"!=typeof window?document:null)}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};var r={};!function(){"use strict";n.d(r,{_:function(){return Ff}});var e=" M src/events.ts\n M src/intel.ts\n M tests/autocomplete.spec.ts";function t(){var t=e.length>0?"⚠":"",n=e.length>0?"".concat("23 Mar 2024 23:40"," "):"";return"Neptune's Pride Agent v".concat("2.2.54"," (").concat(n).concat(t).concat("f0dbb9b",")")}var i=n(441),s="Error";function o(e){s=e,navigator.clipboard.write([new ClipboardItem({"text/plain":new Blob([s],{type:"text/plain"}),"text/html":new Blob([Crux.format(s.replaceAll("\n","<br/>"),NeptunesPride.universe.hyperlinkedMessageInserts)],{type:"text/html"})})])}function a(){return s}var c={},u={};function l(e,t,n,r){var s;n&&(t.help=n),t.button=r||e,c[e]=t,u[r]=e,i.bind(e,(s=t,function(){return s(),!1}))}function h(){return Object.keys(c)}function d(e){return c[e]}let f,p;const g=new WeakMap,m=new WeakMap,y=new WeakMap,v=new WeakMap,w=new WeakMap;let b={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return m.get(e);if("objectStoreNames"===t)return e.objectStoreNames||y.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return T(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e}};function _(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(p||(p=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(E(this),e),T(g.get(this))}:function(...e){return T(t.apply(E(this),e))}:function(e,...n){const r=t.call(E(this),e,...n);return y.set(r,e.sort?e.sort():[e]),T(r)}:(e instanceof IDBTransaction&&function(e){if(m.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)}));m.set(e,t)}(e),n=e,(f||(f=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,b):e);var t,n}function T(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{t(T(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&g.set(t,e)})).catch((()=>{})),w.set(t,e),t}(e);if(v.has(e))return v.get(e);const t=_(e);return t!==e&&(v.set(e,t),w.set(t,e)),t}const E=e=>w.get(e);function x(e,t,{blocked:n,upgrade:r,blocking:i,terminated:s}={}){const o=indexedDB.open(e,t),a=T(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(T(o.result),e.oldVersion,e.newVersion,T(o.transaction),e)})),n&&o.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),a.then((e=>{s&&e.addEventListener("close",(()=>s())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}const S=["get","getKey","getAll","getAllKeys","count"],k=["put","add","delete","clear"],I=new Map;function C(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(I.get(t))return I.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=k.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!S.includes(n))return;const s=async function(e,...t){const s=this.transaction(e,i?"readwrite":"readonly");let o=s.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),i&&s.done]))[0]};return I.set(t,s),s}var N;N=b,b={...N,get:(e,t,n)=>C(e,t)||N.get(e,t,n),has:(e,t)=>!!C(e,t)||N.has(e,t)};const A=function(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},P={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let t=0;t<e.length;t+=3){const i=e[t],s=t+1<e.length,o=s?e[t+1]:0,a=t+2<e.length,c=a?e[t+2]:0,u=i>>2,l=(3&i)<<4|o>>4;let h=(15&o)<<2|c>>6,d=63&c;a||(d=64,s||(h=64)),r.push(n[u],n[l],n[h],n[d])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(A(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){const i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){const s=e[n++];t[r++]=String.fromCharCode((31&i)<<6|63&s)}else if(i>239&&i<365){const s=((7&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))}else{const s=e[n++],o=e[n++];t[r++]=String.fromCharCode((15&i)<<12|(63&s)<<6|63&o)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let t=0;t<e.length;){const i=n[e.charAt(t++)],s=t<e.length?n[e.charAt(t)]:0;++t;const o=t<e.length?n[e.charAt(t)]:64;++t;const a=t<e.length?n[e.charAt(t)]:64;if(++t,null==i||null==s||null==o||null==a)throw Error();const c=i<<2|s>>4;if(r.push(c),64!==o){const e=s<<4&240|o>>2;if(r.push(e),64!==a){const e=o<<6&192|a;r.push(e)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},D=function(e){return function(e){const t=A(e);return P.encodeByteArray(t,!0)}(e).replace(/\./g,"")},M=()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n.g)return n.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&function(e){try{return P.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}};class R{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),"function"==typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,n))}}}class O extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,O.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,L.prototype.create)}}class L{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){const n=t[0]||{},r=`${this.service}/${e}`,i=this.errors[e],s=i?function(e,t){return e.replace(F,((e,n)=>{const r=t[n];return null!=r?String(r):`<${n}?>`}))}(i,n):"Error",o=`${this.serviceName}: ${s} (${r}).`;return new O(r,o,n)}}const F=/\{\$([^}]+)}/g;function V(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const i of n){if(!r.includes(i))return!1;const n=e[i],s=t[i];if(U(n)&&U(s)){if(!V(n,s))return!1}else if(n!==s)return!1}for(const e of r)if(!n.includes(e))return!1;return!0}function U(e){return null!==e&&"object"==typeof e}function B(e){return e&&e._delegate?e._delegate:e}class j{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const q="[DEFAULT]";class ${constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const e=new R;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:t});n&&e.resolve(n)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const n=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),r=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(r)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(e){if(r)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:q})}catch(e){}for(const[e,t]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const e=this.getOrInitializeService({instanceIdentifier:n});t.resolve(e)}catch(e){}}}}clearInstance(e=q){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(e=q){return this.instances.has(e)}getOptions(e=q){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const r=this.getOrInitializeService({instanceIdentifier:n,options:t});for(const[e,t]of this.instancesDeferred.entries())n===this.normalizeInstanceIdentifier(e)&&t.resolve(r);return r}onInit(e,t){var n;const r=this.normalizeInstanceIdentifier(t),i=null!==(n=this.onInitCallbacks.get(r))&&void 0!==n?n:new Set;i.add(e),this.onInitCallbacks.set(r,i);const s=this.instances.get(r);return s&&e(s,r),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const n=this.onInitCallbacks.get(t);if(n)for(const r of n)try{r(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let n=this.instances.get(e);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:(r=e,r===q?void 0:r),options:t}),this.instances.set(e,n),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(n,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,n)}catch(e){}var r;return n||null}normalizeInstanceIdentifier(e=q){return this.component?this.component.multipleInstances?e:q:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class H{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new $(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const K=[];var G,z;(z=G||(G={}))[z.DEBUG=0]="DEBUG",z[z.VERBOSE=1]="VERBOSE",z[z.INFO=2]="INFO",z[z.WARN=3]="WARN",z[z.ERROR=4]="ERROR",z[z.SILENT=5]="SILENT";const W={debug:G.DEBUG,verbose:G.VERBOSE,info:G.INFO,warn:G.WARN,error:G.ERROR,silent:G.SILENT},Q=G.INFO,X={[G.DEBUG]:"log",[G.VERBOSE]:"log",[G.INFO]:"info",[G.WARN]:"warn",[G.ERROR]:"error"},Y=(e,t,...n)=>{if(t<e.logLevel)return;const r=(new Date).toISOString(),i=X[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)};class J{constructor(e){this.name=e,this._logLevel=Q,this._logHandler=Y,this._userLogHandler=null,K.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in G))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?W[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,G.DEBUG,...e),this._logHandler(this,G.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,G.VERBOSE,...e),this._logHandler(this,G.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,G.INFO,...e),this._logHandler(this,G.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,G.WARN,...e),this._logHandler(this,G.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,G.ERROR,...e),this._logHandler(this,G.ERROR,...e)}}let Z,ee;const te=new WeakMap,ne=new WeakMap,re=new WeakMap,ie=new WeakMap,se=new WeakMap;let oe={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return ne.get(e);if("objectStoreNames"===t)return e.objectStoreNames||re.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return ce(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e}};function ae(e){return"function"==typeof e?(t=e)!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(ee||(ee=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(ue(this),e),ce(te.get(this))}:function(...e){return ce(t.apply(ue(this),e))}:function(e,...n){const r=t.call(ue(this),e,...n);return re.set(r,e.sort?e.sort():[e]),ce(r)}:(e instanceof IDBTransaction&&function(e){if(ne.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)}));ne.set(e,t)}(e),n=e,(Z||(Z=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>n instanceof e))?new Proxy(e,oe):e);var t,n}function ce(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{t(ce(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&te.set(t,e)})).catch((()=>{})),se.set(t,e),t}(e);if(ie.has(e))return ie.get(e);const t=ae(e);return t!==e&&(ie.set(e,t),se.set(t,e)),t}const ue=e=>se.get(e),le=["get","getKey","getAll","getAllKeys","count"],he=["put","add","delete","clear"],de=new Map;function fe(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(de.get(t))return de.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=he.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!le.includes(n))return;const s=async function(e,...t){const s=this.transaction(e,i?"readwrite":"readonly");let o=s.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),i&&s.done]))[0]};return de.set(t,s),s}oe=(e=>({...e,get:(t,n,r)=>fe(t,n)||e.get(t,n,r),has:(t,n)=>!!fe(t,n)||e.has(t,n)}))(oe);class pe{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null})).filter((e=>e)).join(" ")}}const ge="@firebase/app",me="0.9.3",ye=new J("@firebase/app"),ve={[ge]:"fire-core","@firebase/app-compat":"fire-core-compat","@firebase/analytics":"fire-analytics","@firebase/analytics-compat":"fire-analytics-compat","@firebase/app-check":"fire-app-check","@firebase/app-check-compat":"fire-app-check-compat","@firebase/auth":"fire-auth","@firebase/auth-compat":"fire-auth-compat","@firebase/database":"fire-rtdb","@firebase/database-compat":"fire-rtdb-compat","@firebase/functions":"fire-fn","@firebase/functions-compat":"fire-fn-compat","@firebase/installations":"fire-iid","@firebase/installations-compat":"fire-iid-compat","@firebase/messaging":"fire-fcm","@firebase/messaging-compat":"fire-fcm-compat","@firebase/performance":"fire-perf","@firebase/performance-compat":"fire-perf-compat","@firebase/remote-config":"fire-rc","@firebase/remote-config-compat":"fire-rc-compat","@firebase/storage":"fire-gcs","@firebase/storage-compat":"fire-gcs-compat","@firebase/firestore":"fire-fst","@firebase/firestore-compat":"fire-fst-compat","fire-js":"fire-js",firebase:"fire-js-all"},we=new Map,be=new Map;function _e(e,t){try{e.container.addComponent(t)}catch(n){ye.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function Te(e){const t=e.name;if(be.has(t))return ye.debug(`There were multiple attempts to register component ${t}.`),!1;be.set(t,e);for(const t of we.values())_e(t,e);return!0}const Ee=new L("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call Firebase App.initializeApp()","bad-app-name":"Illegal App name: '{$appName}","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}."});class xe{constructor(e,t,n){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new j("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Ee.create("app-deleted",{appName:this._name})}}function Se(e,t,n){var r;let i=null!==(r=ve[e])&&void 0!==r?r:e;n&&(i+=`-${n}`);const s=i.match(/\s|\//),o=t.match(/\s|\//);if(s||o){const e=[`Unable to register library "${i}" with version "${t}":`];return s&&e.push(`library name "${i}" contains illegal characters (whitespace or "/")`),s&&o&&e.push("and"),o&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void ye.warn(e.join(" "))}Te(new j(`${i}-version`,(()=>({library:i,version:t})),"VERSION"))}const ke="firebase-heartbeat-store";let Ie=null;function Ce(){return Ie||(Ie=function(e,t,{blocked:n,upgrade:r,blocking:i,terminated:s}={}){const o=indexedDB.open(e,t),a=ce(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(ce(o.result),e.oldVersion,e.newVersion,ce(o.transaction))})),n&&o.addEventListener("blocked",(()=>n())),a.then((e=>{s&&e.addEventListener("close",(()=>s())),i&&e.addEventListener("versionchange",(()=>i()))})).catch((()=>{})),a}("firebase-heartbeat-database",1,{upgrade:(e,t)=>{0===t&&e.createObjectStore(ke)}}).catch((e=>{throw Ee.create("idb-open",{originalErrorMessage:e.message})}))),Ie}async function Ne(e,t){try{const n=(await Ce()).transaction(ke,"readwrite"),r=n.objectStore(ke);return await r.put(t,Ae(e)),n.done}catch(e){if(e instanceof O)ye.warn(e.message);else{const t=Ee.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});ye.warn(t.message)}}}function Ae(e){return`${e.name}!${e.options.appId}`}class Pe{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new Me(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){const e=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),t=De();if(null===this._heartbeatsCache&&(this._heartbeatsCache=await this._heartbeatsCachePromise),this._heartbeatsCache.lastSentHeartbeatDate!==t&&!this._heartbeatsCache.heartbeats.some((e=>e.date===t)))return this._heartbeatsCache.heartbeats.push({date:t,agent:e}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null===this._heartbeatsCache||0===this._heartbeatsCache.heartbeats.length)return"";const e=De(),{heartbeatsToSend:t,unsentEntries:n}=function(e,t=1024){const n=[];let r=e.slice();for(const i of e){const e=n.find((e=>e.agent===i.agent));if(e){if(e.dates.push(i.date),Re(n)>t){e.dates.pop();break}}else if(n.push({agent:i.agent,dates:[i.date]}),Re(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}(this._heartbeatsCache.heartbeats),r=D(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}}function De(){return(new Date).toISOString().substring(0,10)}class Me{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!function(){try{return"object"==typeof indexedDB}catch(e){return!1}}()&&new Promise(((e,t)=>{try{let n=!0;const r="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(r);i.onsuccess=()=>{i.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},i.onupgradeneeded=()=>{n=!1},i.onerror=()=>{var e;t((null===(e=i.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){return await async function(e){try{return(await Ce()).transaction(ke).objectStore(ke).get(Ae(e))}catch(e){if(e instanceof O)ye.warn(e.message);else{const t=Ee.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});ye.warn(t.message)}}}(this.app)||{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return Ne(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return Ne(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...e.heartbeats]})}}}function Re(e){return D(JSON.stringify({version:2,heartbeats:e})).length}function Oe(){return!!/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}Te(new j("platform-logger",(e=>new pe(e)),"PRIVATE")),Te(new j("heartbeat",(e=>new Pe(e)),"PRIVATE")),Se(ge,me,""),Se(ge,me,"esm2017"),Se("fire-js",""),Se("firebase","9.17.1","app");var Le,Fe="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},Ve={},Ue=Ue||{},Be=Fe||self;function je(){}function qe(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function $e(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var He="closure_uid_"+(1e9*Math.random()>>>0),Ke=0;function Ge(e,t,n){return e.call.apply(e.bind,arguments)}function ze(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function We(e,t,n){return(We=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?Ge:ze).apply(null,arguments)}function Qe(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function Xe(e,t){function n(){}n.prototype=t.prototype,e.X=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.Wb=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}function Ye(){this.s=this.s,this.o=this.o}Ye.prototype.s=!1,Ye.prototype.na=function(){var e;!this.s&&(this.s=!0,this.M(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,He)&&e[He]||(e[He]=++Ke))},Ye.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const Je=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function Ze(e){const t=e.length;if(0<t){const n=Array(t);for(let r=0;r<t;r++)n[r]=e[r];return n}return[]}function et(e,t){for(let t=1;t<arguments.length;t++){const n=arguments[t];if(qe(n)){const t=e.length||0,r=n.length||0;e.length=t+r;for(let i=0;i<r;i++)e[t+i]=n[i]}else e.push(n)}}function tt(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}tt.prototype.h=function(){this.defaultPrevented=!0};var nt=function(){if(!Be.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{Be.addEventListener("test",je,t),Be.removeEventListener("test",je,t)}catch(e){}return e}();function rt(e){return/^[\s\xa0]*$/.test(e)}var it=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function st(e,t){return e<t?-1:e>t?1:0}function ot(){var e=Be.navigator;return e&&(e=e.userAgent)?e:""}function at(e){return-1!=ot().indexOf(e)}function ct(e){return ct[" "](e),e}ct[" "]=je;var ut,lt,ht=at("Opera"),dt=at("Trident")||at("MSIE"),ft=at("Edge"),pt=ft||dt,gt=at("Gecko")&&!(-1!=ot().toLowerCase().indexOf("webkit")&&!at("Edge"))&&!(at("Trident")||at("MSIE"))&&!at("Edge"),mt=-1!=ot().toLowerCase().indexOf("webkit")&&!at("Edge");function yt(){var e=Be.document;return e?e.documentMode:void 0}e:{var vt="",wt=(lt=ot(),gt?/rv:([^\);]+)(\)|;)/.exec(lt):ft?/Edge\/([\d\.]+)/.exec(lt):dt?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(lt):mt?/WebKit\/(\S+)/.exec(lt):ht?/(?:Version)[ \/]?(\S+)/.exec(lt):void 0);if(wt&&(vt=wt?wt[1]:""),dt){var bt=yt();if(null!=bt&&bt>parseFloat(vt)){ut=String(bt);break e}}ut=vt}var _t,Tt={};function Et(){return function(e){var t=Tt;return Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=function(){let e=0;const t=it(String(ut)).split("."),n=it("9").split("."),r=Math.max(t.length,n.length);for(let o=0;0==e&&o<r;o++){var i=t[o]||"",s=n[o]||"";do{if(i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==i[0].length&&0==s[0].length)break;e=st(0==i[1].length?0:parseInt(i[1],10),0==s[1].length?0:parseInt(s[1],10))||st(0==i[2].length,0==s[2].length)||st(i[2],s[2]),i=i[3],s=s[3]}while(0==e)}return 0<=e}()}()}Be.document&&dt?_t=yt()||parseInt(ut,10)||void 0:_t=void 0;var xt=_t;function St(e,t){if(tt.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(gt){e:{try{ct(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:kt[e.pointerType]||"",this.state=e.state,this.i=e,e.defaultPrevented&&St.X.h.call(this)}}Xe(St,tt);var kt={2:"touch",3:"pen",4:"mouse"};St.prototype.h=function(){St.X.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var It="closure_listenable_"+(1e6*Math.random()|0),Ct=0;function Nt(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=i,this.key=++Ct,this.ba=this.ea=!1}function At(e){e.ba=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function Pt(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function Dt(e){const t={};for(const n in e)t[n]=e[n];return t}const Mt="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Rt(e,t){let n,r;for(let t=1;t<arguments.length;t++){for(n in r=arguments[t],r)e[n]=r[n];for(let t=0;t<Mt.length;t++)n=Mt[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function Ot(e){this.src=e,this.g={},this.h=0}function Lt(e,t){var n=t.type;if(n in e.g){var r,i=e.g[n],s=Je(i,t);(r=0<=s)&&Array.prototype.splice.call(i,s,1),r&&(At(t),0==e.g[n].length&&(delete e.g[n],e.h--))}}function Ft(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.ba&&s.listener==t&&s.capture==!!n&&s.ha==r)return i}return-1}Ot.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var o=Ft(e,t,r,i);return-1<o?(t=e[o],n||(t.ea=!1)):((t=new Nt(t,this.src,s,!!r,i)).ea=n,e.push(t)),t};var Vt="closure_lm_"+(1e6*Math.random()|0),Ut={};function Bt(e,t,n,r,i){if(r&&r.once)return qt(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)Bt(e,t[s],n,r,i);return null}return n=Qt(n),e&&e[It]?e.N(t,n,$e(r)?!!r.capture:!!r,i):jt(e,t,n,!1,r,i)}function jt(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var o=$e(i)?!!i.capture:!!i,a=zt(e);if(a||(e[Vt]=a=new Ot(e)),(n=a.add(t,n,r,o,s)).proxy)return n;if(r=function(){const e=Gt;return function t(n){return e.call(t.src,t.listener,n)}}(),n.proxy=r,r.src=e,r.listener=n,e.addEventListener)nt||(i=o),void 0===i&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(Kt(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function qt(e,t,n,r,i){if(Array.isArray(t)){for(var s=0;s<t.length;s++)qt(e,t[s],n,r,i);return null}return n=Qt(n),e&&e[It]?e.O(t,n,$e(r)?!!r.capture:!!r,i):jt(e,t,n,!0,r,i)}function $t(e,t,n,r,i){if(Array.isArray(t))for(var s=0;s<t.length;s++)$t(e,t[s],n,r,i);else r=$e(r)?!!r.capture:!!r,n=Qt(n),e&&e[It]?(e=e.i,(t=String(t).toString())in e.g&&-1<(n=Ft(s=e.g[t],n,r,i))&&(At(s[n]),Array.prototype.splice.call(s,n,1),0==s.length&&(delete e.g[t],e.h--))):e&&(e=zt(e))&&(t=e.g[t.toString()],e=-1,t&&(e=Ft(t,n,r,i)),(n=-1<e?t[e]:null)&&Ht(n))}function Ht(e){if("number"!=typeof e&&e&&!e.ba){var t=e.src;if(t&&t[It])Lt(t.i,e);else{var n=e.type,r=e.proxy;t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(Kt(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=zt(t))?(Lt(n,e),0==n.h&&(n.src=null,t[Vt]=null)):At(e)}}}function Kt(e){return e in Ut?Ut[e]:Ut[e]="on"+e}function Gt(e,t){if(e.ba)e=!0;else{t=new St(t,this);var n=e.listener,r=e.ha||e.src;e.ea&&Ht(e),e=n.call(r,t)}return e}function zt(e){return(e=e[Vt])instanceof Ot?e:null}var Wt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Qt(e){return"function"==typeof e?e:(e[Wt]||(e[Wt]=function(t){return e.handleEvent(t)}),e[Wt])}function Xt(){Ye.call(this),this.i=new Ot(this),this.P=this,this.I=null}function Yt(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t)t=new tt(t,e);else if(t instanceof tt)t.target=t.target||e;else{var i=t;Rt(t=new tt(r,e),i)}if(i=!0,n)for(var s=n.length-1;0<=s;s--){var o=t.g=n[s];i=Jt(o,r,!0,t)&&i}if(i=Jt(o=t.g=e,r,!0,t)&&i,i=Jt(o,r,!1,t)&&i,n)for(s=0;s<n.length;s++)i=Jt(o=t.g=n[s],r,!1,t)&&i}function Jt(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var o=t[s];if(o&&!o.ba&&o.capture==n){var a=o.listener,c=o.ha||o.src;o.ea&&Lt(e.i,o),i=!1!==a.call(c,r)&&i}}return i&&!r.defaultPrevented}Xe(Xt,Ye),Xt.prototype[It]=!0,Xt.prototype.removeEventListener=function(e,t,n,r){$t(this,e,t,n,r)},Xt.prototype.M=function(){if(Xt.X.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)At(n[r]);delete t.g[e],t.h--}}this.I=null},Xt.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Xt.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var Zt=Be.JSON.stringify;function en(){var e=cn;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}var tn,nn=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}((()=>new rn),(e=>e.reset()));class rn{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function sn(e){Be.setTimeout((()=>{throw e}),0)}function on(e,t){tn||function(){var e=Be.Promise.resolve(void 0);tn=function(){e.then(un)}}(),an||(tn(),an=!0),cn.add(e,t)}var an=!1,cn=new class{constructor(){this.h=this.g=null}add(e,t){const n=nn.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function un(){for(var e;e=en();){try{e.h.call(e.g)}catch(e){sn(e)}var t=nn;t.j(e),100>t.h&&(t.h++,e.next=t.g,t.g=e)}an=!1}function ln(e,t){Xt.call(this),this.h=e||1,this.g=t||Be,this.j=We(this.lb,this),this.l=Date.now()}function hn(e){e.ca=!1,e.R&&(e.g.clearTimeout(e.R),e.R=null)}function dn(e,t,n){if("function"==typeof e)n&&(e=We(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=We(e.handleEvent,e)}return 2147483647<Number(t)?-1:Be.setTimeout(e,t||0)}function fn(e){e.g=dn((()=>{e.g=null,e.i&&(e.i=!1,fn(e))}),e.j);const t=e.h;e.h=null,e.m.apply(null,t)}Xe(ln,Xt),(Le=ln.prototype).ca=!1,Le.R=null,Le.lb=function(){if(this.ca){var e=Date.now()-this.l;0<e&&e<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-e):(this.R&&(this.g.clearTimeout(this.R),this.R=null),Yt(this,"tick"),this.ca&&(hn(this),this.start()))}},Le.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},Le.M=function(){ln.X.M.call(this),hn(this),delete this.g};class pn extends Ye{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:fn(this)}M(){super.M(),this.g&&(Be.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function gn(e){Ye.call(this),this.h=e,this.g={}}Xe(gn,Ye);var mn=[];function yn(e,t,n,r){Array.isArray(n)||(n&&(mn[0]=n.toString()),n=mn);for(var i=0;i<n.length;i++){var s=Bt(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function vn(e){Pt(e.g,(function(e,t){this.g.hasOwnProperty(t)&&Ht(e)}),e),e.g={}}function wn(){this.g=!0}function bn(e,t,n,r){e.info((function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(2>r.length)){var i=r[1];if(Array.isArray(i)&&!(1>i.length)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var o=1;o<i.length;o++)i[o]=""}}}return Zt(n)}catch(e){return t}}(e,n)+(r?" "+r:"")}))}gn.prototype.M=function(){gn.X.M.call(this),vn(this)},gn.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},wn.prototype.Aa=function(){this.g=!1},wn.prototype.info=function(){};var _n={},Tn=null;function En(){return Tn=Tn||new Xt}function xn(e){tt.call(this,_n.Pa,e)}function Sn(e){const t=En();Yt(t,new xn(t))}function kn(e,t){tt.call(this,_n.STAT_EVENT,e),this.stat=t}function In(e){const t=En();Yt(t,new kn(t,e))}function Cn(e,t){tt.call(this,_n.Qa,e),this.size=t}function Nn(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return Be.setTimeout((function(){e()}),t)}_n.Pa="serverreachability",Xe(xn,tt),_n.STAT_EVENT="statevent",Xe(kn,tt),_n.Qa="timingevent",Xe(Cn,tt);var An={NO_ERROR:0,mb:1,zb:2,yb:3,tb:4,xb:5,Ab:6,Ma:7,TIMEOUT:8,Db:9},Pn={rb:"complete",Nb:"success",Na:"error",Ma:"abort",Fb:"ready",Gb:"readystatechange",TIMEOUT:"timeout",Bb:"incrementaldata",Eb:"progress",ub:"downloadprogress",Vb:"uploadprogress"};function Dn(){}function Mn(e){return e.h||(e.h=e.i())}function Rn(){}Dn.prototype.h=null;var On,Ln={OPEN:"a",qb:"b",Na:"c",Cb:"d"};function Fn(){tt.call(this,"d")}function Vn(){tt.call(this,"c")}function Un(){}function Bn(e,t,n,r){this.l=e,this.j=t,this.m=n,this.U=r||1,this.S=new gn(this),this.O=qn,e=pt?125:void 0,this.T=new ln(e),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new jn}function jn(){this.i=null,this.g="",this.h=!1}Xe(Fn,tt),Xe(Vn,tt),Xe(Un,Dn),Un.prototype.g=function(){return new XMLHttpRequest},Un.prototype.i=function(){return{}},On=new Un;var qn=45e3,$n={},Hn={};function Kn(e,t,n){e.K=1,e.v=lr(sr(t)),e.s=n,e.P=!0,Gn(e,null)}function Gn(e,t){e.F=Date.now(),Xn(e),e.A=sr(e.v);var n=e.A,r=e.U;Array.isArray(r)||(r=[String(r)]),Er(n.i,"t",r),e.C=0,n=e.l.H,e.h=new jn,e.g=Ti(e.l,n?t:null,!e.s),0<e.N&&(e.L=new pn(We(e.La,e,e.g),e.N)),yn(e.S,e.g,"readystatechange",e.ib),t=e.H?Dt(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.da(e.A,e.u,e.s,t)):(e.u="GET",e.g.da(e.A,e.u,null,t)),Sn(),function(e,t,n,r,i,s){e.info((function(){if(e.g)if(s)for(var o="",a=s.split("&"),c=0;c<a.length;c++){var u=a[c].split("=");if(1<u.length){var l=u[0];u=u[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+u+"&":o+(l+"=redacted&")}}else o=null;else o=s;return"XMLHTTP REQ ("+r+") [attempt "+i+"]: "+t+"\n"+n+"\n"+o}))}(e.j,e.u,e.A,e.m,e.U,e.s)}function zn(e){return!!e.g&&"GET"==e.u&&2!=e.K&&e.l.Da}function Wn(e,t,n){let r,i=!0;for(;!e.I&&e.C<n.length;){if(r=Qn(e,n),r==Hn){4==t&&(e.o=4,In(14),i=!1),bn(e.j,e.m,null,"[Incomplete Response]");break}if(r==$n){e.o=4,In(15),bn(e.j,e.m,n,"[Invalid Chunk]"),i=!1;break}bn(e.j,e.m,r,null),tr(e,r)}zn(e)&&r!=Hn&&r!=$n&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,In(16),i=!1),e.i=e.i&&i,i?0<n.length&&!e.$&&(e.$=!0,(t=e.l).g==e&&t.$&&!t.K&&(t.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),pi(t),t.K=!0,In(11))):(bn(e.j,e.m,n,"[Invalid Chunked Response]"),er(e),Zn(e))}function Qn(e,t){var n=e.C,r=t.indexOf("\n",n);return-1==r?Hn:(n=Number(t.substring(n,r)),isNaN(n)?$n:(r+=1)+n>t.length?Hn:(t=t.substr(r,n),e.C=r+n,t))}function Xn(e){e.V=Date.now()+e.O,Yn(e,e.O)}function Yn(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=Nn(We(e.gb,e),t)}function Jn(e){e.B&&(Be.clearTimeout(e.B),e.B=null)}function Zn(e){0==e.l.G||e.I||yi(e.l,e)}function er(e){Jn(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,hn(e.T),vn(e.S),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function tr(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||Nr(n.h,e)))if(!e.J&&Nr(n.h,e)&&3==n.G){try{var r=n.Fa.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;mi(n),oi(n)}fi(n),In(18)}}else n.Ba=i[1],0<n.Ba-n.T&&37500>i[2]&&n.L&&0==n.A&&!n.v&&(n.v=Nn(We(n.cb,n),6e3));if(1>=Cr(n.h)&&n.ja){try{n.ja()}catch(e){}n.ja=void 0}}else wi(n,11)}else if((e.J||n.g==e)&&mi(n),!rt(t))for(i=n.Fa.g.parse(t),t=0;t<i.length;t++){let u=i[t];if(n.T=u[0],u=u[1],2==n.G)if("c"==u[0]){n.I=u[1],n.ka=u[2];const t=u[3];null!=t&&(n.ma=t,n.j.info("VER="+n.ma));const i=u[4];null!=i&&(n.Ca=i,n.j.info("SVER="+n.Ca));const l=u[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.J=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=e.g;if(h){const e=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(e){var s=r.h;s.g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(s.j=s.l,s.g=new Set,s.h&&(Ar(s,s.h),s.h=null))}if(r.D){const e=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;e&&(r.za=e,ur(r.F,r.D,e))}}n.G=3,n.l&&n.l.xa(),n.$&&(n.P=Date.now()-e.F,n.j.info("Handshake RTT: "+n.P+"ms"));var o=e;if((r=n).sa=_i(r,r.H?r.ka:null,r.V),o.J){Pr(r.h,o);var a=o,c=r.J;c&&a.setTimeout(c),a.B&&(Jn(a),Xn(a)),r.g=o}else di(r);0<n.i.length&&ci(n)}else"stop"!=u[0]&&"close"!=u[0]||wi(n,7);else 3==n.G&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?wi(n,7):si(n):"noop"!=u[0]&&n.l&&n.l.wa(u),n.A=0)}Sn()}catch(e){}}function nr(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(qe(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.oa&&"function"==typeof e.oa)return e.oa();if(!e.W||"function"!=typeof e.W){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(qe(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.W&&"function"==typeof e.W)return e.W();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(qe(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(Le=Bn.prototype).setTimeout=function(e){this.O=e},Le.ib=function(e){e=e.target;const t=this.L;t&&3==Zr(e)?t.l():this.La(e)},Le.La=function(e){try{if(e==this.g)e:{const l=Zr(this.g);var t=this.g.Ea();if(this.g.aa(),!(3>l)&&(3!=l||pt||this.g&&(this.h.h||this.g.fa()||ei(this.g)))){this.I||4!=l||7==t||Sn(),Jn(this);var n=this.g.aa();this.Y=n;t:if(zn(this)){var r=ei(this.g);e="";var i=r.length,s=4==Zr(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){er(this),Zn(this);var o="";break t}this.h.i=new Be.TextDecoder}for(t=0;t<i;t++)this.h.h=!0,e+=this.h.i.decode(r[t],{stream:s&&t==i-1});r.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.fa();if(this.i=200==n,function(e,t,n,r,i,s,o){e.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+i+"]: "+t+"\n"+n+"\n"+s+" "+o}))}(this.j,this.u,this.A,this.m,this.U,l,n),this.i){if(this.Z&&!this.J){t:{if(this.g){var a,c=this.g;if((a=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!rt(a)){var u=a;break t}}u=null}if(!(n=u)){this.i=!1,this.o=3,In(12),er(this),Zn(this);break e}bn(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,tr(this,n)}this.P?(Wn(this,l,o),pt&&this.i&&3==l&&(yn(this.S,this.T,"tick",this.hb),this.T.start())):(bn(this.j,this.m,o,null),tr(this,o)),4==l&&er(this),this.i&&!this.I&&(4==l?yi(this.l,this):(this.i=!1,Xn(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,In(12)):(this.o=0,In(13)),er(this),Zn(this)}}}catch(e){}},Le.hb=function(){if(this.g){var e=Zr(this.g),t=this.g.fa();this.C<t.length&&(Jn(this),Wn(this,e,t),this.i&&4!=e&&Xn(this))}},Le.cancel=function(){this.I=!0,er(this)},Le.gb=function(){this.B=null;const e=Date.now();0<=e-this.V?(function(e,t){e.info((function(){return"TIMEOUT: "+t}))}(this.j,this.A),2!=this.K&&(Sn(),In(17)),er(this),this.o=2,Zn(this)):Yn(this,this.V-e)};var rr=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function ir(e,t){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof ir){this.h=void 0!==t?t:e.h,or(this,e.j),this.s=e.s,this.g=e.g,ar(this,e.m),this.l=e.l,t=e.i;var n=new wr;n.i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),cr(this,n),this.o=e.o}else e&&(n=String(e).match(rr))?(this.h=!!t,or(this,n[1]||"",!0),this.s=hr(n[2]||""),this.g=hr(n[3]||"",!0),ar(this,n[4]),this.l=hr(n[5]||"",!0),cr(this,n[6]||"",!0),this.o=hr(n[7]||"")):(this.h=!!t,this.i=new wr(null,this.h))}function sr(e){return new ir(e)}function or(e,t,n){e.j=n?hr(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function ar(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.m=t}else e.m=null}function cr(e,t,n){t instanceof wr?(e.i=t,function(e,t){t&&!e.j&&(br(e),e.i=null,e.g.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(_r(this,t),Er(this,n,e))}),e)),e.j=t}(e.i,e.h)):(n||(t=dr(t,yr)),e.i=new wr(t,e.h))}function ur(e,t,n){e.i.set(t,n)}function lr(e){return ur(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function hr(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function dr(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,fr),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function fr(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}ir.prototype.toString=function(){var e=[],t=this.j;t&&e.push(dr(t,pr,!0),":");var n=this.g;return(n||"file"==t)&&(e.push("//"),(t=this.s)&&e.push(dr(t,pr,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(dr(n,"/"==n.charAt(0)?mr:gr,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",dr(n,vr)),e.join("")};var pr=/[#\/\?@]/g,gr=/[#\?:]/g,mr=/[#\?]/g,yr=/[#\?@]/g,vr=/#/g;function wr(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function br(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r=e[n].indexOf("="),i=null;if(0<=r){var s=e[n].substring(0,r);i=e[n].substring(r+1)}else s=e[n];t(s,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(e.i,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function _r(e,t){br(e),t=xr(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function Tr(e,t){return br(e),t=xr(e,t),e.g.has(t)}function Er(e,t,n){_r(e,t),0<n.length&&(e.i=null,e.g.set(xr(e,t),Ze(n)),e.h+=n.length)}function xr(e,t){return t=String(t),e.j&&(t=t.toLowerCase()),t}function Sr(e){this.l=e||kr,e=Be.PerformanceNavigationTiming?0<(e=Be.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(Be.g&&Be.g.Ga&&Be.g.Ga()&&Be.g.Ga().$b),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(Le=wr.prototype).add=function(e,t){br(this),this.i=null,e=xr(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},Le.forEach=function(e,t){br(this),this.g.forEach((function(n,r){n.forEach((function(n){e.call(t,n,r,this)}),this)}),this)},Le.oa=function(){br(this);const e=Array.from(this.g.values()),t=Array.from(this.g.keys()),n=[];for(let r=0;r<t.length;r++){const i=e[r];for(let e=0;e<i.length;e++)n.push(t[r])}return n},Le.W=function(e){br(this);let t=[];if("string"==typeof e)Tr(this,e)&&(t=t.concat(this.g.get(xr(this,e))));else{e=Array.from(this.g.values());for(let n=0;n<e.length;n++)t=t.concat(e[n])}return t},Le.set=function(e,t){return br(this),this.i=null,Tr(this,e=xr(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},Le.get=function(e,t){return e&&0<(e=this.W(e)).length?String(e[0]):t},Le.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++){var r=t[n];const s=encodeURIComponent(String(r)),o=this.W(r);for(r=0;r<o.length;r++){var i=s;""!==o[r]&&(i+="="+encodeURIComponent(String(o[r]))),e.push(i)}}return this.i=e.join("&")};var kr=10;function Ir(e){return!!e.h||!!e.g&&e.g.size>=e.j}function Cr(e){return e.h?1:e.g?e.g.size:0}function Nr(e,t){return e.h?e.h==t:!!e.g&&e.g.has(t)}function Ar(e,t){e.g?e.g.add(t):e.h=t}function Pr(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function Dr(e){if(null!=e.h)return e.i.concat(e.h.D);if(null!=e.g&&0!==e.g.size){let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}return Ze(e.i)}function Mr(){}function Rr(){this.g=new Mr}function Or(e,t,n){const r=n||"";try{nr(e,(function(e,n){let i=e;$e(e)&&(i=Zt(e)),t.push(r+n+"="+encodeURIComponent(i))}))}catch(e){throw t.push(r+"type="+encodeURIComponent("_badmap")),e}}function Lr(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function Fr(e){this.l=e.ac||null,this.j=e.jb||!1}function Vr(e,t){Xt.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=Ur,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}Sr.prototype.cancel=function(){if(this.i=Dr(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},Mr.prototype.stringify=function(e){return Be.JSON.stringify(e,void 0)},Mr.prototype.parse=function(e){return Be.JSON.parse(e,void 0)},Xe(Fr,Dn),Fr.prototype.g=function(){return new Vr(this.l,this.j)},Fr.prototype.i=function(e){return function(){return e}}({}),Xe(Vr,Xt);var Ur=0;function Br(e){e.j.read().then(e.Ta.bind(e)).catch(e.ga.bind(e))}function jr(e){e.readyState=4,e.l=null,e.j=null,e.A=null,qr(e)}function qr(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(Le=Vr.prototype).open=function(e,t){if(this.readyState!=Ur)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,qr(this)},Le.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||Be).fetch(new Request(this.B,t)).then(this.Wa.bind(this),this.ga.bind(this))},Le.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,jr(this)),this.readyState=Ur},Le.Wa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,qr(this)),this.g&&(this.readyState=3,qr(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ua.bind(this),this.ga.bind(this));else if(void 0!==Be.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Br(this)}else e.text().then(this.Va.bind(this),this.ga.bind(this))},Le.Ta=function(e){if(this.g){if(this.u&&e.value)this.response.push(e.value);else if(!this.u){var t=e.value?e.value:new Uint8Array(0);(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)}e.done?jr(this):qr(this),3==this.readyState&&Br(this)}},Le.Va=function(e){this.g&&(this.response=this.responseText=e,jr(this))},Le.Ua=function(e){this.g&&(this.response=e,jr(this))},Le.ga=function(){this.g&&jr(this)},Le.setRequestHeader=function(e,t){this.v.append(e,t)},Le.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},Le.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(Vr.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var $r=Be.JSON.parse;function Hr(e){Xt.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Kr,this.K=this.L=!1}Xe(Hr,Xt);var Kr="",Gr=/^https?$/i,zr=["POST","PUT"];function Wr(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Qr(e),Yr(e)}function Qr(e){e.D||(e.D=!0,Yt(e,"complete"),Yt(e,"error"))}function Xr(e){if(e.h&&void 0!==Ue&&(!e.C[1]||4!=Zr(e)||2!=e.aa()))if(e.v&&4==Zr(e))dn(e.Ha,0,e);else if(Yt(e,"readystatechange"),4==Zr(e)){e.h=!1;try{const a=e.aa();e:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break e;default:t=!1}var n;if(!(n=t)){var r;if(r=0===a){var i=String(e.H).match(rr)[1]||null;if(!i&&Be.self&&Be.self.location){var s=Be.self.location.protocol;i=s.substr(0,s.length-1)}r=!Gr.test(i?i.toLowerCase():"")}n=r}if(n)Yt(e,"complete"),Yt(e,"success");else{e.m=6;try{var o=2<Zr(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.aa()+"]",Qr(e)}}finally{Yr(e)}}}function Yr(e,t){if(e.g){Jr(e);const n=e.g,r=e.C[0]?je:null;e.g=null,e.C=null,t||Yt(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function Jr(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(Be.clearTimeout(e.A),e.A=null)}function Zr(e){return e.g?e.g.readyState:0}function ei(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case Kr:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function ti(e){let t="";return Pt(e,(function(e,n){t+=n,t+=":",t+=e,t+="\r\n"})),t}function ni(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=ti(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):ur(e,t,n))}function ri(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function ii(e){this.Ca=0,this.i=[],this.j=new wn,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.ab=this.U=0,this.Za=ri("failFast",!1,e),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Xa=ri("baseRetryDelayMs",5e3,e),this.bb=ri("retryDelaySeedMs",1e4,e),this.$a=ri("forwardChannelMaxRetries",2,e),this.ta=ri("forwardChannelRequestTimeoutMs",2e4,e),this.ra=e&&e.xmlHttpFactory||void 0,this.Da=e&&e.Zb||!1,this.J=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.I="",this.h=new Sr(e&&e.concurrentRequestLimit),this.Fa=new Rr,this.O=e&&e.fastHandshake||!1,this.N=e&&e.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Ya=e&&e.Xb||!1,e&&e.Aa&&this.j.Aa(),e&&e.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&e&&e.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function si(e){if(ai(e),3==e.G){var t=e.U++,n=sr(e.F);ur(n,"SID",e.I),ur(n,"RID",t),ur(n,"TYPE","terminate"),li(e,n),(t=new Bn(e,e.j,t,void 0)).K=2,t.v=lr(sr(n)),n=!1,Be.navigator&&Be.navigator.sendBeacon&&(n=Be.navigator.sendBeacon(t.v.toString(),"")),!n&&Be.Image&&((new Image).src=t.v,n=!0),n||(t.g=Ti(t.l,null),t.g.da(t.v)),t.F=Date.now(),Xn(t)}bi(e)}function oi(e){e.g&&(pi(e),e.g.cancel(),e.g=null)}function ai(e){oi(e),e.u&&(Be.clearTimeout(e.u),e.u=null),mi(e),e.h.cancel(),e.m&&("number"==typeof e.m&&Be.clearTimeout(e.m),e.m=null)}function ci(e){Ir(e.h)||e.m||(e.m=!0,on(e.Ja,e),e.C=0)}function ui(e,t){var n;n=t?t.m:e.U++;const r=sr(e.F);ur(r,"SID",e.I),ur(r,"RID",n),ur(r,"AID",e.T),li(e,r),e.o&&e.s&&ni(r,e.o,e.s),n=new Bn(e,e.j,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.i=t.D.concat(e.i)),t=hi(e,n,1e3),n.setTimeout(Math.round(.5*e.ta)+Math.round(.5*e.ta*Math.random())),Ar(e.h,n),Kn(n,r,t)}function li(e,t){e.ia&&Pt(e.ia,(function(e,n){ur(t,n,e)})),e.l&&nr({},(function(e,n){ur(t,n,e)}))}function hi(e,t,n){n=Math.min(e.i.length,n);var r=e.l?We(e.l.Ra,e.l,e):null;e:{var i=e.i;let t=-1;for(;;){const e=["count="+n];-1==t?0<n?(t=i[0].h,e.push("ofs="+t)):t=0:e.push("ofs="+t);let s=!0;for(let o=0;o<n;o++){let n=i[o].h;const a=i[o].g;if(n-=t,0>n)t=Math.max(0,i[o].h-100),s=!1;else try{Or(a,e,"req"+n+"_")}catch(e){r&&r(a)}}if(s){r=e.join("&");break e}}}return e=e.i.splice(0,n),t.D=e,r}function di(e){e.g||e.u||(e.Z=1,on(e.Ia,e),e.A=0)}function fi(e){return!(e.g||e.u||3<=e.A||(e.Z++,e.u=Nn(We(e.Ia,e),vi(e,e.A)),e.A++,0))}function pi(e){null!=e.B&&(Be.clearTimeout(e.B),e.B=null)}function gi(e){e.g=new Bn(e,e.j,"rpc",e.Z),null===e.o&&(e.g.H=e.s),e.g.N=0;var t=sr(e.sa);ur(t,"RID","rpc"),ur(t,"SID",e.I),ur(t,"CI",e.L?"0":"1"),ur(t,"AID",e.T),ur(t,"TYPE","xmlhttp"),li(e,t),e.o&&e.s&&ni(t,e.o,e.s),e.J&&e.g.setTimeout(e.J);var n=e.g;e=e.ka,n.K=1,n.v=lr(sr(t)),n.s=null,n.P=!0,Gn(n,e)}function mi(e){null!=e.v&&(Be.clearTimeout(e.v),e.v=null)}function yi(e,t){var n=null;if(e.g==t){mi(e),pi(e),e.g=null;var r=2}else{if(!Nr(e.h,t))return;n=t.D,Pr(e.h,t),r=1}if(0!=e.G)if(e.pa=t.Y,t.i)if(1==r){n=t.s?t.s.length:0,t=Date.now()-t.F;var i=e.C;Yt(r=En(),new Cn(r,n)),ci(e)}else di(e);else if(3==(i=t.o)||0==i&&0<e.pa||!(1==r&&function(e,t){return!(Cr(e.h)>=e.h.j-(e.m?1:0)||(e.m?(e.i=t.D.concat(e.i),0):1==e.G||2==e.G||e.C>=(e.Za?0:e.$a)||(e.m=Nn(We(e.Ja,e,t),vi(e,e.C)),e.C++,0)))}(e,t)||2==r&&fi(e)))switch(n&&0<n.length&&(t=e.h,t.i=t.i.concat(n)),i){case 1:wi(e,5);break;case 4:wi(e,10);break;case 3:wi(e,6);break;default:wi(e,2)}}function vi(e,t){let n=e.Xa+Math.floor(Math.random()*e.bb);return e.l||(n*=2),n*t}function wi(e,t){if(e.j.info("Error code "+t),2==t){var n=null;e.l&&(n=null);var r=We(e.kb,e);n||(n=new ir("//www.google.com/images/cleardot.gif"),Be.location&&"http"==Be.location.protocol||or(n,"https"),lr(n)),function(e,t){const n=new wn;if(Be.Image){const r=new Image;r.onload=Qe(Lr,n,r,"TestLoadImage: loaded",!0,t),r.onerror=Qe(Lr,n,r,"TestLoadImage: error",!1,t),r.onabort=Qe(Lr,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=Qe(Lr,n,r,"TestLoadImage: timeout",!1,t),Be.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=e}else t(!1)}(n.toString(),r)}else In(2);e.G=0,e.l&&e.l.va(t),bi(e),ai(e)}function bi(e){if(e.G=0,e.la=[],e.l){const t=Dr(e.h);0==t.length&&0==e.i.length||(et(e.la,t),et(e.la,e.i),e.h.i.length=0,Ze(e.i),e.i.length=0),e.l.ua()}}function _i(e,t,n){var r=n instanceof ir?sr(n):new ir(n,void 0);if(""!=r.g)t&&(r.g=t+"."+r.g),ar(r,r.m);else{var i=Be.location;r=i.protocol,t=t?t+"."+i.hostname:i.hostname,i=+i.port;var s=new ir(null,void 0);r&&or(s,r),t&&(s.g=t),i&&ar(s,i),n&&(s.l=n),r=s}return n=e.D,t=e.za,n&&t&&ur(r,n,t),ur(r,"VER",e.ma),li(e,r),r}function Ti(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Da&&!e.ra?new Hr(new Fr({jb:!0})):new Hr(e.ra)).Ka(e.H),t}function Ei(){}function xi(){if(dt&&!(10<=Number(xt)))throw Error("Environmental error: no available transport.")}function Si(e,t){Xt.call(this),this.g=new ii(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.S=e,(e=t&&t.Yb)&&!rt(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!rt(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new Ci(this)}function ki(e){Fn.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function Ii(){Vn.call(this),this.status=1}function Ci(e){this.g=e}(Le=Hr.prototype).Ka=function(e){this.L=e},Le.da=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():On.g(),this.C=this.u?Mn(this.u):Mn(On),this.g.onreadystatechange=We(this.Ha,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void Wr(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const e of r.keys())n.set(e,r.get(e))}r=Array.from(n.keys()).find((e=>"content-type"==e.toLowerCase())),i=Be.FormData&&e instanceof Be.FormData,!(0<=Je(zr,t))||r||i||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[e,t]of n)this.g.setRequestHeader(e,t);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Jr(this),0<this.B&&((this.K=function(e){return dt&&Et()&&"number"==typeof e.timeout&&void 0!==e.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=We(this.qa,this)):this.A=dn(this.qa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){Wr(this,e)}},Le.qa=function(){void 0!==Ue&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Yt(this,"timeout"),this.abort(8))},Le.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,Yt(this,"complete"),Yt(this,"abort"),Yr(this))},Le.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Yr(this,!0)),Hr.X.M.call(this)},Le.Ha=function(){this.s||(this.F||this.v||this.l?Xr(this):this.fb())},Le.fb=function(){Xr(this)},Le.aa=function(){try{return 2<Zr(this)?this.g.status:-1}catch(e){return-1}},Le.fa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},Le.Sa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),$r(t)}},Le.Ea=function(){return this.m},Le.Oa=function(){return"string"==typeof this.j?this.j:String(this.j)},(Le=ii.prototype).ma=8,Le.G=1,Le.Ja=function(e){if(this.m)if(this.m=null,1==this.G){if(!e){this.U=Math.floor(1e5*Math.random()),e=this.U++;const i=new Bn(this,this.j,e,void 0);let s=this.s;if(this.S&&(s?(s=Dt(s),Rt(s,this.S)):s=this.S),null!==this.o||this.N||(i.H=s,s=null),this.O)e:{for(var t=0,n=0;n<this.i.length;n++){var r=this.i[n];if(void 0===(r="__data__"in r.g&&"string"==typeof(r=r.g.__data__)?r.length:void 0))break;if(4096<(t+=r)){t=n;break e}if(4096===t||n===this.i.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=hi(this,i,t),ur(n=sr(this.F),"RID",e),ur(n,"CVER",22),this.D&&ur(n,"X-HTTP-Session-Id",this.D),li(this,n),s&&(this.N?t="headers="+encodeURIComponent(String(ti(s)))+"&"+t:this.o&&ni(n,this.o,s)),Ar(this.h,i),this.Ya&&ur(n,"TYPE","init"),this.O?(ur(n,"$req",t),ur(n,"SID","null"),i.Z=!0,Kn(i,n,null)):Kn(i,n,t),this.G=2}}else 3==this.G&&(e?ui(this,e):0==this.i.length||Ir(this.h)||ui(this))},Le.Ia=function(){if(this.u=null,gi(this),this.$&&!(this.K||null==this.g||0>=this.P)){var e=2*this.P;this.j.info("BP detection timer enabled: "+e),this.B=Nn(We(this.eb,this),e)}},Le.eb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,In(10),oi(this),gi(this))},Le.cb=function(){null!=this.v&&(this.v=null,oi(this),fi(this),In(19))},Le.kb=function(e){e?(this.j.info("Successfully pinged google.com"),In(2)):(this.j.info("Failed to ping google.com"),In(1))},(Le=Ei.prototype).xa=function(){},Le.wa=function(){},Le.va=function(){},Le.ua=function(){},Le.Ra=function(){},xi.prototype.g=function(e,t){return new Si(e,t)},Xe(Si,Xt),Si.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;In(0),e.V=t,e.ia=n||{},e.L=e.Y,e.F=_i(e,null,e.V),ci(e)},Si.prototype.close=function(){si(this.g)},Si.prototype.u=function(e){var t=this.g;if("string"==typeof e){var n={};n.__data__=e,e=n}else this.v&&((n={}).__data__=Zt(e),e=n);t.i.push(new class{constructor(e,t){this.h=e,this.g=t}}(t.ab++,e)),3==t.G&&ci(t)},Si.prototype.M=function(){this.g.l=null,delete this.j,si(this.g),delete this.g,Si.X.M.call(this)},Xe(ki,Fn),Xe(Ii,Vn),Xe(Ci,Ei),Ci.prototype.xa=function(){Yt(this.g,"a")},Ci.prototype.wa=function(e){Yt(this.g,new ki(e))},Ci.prototype.va=function(e){Yt(this.g,new Ii)},Ci.prototype.ua=function(){Yt(this.g,"b")},xi.prototype.createWebChannel=xi.prototype.g,Si.prototype.send=Si.prototype.u,Si.prototype.open=Si.prototype.m,Si.prototype.close=Si.prototype.close,An.NO_ERROR=0,An.TIMEOUT=8,An.HTTP_ERROR=6,Pn.COMPLETE="complete",Rn.EventType=Ln,Ln.OPEN="a",Ln.CLOSE="b",Ln.ERROR="c",Ln.MESSAGE="d",Xt.prototype.listen=Xt.prototype.N,Hr.prototype.listenOnce=Hr.prototype.O,Hr.prototype.getLastError=Hr.prototype.Oa,Hr.prototype.getLastErrorCode=Hr.prototype.Ea,Hr.prototype.getStatus=Hr.prototype.aa,Hr.prototype.getResponseJson=Hr.prototype.Sa,Hr.prototype.getResponseText=Hr.prototype.fa,Hr.prototype.send=Hr.prototype.da,Hr.prototype.setWithCredentials=Hr.prototype.Ka;var Ni=Ve.createWebChannelTransport=function(){return new xi},Ai=Ve.getStatEventTarget=function(){return En()},Pi=Ve.ErrorCode=An,Di=Ve.EventType=Pn,Mi=Ve.Event=_n,Ri=Ve.Stat={sb:0,vb:1,wb:2,Pb:3,Ub:4,Rb:5,Sb:6,Qb:7,Ob:8,Tb:9,PROXY:10,NOPROXY:11,Mb:12,Ib:13,Jb:14,Hb:15,Kb:16,Lb:17,ob:18,nb:19,pb:20},Oi=Ve.FetchXmlHttpFactory=Fr,Li=Ve.WebChannel=Rn,Fi=Ve.XhrIo=Hr;const Vi="@firebase/firestore";class Ui{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Ui.UNAUTHENTICATED=new Ui(null),Ui.GOOGLE_CREDENTIALS=new Ui("google-credentials-uid"),Ui.FIRST_PARTY=new Ui("first-party-uid"),Ui.MOCK_USER=new Ui("mock-user");let Bi="9.17.1";const ji=new J("@firebase/firestore");function qi(){return ji.logLevel}function $i(e,...t){if(ji.logLevel<=G.DEBUG){const n=t.map(Gi);ji.debug(`Firestore (${Bi}): ${e}`,...n)}}function Hi(e,...t){if(ji.logLevel<=G.ERROR){const n=t.map(Gi);ji.error(`Firestore (${Bi}): ${e}`,...n)}}function Ki(e,...t){if(ji.logLevel<=G.WARN){const n=t.map(Gi);ji.warn(`Firestore (${Bi}): ${e}`,...n)}}function Gi(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function zi(e="Unexpected state"){const t=`FIRESTORE (${Bi}) INTERNAL ASSERTION FAILED: `+e;throw Hi(t),new Error(t)}function Wi(e,t){e||zi()}function Qi(e,t){return e}const Xi={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Yi extends O{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ji{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class Zi{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class es{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(Ui.UNAUTHENTICATED)))}shutdown(){}}class ts{constructor(e){this.t=e,this.currentUser=Ui.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let i=new Ji;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Ji,e.enqueueRetryable((()=>r(this.currentUser)))};const s=()=>{const t=i;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{$i("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),s()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):($i("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Ji)}}),0),s()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?($i("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(Wi("string"==typeof t.accessToken),new Zi(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return Wi(null===e||"string"==typeof e),new Ui(e)}}class ns{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r,this.type="FirstParty",this.user=Ui.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(Wi(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);const e=this.I();return e&&this.p.set("Authorization",e),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class rs{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r}getToken(){return Promise.resolve(new ns(this.h,this.l,this.m,this.g))}start(e,t){e.enqueueRetryable((()=>t(Ui.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class is{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class ss{constructor(e){this.T=e,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(e,t){const n=e=>{null!=e.error&&$i("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.A;return this.A=e.token,$i("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{$i("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.T.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.T.getImmediate({optional:!0});e?r(e):$i("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(Wi("string"==typeof e.token),this.A=e.token,new is(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function os(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class as{static R(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const r=os(40);for(let i=0;i<r.length;++i)n.length<20&&r[i]<t&&(n+=e.charAt(r[i]%e.length))}return n}}function cs(e,t){return e<t?-1:e>t?1:0}function us(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}class ls{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new Yi(Xi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new Yi(Xi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Yi(Xi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new Yi(Xi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ls.fromMillis(Date.now())}static fromDate(e){return ls.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new ls(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?cs(this.nanoseconds,e.nanoseconds):cs(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class hs{constructor(e){this.timestamp=e}static fromTimestamp(e){return new hs(e)}static min(){return new hs(new ls(0,0))}static max(){return new hs(new ls(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ds{constructor(e,t,n){void 0===t?t=0:t>e.length&&zi(),void 0===n?n=e.length-t:n>e.length-t&&zi(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===ds.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof ds?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class fs extends ds{construct(e,t,n){return new fs(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new Yi(Xi.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new fs(t)}static emptyPath(){return new fs([])}}const ps=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class gs extends ds{construct(e,t,n){return new gs(e,t,n)}static isValidIdentifier(e){return ps.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),gs.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new gs(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const i=()=>{if(0===n.length)throw new Yi(Xi.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Yi(Xi.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Yi(Xi.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(s=!s,r++):"."!==t||s?(n+=t,r++):(i(),r++)}if(i(),s)throw new Yi(Xi.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new gs(t)}static emptyPath(){return new gs([])}}class ms{constructor(e){this.path=e}static fromPath(e){return new ms(fs.fromString(e))}static fromName(e){return new ms(fs.fromString(e).popFirst(5))}static empty(){return new ms(fs.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===fs.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return fs.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new ms(new fs(e.slice()))}}function ys(e){return new vs(e.readTime,e.key,-1)}class vs{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new vs(hs.min(),ms.empty(),-1)}static max(){return new vs(hs.max(),ms.empty(),-1)}}function ws(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=ms.comparator(e.documentKey,t.documentKey),0!==n?n:cs(e.largestBatchId,t.largestBatchId))}class bs{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function _s(e){if(e.code!==Xi.FAILED_PRECONDITION||"The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab."!==e.message)throw e;$i("LocalStore","Unexpectedly lost primary lease")}class Ts{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&zi(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new Ts(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof Ts?t:Ts.resolve(t)}catch(e){return Ts.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):Ts.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):Ts.reject(t)}static resolve(e){return new Ts(((t,n)=>{t(e)}))}static reject(e){return new Ts(((t,n)=>{n(e)}))}static waitFor(e){return new Ts(((t,n)=>{let r=0,i=0,s=!1;e.forEach((e=>{++r,e.next((()=>{++i,s&&i===r&&t()}),(e=>n(e)))})),s=!0,i===r&&t()}))}static or(e){let t=Ts.resolve(!1);for(const n of e)t=t.next((e=>e?Ts.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new Ts(((n,r)=>{const i=e.length,s=new Array(i);let o=0;for(let a=0;a<i;a++){const c=a;t(e[c]).next((e=>{s[c]=e,++o,o===i&&n(s)}),(e=>r(e)))}}))}static doWhile(e,t){return new Ts(((n,r)=>{const i=()=>{!0===e()?t().next((()=>{i()}),r):n()};i()}))}}function Es(e){return"IndexedDbTransactionError"===e.name}class xs{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ut(e),this.ct=e=>t.writeSequenceNumber(e))}ut(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ct&&this.ct(e),e}}xs.at=-1;class Ss{constructor(e,t,n,r,i,s,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class ks{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new ks("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof ks&&e.projectId===this.projectId&&e.database===this.database}}function Is(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Cs(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Ns(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function As(e){return null==e}function Ps(e){return 0===e&&1/e==-1/0}class Ds{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new Ds(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Ds(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return cs(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Ds.EMPTY_BYTE_STRING=new Ds("");const Ms=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Rs(e){if(Wi(!!e),"string"==typeof e){let t=0;const n=Ms.exec(e);if(Wi(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:Os(e.seconds),nanos:Os(e.nanos)}}function Os(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ls(e){return"string"==typeof e?Ds.fromBase64String(e):Ds.fromUint8Array(e)}function Fs(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Vs(e){const t=e.mapValue.fields.__previous_value__;return Fs(t)?Vs(t):t}function Us(e){const t=Rs(e.mapValue.fields.__local_write_time__.timestampValue);return new ls(t.seconds,t.nanos)}const Bs={fields:{__type__:{stringValue:"__max__"}}};function js(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Fs(e)?4:to(e)?9007199254740991:10:zi()}function qs(e,t){if(e===t)return!0;const n=js(e);if(n!==js(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Us(e).isEqual(Us(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=Rs(e.timestampValue),r=Rs(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return Ls(e.bytesValue).isEqual(Ls(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return Os(e.geoPointValue.latitude)===Os(t.geoPointValue.latitude)&&Os(e.geoPointValue.longitude)===Os(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Os(e.integerValue)===Os(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=Os(e.doubleValue),r=Os(t.doubleValue);return n===r?Ps(n)===Ps(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return us(e.arrayValue.values||[],t.arrayValue.values||[],qs);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(Is(n)!==Is(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!qs(n[e],r[e])))return!1;return!0}(e,t);default:return zi()}}function $s(e,t){return void 0!==(e.values||[]).find((e=>qs(e,t)))}function Hs(e,t){if(e===t)return 0;const n=js(e),r=js(t);if(n!==r)return cs(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return cs(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=Os(e.integerValue||e.doubleValue),r=Os(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Ks(e.timestampValue,t.timestampValue);case 4:return Ks(Us(e),Us(t));case 5:return cs(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ls(e),r=Ls(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=cs(n[e],r[e]);if(0!==t)return t}return cs(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=cs(Os(e.latitude),Os(t.latitude));return 0!==n?n:cs(Os(e.longitude),Os(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=Hs(n[e],r[e]);if(t)return t}return cs(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Bs&&t===Bs)return 0;if(e===Bs)return 1;if(t===Bs)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){const t=cs(r[e],s[e]);if(0!==t)return t;const o=Hs(n[r[e]],i[s[e]]);if(0!==o)return o}return cs(r.length,s.length)}(e.mapValue,t.mapValue);default:throw zi()}}function Ks(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return cs(e,t);const n=Rs(e),r=Rs(t),i=cs(n.seconds,r.seconds);return 0!==i?i:cs(n.nanos,r.nanos)}function Gs(e){return zs(e)}function zs(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Rs(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Ls(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,ms.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=zs(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const i of t)r?r=!1:n+=",",n+=`${i}:${zs(e.fields[i])}`;return n+"}"}(e.mapValue):zi();var t,n}function Ws(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Qs(e){return!!e&&"integerValue"in e}function Xs(e){return!!e&&"arrayValue"in e}function Ys(e){return!!e&&"nullValue"in e}function Js(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Zs(e){return!!e&&"mapValue"in e}function eo(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return Cs(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=eo(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=eo(e.arrayValue.values[n]);return t}return Object.assign({},e)}function to(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}class no{constructor(e,t){this.position=e,this.inclusive=t}}function ro(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],o=e.position[i];if(r=s.field.isKeyField()?ms.comparator(ms.fromName(o.referenceValue),n.key):Hs(o,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function io(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!qs(e.position[n],t.position[n]))return!1;return!0}class so{}class oo extends so{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new po(e,t,n):"array-contains"===t?new vo(e,n):"in"===t?new wo(e,n):"not-in"===t?new bo(e,n):"array-contains-any"===t?new _o(e,n):new oo(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new go(e,n):new mo(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Hs(t,this.value)):null!==t&&js(this.value)===js(t)&&this.matchesComparison(Hs(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return zi()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class ao extends so{constructor(e,t){super(),this.filters=e,this.op=t,this.ht=null}static create(e,t){return new ao(e,t)}matches(e){return co(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ht||(this.ht=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ht}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const e=this.lt((e=>e.isInequality()));return null!==e?e.field:null}lt(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function co(e){return"and"===e.op}function uo(e){return function(e){for(const t of e.filters)if(t instanceof ao)return!1;return!0}(e)&&co(e)}function lo(e){if(e instanceof oo)return e.field.canonicalString()+e.op.toString()+Gs(e.value);if(uo(e))return e.filters.map((e=>lo(e))).join(",");{const t=e.filters.map((e=>lo(e))).join(",");return`${e.op}(${t})`}}function ho(e,t){return e instanceof oo?function(e,t){return t instanceof oo&&e.op===t.op&&e.field.isEqual(t.field)&&qs(e.value,t.value)}(e,t):e instanceof ao?function(e,t){return t instanceof ao&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&ho(n,t.filters[r])),!0)}(e,t):void zi()}function fo(e){return e instanceof oo?function(e){return`${e.field.canonicalString()} ${e.op} ${Gs(e.value)}`}(e):e instanceof ao?function(e){return e.op.toString()+" {"+e.getFilters().map(fo).join(" ,")+"}"}(e):"Filter"}class po extends oo{constructor(e,t,n){super(e,t,n),this.key=ms.fromName(n.referenceValue)}matches(e){const t=ms.comparator(e.key,this.key);return this.matchesComparison(t)}}class go extends oo{constructor(e,t){super(e,"in",t),this.keys=yo(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class mo extends oo{constructor(e,t){super(e,"not-in",t),this.keys=yo(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function yo(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>ms.fromName(e.referenceValue)))}class vo extends oo{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Xs(t)&&$s(t.arrayValue,this.value)}}class wo extends oo{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&$s(this.value.arrayValue,t)}}class bo extends oo{constructor(e,t){super(e,"not-in",t)}matches(e){if($s(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!$s(this.value.arrayValue,t)}}class _o extends oo{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Xs(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>$s(this.value.arrayValue,e)))}}class To{constructor(e,t="asc"){this.field=e,this.dir=t}}function Eo(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class xo{constructor(e,t){this.comparator=e,this.root=t||ko.EMPTY}insert(e,t){return new xo(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,ko.BLACK,null,null))}remove(e){return new xo(this.comparator,this.root.remove(e,this.comparator).copy(null,null,ko.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new So(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new So(this.root,e,this.comparator,!1)}getReverseIterator(){return new So(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new So(this.root,e,this.comparator,!0)}}class So{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class ko{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:ko.RED,this.left=null!=r?r:ko.EMPTY,this.right=null!=i?i:ko.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new ko(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return ko.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return ko.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,ko.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,ko.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw zi();if(this.right.isRed())throw zi();const e=this.left.check();if(e!==this.right.check())throw zi();return e+(this.isRed()?0:1)}}ko.EMPTY=null,ko.RED=!0,ko.BLACK=!1,ko.EMPTY=new class{constructor(){this.size=0}get key(){throw zi()}get value(){throw zi()}get color(){throw zi()}get left(){throw zi()}get right(){throw zi()}copy(e,t,n,r,i){return this}insert(e,t,n){return new ko(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Io{constructor(e){this.comparator=e,this.data=new xo(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Co(this.data.getIterator())}getIteratorFrom(e){return new Co(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Io))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Io(this.comparator);return t.data=e,t}}class Co{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}class No{constructor(e){this.fields=e,e.sort(gs.comparator)}static empty(){return new No([])}unionWith(e){let t=new Io(gs.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new No(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return us(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class Ao{constructor(e){this.value=e}static empty(){return new Ao({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Zs(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=eo(t)}setAll(e){let t=gs.emptyPath(),n={},r=[];e.forEach(((e,i)=>{if(!t.isImmediateParentOf(i)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=eo(e):r.push(i.lastSegment())}));const i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){const t=this.field(e.popLast());Zs(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return qs(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];Zs(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){Cs(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Ao(eo(this.value))}}function Po(e){const t=[];return Cs(e.fields,((e,n)=>{const r=new gs([e]);if(Zs(n)){const e=Po(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new No(t)}class Do{constructor(e,t,n,r,i,s,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=o}static newInvalidDocument(e){return new Do(e,0,hs.min(),hs.min(),hs.min(),Ao.empty(),0)}static newFoundDocument(e,t,n,r){return new Do(e,1,t,hs.min(),n,r,0)}static newNoDocument(e,t){return new Do(e,2,t,hs.min(),hs.min(),Ao.empty(),0)}static newUnknownDocument(e,t){return new Do(e,3,t,hs.min(),hs.min(),Ao.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(hs.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ao.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ao.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=hs.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Do&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Do(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Mo{constructor(e,t=null,n=[],r=[],i=null,s=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=o,this.ft=null}}function Ro(e,t=null,n=[],r=[],i=null,s=null,o=null){return new Mo(e,t,n,r,i,s,o)}function Oo(e){const t=Qi(e);if(null===t.ft){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>lo(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),As(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Gs(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Gs(e))).join(",")),t.ft=e}return t.ft}function Lo(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Eo(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!ho(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!io(e.startAt,t.startAt)&&io(e.endAt,t.endAt)}function Fo(e){return ms.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class Vo{constructor(e,t=null,n=[],r=[],i=null,s="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=o,this.endAt=a,this.dt=null,this._t=null,this.startAt,this.endAt}}function Uo(e){return new Vo(e)}function Bo(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function jo(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function qo(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function $o(e){return null!==e.collectionGroup}function Ho(e){const t=Qi(e);if(null===t.dt){t.dt=[];const e=qo(t),n=jo(t);if(null!==e&&null===n)e.isKeyField()||t.dt.push(new To(e)),t.dt.push(new To(gs.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.dt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.dt.push(new To(gs.keyField(),e))}}}return t.dt}function Ko(e){const t=Qi(e);if(!t._t)if("F"===t.limitType)t._t=Ro(t.path,t.collectionGroup,Ho(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const n of Ho(t)){const t="desc"===n.dir?"asc":"desc";e.push(new To(n.field,t))}const n=t.endAt?new no(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new no(t.startAt.position,t.startAt.inclusive):null;t._t=Ro(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t._t}function Go(e,t){t.getFirstInequalityField(),qo(e);const n=e.filters.concat([t]);return new Vo(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function zo(e,t,n){return new Vo(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Wo(e,t){return Lo(Ko(e),Ko(t))&&e.limitType===t.limitType}function Qo(e){return`${Oo(Ko(e))}|lt:${e.limitType}`}function Xo(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>fo(e))).join(", ")}]`),As(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Gs(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Gs(e))).join(",")),`Target(${t})`}(Ko(e))}; limitType=${e.limitType})`}function Yo(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):ms.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Ho(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=ro(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Ho(e),t)||e.endAt&&!function(e,t,n){const r=ro(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Ho(e),t))}(e,t)}function Jo(e){return(t,n)=>{let r=!1;for(const i of Ho(e)){const e=Zo(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}function Zo(e,t,n){const r=e.field.isKeyField()?ms.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Hs(r,i):zi()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return zi()}}function ea(e,t){if(e.wt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ps(t)?"-0":t}}function ta(e){return{integerValue:""+e}}function na(e,t){return function(e){return"number"==typeof e&&Number.isInteger(e)&&!Ps(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}(t)?ta(t):ea(e,t)}class ra{constructor(){this._=void 0}}function ia(e,t,n){return e instanceof aa?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof ca?ua(e,t):e instanceof la?ha(e,t):function(e,t){const n=oa(e,t),r=fa(n)+fa(e.gt);return Qs(n)&&Qs(e.gt)?ta(r):ea(e.yt,r)}(e,t)}function sa(e,t,n){return e instanceof ca?ua(e,t):e instanceof la?ha(e,t):n}function oa(e,t){return e instanceof da?Qs(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class aa extends ra{}class ca extends ra{constructor(e){super(),this.elements=e}}function ua(e,t){const n=pa(t);for(const t of e.elements)n.some((e=>qs(e,t)))||n.push(t);return{arrayValue:{values:n}}}class la extends ra{constructor(e){super(),this.elements=e}}function ha(e,t){let n=pa(t);for(const t of e.elements)n=n.filter((e=>!qs(e,t)));return{arrayValue:{values:n}}}class da extends ra{constructor(e,t){super(),this.yt=e,this.gt=t}}function fa(e){return Os(e.integerValue||e.doubleValue)}function pa(e){return Xs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class ga{constructor(e,t){this.field=e,this.transform=t}}class ma{constructor(e,t){this.version=e,this.transformResults=t}}class ya{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new ya}static exists(e){return new ya(void 0,e)}static updateTime(e){return new ya(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function va(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class wa{}function ba(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Aa(e.key,ya.none()):new Sa(e.key,e.data,ya.none());{const n=e.data,r=Ao.empty();let i=new Io(gs.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new ka(e.key,r,new No(i.toArray()),ya.none())}}function _a(e,t,n){e instanceof Sa?function(e,t,n){const r=e.value.clone(),i=Ca(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof ka?function(e,t,n){if(!va(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Ca(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(Ia(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Ta(e,t,n,r){return e instanceof Sa?function(e,t,n,r){if(!va(e.precondition,t))return n;const i=e.value.clone(),s=Na(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof ka?function(e,t,n,r){if(!va(e.precondition,t))return n;const i=Na(e.fieldTransforms,r,t),s=t.data;return s.setAll(Ia(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return va(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Ea(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=oa(r.transform,e||null);null!=i&&(null===n&&(n=Ao.empty()),n.set(r.field,i))}return n||null}function xa(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&us(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof ca&&t instanceof ca||e instanceof la&&t instanceof la?us(e.elements,t.elements,qs):e instanceof da&&t instanceof da?qs(e.gt,t.gt):e instanceof aa&&t instanceof aa}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class Sa extends wa{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class ka extends wa{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function Ia(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function Ca(e,t,n){const r=new Map;Wi(e.length===n.length);for(let i=0;i<n.length;i++){const s=e[i],o=s.transform,a=t.data.field(s.field);r.set(s.field,sa(o,a,n[i]))}return r}function Na(e,t,n){const r=new Map;for(const i of e){const e=i.transform,s=n.data.field(i.field);r.set(i.field,ia(e,s,t))}return r}class Aa extends wa{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Pa extends wa{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Da{constructor(e){this.count=e}}var Ma,Ra;function Oa(e){if(void 0===e)return Hi("GRPC error has no .code"),Xi.UNKNOWN;switch(e){case Ma.OK:return Xi.OK;case Ma.CANCELLED:return Xi.CANCELLED;case Ma.UNKNOWN:return Xi.UNKNOWN;case Ma.DEADLINE_EXCEEDED:return Xi.DEADLINE_EXCEEDED;case Ma.RESOURCE_EXHAUSTED:return Xi.RESOURCE_EXHAUSTED;case Ma.INTERNAL:return Xi.INTERNAL;case Ma.UNAVAILABLE:return Xi.UNAVAILABLE;case Ma.UNAUTHENTICATED:return Xi.UNAUTHENTICATED;case Ma.INVALID_ARGUMENT:return Xi.INVALID_ARGUMENT;case Ma.NOT_FOUND:return Xi.NOT_FOUND;case Ma.ALREADY_EXISTS:return Xi.ALREADY_EXISTS;case Ma.PERMISSION_DENIED:return Xi.PERMISSION_DENIED;case Ma.FAILED_PRECONDITION:return Xi.FAILED_PRECONDITION;case Ma.ABORTED:return Xi.ABORTED;case Ma.OUT_OF_RANGE:return Xi.OUT_OF_RANGE;case Ma.UNIMPLEMENTED:return Xi.UNIMPLEMENTED;case Ma.DATA_LOSS:return Xi.DATA_LOSS;default:return zi()}}(Ra=Ma||(Ma={}))[Ra.OK=0]="OK",Ra[Ra.CANCELLED=1]="CANCELLED",Ra[Ra.UNKNOWN=2]="UNKNOWN",Ra[Ra.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ra[Ra.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ra[Ra.NOT_FOUND=5]="NOT_FOUND",Ra[Ra.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ra[Ra.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ra[Ra.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ra[Ra.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ra[Ra.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ra[Ra.ABORTED=10]="ABORTED",Ra[Ra.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ra[Ra.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ra[Ra.INTERNAL=13]="INTERNAL",Ra[Ra.UNAVAILABLE=14]="UNAVAILABLE",Ra[Ra.DATA_LOSS=15]="DATA_LOSS";class La{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){Cs(this.inner,((t,n)=>{for(const[t,r]of n)e(t,r)}))}isEmpty(){return Ns(this.inner)}size(){return this.innerSize}}const Fa=new xo(ms.comparator);function Va(){return Fa}const Ua=new xo(ms.comparator);function Ba(...e){let t=Ua;for(const n of e)t=t.insert(n.key,n);return t}function ja(e){let t=Ua;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function qa(){return Ha()}function $a(){return Ha()}function Ha(){return new La((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Ka=new xo(ms.comparator),Ga=new Io(ms.comparator);function za(...e){let t=Ga;for(const n of e)t=t.add(n);return t}const Wa=new Io(cs);function Qa(){return Wa}class Xa{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Ya.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Xa(hs.min(),r,Qa(),Va(),za())}}class Ya{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Ya(n,t,za(),za(),za())}}class Ja{constructor(e,t,n,r){this.It=e,this.removedTargetIds=t,this.key=n,this.Tt=r}}class Za{constructor(e,t){this.targetId=e,this.Et=t}}class ec{constructor(e,t,n=Ds.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class tc{constructor(){this.At=0,this.Rt=ic(),this.bt=Ds.EMPTY_BYTE_STRING,this.Pt=!1,this.vt=!0}get current(){return this.Pt}get resumeToken(){return this.bt}get Vt(){return 0!==this.At}get St(){return this.vt}Dt(e){e.approximateByteSize()>0&&(this.vt=!0,this.bt=e)}Ct(){let e=za(),t=za(),n=za();return this.Rt.forEach(((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:zi()}})),new Ya(this.bt,this.Pt,e,t,n)}xt(){this.vt=!1,this.Rt=ic()}Nt(e,t){this.vt=!0,this.Rt=this.Rt.insert(e,t)}kt(e){this.vt=!0,this.Rt=this.Rt.remove(e)}Ot(){this.At+=1}Mt(){this.At-=1}Ft(){this.vt=!0,this.Pt=!0}}class nc{constructor(e){this.$t=e,this.Bt=new Map,this.Lt=Va(),this.qt=rc(),this.Ut=new Io(cs)}Kt(e){for(const t of e.It)e.Tt&&e.Tt.isFoundDocument()?this.Gt(t,e.Tt):this.Qt(t,e.key,e.Tt);for(const t of e.removedTargetIds)this.Qt(t,e.key,e.Tt)}jt(e){this.forEachTarget(e,(t=>{const n=this.Wt(t);switch(e.state){case 0:this.zt(t)&&n.Dt(e.resumeToken);break;case 1:n.Mt(),n.Vt||n.xt(),n.Dt(e.resumeToken);break;case 2:n.Mt(),n.Vt||this.removeTarget(t);break;case 3:this.zt(t)&&(n.Ft(),n.Dt(e.resumeToken));break;case 4:this.zt(t)&&(this.Ht(t),n.Dt(e.resumeToken));break;default:zi()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Bt.forEach(((e,n)=>{this.zt(n)&&t(n)}))}Jt(e){const t=e.targetId,n=e.Et.count,r=this.Yt(t);if(r){const e=r.target;if(Fo(e))if(0===n){const n=new ms(e.path);this.Qt(t,n,Do.newNoDocument(n,hs.min()))}else Wi(1===n);else this.Xt(t)!==n&&(this.Ht(t),this.Ut=this.Ut.add(t))}}Zt(e){const t=new Map;this.Bt.forEach(((n,r)=>{const i=this.Yt(r);if(i){if(n.current&&Fo(i.target)){const t=new ms(i.target.path);null!==this.Lt.get(t)||this.te(r,t)||this.Qt(r,t,Do.newNoDocument(t,e))}n.St&&(t.set(r,n.Ct()),n.xt())}}));let n=za();this.qt.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Yt(e);return!t||2===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.Lt.forEach(((t,n)=>n.setReadTime(e)));const r=new Xa(e,t,this.Ut,this.Lt,n);return this.Lt=Va(),this.qt=rc(),this.Ut=new Io(cs),r}Gt(e,t){if(!this.zt(e))return;const n=this.te(e,t.key)?2:0;this.Wt(e).Nt(t.key,n),this.Lt=this.Lt.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ee(t.key).add(e))}Qt(e,t,n){if(!this.zt(e))return;const r=this.Wt(e);this.te(e,t)?r.Nt(t,1):r.kt(t),this.qt=this.qt.insert(t,this.ee(t).delete(e)),n&&(this.Lt=this.Lt.insert(t,n))}removeTarget(e){this.Bt.delete(e)}Xt(e){const t=this.Wt(e).Ct();return this.$t.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ot(e){this.Wt(e).Ot()}Wt(e){let t=this.Bt.get(e);return t||(t=new tc,this.Bt.set(e,t)),t}ee(e){let t=this.qt.get(e);return t||(t=new Io(cs),this.qt=this.qt.insert(e,t)),t}zt(e){const t=null!==this.Yt(e);return t||$i("WatchChangeAggregator","Detected inactive target",e),t}Yt(e){const t=this.Bt.get(e);return t&&t.Vt?null:this.$t.ne(e)}Ht(e){this.Bt.set(e,new tc),this.$t.getRemoteKeysForTarget(e).forEach((t=>{this.Qt(e,t,null)}))}te(e,t){return this.$t.getRemoteKeysForTarget(e).has(t)}}function rc(){return new xo(ms.comparator)}function ic(){return new xo(ms.comparator)}const sc={asc:"ASCENDING",desc:"DESCENDING"},oc={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ac={and:"AND",or:"OR"};class cc{constructor(e,t){this.databaseId=e,this.wt=t}}function uc(e,t){return e.wt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function lc(e,t){return e.wt?t.toBase64():t.toUint8Array()}function hc(e,t){return uc(e,t.toTimestamp())}function dc(e){return Wi(!!e),hs.fromTimestamp(function(e){const t=Rs(e);return new ls(t.seconds,t.nanos)}(e))}function fc(e,t){return function(e){return new fs(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function pc(e){const t=fs.fromString(e);return Wi(Dc(t)),t}function gc(e,t){return fc(e.databaseId,t.path)}function mc(e,t){const n=pc(t);if(n.get(1)!==e.databaseId.projectId)throw new Yi(Xi.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Yi(Xi.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new ms(wc(n))}function yc(e,t){return fc(e.databaseId,t)}function vc(e){return new fs(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function wc(e){return Wi(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function bc(e,t,n){return{name:gc(e,t),fields:n.value.mapValue.fields}}function _c(e,t){return{documents:[yc(e,t.path)]}}function Tc(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=yc(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=yc(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const i=function(e){if(0!==e.length)return Ac(ao.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const s=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Cc(e.field),direction:Sc(e.dir)}}(e)))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);const o=function(e,t){return e.wt||As(t)?t:{value:t}}(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Ec(e){let t=function(e){const t=pc(e);return 4===t.length?fs.emptyPath():wc(t)}(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let i=null;if(r>0){Wi(1===r);const e=n.from[0];e.allDescendants?i=e.collectionId:t=t.child(e.collectionId)}let s=[];n.where&&(s=function(e){const t=xc(e);return t instanceof ao&&uo(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new To(Nc(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,As(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new no(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new no(n,t)}(n.endAt)),function(e,t,n,r,i,s,o,a){return new Vo(e,t,n,r,i,s,o,a)}(t,i,o,s,a,"F",c,u)}function xc(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Nc(e.unaryFilter.field);return oo.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Nc(e.unaryFilter.field);return oo.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Nc(e.unaryFilter.field);return oo.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=Nc(e.unaryFilter.field);return oo.create(i,"!=",{nullValue:"NULL_VALUE"});default:return zi()}}(e):void 0!==e.fieldFilter?function(e){return oo.create(Nc(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return zi()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return ao.create(e.compositeFilter.filters.map((e=>xc(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return zi()}}(e.compositeFilter.op))}(e):zi()}function Sc(e){return sc[e]}function kc(e){return oc[e]}function Ic(e){return ac[e]}function Cc(e){return{fieldPath:e.canonicalString()}}function Nc(e){return gs.fromServerFormat(e.fieldPath)}function Ac(e){return e instanceof oo?function(e){if("=="===e.op){if(Js(e.value))return{unaryFilter:{field:Cc(e.field),op:"IS_NAN"}};if(Ys(e.value))return{unaryFilter:{field:Cc(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Js(e.value))return{unaryFilter:{field:Cc(e.field),op:"IS_NOT_NAN"}};if(Ys(e.value))return{unaryFilter:{field:Cc(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Cc(e.field),op:kc(e.op),value:e.value}}}(e):e instanceof ao?function(e){const t=e.getFilters().map((e=>Ac(e)));return 1===t.length?t[0]:{compositeFilter:{op:Ic(e.op),filters:t}}}(e):zi()}function Pc(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Dc(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class Mc{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&_a(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Ta(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Ta(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=$a();return this.mutations.forEach((r=>{const i=e.get(r.key),s=i.overlayedDocument;let o=this.applyToLocalView(s,i.mutatedFields);o=t.has(r.key)?null:o;const a=ba(s,o);null!==a&&n.set(r.key,a),s.isValidDocument()||s.convertToNoDocument(hs.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),za())}isEqual(e){return this.batchId===e.batchId&&us(this.mutations,e.mutations,((e,t)=>xa(e,t)))&&us(this.baseMutations,e.baseMutations,((e,t)=>xa(e,t)))}}class Rc{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Wi(e.mutations.length===n.length);let r=Ka;const i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new Rc(e,t,n,r)}}class Oc{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Lc{constructor(e,t,n,r,i=hs.min(),s=hs.min(),o=Ds.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=o}withSequenceNumber(e){return new Lc(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new Lc(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new Lc(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Fc{constructor(e){this.ie=e}}function Vc(e){const t=Ec({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?zo(t,t.limit,"L"):t}class Uc{constructor(){}ue(e,t){this.ce(e,t),t.ae()}ce(e,t){if("nullValue"in e)this.he(t,5);else if("booleanValue"in e)this.he(t,10),t.le(e.booleanValue?1:0);else if("integerValue"in e)this.he(t,15),t.le(Os(e.integerValue));else if("doubleValue"in e){const n=Os(e.doubleValue);isNaN(n)?this.he(t,13):(this.he(t,15),Ps(n)?t.le(0):t.le(n))}else if("timestampValue"in e){const n=e.timestampValue;this.he(t,20),"string"==typeof n?t.fe(n):(t.fe(`${n.seconds||""}`),t.le(n.nanos||0))}else if("stringValue"in e)this.de(e.stringValue,t),this._e(t);else if("bytesValue"in e)this.he(t,30),t.we(Ls(e.bytesValue)),this._e(t);else if("referenceValue"in e)this.me(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.he(t,45),t.le(n.latitude||0),t.le(n.longitude||0)}else"mapValue"in e?to(e)?this.he(t,Number.MAX_SAFE_INTEGER):(this.ge(e.mapValue,t),this._e(t)):"arrayValue"in e?(this.ye(e.arrayValue,t),this._e(t)):zi()}de(e,t){this.he(t,25),this.pe(e,t)}pe(e,t){t.fe(e)}ge(e,t){const n=e.fields||{};this.he(t,55);for(const e of Object.keys(n))this.de(e,t),this.ce(n[e],t)}ye(e,t){const n=e.values||[];this.he(t,50);for(const e of n)this.ce(e,t)}me(e,t){this.he(t,37),ms.fromName(e).path.forEach((e=>{this.he(t,60),this.pe(e,t)}))}he(e,t){e.le(t)}_e(e){e.le(2)}}Uc.Ie=new Uc;class Bc{constructor(){this.Je=new jc}addToCollectionParentIndex(e,t){return this.Je.add(t),Ts.resolve()}getCollectionParents(e,t){return Ts.resolve(this.Je.getEntries(t))}addFieldIndex(e,t){return Ts.resolve()}deleteFieldIndex(e,t){return Ts.resolve()}getDocumentsMatchingTarget(e,t){return Ts.resolve(null)}getIndexType(e,t){return Ts.resolve(0)}getFieldIndexes(e,t){return Ts.resolve([])}getNextCollectionGroupToUpdate(e){return Ts.resolve(null)}getMinOffset(e,t){return Ts.resolve(vs.min())}getMinOffsetFromCollectionGroup(e,t){return Ts.resolve(vs.min())}updateCollectionGroup(e,t,n){return Ts.resolve()}updateIndexEntries(e,t){return Ts.resolve()}}class jc{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Io(fs.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Io(fs.comparator)).toArray()}}new Uint8Array(0);class qc{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new qc(e,qc.DEFAULT_COLLECTION_PERCENTILE,qc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}qc.DEFAULT_COLLECTION_PERCENTILE=10,qc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,qc.DEFAULT=new qc(41943040,qc.DEFAULT_COLLECTION_PERCENTILE,qc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),qc.DISABLED=new qc(-1,0,0);class $c{constructor(e){this.bn=e}next(){return this.bn+=2,this.bn}static Pn(){return new $c(0)}static vn(){return new $c(-1)}}class Hc{constructor(){this.changes=new La((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Do.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?Ts.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Kc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Gc{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&Ta(n.mutation,e,No.empty(),ls.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,za()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=za()){const r=qa();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Ba();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=qa();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,za())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let i=Va();const s=Ha(),o=Ha();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof ka)?i=i.insert(t.key,t):void 0!==o?(s.set(t.key,o.mutation.getFieldMask()),Ta(o.mutation,t,o.mutation.getFieldMask(),ls.now())):s.set(t.key,No.empty())})),this.recalculateAndSaveOverlays(e,i).next((e=>(e.forEach(((e,t)=>s.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new Kc(t,null!==(n=s.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Ha();let r=new xo(((e,t)=>e-t)),i=za();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const i of e)i.keys().forEach((e=>{const s=t.get(e);if(null===s)return;let o=n.get(e)||No.empty();o=i.applyToLocalView(s,o),n.set(e,o);const a=(r.get(i.batchId)||za()).add(e);r=r.insert(i.batchId,a)}))})).next((()=>{const s=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,c=r.value,u=$a();c.forEach((e=>{if(!i.has(e)){const r=ba(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}})),s.push(this.documentOverlayCache.saveOverlays(e,a,u))}return Ts.waitFor(s)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return ms.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):$o(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((i=>{const s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):Ts.resolve(qa());let o=-1,a=i;return s.next((t=>Ts.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),i.get(t)?Ts.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,i))).next((()=>this.computeViews(e,a,t,za()))).next((e=>({batchId:o,changes:ja(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new ms(t)).next((e=>{let t=Ba();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const r=t.collectionGroup;let i=Ba();return this.indexManager.getCollectionParents(e,r).next((s=>Ts.forEach(s,(s=>{const o=function(e,t){return new Vo(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,s.child(r));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{i=i.insert(e,t)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(e,t,n){let r;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((i=>(r=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,r)))).next((e=>{r.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,Do.newInvalidDocument(r)))}));let n=Ba();return e.forEach(((e,i)=>{const s=r.get(e);void 0!==s&&Ta(s.mutation,i,No.empty(),ls.now()),Yo(t,i)&&(n=n.insert(e,i))})),n}))}}class zc{constructor(e){this.yt=e,this.Zn=new Map,this.ts=new Map}getBundleMetadata(e,t){return Ts.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){var n;return this.Zn.set(t.id,{id:(n=t).id,version:n.version,createTime:dc(n.createTime)}),Ts.resolve()}getNamedQuery(e,t){return Ts.resolve(this.ts.get(t))}saveNamedQuery(e,t){return this.ts.set(t.name,function(e){return{name:e.name,query:Vc(e.bundledQuery),readTime:dc(e.readTime)}}(t)),Ts.resolve()}}class Wc{constructor(){this.overlays=new xo(ms.comparator),this.es=new Map}getOverlay(e,t){return Ts.resolve(this.overlays.get(t))}getOverlays(e,t){const n=qa();return Ts.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.oe(e,t,r)})),Ts.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.es.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.es.delete(n)),Ts.resolve()}getOverlaysForCollection(e,t,n){const r=qa(),i=t.length+1,s=new ms(t.child("")),o=this.overlays.getIteratorFrom(s);for(;o.hasNext();){const e=o.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return Ts.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new xo(((e,t)=>e-t));const s=this.overlays.getIterator();for(;s.hasNext();){const e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=qa(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=qa(),a=i.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return Ts.resolve(o)}oe(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.es.get(r.largestBatchId).delete(n.key);this.es.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Oc(t,n));let i=this.es.get(t);void 0===i&&(i=za(),this.es.set(t,i)),this.es.set(t,i.add(n.key))}}class Qc{constructor(){this.ns=new Io(Xc.ss),this.rs=new Io(Xc.os)}isEmpty(){return this.ns.isEmpty()}addReference(e,t){const n=new Xc(e,t);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.cs(new Xc(e,t))}hs(e,t){e.forEach((e=>this.removeReference(e,t)))}ls(e){const t=new ms(new fs([])),n=new Xc(t,e),r=new Xc(t,e+1),i=[];return this.rs.forEachInRange([n,r],(e=>{this.cs(e),i.push(e.key)})),i}fs(){this.ns.forEach((e=>this.cs(e)))}cs(e){this.ns=this.ns.delete(e),this.rs=this.rs.delete(e)}ds(e){const t=new ms(new fs([])),n=new Xc(t,e),r=new Xc(t,e+1);let i=za();return this.rs.forEachInRange([n,r],(e=>{i=i.add(e.key)})),i}containsKey(e){const t=new Xc(e,0),n=this.ns.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Xc{constructor(e,t){this.key=e,this._s=t}static ss(e,t){return ms.comparator(e.key,t.key)||cs(e._s,t._s)}static os(e,t){return cs(e._s,t._s)||ms.comparator(e.key,t.key)}}class Yc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this.gs=new Io(Xc.ss)}checkEmpty(e){return Ts.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const i=this.ws;this.ws++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const s=new Mc(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.gs=this.gs.add(new Xc(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return Ts.resolve(s)}lookupMutationBatch(e,t){return Ts.resolve(this.ys(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.ps(n),i=r<0?0:r;return Ts.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}getHighestUnacknowledgedBatchId(){return Ts.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return Ts.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Xc(t,0),r=new Xc(t,Number.POSITIVE_INFINITY),i=[];return this.gs.forEachInRange([n,r],(e=>{const t=this.ys(e._s);i.push(t)})),Ts.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Io(cs);return t.forEach((e=>{const t=new Xc(e,0),r=new Xc(e,Number.POSITIVE_INFINITY);this.gs.forEachInRange([t,r],(e=>{n=n.add(e._s)}))})),Ts.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;ms.isDocumentKey(i)||(i=i.child(""));const s=new Xc(new ms(i),0);let o=new Io(cs);return this.gs.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e._s)),!0)}),s),Ts.resolve(this.Is(o))}Is(e){const t=[];return e.forEach((e=>{const n=this.ys(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){Wi(0===this.Ts(t.batchId,"removed")),this.mutationQueue.shift();let n=this.gs;return Ts.forEach(t.mutations,(r=>{const i=new Xc(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.gs=n}))}An(e){}containsKey(e,t){const n=new Xc(t,0),r=this.gs.firstAfterOrEqual(n);return Ts.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,Ts.resolve()}Ts(e,t){return this.ps(e)}ps(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ys(e){const t=this.ps(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Jc{constructor(e){this.Es=e,this.docs=new xo(ms.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Es(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return Ts.resolve(n?n.document.mutableCopy():Do.newInvalidDocument(t))}getEntries(e,t){let n=Va();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Do.newInvalidDocument(e))})),Ts.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Va();const s=t.path,o=new ms(s.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||ws(ys(o),n)<=0||(r.has(o.key)||Yo(t,o))&&(i=i.insert(o.key,o.mutableCopy()))}return Ts.resolve(i)}getAllFromCollectionGroup(e,t,n,r){zi()}As(e,t){return Ts.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Zc(this)}getSize(e){return Ts.resolve(this.size)}}class Zc extends Hc{constructor(e){super(),this.Yn=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.Yn.addEntry(e,r)):this.Yn.removeEntry(n)})),Ts.waitFor(t)}getFromCache(e,t){return this.Yn.getEntry(e,t)}getAllFromCache(e,t){return this.Yn.getEntries(e,t)}}class eu{constructor(e){this.persistence=e,this.Rs=new La((e=>Oo(e)),Lo),this.lastRemoteSnapshotVersion=hs.min(),this.highestTargetId=0,this.bs=0,this.Ps=new Qc,this.targetCount=0,this.vs=$c.Pn()}forEachTarget(e,t){return this.Rs.forEach(((e,n)=>t(n))),Ts.resolve()}getLastRemoteSnapshotVersion(e){return Ts.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return Ts.resolve(this.bs)}allocateTargetId(e){return this.highestTargetId=this.vs.next(),Ts.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.bs&&(this.bs=t),Ts.resolve()}Dn(e){this.Rs.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.vs=new $c(t),this.highestTargetId=t),e.sequenceNumber>this.bs&&(this.bs=e.sequenceNumber)}addTargetData(e,t){return this.Dn(t),this.targetCount+=1,Ts.resolve()}updateTargetData(e,t){return this.Dn(t),Ts.resolve()}removeTargetData(e,t){return this.Rs.delete(t.target),this.Ps.ls(t.targetId),this.targetCount-=1,Ts.resolve()}removeTargets(e,t,n){let r=0;const i=[];return this.Rs.forEach(((s,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Rs.delete(s),i.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),Ts.waitFor(i).next((()=>r))}getTargetCount(e){return Ts.resolve(this.targetCount)}getTargetData(e,t){const n=this.Rs.get(t)||null;return Ts.resolve(n)}addMatchingKeys(e,t,n){return this.Ps.us(t,n),Ts.resolve()}removeMatchingKeys(e,t,n){this.Ps.hs(t,n);const r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((t=>{i.push(r.markPotentiallyOrphaned(e,t))})),Ts.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Ps.ls(t),Ts.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Ps.ds(t);return Ts.resolve(n)}containsKey(e,t){return Ts.resolve(this.Ps.containsKey(t))}}class tu{constructor(e,t){this.Vs={},this.overlays={},this.Ss=new xs(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=e(this),this.Cs=new eu(this),this.indexManager=new Bc,this.remoteDocumentCache=function(e){return new Jc(e)}((e=>this.referenceDelegate.xs(e))),this.yt=new Fc(t),this.Ns=new zc(this.yt)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Wc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Vs[e.toKey()];return n||(n=new Yc(t,this.referenceDelegate),this.Vs[e.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(e,t,n){$i("MemoryPersistence","Starting transaction:",e);const r=new nu(this.Ss.next());return this.referenceDelegate.ks(),n(r).next((e=>this.referenceDelegate.Os(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Ms(e,t){return Ts.or(Object.values(this.Vs).map((n=>()=>n.containsKey(e,t))))}}class nu extends bs{constructor(e){super(),this.currentSequenceNumber=e}}class ru{constructor(e){this.persistence=e,this.Fs=new Qc,this.$s=null}static Bs(e){return new ru(e)}get Ls(){if(this.$s)return this.$s;throw zi()}addReference(e,t,n){return this.Fs.addReference(n,t),this.Ls.delete(n.toString()),Ts.resolve()}removeReference(e,t,n){return this.Fs.removeReference(n,t),this.Ls.add(n.toString()),Ts.resolve()}markPotentiallyOrphaned(e,t){return this.Ls.add(t.toString()),Ts.resolve()}removeTarget(e,t){this.Fs.ls(t.targetId).forEach((e=>this.Ls.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Ls.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}ks(){this.$s=new Set}Os(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ts.forEach(this.Ls,(n=>{const r=ms.fromPath(n);return this.qs(e,r).next((e=>{e||t.removeEntry(r,hs.min())}))})).next((()=>(this.$s=null,t.apply(e))))}updateLimboDocument(e,t){return this.qs(e,t).next((e=>{e?this.Ls.delete(t.toString()):this.Ls.add(t.toString())}))}xs(e){return 0}qs(e,t){return Ts.or([()=>Ts.resolve(this.Fs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ms(e,t)])}}class iu{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Si=n,this.Di=r}static Ci(e,t){let n=za(),r=za();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new iu(e,t.fromCache,n,r)}}class su{constructor(){this.xi=!1}initialize(e,t){this.Ni=e,this.indexManager=t,this.xi=!0}getDocumentsMatchingQuery(e,t,n,r){return this.ki(e,t).next((i=>i||this.Oi(e,t,r,n))).next((n=>n||this.Mi(e,t)))}ki(e,t){if(Bo(t))return Ts.resolve(null);let n=Ko(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=zo(t,null,"F"),n=Ko(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const i=za(...r);return this.Ni.getDocuments(e,i).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const s=this.Fi(t,r);return this.$i(t,s,i,n.readTime)?this.ki(e,zo(t,null,"F")):this.Bi(e,s,t,n)}))))})))))}Oi(e,t,n,r){return Bo(t)||r.isEqual(hs.min())?this.Mi(e,t):this.Ni.getDocuments(e,n).next((i=>{const s=this.Fi(t,i);return this.$i(t,s,n,r)?this.Mi(e,t):(qi()<=G.DEBUG&&$i("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Xo(t)),this.Bi(e,s,t,function(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,i=hs.fromTimestamp(1e9===r?new ls(n+1,0):new ls(n,r));return new vs(i,ms.empty(),t)}(r,-1)))}))}Fi(e,t){let n=new Io(Jo(e));return t.forEach(((t,r)=>{Yo(e,r)&&(n=n.add(r))})),n}$i(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Mi(e,t){return qi()<=G.DEBUG&&$i("QueryEngine","Using full collection scan to execute query:",Xo(t)),this.Ni.getDocumentsMatchingQuery(e,t,vs.min())}Bi(e,t,n,r){return this.Ni.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class ou{constructor(e,t,n,r){this.persistence=e,this.Li=t,this.yt=r,this.qi=new xo(cs),this.Ui=new La((e=>Oo(e)),Lo),this.Ki=new Map,this.Gi=e.getRemoteDocumentCache(),this.Cs=e.getTargetCache(),this.Ns=e.getBundleCache(),this.Qi(n)}Qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Gc(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.qi)))}}async function au(e,t){const n=Qi(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((i=>(r=i,n.Qi(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const i=[],s=[];let o=za();for(const e of r){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({ji:e,removedBatchIds:i,addedBatchIds:s})))}))}))}function cu(e){const t=Qi(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Cs.getLastRemoteSnapshotVersion(e)))}function uu(e,t){const n=Qi(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}async function lu(e,t,n){const r=Qi(e),i=r.qi.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,(e=>r.persistence.referenceDelegate.removeTarget(e,i)))}catch(e){if(!Es(e))throw e;$i("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.qi=r.qi.remove(t),r.Ui.delete(i.target)}function hu(e,t,n){const r=Qi(e);let i=hs.min(),s=za();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=Qi(e),i=r.Ui.get(n);return void 0!==i?Ts.resolve(r.qi.get(i)):r.Cs.getTargetData(t,n)}(r,e,Ko(t)).next((t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,r.Cs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{s=e}))})).next((()=>r.Li.getDocumentsMatchingQuery(e,t,n?i:hs.min(),n?s:za()))).next((e=>(function(e,t,n){let r=e.Ki.get(t)||hs.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Ki.set(t,r)}(r,function(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}(t),e),{documents:e,Hi:s})))))}class du{constructor(){this.activeTargetIds=Qa()}er(e){this.activeTargetIds=this.activeTargetIds.add(e)}nr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}tr(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class fu{constructor(){this.Lr=new du,this.qr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Lr.er(e),this.qr[e]||"not-current"}updateQueryState(e,t,n){this.qr[e]=t}removeLocalQueryTarget(e){this.Lr.nr(e)}isLocalQueryTarget(e){return this.Lr.activeTargetIds.has(e)}clearQueryState(e){delete this.qr[e]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(e){return this.Lr.activeTargetIds.has(e)}start(){return this.Lr=new du,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class pu{Ur(e){}shutdown(){}}class gu{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}Ur(e){this.Wr.push(e)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){$i("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Wr)e(0)}jr(){$i("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Wr)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const mu={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class yu{constructor(e){this.Hr=e.Hr,this.Jr=e.Jr}Yr(e){this.Xr=e}Zr(e){this.eo=e}onMessage(e){this.no=e}close(){this.Jr()}send(e){this.Hr(e)}so(){this.Xr()}io(e){this.eo(e)}ro(e){this.no(e)}}class vu extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.oo=t+"://"+e.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get co(){return!1}ao(e,t,n,r,i){const s=this.ho(e,t);$i("RestConnection","Sending: ",s,n);const o={};return this.lo(o,r,i),this.fo(e,s,o,n).then((e=>($i("RestConnection","Received: ",e),e)),(t=>{throw Ki("RestConnection",`${e} failed with error: `,t,"url: ",s,"request:",n),t}))}_o(e,t,n,r,i,s){return this.ao(e,t,n,r,i)}lo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+Bi,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}ho(e,t){const n=mu[e];return`${this.oo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}fo(e,t,n,r){return new Promise(((i,s)=>{const o=new Fi;o.setWithCredentials(!0),o.listenOnce(Di.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case Pi.NO_ERROR:const t=o.getResponseJson();$i("Connection","XHR received:",JSON.stringify(t)),i(t);break;case Pi.TIMEOUT:$i("Connection",'RPC "'+e+'" timed out'),s(new Yi(Xi.DEADLINE_EXCEEDED,"Request time out"));break;case Pi.HTTP_ERROR:const n=o.getStatus();if($i("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(Xi).indexOf(t)>=0?t:Xi.UNKNOWN}(t.status);s(new Yi(e,t.message))}else s(new Yi(Xi.UNKNOWN,"Server responded with status "+o.getStatus()))}else s(new Yi(Xi.UNAVAILABLE,"Connection failed."));break;default:zi()}}finally{$i("Connection",'RPC "'+e+'" completed.')}}));const a=JSON.stringify(r);o.send(t,"POST",a,n,15)}))}wo(e,t,n){const r=[this.oo,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=Ni(),s=Ai(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new Oi({})),this.lo(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;const a=r.join("");$i("Connection","Creating WebChannel: "+a,o);const c=i.createWebChannel(a,o);let u=!1,l=!1;const h=new yu({Hr:e=>{l?$i("Connection","Not sending because WebChannel is closed:",e):(u||($i("Connection","Opening WebChannel transport."),c.open(),u=!0),$i("Connection","WebChannel sending:",e),c.send(e))},Jr:()=>c.close()}),d=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return d(c,Li.EventType.OPEN,(()=>{l||$i("Connection","WebChannel transport opened.")})),d(c,Li.EventType.CLOSE,(()=>{l||(l=!0,$i("Connection","WebChannel transport closed"),h.io())})),d(c,Li.EventType.ERROR,(e=>{l||(l=!0,Ki("Connection","WebChannel transport errored:",e),h.io(new Yi(Xi.UNAVAILABLE,"The operation could not be completed")))})),d(c,Li.EventType.MESSAGE,(e=>{var t;if(!l){const n=e.data[0];Wi(!!n);const r=n,i=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(i){$i("Connection","WebChannel received error:",i);const e=i.status;let t=function(e){const t=Ma[e];if(void 0!==t)return Oa(t)}(e),n=i.message;void 0===t&&(t=Xi.INTERNAL,n="Unknown error status: "+e+" with message "+i.message),l=!0,h.io(new Yi(t,n)),c.close()}else $i("Connection","WebChannel received:",n),h.ro(n)}})),d(s,Mi.STAT_EVENT,(e=>{e.stat===Ri.PROXY?$i("Connection","Detected buffering proxy"):e.stat===Ri.NOPROXY&&$i("Connection","Detected no buffering proxy")})),setTimeout((()=>{h.so()}),0),h}}function wu(){return"undefined"!=typeof document?document:null}function bu(e){return new cc(e,!0)}class _u{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Hs=e,this.timerId=t,this.mo=n,this.yo=r,this.po=i,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(e){this.cancel();const t=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),r=Math.max(0,t-n);r>0&&$i("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Io} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.To=this.Hs.enqueueAfterDelay(this.timerId,r,(()=>(this.Eo=Date.now(),e()))),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class Tu{constructor(e,t,n,r,i,s,o,a){this.Hs=e,this.vo=n,this.Vo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new _u(e,t)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.No()&&await this.close(0)}Mo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.vo,6e4,(()=>this.$o())))}Bo(e){this.Lo(),this.stream.send(e)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}qo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(e,t){this.Lo(),this.qo(),this.xo.cancel(),this.So++,4!==e?this.xo.reset():t&&t.code===Xi.RESOURCE_EXHAUSTED?(Hi(t.toString()),Hi("Using maximum backoff delay to prevent overloading the backend."),this.xo.Ao()):t&&t.code===Xi.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Uo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}Uo(){}auth(){this.state=1;const e=this.Ko(this.So),t=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.So===t&&this.Go(e,n)}),(t=>{e((()=>{const e=new Yi(Xi.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Qo(e)}))}))}Go(e,t){const n=this.Ko(this.So);this.stream=this.jo(e,t),this.stream.Yr((()=>{n((()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.Vo,1e4,(()=>(this.ko()&&(this.state=3),Promise.resolve()))),this.listener.Yr())))})),this.stream.Zr((e=>{n((()=>this.Qo(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Oo(){this.state=5,this.xo.Ro((async()=>{this.state=0,this.start()}))}Qo(e){return $i("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Ko(e){return t=>{this.Hs.enqueueAndForget((()=>this.So===e?t():($i("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Eu extends Tu{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.yt=i}jo(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.xo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:zi()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(e,t){return e.wt?(Wi(void 0===t||"string"==typeof t),Ds.fromBase64String(t||"")):(Wi(void 0===t||t instanceof Uint8Array),Ds.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?Xi.UNKNOWN:Oa(e.code);return new Yi(t,e.message||"")}(o);n=new ec(r,i,s,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const i=mc(e,r.document.name),s=dc(r.document.updateTime),o=r.document.createTime?dc(r.document.createTime):hs.min(),a=new Ao({mapValue:{fields:r.document.fields}}),c=Do.newFoundDocument(i,s,o,a),u=r.targetIds||[],l=r.removedTargetIds||[];n=new Ja(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const i=mc(e,r.document),s=r.readTime?dc(r.readTime):hs.min(),o=Do.newNoDocument(i,s),a=r.removedTargetIds||[];n=new Ja([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const i=mc(e,r.document),s=r.removedTargetIds||[];n=new Ja([],s,i,null)}else{if(!("filter"in t))return zi();{t.filter;const e=t.filter;e.targetId;const r=e.count||0,i=new Da(r),s=e.targetId;n=new Za(s,i)}}return n}(this.yt,e),n=function(e){if(!("targetChange"in e))return hs.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?hs.min():t.readTime?dc(t.readTime):hs.min()}(e);return this.listener.Wo(t,n)}zo(e){const t={};t.database=vc(this.yt),t.addTarget=function(e,t){let n;const r=t.target;return n=Fo(r)?{documents:_c(e,r)}:{query:Tc(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=lc(e,t.resumeToken):t.snapshotVersion.compareTo(hs.min())>0&&(n.readTime=uc(e,t.snapshotVersion.toTimestamp())),n}(this.yt,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return zi()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.yt,e);n&&(t.labels=n),this.Bo(t)}Ho(e){const t={};t.database=vc(this.yt),t.removeTarget=e,this.Bo(t)}}class xu extends Tu{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.yt=i,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}Uo(){this.Jo&&this.Xo([])}jo(e,t){return this.connection.wo("Write",e,t)}onMessage(e){if(Wi(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Jo){this.xo.reset();const t=function(e,t){return e&&e.length>0?(Wi(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?dc(e.updateTime):dc(t);return n.isEqual(hs.min())&&(n=dc(t)),new ma(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=dc(e.commitTime);return this.listener.Zo(n,t)}return Wi(!e.writeResults||0===e.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const e={};e.database=vc(this.yt),this.Bo(e)}Xo(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>function(e,t){let n;if(t instanceof Sa)n={update:bc(e,t.key,t.value)};else if(t instanceof Aa)n={delete:gc(e,t.key)};else if(t instanceof ka)n={update:bc(e,t.key,t.data),updateMask:Pc(t.fieldMask)};else{if(!(t instanceof Pa))return zi();n={verify:gc(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof aa)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ca)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof la)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof da)return{fieldPath:t.field.canonicalString(),increment:n.gt};throw zi()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:hc(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:zi()}(e,t.precondition)),n}(this.yt,e)))};this.Bo(t)}}class Su extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.yt=r,this.nu=!1}su(){if(this.nu)throw new Yi(Xi.FAILED_PRECONDITION,"The client has already been terminated.")}ao(e,t,n){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,i])=>this.connection.ao(e,t,n,r,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===Xi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Yi(Xi.UNKNOWN,e.toString())}))}_o(e,t,n,r){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,s])=>this.connection._o(e,t,n,i,s,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===Xi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Yi(Xi.UNKNOWN,e.toString())}))}terminate(){this.nu=!0}}class ku{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve()))))}hu(e){"Online"===this.state?this.cu("Unknown"):(this.iu++,this.iu>=1&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.cu("Offline")))}set(e){this.lu(),this.iu=0,"Online"===e&&(this.ou=!1),this.cu(e)}cu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}au(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(Hi(t),this.ou=!1):$i("OnlineStateTracker",t)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class Iu{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=i,this.mu.Ur((e=>{n.enqueueAndForget((async()=>{Lu(this)&&($i("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=Qi(e);t._u.add(4),await Nu(t),t.gu.set("Unknown"),t._u.delete(4),await Cu(t)}(this))}))})),this.gu=new ku(n,r)}}async function Cu(e){if(Lu(e))for(const t of e.wu)await t(!0)}async function Nu(e){for(const t of e.wu)await t(!1)}function Au(e,t){const n=Qi(e);n.du.has(t.targetId)||(n.du.set(t.targetId,t),Ou(n)?Ru(n):Zu(n).ko()&&Du(n,t))}function Pu(e,t){const n=Qi(e),r=Zu(n);n.du.delete(t),r.ko()&&Mu(n,t),0===n.du.size&&(r.ko()?r.Fo():Lu(n)&&n.gu.set("Unknown"))}function Du(e,t){e.yu.Ot(t.targetId),Zu(e).zo(t)}function Mu(e,t){e.yu.Ot(t),Zu(e).Ho(t)}function Ru(e){e.yu=new nc({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ne:t=>e.du.get(t)||null}),Zu(e).start(),e.gu.uu()}function Ou(e){return Lu(e)&&!Zu(e).No()&&e.du.size>0}function Lu(e){return 0===Qi(e)._u.size}function Fu(e){e.yu=void 0}async function Vu(e){e.du.forEach(((t,n)=>{Du(e,t)}))}async function Uu(e,t){Fu(e),Ou(e)?(e.gu.hu(t),Ru(e)):e.gu.set("Unknown")}async function Bu(e,t,n){if(e.gu.set("Online"),t instanceof ec&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.du.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.du.delete(r),e.yu.removeTarget(r))}(e,t)}catch(n){$i("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await ju(e,n)}else if(t instanceof Ja?e.yu.Kt(t):t instanceof Za?e.yu.Jt(t):e.yu.jt(t),!n.isEqual(hs.min()))try{const t=await cu(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.yu.Zt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const i=e.du.get(r);i&&e.du.set(r,i.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.du.get(t);if(!n)return;e.du.set(t,n.withResumeToken(Ds.EMPTY_BYTE_STRING,n.snapshotVersion)),Mu(e,t);const r=new Lc(n.target,t,1,n.sequenceNumber);Du(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){$i("RemoteStore","Failed to raise snapshot:",t),await ju(e,t)}}async function ju(e,t,n){if(!Es(t))throw t;e._u.add(1),await Nu(e),e.gu.set("Offline"),n||(n=()=>cu(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{$i("RemoteStore","Retrying IndexedDB access"),await n(),e._u.delete(1),await Cu(e)}))}function qu(e,t){return t().catch((n=>ju(e,n,t)))}async function $u(e){const t=Qi(e),n=el(t);let r=t.fu.length>0?t.fu[t.fu.length-1].batchId:-1;for(;Hu(t);)try{const e=await uu(t.localStore,r);if(null===e){0===t.fu.length&&n.Fo();break}r=e.batchId,Ku(t,e)}catch(e){await ju(t,e)}Gu(t)&&zu(t)}function Hu(e){return Lu(e)&&e.fu.length<10}function Ku(e,t){e.fu.push(t);const n=el(e);n.ko()&&n.Yo&&n.Xo(t.mutations)}function Gu(e){return Lu(e)&&!el(e).No()&&e.fu.length>0}function zu(e){el(e).start()}async function Wu(e){el(e).eu()}async function Qu(e){const t=el(e);for(const n of e.fu)t.Xo(n.mutations)}async function Xu(e,t,n){const r=e.fu.shift(),i=Rc.from(r,t,n);await qu(e,(()=>e.remoteSyncer.applySuccessfulWrite(i))),await $u(e)}async function Yu(e,t){t&&el(e).Yo&&await async function(e,t){if(function(e){switch(e){default:return zi();case Xi.CANCELLED:case Xi.UNKNOWN:case Xi.DEADLINE_EXCEEDED:case Xi.RESOURCE_EXHAUSTED:case Xi.INTERNAL:case Xi.UNAVAILABLE:case Xi.UNAUTHENTICATED:return!1;case Xi.INVALID_ARGUMENT:case Xi.NOT_FOUND:case Xi.ALREADY_EXISTS:case Xi.PERMISSION_DENIED:case Xi.FAILED_PRECONDITION:case Xi.ABORTED:case Xi.OUT_OF_RANGE:case Xi.UNIMPLEMENTED:case Xi.DATA_LOSS:return!0}}(n=t.code)&&n!==Xi.ABORTED){const n=e.fu.shift();el(e).Mo(),await qu(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await $u(e)}var n}(e,t),Gu(e)&&zu(e)}async function Ju(e,t){const n=Qi(e);n.asyncQueue.verifyOperationInProgress(),$i("RemoteStore","RemoteStore received new credentials");const r=Lu(n);n._u.add(3),await Nu(n),r&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n._u.delete(3),await Cu(n)}function Zu(e){return e.pu||(e.pu=function(e,t,n){const r=Qi(e);return r.su(),new Eu(t,r.connection,r.authCredentials,r.appCheckCredentials,r.yt,n)}(e.datastore,e.asyncQueue,{Yr:Vu.bind(null,e),Zr:Uu.bind(null,e),Wo:Bu.bind(null,e)}),e.wu.push((async t=>{t?(e.pu.Mo(),Ou(e)?Ru(e):e.gu.set("Unknown")):(await e.pu.stop(),Fu(e))}))),e.pu}function el(e){return e.Iu||(e.Iu=function(e,t,n){const r=Qi(e);return r.su(),new xu(t,r.connection,r.authCredentials,r.appCheckCredentials,r.yt,n)}(e.datastore,e.asyncQueue,{Yr:Wu.bind(null,e),Zr:Yu.bind(null,e),tu:Qu.bind(null,e),Zo:Xu.bind(null,e)}),e.wu.push((async t=>{t?(e.Iu.Mo(),await $u(e)):(await e.Iu.stop(),e.fu.length>0&&($i("RemoteStore",`Stopping write stream with ${e.fu.length} pending writes`),e.fu=[]))}))),e.Iu}class tl{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Ji,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,o=new tl(e,t,s,r,i);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Yi(Xi.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function nl(e,t){if(Hi("AsyncQueue",`${t}: ${e}`),Es(e))return new Yi(Xi.UNAVAILABLE,`${t}: ${e}`);throw e}class rl{constructor(e){this.comparator=e?(t,n)=>e(t,n)||ms.comparator(t.key,n.key):(e,t)=>ms.comparator(e.key,t.key),this.keyedMap=Ba(),this.sortedSet=new xo(this.comparator)}static emptySet(e){return new rl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof rl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new rl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class il{constructor(){this.Tu=new xo(ms.comparator)}track(e){const t=e.doc.key,n=this.Tu.get(t);n?0!==e.type&&3===n.type?this.Tu=this.Tu.insert(t,e):3===e.type&&1!==n.type?this.Tu=this.Tu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Tu=this.Tu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Tu=this.Tu.remove(t):1===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):zi():this.Tu=this.Tu.insert(t,e)}Eu(){const e=[];return this.Tu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class sl{constructor(e,t,n,r,i,s,o,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach((e=>{s.push({type:0,doc:e})})),new sl(e,t,rl.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Wo(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class ol{constructor(){this.Au=void 0,this.listeners=[]}}class al{constructor(){this.queries=new La((e=>Qo(e)),Wo),this.onlineState="Unknown",this.Ru=new Set}}function cl(e,t){const n=Qi(e);let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.Pu(e)&&(r=!0);i.Au=e}}r&&ll(n)}function ul(e,t,n){const r=Qi(e),i=r.queries.get(t);if(i)for(const e of i.listeners)e.onError(n);r.queries.delete(t)}function ll(e){e.Ru.forEach((e=>{e.next()}))}class hl{constructor(e,t,n){this.query=e,this.vu=t,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new sl(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Vu?this.Du(e)&&(this.vu.next(e),t=!0):this.Cu(e,this.onlineState)&&(this.xu(e),t=!0),this.Su=e,t}onError(e){this.vu.error(e)}bu(e){this.onlineState=e;let t=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,e)&&(this.xu(this.Su),t=!0),t}Cu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Nu||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Du(e){if(e.docChanges.length>0)return!0;const t=this.Su&&this.Su.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}xu(e){e=sl.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Vu=!0,this.vu.next(e)}}class dl{constructor(e){this.key=e}}class fl{constructor(e){this.key=e}}class pl{constructor(e,t){this.query=e,this.qu=t,this.Uu=null,this.hasCachedResults=!1,this.current=!1,this.Ku=za(),this.mutatedKeys=za(),this.Gu=Jo(e),this.Qu=new rl(this.Gu)}get ju(){return this.qu}Wu(e,t){const n=t?t.zu:new il,r=t?t.Qu:this.Qu;let i=t?t.mutatedKeys:this.mutatedKeys,s=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),l=Yo(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Hu(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Gu(l,a)>0||c&&this.Gu(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(s=s.add(l),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))})),null!==this.query.limit)for(;s.size>this.query.limit;){const e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{Qu:s,zu:n,$i:o,mutatedKeys:i}}Hu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.Qu;this.Qu=e.Qu,this.mutatedKeys=e.mutatedKeys;const i=e.zu.Eu();i.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return zi()}};return n(e)-n(t)}(e.type,t.type)||this.Gu(e.doc,t.doc))),this.Ju(n);const s=t?this.Yu():[],o=0===this.Ku.size&&this.current?1:0,a=o!==this.Uu;return this.Uu=o,0!==i.length||a?{snapshot:new sl(this.query,e.Qu,r,i,e.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),Xu:s}:{Xu:s}}bu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new il,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Xu:[]}}Zu(e){return!this.qu.has(e)&&!!this.Qu.has(e)&&!this.Qu.get(e).hasLocalMutations}Ju(e){e&&(e.addedDocuments.forEach((e=>this.qu=this.qu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.qu=this.qu.delete(e))),this.current=e.current)}Yu(){if(!this.current)return[];const e=this.Ku;this.Ku=za(),this.Qu.forEach((e=>{this.Zu(e.key)&&(this.Ku=this.Ku.add(e.key))}));const t=[];return e.forEach((e=>{this.Ku.has(e)||t.push(new fl(e))})),this.Ku.forEach((n=>{e.has(n)||t.push(new dl(n))})),t}tc(e){this.qu=e.Hi,this.Ku=za();const t=this.Wu(e.documents);return this.applyChanges(t,!0)}ec(){return sl.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.Uu,this.hasCachedResults)}}class gl{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class ml{constructor(e){this.key=e,this.nc=!1}}class yl{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.sc={},this.ic=new La((e=>Qo(e)),Wo),this.rc=new Map,this.oc=new Set,this.uc=new xo(ms.comparator),this.cc=new Map,this.ac=new Qc,this.hc={},this.lc=new Map,this.fc=$c.vn(),this.onlineState="Unknown",this.dc=void 0}get isPrimaryClient(){return!0===this.dc}}async function vl(e,t){const n=function(e){const t=Qi(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=bl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Rl.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Tl.bind(null,t),t.sc.Wo=cl.bind(null,t.eventManager),t.sc.wc=ul.bind(null,t.eventManager),t}(e);let r,i;const s=n.ic.get(t);if(s)r=s.targetId,n.sharedClientState.addLocalQueryTarget(r),i=s.view.ec();else{const e=await function(e,t){const n=Qi(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Cs.getTargetData(e,t).next((i=>i?(r=i,Ts.resolve(r)):n.Cs.allocateTargetId(e).next((i=>(r=new Lc(t,i,0,e.currentSequenceNumber),n.Cs.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.qi.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.qi=n.qi.insert(e.targetId,e),n.Ui.set(t,e.targetId)),e}))}(n.localStore,Ko(t));n.isPrimaryClient&&Au(n.remoteStore,e);const s=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,i=await async function(e,t,n,r,i){e._c=(t,n,r)=>async function(e,t,n,r){let i=t.view.Wu(n);i.$i&&(i=await hu(e.localStore,t.query,!1).then((({documents:e})=>t.view.Wu(e,i))));const s=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s);return Nl(e,t.targetId,o.Xu),o.snapshot}(e,t,n,r);const s=await hu(e.localStore,t,!0),o=new pl(t,s.Hi),a=o.Wu(s.documents),c=Ya.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=o.applyChanges(a,e.isPrimaryClient,c);Nl(e,n,u.Xu);const l=new gl(t,n,o);return e.ic.set(t,l),e.rc.has(n)?e.rc.get(n).push(t):e.rc.set(n,[t]),u.snapshot}(n,t,r,"current"===s,e.resumeToken)}return i}async function wl(e,t){const n=Qi(e),r=n.ic.get(t),i=n.rc.get(r.targetId);if(i.length>1)return n.rc.set(r.targetId,i.filter((e=>!Wo(e,t)))),void n.ic.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await lu(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Pu(n.remoteStore,r.targetId),Il(n,r.targetId)})).catch(_s)):(Il(n,r.targetId),await lu(n.localStore,r.targetId,!0))}async function bl(e,t){const n=Qi(e);try{const e=await function(e,t){const n=Qi(e),r=t.snapshotVersion;let i=n.qi;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const s=n.Gi.newChangeBuffer({trackRemovals:!0});i=n.qi;const o=[];t.targetChanges.forEach(((s,a)=>{const c=i.get(a);if(!c)return;o.push(n.Cs.removeMatchingKeys(e,s.removedDocuments,a).next((()=>n.Cs.addMatchingKeys(e,s.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?u=u.withResumeToken(Ds.EMPTY_BYTE_STRING,hs.min()).withLastLimboFreeSnapshotVersion(hs.min()):s.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(s.resumeToken,r)),i=i.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,s)&&o.push(n.Cs.updateTargetData(e,u))}));let a=Va(),c=za();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(function(e,t,n){let r=za(),i=za();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Va();return n.forEach(((n,s)=>{const o=e.get(n);s.isFoundDocument()!==o.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(hs.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!o.isValidDocument()||s.version.compareTo(o.version)>0||0===s.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):$i("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",s.version)})),{Wi:r,zi:i}}))}(e,s,t.documentUpdates).next((e=>{a=e.Wi,c=e.zi}))),!r.isEqual(hs.min())){const t=n.Cs.getLastRemoteSnapshotVersion(e).next((t=>n.Cs.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return Ts.waitFor(o).next((()=>s.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,c))).next((()=>a))})).then((e=>(n.qi=i,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.cc.get(t);r&&(Wi(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.nc=!0:e.modifiedDocuments.size>0?Wi(r.nc):e.removedDocuments.size>0&&(Wi(r.nc),r.nc=!1))})),await Dl(n,e,t)}catch(e){await _s(e)}}function _l(e,t,n){const r=Qi(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ic.forEach(((n,r)=>{const i=r.view.bu(t);i.snapshot&&e.push(i.snapshot)})),function(e,t){const n=Qi(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const e of n.listeners)e.bu(t)&&(r=!0)})),r&&ll(n)}(r.eventManager,t),e.length&&r.sc.Wo(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function Tl(e,t,n){const r=Qi(e);r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.cc.get(t),s=i&&i.key;if(s){let e=new xo(ms.comparator);e=e.insert(s,Do.newNoDocument(s,hs.min()));const n=za().add(s),i=new Xa(hs.min(),new Map,new Io(cs),e,n);await bl(r,i),r.uc=r.uc.remove(s),r.cc.delete(t),Pl(r)}else await lu(r.localStore,t,!1).then((()=>Il(r,t,n))).catch(_s)}async function El(e,t){const n=Qi(e),r=t.batch.batchId;try{const e=await function(e,t){const n=Qi(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),i=n.Gi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const i=n.batch,s=i.keys();let o=Ts.resolve();return s.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const s=n.docVersions.get(e);Wi(null!==s),t.version.compareTo(s)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,i)))}(n,e,t,i).next((()=>i.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=za();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);kl(n,r,null),Sl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Dl(n,e)}catch(e){await _s(e)}}async function xl(e,t,n){const r=Qi(e);try{const e=await function(e,t){const n=Qi(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(Wi(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);kl(r,t,n),Sl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Dl(r,e)}catch(n){await _s(n)}}function Sl(e,t){(e.lc.get(t)||[]).forEach((e=>{e.resolve()})),e.lc.delete(t)}function kl(e,t,n){const r=Qi(e);let i=r.hc[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.hc[r.currentUser.toKey()]=i}}function Il(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.rc.get(t))e.ic.delete(r),n&&e.sc.wc(r,n);e.rc.delete(t),e.isPrimaryClient&&e.ac.ls(t).forEach((t=>{e.ac.containsKey(t)||Cl(e,t)}))}function Cl(e,t){e.oc.delete(t.path.canonicalString());const n=e.uc.get(t);null!==n&&(Pu(e.remoteStore,n),e.uc=e.uc.remove(t),e.cc.delete(n),Pl(e))}function Nl(e,t,n){for(const r of n)r instanceof dl?(e.ac.addReference(r.key,t),Al(e,r)):r instanceof fl?($i("SyncEngine","Document no longer in limbo: "+r.key),e.ac.removeReference(r.key,t),e.ac.containsKey(r.key)||Cl(e,r.key)):zi()}function Al(e,t){const n=t.key,r=n.path.canonicalString();e.uc.get(n)||e.oc.has(r)||($i("SyncEngine","New document in limbo: "+n),e.oc.add(r),Pl(e))}function Pl(e){for(;e.oc.size>0&&e.uc.size<e.maxConcurrentLimboResolutions;){const t=e.oc.values().next().value;e.oc.delete(t);const n=new ms(fs.fromString(t)),r=e.fc.next();e.cc.set(r,new ml(n)),e.uc=e.uc.insert(n,r),Au(e.remoteStore,new Lc(Ko(Uo(n.path)),r,2,xs.at))}}async function Dl(e,t,n){const r=Qi(e),i=[],s=[],o=[];r.ic.isEmpty()||(r.ic.forEach(((e,a)=>{o.push(r._c(a,t,n).then((e=>{if((e||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){i.push(e);const t=iu.Ci(a.targetId,e);s.push(t)}})))})),await Promise.all(o),r.sc.Wo(i),await async function(e,t){const n=Qi(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>Ts.forEach(t,(t=>Ts.forEach(t.Si,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>Ts.forEach(t.Di,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!Es(e))throw e;$i("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.qi.get(t),r=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(r);n.qi=n.qi.insert(t,i)}}}(r.localStore,s))}async function Ml(e,t){const n=Qi(e);if(!n.currentUser.isEqual(t)){$i("SyncEngine","User change. New user:",t.toKey());const e=await au(n.localStore,t);n.currentUser=t,function(e,t){e.lc.forEach((e=>{e.forEach((e=>{e.reject(new Yi(Xi.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.lc.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Dl(n,e.ji)}}function Rl(e,t){const n=Qi(e),r=n.cc.get(t);if(r&&r.nc)return za().add(r.key);{let e=za();const r=n.rc.get(t);if(!r)return e;for(const t of r){const r=n.ic.get(t);e=e.unionWith(r.view.ju)}return e}}function Ol(e){const t=Qi(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=El.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=xl.bind(null,t),t}class Ll{constructor(){this.synchronizeTabs=!1}async initialize(e){this.yt=bu(e.databaseInfo.databaseId),this.sharedClientState=this.gc(e),this.persistence=this.yc(e),await this.persistence.start(),this.localStore=this.Ic(e),this.gcScheduler=this.Tc(e,this.localStore),this.indexBackfillerScheduler=this.Ec(e,this.localStore)}Tc(e,t){return null}Ec(e,t){return null}Ic(e){return function(e,t,n,r){return new ou(e,t,n,r)}(this.persistence,new su,e.initialUser,this.yt)}yc(e){return new tu(ru.Bs,this.yt)}gc(e){return new fu}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Fl{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>_l(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Ml.bind(null,this.syncEngine),await async function(e,t){const n=Qi(e);t?(n._u.delete(2),await Cu(n)):t||(n._u.add(2),await Nu(n),n.gu.set("Unknown"))}(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new al}createDatastore(e){const t=bu(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new vu(r));var r;return function(e,t,n,r){return new Su(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>_l(this.syncEngine,e,0),s=gu.C()?new gu:new pu,new Iu(t,n,r,i,s);var t,n,r,i,s}createSyncEngine(e,t){return function(e,t,n,r,i,s,o){const a=new yl(e,t,n,r,i,s);return o&&(a.dc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=Qi(e);$i("RemoteStore","RemoteStore shutting down."),t._u.add(5),await Nu(t),t.mu.shutdown(),t.gu.set("Unknown")}(this.remoteStore)}}function Vl(e,t,n){if(!n)throw new Yi(Xi.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Ul(e){if(!ms.isDocumentKey(e))throw new Yi(Xi.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Bl(e){if(ms.isDocumentKey(e))throw new Yi(Xi.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function jl(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":zi()}function ql(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new Yi(Xi.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=jl(e);throw new Yi(Xi.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}const $l=new Map;class Hl{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Yi(Xi.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Yi(Xi.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,function(e,t,n,r){if(!0===t&&!0===r)throw new Yi(Xi.INVALID_ARGUMENT,"experimentalForceLongPolling and experimentalAutoDetectLongPolling cannot be used together.")}(0,e.experimentalForceLongPolling,0,e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Kl{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Hl({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Yi(Xi.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Yi(Xi.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Hl(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new es;switch(e.type){case"gapi":const t=e.client;return new rs(t,e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Yi(Xi.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=$l.get(e);t&&($i("ComponentProvider","Removing Datastore"),$l.delete(e),t.terminate())}(this),Promise.resolve()}}class Gl{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Wl(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Gl(this.firestore,e,this._key)}}class zl{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new zl(this.firestore,e,this._query)}}class Wl extends zl{constructor(e,t,n){super(e,t,Uo(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Gl(this.firestore,null,new ms(e))}withConverter(e){return new Wl(this.firestore,e,this._path)}}function Ql(e,t,...n){if(e=B(e),Vl("collection","path",t),e instanceof Kl){const r=fs.fromString(t,...n);return Bl(r),new Wl(e,null,r)}{if(!(e instanceof Gl||e instanceof Wl))throw new Yi(Xi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(fs.fromString(t,...n));return Bl(r),new Wl(e.firestore,null,r)}}function Xl(e,t,...n){if(e=B(e),1===arguments.length&&(t=as.R()),Vl("doc","path",t),e instanceof Kl){const r=fs.fromString(t,...n);return Ul(r),new Gl(e,null,new ms(r))}{if(!(e instanceof Gl||e instanceof Wl))throw new Yi(Xi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(fs.fromString(t,...n));return Ul(r),new Gl(e.firestore,e instanceof Wl?e.converter:null,new ms(r))}}class Yl{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Rc(this.observer.next,e)}error(e){this.observer.error?this.Rc(this.observer.error,e):Hi("Uncaught Error in snapshot listener:",e.toString())}bc(){this.muted=!0}Rc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Jl{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=Ui.UNAUTHENTICATED,this.clientId=as.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{$i("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>($i("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Yi(Xi.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new Ji;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=nl(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Zl(e,t){e.asyncQueue.verifyOperationInProgress();const n=await async function(e){return e.offlineComponents||($i("FirestoreClient","Using default OfflineComponentProvider"),await async function(e,t){e.asyncQueue.verifyOperationInProgress(),$i("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await au(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}(e,new Ll)),e.offlineComponents}(e);$i("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>Ju(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Ju(t.remoteStore,n))),e.onlineComponents=t}async function eh(e){return e.onlineComponents||($i("FirestoreClient","Using default OnlineComponentProvider"),await Zl(e,new Fl)),e.onlineComponents}async function th(e){const t=await eh(e),n=t.eventManager;return n.onListen=vl.bind(null,t.syncEngine),n.onUnlisten=wl.bind(null,t.syncEngine),n}class nh{constructor(){this.Bc=Promise.resolve(),this.Lc=[],this.qc=!1,this.Uc=[],this.Kc=null,this.Gc=!1,this.Qc=!1,this.jc=[],this.xo=new _u(this,"async_queue_retry"),this.Wc=()=>{const e=wu();e&&$i("AsyncQueue","Visibility state changed to "+e.visibilityState),this.xo.Po()};const e=wu();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Wc)}get isShuttingDown(){return this.qc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.zc(),this.Hc(e)}enterRestrictedMode(e){if(!this.qc){this.qc=!0,this.Qc=e||!1;const t=wu();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Wc)}}enqueue(e){if(this.zc(),this.qc)return new Promise((()=>{}));const t=new Ji;return this.Hc((()=>this.qc&&this.Qc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Lc.push(e),this.Jc())))}async Jc(){if(0!==this.Lc.length){try{await this.Lc[0](),this.Lc.shift(),this.xo.reset()}catch(e){if(!Es(e))throw e;$i("AsyncQueue","Operation failed with retryable error: "+e)}this.Lc.length>0&&this.xo.Ro((()=>this.Jc()))}}Hc(e){const t=this.Bc.then((()=>(this.Gc=!0,e().catch((e=>{this.Kc=e,this.Gc=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw Hi("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Gc=!1,e))))));return this.Bc=t,t}enqueueAfterDelay(e,t,n){this.zc(),this.jc.indexOf(e)>-1&&(t=0);const r=tl.createAndSchedule(this,e,t,n,(e=>this.Yc(e)));return this.Uc.push(r),r}zc(){this.Kc&&zi()}verifyOperationInProgress(){}async Xc(){let e;do{e=this.Bc,await e}while(e!==this.Bc)}Zc(e){for(const t of this.Uc)if(t.timerId===e)return!0;return!1}ta(e){return this.Xc().then((()=>{this.Uc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.Uc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Xc()}))}ea(e){this.jc.push(e)}Yc(e){const t=this.Uc.indexOf(e);this.Uc.splice(t,1)}}function rh(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const e of["next","error","complete"])if(e in n&&"function"==typeof n[e])return!0;return!1}(e)}class ih extends Kl{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new nh,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||oh(this),this._firestoreClient.terminate()}}function sh(e){return e._firestoreClient||oh(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function oh(e){var t;const n=e._freezeSettings(),r=function(e,t,n,r){return new Ss(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new Jl(e._authCredentials,e._appCheckCredentials,e._queue,r)}class ah{constructor(e){this._byteString=e}static fromBase64String(e){try{return new ah(Ds.fromBase64String(e))}catch(e){throw new Yi(Xi.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new ah(Ds.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class ch{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Yi(Xi.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new gs(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class uh{constructor(e){this._methodName=e}}class lh{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new Yi(Xi.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new Yi(Xi.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return cs(this._lat,e._lat)||cs(this._long,e._long)}}const hh=/^__.*__$/;class dh{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new ka(e,this.data,this.fieldMask,t,this.fieldTransforms):new Sa(e,this.data,t,this.fieldTransforms)}}function fh(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw zi()}}class ph{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.yt=n,this.ignoreUndefinedProperties=r,void 0===i&&this.na(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get sa(){return this.settings.sa}ia(e){return new ph(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.yt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ra(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.ua(e),r}ca(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.na(),r}aa(e){return this.ia({path:void 0,oa:!0})}ha(e){return kh(e,this.settings.methodName,this.settings.la||!1,this.path,this.settings.fa)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}na(){if(this.path)for(let e=0;e<this.path.length;e++)this.ua(this.path.get(e))}ua(e){if(0===e.length)throw this.ha("Document fields must not be empty");if(fh(this.sa)&&hh.test(e))throw this.ha('Document fields cannot begin and end with "__"')}}class gh{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.yt=n||bu(e)}da(e,t,n,r=!1){return new ph({sa:e,methodName:t,fa:n,path:gs.emptyPath(),oa:!1,la:r},this.databaseId,this.yt,this.ignoreUndefinedProperties)}}function mh(e){const t=e._freezeSettings(),n=bu(e._databaseId);return new gh(e._databaseId,!!t.ignoreUndefinedProperties,n)}function yh(e,t,n,r,i,s={}){const o=e.da(s.merge||s.mergeFields?2:0,t,n,i);Th("Data must be an object, but it was:",o,r);const a=bh(r,o);let c,u;if(s.merge)c=new No(o.fieldMask),u=o.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=Eh(t,r,n);if(!o.contains(i))throw new Yi(Xi.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);Ih(e,i)||e.push(i)}c=new No(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new dh(new Ao(a),c,u)}class vh extends uh{constructor(e,t){super(e),this.wa=t}_toFieldTransform(e){const t=new da(e.yt,na(e.yt,this.wa));return new ga(e.path,t)}isEqual(e){return this===e}}function wh(e,t){if(_h(e=B(e)))return Th("Unsupported field value:",t,e),bh(e,t);if(e instanceof uh)return function(e,t){if(!fh(t.sa))throw t.ha(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.ha(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.oa&&4!==t.sa)throw t.ha("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const i of e){let e=wh(i,t.aa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=B(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return na(t.yt,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=ls.fromDate(e);return{timestampValue:uc(t.yt,n)}}if(e instanceof ls){const n=new ls(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:uc(t.yt,n)}}if(e instanceof lh)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof ah)return{bytesValue:lc(t.yt,e._byteString)};if(e instanceof Gl){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.ha(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:fc(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.ha(`Unsupported field value: ${jl(e)}`)}(e,t)}function bh(e,t){const n={};return Ns(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Cs(e,((e,r)=>{const i=wh(r,t.ra(e));null!=i&&(n[e]=i)})),{mapValue:{fields:n}}}function _h(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ls||e instanceof lh||e instanceof ah||e instanceof Gl||e instanceof uh)}function Th(e,t,n){if(!_h(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=jl(n);throw"an object"===r?t.ha(e+" a custom object"):t.ha(e+" "+r)}}function Eh(e,t,n){if((t=B(t))instanceof ch)return t._internalPath;if("string"==typeof t)return Sh(e,t);throw kh("Field path arguments must be of type string or ",e,!1,void 0,n)}const xh=new RegExp("[~\\*/\\[\\]]");function Sh(e,t,n){if(t.search(xh)>=0)throw kh(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new ch(...t.split("."))._internalPath}catch(r){throw kh(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function kh(e,t,n,r,i){const s=r&&!r.isEmpty(),o=void 0!==i;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(s||o)&&(c+=" (found",s&&(c+=` in field ${r}`),o&&(c+=` in document ${i}`),c+=")"),new Yi(Xi.INVALID_ARGUMENT,a+e+c)}function Ih(e,t){return e.some((e=>e.isEqual(t)))}class Ch{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Gl(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Nh(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Ah("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Nh extends Ch{data(){return super.data()}}function Ah(e,t){return"string"==typeof t?Sh(e,t):t instanceof ch?t._internalPath:t._delegate._internalPath}class Ph{}class Dh extends Ph{}function Mh(e,t,...n){let r=[];t instanceof Ph&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof Lh)).length,n=e.filter((e=>e instanceof Rh)).length;if(t>1||t>0&&n>0)throw new Yi(Xi.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class Rh extends Dh{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Rh(e,t,n)}_apply(e){const t=this._parse(e);return jh(e._query,t),new zl(e.firestore,e.converter,Go(e._query,t))}_parse(e){const t=mh(e.firestore),n=function(e,t,n,r,i,s,o){let a;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new Yi(Xi.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){Bh(o,s);const t=[];for(const n of o)t.push(Uh(r,e,n));a={arrayValue:{values:t}}}else a=Uh(r,e,o)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||Bh(o,s),a=function(e,t,n,r=!1){return wh(n,e.da(r?4:3,t))}(n,"where",o,"in"===s||"not-in"===s);return oo.create(i,s,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function Oh(e,t,n){const r=t,i=Ah("where",e);return Rh._create(i,r,n)}class Lh extends Ph{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Lh(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:ao.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const e of r)jh(n,e),n=Go(n,e)}(e._query,t),new zl(e.firestore,e.converter,Go(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Fh extends Dh{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Fh(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new Yi(Xi.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Yi(Xi.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new To(t,n);return function(e,t){if(null===jo(e)){const n=qo(e);null!==n&&qh(0,n,t.field)}}(e,r),r}(e._query,this._field,this._direction);return new zl(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Vo(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function Vh(e,t="asc"){const n=t,r=Ah("orderBy",e);return Fh._create(r,n)}function Uh(e,t,n){if("string"==typeof(n=B(n))){if(""===n)throw new Yi(Xi.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!$o(t)&&-1!==n.indexOf("/"))throw new Yi(Xi.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(fs.fromString(n));if(!ms.isDocumentKey(r))throw new Yi(Xi.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Ws(e,new ms(r))}if(n instanceof Gl)return Ws(e,n._key);throw new Yi(Xi.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${jl(n)}.`)}function Bh(e,t){if(!Array.isArray(e)||0===e.length)throw new Yi(Xi.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new Yi(Xi.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function jh(e,t){if(t.isInequality()){const n=qo(e),r=t.field;if(null!==n&&!n.isEqual(r))throw new Yi(Xi.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${r.toString()}'`);const i=jo(e);null!==i&&qh(0,r,i)}const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new Yi(Xi.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Yi(Xi.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function qh(e,t,n){if(!n.isEqual(t))throw new Yi(Xi.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class $h{convertValue(e,t="none"){switch(js(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Os(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ls(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw zi()}}convertObject(e,t){const n={};return Cs(e.fields,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new lh(Os(e.latitude),Os(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=Vs(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Us(e));default:return null}}convertTimestamp(e){const t=Rs(e);return new ls(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=fs.fromString(e);Wi(Dc(n));const r=new ks(n.get(1),n.get(3)),i=new ms(n.popFirst(5));return r.isEqual(t)||Hi(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function Hh(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Kh{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Gh extends Ch{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new zh(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Ah("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class zh extends Gh{data(e={}){return super.data(e)}}class Wh{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Kh(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new zh(this._firestore,this._userDataWriter,n.key,n,new Kh(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Yi(Xi.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new zh(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Kh(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new zh(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Kh(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),s=n.indexOf(t.doc.key)),{type:Qh(t.type),doc:r,oldIndex:i,newIndex:s}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Qh(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return zi()}}class Xh extends $h{constructor(e){super(),this.firestore=e}convertBytes(e){return new ah(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Gl(this.firestore,null,t)}}function Yh(e,t){const n=ql(e.firestore,ih),r=Xl(e),i=Hh(e.converter,t);return Zh(n,[yh(mh(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,ya.exists(!1))]).then((()=>r))}function Jh(e,...t){var n,r,i;e=B(e);let s={includeMetadataChanges:!1},o=0;"object"!=typeof t[o]||rh(t[o])||(s=t[o],o++);const a={includeMetadataChanges:s.includeMetadataChanges};if(rh(t[o])){const e=t[o];t[o]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[o+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[o+2]=null===(i=e.complete)||void 0===i?void 0:i.bind(e)}let c,u,l;if(e instanceof Gl)u=ql(e.firestore,ih),l=Uo(e._key.path),c={next:n=>{t[o]&&t[o](function(e,t,n){const r=n.docs.get(t._key),i=new Xh(e);return new Gh(e,i,t._key,r,new Kh(n.hasPendingWrites,n.fromCache),t.converter)}(u,e,n))},error:t[o+1],complete:t[o+2]};else{const n=ql(e,zl);u=ql(n.firestore,ih),l=n._query;const r=new Xh(u);c={next:e=>{t[o]&&t[o](new Wh(u,r,n,e))},error:t[o+1],complete:t[o+2]},function(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Yi(Xi.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}(e._query)}return function(e,t,n,r){const i=new Yl(r),s=new hl(t,i,n);return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=Qi(e),r=t.query;let i=!1,s=n.queries.get(r);if(s||(i=!0,s=new ol),i)try{s.Au=await n.onListen(r)}catch(e){const n=nl(e,`Initialization of query '${Xo(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,s),s.listeners.push(t),t.bu(n.onlineState),s.Au&&t.Pu(s.Au)&&ll(n)}(await th(e),s))),()=>{i.bc(),e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=Qi(e),r=t.query;let i=!1;const s=n.queries.get(r);if(s){const e=s.listeners.indexOf(t);e>=0&&(s.listeners.splice(e,1),i=0===s.listeners.length)}if(i)return n.queries.delete(r),n.onUnlisten(r)}(await th(e),s)))}}(sh(u),l,a,c)}function Zh(e,t){return function(e,t){const n=new Ji;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Ol(e);try{const e=await function(e,t){const n=Qi(e),r=ls.now(),i=t.reduce(((e,t)=>e.add(t.key)),za());let s,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Va(),c=za();return n.Gi.getEntries(e,i).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((i=>{s=i;const o=[];for(const e of t){const t=Ea(e,s.get(e.key).overlayedDocument);null!=t&&o.push(new ka(e.key,t,Po(t.value.mapValue),ya.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(s,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:ja(s)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.hc[e.currentUser.toKey()];r||(r=new xo(cs)),r=r.insert(t,n),e.hc[e.currentUser.toKey()]=r}(r,e.batchId,n),await Dl(r,e.changes),await $u(r.remoteStore)}catch(e){const t=nl(e,"Failed to persist write");n.reject(t)}}(await function(e){return eh(e).then((e=>e.syncEngine))}(e),t,n))),n.promise}(sh(e),t)}!function(e,t=!0){Bi="9.17.1",Te(new j("firestore",((e,{instanceIdentifier:n,options:r})=>{const i=e.getProvider("app").getImmediate(),s=new ih(new ts(e.getProvider("auth-internal")),new ss(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Yi(Xi.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ks(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:t},r),s._setSettings(r),s}),"PUBLIC").setMultipleInstances(!0)),Se(Vi,"3.8.3",e),Se(Vi,"3.8.3","esm2017")}();var ed=function(){return ed=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},ed.apply(this,arguments)};function td(e){if("object"==typeof e&&null!==e){var t=Array.isArray(e)?function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}([],e,!0):ed({},e);for(var n in t)t[n]=td(t[n]);return t}return e}function nd(e,t){if(e===t)return null;if(void 0===e||"object"!=typeof t||typeof t!=typeof e)return t;var n=e,r=t;if("object"==typeof t&&"object"!=typeof e)throw"type mismatch, ".concat(typeof e," vs ").concat(typeof t);var i={},s=0;return Object.entries(n).forEach((function(e){var t=nd(n[e[0]],r[e[0]]);null!==t&&(++s,i[e[0]]=void 0===t?null:t)})),Object.entries(t).filter((function(e){return void 0===n[e[0]]})).forEach((function(e){++s,i[e[0]]=r[e[0]]})),0===s?null:td(i)}function rd(e,t){if(null===t)return e;if(typeof e!=typeof t)return"object"==typeof t?td(t):t;if("object"!=typeof t)return t;var n=e;return Object.keys(t).forEach((function(e){var r=t[e];null===r?delete n[e]:n[e]=rd(n[e],r)})),Array.isArray(n)?n.filter((function(e){return null!=e})):n}var id=function(){return id=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},id.apply(this,arguments)},sd=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},od=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},ad=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};function cd(e){if("object"!=typeof e)return!1;if(null===e)return!0;for(var t in e)if(cd(e[t]))return!0;return!1}function ud(e,t){var n=td(e);cd(n)&&console.error("nulls before");var r=rd(e,t);if(cd(r))throw console.error("nulls after",n),"nulls";return r}var ld={},hd={};function dd(e){var t;return console.log("Count scans for key ".concat(e)),void 0===e&&console.error("undefined key"),(null===(t=hd[e])||void 0===t?void 0:t.length)||0}function fd(e){return sd(this,void 0,void 0,(function(){return od(this,(function(t){return[2,x(e,1,{upgrade:function(t){t.createObjectStore(e,{keyPath:"timestamp"}).createIndex("timestamp","timestamp",{unique:!0})}})]}))}))}function pd(e,t,n,r){return sd(this,void 0,void 0,(function(){var i,s,o,a;return od(this,(function(c){switch(c.label){case 0:return i="diffCache"===r?":diffcache":"",[4,fd(s="".concat(t,":").concat(n).concat(i))];case 1:return o=c.sent(),a=o.transaction(s,"readwrite"),[4,Promise.all(ad(ad([],e.map((function(e){var t=id({},e);t.prev=void 0,t.next=void 0,a.store.put(t)})),!0),[a.done],!1))];case 2:return c.sent(),[2]}}))}))}function gd(e,t,n){return sd(this,void 0,void 0,(function(){var r,i;return od(this,(function(s){switch(s.label){case 0:return r="diffCache"===n?":diffcache":"",[4,fd(i="".concat(e,":").concat(t).concat(r))];case 1:return[2,s.sent().getAllFromIndex(i,"timestamp")]}}))}))}function md(e,t,n){return sd(this,void 0,void 0,(function(){var r,i,s,o,a;return od(this,(function(c){switch(c.label){case 0:return r="diffCache"===n?":diffcache":"",[4,fd(i="".concat(e,":").concat(t).concat(r))];case 1:return[4,(s=c.sent()).getAllKeys(i)];case 2:return o=c.sent(),console.log({k0:o[0],kl:o.slice(-1)[0]}),(a=o.slice(-1)[0])?[2,s.getFromIndex(i,"timestamp",a)]:[2,void 0]}}))}))}var yd=function(e,t,n){n||(n="(default)");const r=function(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}(e,"firestore");if(r.isInitialized(n)){const e=r.getImmediate({identifier:n});if(V(r.getOptions(n),t))return e;throw new Yi(Xi.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Yi(Xi.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:t,instanceIdentifier:n})}(function(e,t={}){let n=e;"object"!=typeof t&&(t={name:t});const r=Object.assign({name:"[DEFAULT]",automaticDataCollectionEnabled:!1},t),i=r.name;if("string"!=typeof i||!i)throw Ee.create("bad-app-name",{appName:String(i)});if(n||(n=(()=>{var e;return null===(e=M())||void 0===e?void 0:e.config})()),!n)throw Ee.create("no-options");const s=we.get(i);if(s){if(V(n,s.options)&&V(r,s.config))return s;throw Ee.create("duplicate-app",{appName:i})}const o=new H(i);for(const e of be.values())o.addComponent(e);const a=new xe(n,r,o);return we.set(i,a),a}({apiKey:"AIzaSyCzwCKesO-Me1dVpo-5jZxoo559SoGGstk",authDomain:"npaserver.firebaseapp.com",projectId:"npaserver",storageBucket:"npaserver.appspot.com",messagingSenderId:"560331767449",appId:"1:560331767449:web:5595a4f5c3e02ed49bc208"}),{experimentalForceLongPolling:Oe()});function vd(e,t){return sd(this,void 0,void 0,(function(){var n,r,i;return od(this,(function(s){switch(s.label){case 0:if(hd[t]&&0!==hd[t].length)return[3,4];s.label=1;case 1:return s.trys.push([1,3,,4]),n=hd,r=t,[4,gd(e,t,"scanCache")];case 2:return n[r]=s.sent(),console.log("Restored scan cache from db: ".concat(hd[t].length)),console.log("Done restores."),[3,4];case 3:return Id(i=s.sent()),console.error(i),[3,4];case 4:return[2]}}))}))}function wd(e,t){var n=Ff();Yh(Ql(yd,"newkey"),t?{game_id:n,api_key:e,notifications:t}:{game_id:n,api_key:e})}function bd(e){for(var t,n=hd[e].length,r=n-1;r>=0&&void 0===(null===(t=xd(e,r))||void 0===t?void 0:t.tick);)r--;r+1<n&&(r++,hd[e]=hd[e].slice(0,r),console.log("trimInvalidEntries: ".concat(e," ").concat(n," -> ").concat(r)),r>0&&(hd[e][r-1].eof=!0))}function _d(e){var t;return sd(this,void 0,void 0,(function(){var n,r,i,s,o,a,c,u,l,h,d,f,p,g,m;return od(this,(function(y){switch(y.label){case 0:return void 0!==hd[e]?(console.log("Already watching ".concat(e)),[2]):[4,vd(n=Ff(),e)];case 1:if(y.sent(),r=(null===(t=hd[e])||void 0===t?void 0:t.length)||0,console.log("Fetched ".concat(r," entries from ").concat(e)),i=0,r>0){for(s=function(t){var n=hd[e][t];return 0===t?(void 0!==n.apis||void 0!==n.cached)&&n.forward:!(!n.apis&&!n.error)||!(!n.cached||!n.back)||n.back&&n.forward},o=0,o=0;o<r&&s(o);++o);if((o-=1)>=0){if(o<r-1)console.error("Valid entries ".concat(o,"/").concat(r," for ").concat(e)),hd[e]=hd[e].slice(0,o+1);else if(console.log("All valid entries ".concat(o,"/").concat(r," for ").concat(e)),r>0){for(hd[e][0].apis||hd[e][0].cached?console.log("Valid: 0th entry has an apis or cached state",hd[e][0]):console.error("Invalid: 0th entry missing an apis string",hd[e][0]),console.log("Validating ".concat(r," entries...")),a="",c={},r>0&&(a=hd[e][0].apis,c=hd[e][0].cached),u=!1,l=-1,f=0;f<r;++f)f>0&&(hd[e][f].prev=hd[e][f-1]),(p=xd(e,f))&&void 0!==(null==p?void 0:p.tick)?u&&console.error("Invalid: found good scan data @ index ".concat(f," for ").concat(e," after endOfKeyData @ ").concat(l)):hd[e][f].error?u||(u=!0,l=f,console.log("Valid: End of ".concat(e," @ ").concat(l))):console.error("Invalid: cannot find good scan data @ index ".concat(f," for ").concat(e));for(console.log("Validated ".concat(r," entries for ").concat(e)),console.log("Reverse validating ".concat(e,"...")),h=-1,d=-1,f=l>=0?l:r-1;f>=0;--f)f<r&&(hd[e][f].next=hd[e][f+1]),(p=xd(e,f))&&void 0!==(null==p?void 0:p.tick)?p.tick>h&&(h=p.tick):console.error("Invalid: cannot find good scan data @ index ".concat(f," for ").concat(e)),0===f&&(d=null==p?void 0:p.tick,ld[e]={puid:p.player_uid,firstTick:d,lastTick:h},null!==nd(void 0!==c?c:JSON.parse(a),p)?(Id("error_invalidindex_".concat(f,"_").concat(n,":").concat(e)),console.error("Invalid: index ".concat(f," doesn't match ").concat(a))):console.log("Valid: index ".concat(f," matches!")))}i=hd[e][o].timestamp}else console.error("No valid entries found for ".concat(e)),hd[e]=[]}else hd[e]=[];return g=[],hd[e].forEach((function(t,n){t.apis&&Ed(t);var r=n-1;if(r>=0&&void 0===t.error&&void 0===t.back){var i=hd[e][r].cached;Td(hd[e][r],t),i!==hd[e][r].cached&&g.push(hd[e][r])}r>=0&&void 0===t.prev&&(t.prev=hd[e][r],hd[e][r].next=t)})),g.length&&(console.log("Storing ".concat(g.length," freshly computed diffs")),pd(g,n,e,"scanCache")),console.log("getServerScans: ".concat(i," ").concat(e," ").concat(r)),bd(e),m="scans/".concat(n,"/").concat(n,":").concat(e),[2,Jh(Mh(Ql(yd,m),Oh("timestamp",">",i),Vh("timestamp")),(function(t){var r=[];t.docChanges().forEach((function(t){if("added"===t.type||"modified"===t.type&&t.doc){var i=t.doc.data();Ed(i);var s=r.length-1;if(r.push(i),s>=0&&void 0===i.error)Td(r[s],i);else if(-1===s&&void 0===i.error){var o=hd[e].length-1;o>=0&&(Td(hd[e][o],i),pd(hd[e].slice(-1),n,e,"scanCache"))}}})),pd(r,n,e,"scanCache"),console.log("Added ".concat(r.length," scans for ").concat(n,":").concat(e)),hd[e]=hd[e].concat(r),bd(e)}),(function(t){Id("scans query ".concat(n,":").concat(e," failing: ").concat(t)),console.log("scans query ".concat(n,":").concat(e," failing: ")),console.error(t)}))]}}))}))}function Td(e,t){var n=Ed(e),r=Ed(t),i=nd(n,r),s=nd(r,n);t.prev=e,e.next=t,t.back=s,e.forward=i,void 0!==e.back&&(e.cached=void 0)}function Ed(e){var t,n;if(void 0===e.cached&&void 0===e.error)if(void 0!==e.apis){var r=JSON.parse(e.apis);r.error&&(e.error=r.error),e.cached=JSON.parse(e.apis).scanning_data,e.apis=void 0}else if(null===(t=null==e?void 0:e.next)||void 0===t?void 0:t.cached){var i=e.next.cached;e.next.next?e.next.cached=void 0:i=window.structuredClone(i),void 0===e.next.back&&(Id("error_undefined_back__old"),console.error("Patching with undefined back")),e.cached=ud(i,e.next.back)}else(null===(n=null==e?void 0:e.prev)||void 0===n?void 0:n.cached)?(i=e.prev.cached,e.prev.prev?e.prev.cached=void 0:i=window.structuredClone(i),void 0===e.prev.forward&&(Id("error_undefined_forward_old"),console.error("Patching with undefined forward")),e.cached=ud(i,e.prev.forward)):(Id("error_multijump_old"),console.error("multi jump NIY"));return void 0===e.cached&&void 0===e.error&&console.error("parseScans returning undefined for",e),e.cached}function xd(e,t){return Ed(hd[e][t])}function Sd(e,t){return Ed(hd[e][t])}function kd(e){var n,r,i,s,o,a=Ff(),c=Ql(yd,"error"),u=(null===(n=null==e?void 0:e.error)||void 0===n?void 0:n.stack)||(null===(r=null==e?void 0:e.reason)||void 0===r?void 0:r.stack)||"no stack trace",l=(null===(i=null==e?void 0:e.error)||void 0===i?void 0:i.message)||(null===(s=null==e?void 0:e.reason)||void 0===s?void 0:s.message)||(null===(o=null==e?void 0:e.reason)||void 0===o?void 0:o.code)||"no message",h=t(),d=(new Date).getTime();"no stack trace"===u?(console.error("No stack",e),Id("".concat(l)),Id("".concat(l,":").concat(JSON.stringify(e)))):Yh(c,{gameid:a,stack:u,message:l,version:h,timestamp:d}).catch((function(e){console.error("Failed to write error for game ".concat(a))}))}function Id(e){var n=Xl(Ql(yd,"info"),"counters"),r={},i=t(),s=i.match(/v[0-9]\.[^ ]*/)+(-1!==i.indexOf("⚠")?"-dev":""),o="".concat(s,"_").concat(e);console.log("INCREMENT ".concat(o)),r[o]=new vh("increment",1),function(e,t,n){e=ql(e,Gl);const r=ql(e.firestore,ih),i=Hh(e.converter,t,n);return Zh(r,[yh(mh(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,ya.none())])}(n,r,{merge:!0}).catch((function(e){console.error("Error trying to increment ".concat(o),{e:e,d:n,data:r})}))}var Cd=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},Nd=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}};function Ad(e,t){return Cd(this,void 0,void 0,(function(){var n;return Nd(this,(function(r){switch(r.label){case 0:return[4,fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},redirect:"follow",referrerPolicy:"no-referrer",body:new URLSearchParams(t).toString()})];case 1:return n=r.sent(),Id(e),[2,n.json()]}}))}))}function Pd(e,t){return Cd(this,void 0,void 0,(function(){var n;return Nd(this,(function(r){switch(r.label){case 0:return[4,fetch("".concat(e,"?npa&").concat(new URLSearchParams(t).toString()),{method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded"},redirect:"follow",referrerPolicy:"no-referrer"})];case 1:return n=r.sent(),Id(e),[2,n.json()]}}))}))}var Dd=function(){return Dd=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Dd.apply(this,arguments)},Md=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},Rd=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},Od=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},Ld={game_event:[],game_diplomacy:[]},Fd={};function Vd(e){return"".concat(Ff(),":").concat(e)}function Ud(e,t){return Md(this,void 0,void 0,(function(){var n,r,i=this;return Rd(this,(function(s){switch(s.label){case 0:return[4,x(Vd(t),1,{upgrade:function(e){e.createObjectStore(t,{keyPath:"key"}).createIndex("date","date",{unique:!1})}})];case 1:return n=s.sent(),r=n.transaction(t,"readwrite"),[4,Promise.all(Od(Od([],e.map((function(e){return 0===(null==e?void 0:e.comment_count)?r.store.add(e):r.store.put(e).then((function(){return Md(i,void 0,void 0,(function(){var t,n,r;return Rd(this,(function(i){return e.comment_count&&("read"===e.status?void 0===(null===(n=Ld[e.key])||void 0===n?void 0:n.length)?zd(e.comment_count,e.key):(t=Ld[e.key].length,zd(e.comment_count-t+1,e.key)):console.log("Avoid caching comments for ".concat(e.key," since it is unread: ").concat(null===(r=null==e?void 0:e.payload)||void 0===r?void 0:r.subject))),[2]}))}))}))})),!0),[r.done],!1))];case 2:return s.sent(),[2]}}))}))}function Bd(e){return Md(this,void 0,void 0,(function(){return Rd(this,(function(t){switch(t.label){case 0:return[4,x(Vd(e),1,{upgrade:function(t){t.createObjectStore(e,{keyPath:"key"}).createIndex("date","date",{unique:!1})}})];case 1:return[2,t.sent().getAllFromIndex(e,"date")]}}))}))}function jd(e,t){t.forEach((function(t){var n,r;(t.body||(null===(n=t.payload)||void 0===n?void 0:n.body))&&(t.body||(null===(r=t.payload)||void 0===r?void 0:r.body)).split(/[^\w\d]+/).forEach((function(n){n&&(void 0===Fd[n]&&(Fd[n]=[]),Fd[n].push({group:e,message:t}))}))}))}function qd(e){var t;return Md(this,void 0,void 0,(function(){var n,r,i;return Rd(this,(function(s){switch(s.label){case 0:if(void 0===(null===(t=Ld[e])||void 0===t?void 0:t.length)&&(Ld[e]=[]),0!==Ld[e].length)return[3,4];s.label=1;case 1:return s.trys.push([1,3,,4]),n=Ld,r=e,[4,Bd(e)];case 2:return n[r]=s.sent(),jd(e,Ld[e]),console.log("Restored message cache for ".concat(e," from db: ").concat(Ld[e].length)),"game_diplomacy"===e&&(Id("loading_diplomacy_from_db"),Ld[e].forEach((function(e){return qd(e.key)}))),[3,4];case 3:return i=s.sent(),console.error(i),[3,4];case 4:return[2]}}))}))}function $d(e,t){return Md(this,void 0,void 0,(function(){var n,r,i,s,o,a,c,u,l,h,d,f,p,g;return Rd(this,(function(m){switch(m.label){case 0:return void 0===(n=t.report.messages)?(Id("incoming_undefined"),Id(JSON.stringify(t.report)),[2,!1]):(n=n.map((function(e){return Dd(Dd({},e),{date:-Date.parse((null==e?void 0:e.activity)||e.created)})})),[4,qd(e)]);case 1:if(m.sent(),Ld[e].length>0){for(r=-1,i=0,s=Ld[e].length,o=Ld[e][i],a=function(t){var a=n[t];if(a.key===o.key){i++;var u=t;if(function(e,t){if("game_event"!==e.group&&(null==e?void 0:e.status)&&e.status!==(null==t?void 0:t.status))return Id("status_changed_from_".concat(e.status,"_to_").concat(t.status)),!1;var n=(null==e?void 0:e.comment_count)===(null==t?void 0:t.comment_count);return Id("isUnchanged_".concat(n)),n}(a,o)||i>=s){var l={};for(Ld[e].forEach((function(e){return l[e.key]=!0}));t>0&&n[t-1].created===a.created;){var h=n[t-1];if(!l[h.key])break;t--,Id("decrement_i_".concat(u-t))}r=t;for(var d=!0,f=t;f<n.length;++f)d&&(d=l[n[f].key]);Id("overlaps_found_".concat(d));var p=!1;for(f=0;f<t;++f)p||(p=!0===l[n[f].key]);return Id("collisions_found_".concat(p)),c=t,"break"}Ld[e]=Ld[e].slice(1),o=Ld[e][0],t=0}c=t},u=0;u<n.length&&(l=a(u),u=c,"break"!==l);++u);if(n.length>Ld[e].length&&(Id("would_force_restore"),console.log("Incoming messages forced restore: ".concat(n.length)),h={},Ld[e].forEach((function(e){h[e.key]=!0})),d=[],n.forEach((function(e,t){h[e.key]||d.push(e)})),console.log("Forcibly adding ".concat(d.length," missing keys")),Id("Force store ".concat(d.length)),Ud(d,e),Ld[e]=d.concat(Ld[e]),Id("Force messageCache len ".concat(Ld[e].length))),r>=0)console.log("Incoming messages total: ".concat(n.length)),n=n.slice(0,r),console.log("Incoming messages new: ".concat(n.length)),"game_diplomacy"===e&&(f=n.map((function(e){return e.key})),p=[],Ld[e].forEach((function(e,t){-1!==f.indexOf(e.key)&&p.push(t)})),p=p.reverse(),console.log("Removing ".concat(p.length," old messages")),p.forEach((function(t){return Ld[e].splice(t,1)})));else if(r<0)return(g=2*n.length)>4096||g<=0?(Id("invalid_size_".concat(g)),[2,!1]):(console.log("Missing some events for ".concat(e,", double fetch to ").concat(g)),"game_event"===e||"game_diplomacy"===e?(Id("recursive_rrm"),[2,Gd(g,e)]):(Id("call_rmc"),[2,zd(g,e)]))}try{Id("prestore"),Ud(n,e),Id("poststore"),jd(e,n),Ld[e]=n.concat(Ld[e]),Id("postcache"),console.log("Return full message set for ".concat(e," of ").concat(Ld[e].length))}catch(e){Id("ERROR ".concat(e)),console.error(e)}return[2,!0]}}))}))}function Hd(){return""===NeptunesPride.gameVersion&&"NP4"===Crux.templates.NP4}var Kd=function(){return Hd()?"game_api":"proteus"!==NeptunesPride.gameVersion?"trequest_osric":"prequest"};function Gd(e,t){return Md(this,void 0,void 0,(function(){var n,r,i,s;return Rd(this,(function(o){switch(o.label){case 0:return Hd()?(console.error("requestRecentMessages NIY for NP4"),[2]):(console.log("requestRecentMessages"),n="/".concat(Kd(),"/fetch_game_messages"),Id("requestRecentMessages ".concat(e," ").concat(t)),r={type:"fetch_game_messages",count:Ld[t].length>0?e:1e5,offset:0,group:t,version:NeptunesPride.version,game_number:Ff()},Id(t),i=$d,s=[t],[4,Ad(n,r)]);case 1:return[2,i.apply(void 0,s.concat([o.sent()]))]}}))}))}function zd(e,t){return Md(this,void 0,void 0,(function(){var n,r,i,s;return Rd(this,(function(o){switch(o.label){case 0:return console.log("reqeustMessageComments ".concat(e," for ").concat(t)),n="/".concat(Kd(),"/fetch_game_message_comments"),r={type:"fetch_game_message_comments",count:e,offset:0,message_key:t,version:NeptunesPride.version,game_number:Ff()},i=$d,s=[t],[4,Ad(n,r)];case 1:return[2,i.apply(void 0,s.concat([o.sent()]))]}}))}))}var Wd={game_event:0,game_diplomacy:0};function Qd(e){return Md(this,void 0,void 0,(function(){var t;return Rd(this,(function(n){return(t=(new Date).getTime())-Wd[e]<1e4?[2,!0]:(Wd[e]=t,console.log("updateMessageCache"),[2,Gd(4,e)])}))}))}function Xd(e){return Md(this,void 0,void 0,(function(){return Rd(this,(function(t){switch(t.label){case 0:return[4,Qd("game_event")];case 1:return t.sent(),[2,Ld.game_event.filter((function(t){return e<-t.date})).length>0]}}))}))}var Yd,Jd=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},Zd=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},ef=function(){function e(e){this.properties=[],this.storename=e,this.dbPromise=x(e,1,{upgrade:function(t){t.createObjectStore(e)}})}return e.prototype.get=function(e){return Jd(this,void 0,void 0,(function(){return Zd(this,(function(t){switch(t.label){case 0:return[4,this.dbPromise];case 1:return[2,t.sent().get(this.storename,e)]}}))}))},e.prototype.set=function(e,t){return Jd(this,void 0,void 0,(function(){return Zd(this,(function(n){switch(n.label){case 0:return[4,this.dbPromise];case 1:return[2,n.sent().put(this.storename,t,e)]}}))}))},e.prototype.del=function(e){return Jd(this,void 0,void 0,(function(){return Zd(this,(function(t){switch(t.label){case 0:return[4,this.dbPromise];case 1:return[2,t.sent().delete(this.storename,e)]}}))}))},e.prototype.clear=function(){return Jd(this,void 0,void 0,(function(){return Zd(this,(function(e){switch(e.label){case 0:return[4,this.dbPromise];case 1:return[2,e.sent().clear(this.storename)]}}))}))},e.prototype.keys=function(){return Jd(this,void 0,void 0,(function(){return Zd(this,(function(e){switch(e.label){case 0:return[4,this.dbPromise];case 1:return[2,e.sent().getAllKeys(this.storename)]}}))}))},e.prototype.newSetting=function(e,t,n,r){var i=null;this.get(t).then((function(e){i=void 0!==e?e:n}));var s={get:function(){return null===i&&console.error("Getter retuning ".concat(i," for ").concat(t)),i},set:function(e){return i=e,this.set(t,e),i}};Object.defineProperty(this,t,s),this.properties.push({name:t,displayName:e,type:typeof n,allowableValues:r})},e.prototype.getProperties=function(){return this.properties},e}(),tf=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},nf=null,rf={},sf=function(e,t){var n=+e.x-+t.x,r=+e.y-+t.y;return n*n+r*r};function of(e,t,n,r){r===nf&&void 0!==rf[n.uid]||(function(e){var t=Object.keys(e.stars).map((function(t){return e.stars[t]})),n=tf([],t,!0);t.forEach((function(e){var t=tf([],n.sort((function(t,n){return sf(e,n)-sf(e,t)})),!0).reverse();rf[e.uid]=t}))}(r),nf=r);for(var i=t*t,s=rf[n.uid],o=0;s&&o<s.length;++o){var a=s[o];if(a.puid===e)return sf(a,n)<=i}return!1}function af(e,t){if(Hd()){var n=e.tech;return"scanning"===t&&NeptunesPride.universe.galaxy.config.noScn?af(e,"propulsion"):n[NeptunesPride.universe.techNames.indexOf(t)]}return e.tech[t]}function cf(e){return Hd()?NeptunesPride.universe.calcScanValue(e):e.tech.scanning.value}function uf(e){return"1"===e.v||1===e.v}function lf(e,t){return NeptunesPride.universe.distance(e.x,e.y,t.x,t.y)}function hf(e){return Hd()?e.level*e.cost:"proteus"!==NeptunesPride.gameVersion?e.brr*e.level:e.brr*e.level*e.level*e.level}function df(e,t){for(var n=function(e){var n="".concat(e.replace(/[A-Z]/g,"_$&").toLowerCase());e!==n&&Object.defineProperty(t,n,{get:function(){return this[e]},set:function(t){return this[e]=t}})},r=0,i=Object.getOwnPropertyNames(t);r<i.length;r++)n(i[r])}!function(e){e[e.Nothing=0]="Nothing",e[e.CollectAll=1]="CollectAll",e[e.DropAll=2]="DropAll",e[e.Collect=3]="Collect",e[e.Drop=4]="Drop",e[e.CollectAllBut=5]="CollectAllBut",e[e.DropAllBut=6]="DropAllBut",e[e.Garrison=7]="Garrison"}(Yd||(Yd={}));var ff=function(e){var t=e.toLowerCase();return function(e){return-1!==e.indexOf(t)}},pf=function(e,t){return function(n){return e(n)||t(n)}},gf=function(){function e(e,t){this.c=t,this.a=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}([],e,!0);for(var n=this.parent(this.a.length);n>=0;--n)this.heapify(n)}return e.prototype.size=function(){return this.a.length},e.prototype.peek=function(){return this.a[0]},e.prototype.extract=function(){var e=this.a[0],t=this.a.splice(-1)[0];return this.size()>0&&(this.a[0]=t,this.heapify(0)),e},e.prototype.parent=function(e){return Math.floor(e-1>>1)},e.prototype.left=function(e){return 1+(e<<1)},e.prototype.right=function(e){return 2+(e<<1)},e.prototype.heapify=function(e){var t=this.left(e),n=this.right(e),r=this.c,i=this.a,s=e;if(void 0!==i[t]&&r(i[s],i[t])<=0&&(s=t),void 0!==i[n]&&r(i[s],i[n])<=0&&(s=n),s!==e){var o=i[e];i[e]=i[s],i[s]=o,this.heapify(s)}},e}(),mf=function(e){return e.split(/[^\w]/)[3]},yf=function(){function e(e){this.apikey=mf(e),dd(this.apikey)>0?(this.currentScanRecord=hd[this.apikey][0],this.currentScanData=td(this.currentScanRecord.cached)):this.currentScanRecord=void 0}return e.prototype.getScanRecord=function(){return this.currentScanRecord},e.prototype.getScanData=function(){return this.currentScanData},e.prototype.hasNext=function(){var e;return void 0!==(null===(e=this.currentScanRecord)||void 0===e?void 0:e.next)},e.prototype.next=function(){var e,t,n=rd(this.currentScanData,null===(e=this.currentScanRecord)||void 0===e?void 0:e.forward);this.currentScanData=n,this.currentScanRecord=null===(t=this.currentScanRecord)||void 0===t?void 0:t.next},e.prototype.timestamp=function(){var e;return null===(e=this.currentScanRecord)||void 0===e?void 0:e.timestamp},e}(),vf=function(){function e(e,t){var n=e.map((function(e){return new yf(e)})).filter((function(e){return e.hasNext()}));for(this.scanIteratorHeap=new gf(n,(function(e,n){var r=e.getScanData(),i=n.getScanData();if(void 0===r)return r;if(void 0===i)return i;var s=0;return t===i.player_uid?s=.5:t===r.player_uid&&(s=-.5),i.tick-r.tick-s}));void 0===this.getScanData()&&this.scanIteratorHeap.size();)this.scanIteratorHeap.extract()}return e.prototype.getScanRecord=function(){var e;return null===(e=this.scanIteratorHeap.peek())||void 0===e?void 0:e.getScanRecord()},e.prototype.getScanData=function(){var e;return null===(e=this.scanIteratorHeap.peek())||void 0===e?void 0:e.getScanData()},e.prototype.hasNext=function(){var e=this.scanIteratorHeap;return e.size()>1||e.size()>0&&e.peek().hasNext()},e.prototype.next=function(){if(this.hasNext()){var e=this.scanIteratorHeap;for(e.peek().next();void 0===this.getScanData()&&e.size()>0;)e.extract();return this.getScanData()}},e.prototype.timestamp=function(){return this.scanIteratorHeap.peek().timestamp()},e}(),wf={knownAlliances:void 0,combatHandicap:0},bf=function(e){return(void 0!==e?e:wf.combatHandicap>0?"Enemy WS":"My WS")+(wf.combatHandicap>0?"+":"")+wf.combatHandicap};function _f(e,t){return e.tick+t}function Tf(e){return NeptunesPride.universe.galaxy.tick+e}var Ef=function(){for(var e=[],t=0;t<Ld.game_event.length;++t){var n=Ld.game_event[t];if("war_declared"===n.payload.template){var r=n.payload.tick,i=n.payload.attacker,s=n.payload.defender;e.push({tick:r,p0:i,p1:s,war:"war_declared"}),r+=24,e.push({tick:r,p0:i,p1:s,war:"war"})}else"peace_accepted"===n.payload.template&&(r=n.payload.tick,i=n.payload.from_puid,s=n.payload.to_puid,e.push({tick:r,p0:i,p1:s,war:"peace_agreement"}))}return e},xf=function(e,t,n,r){var i,s;if(void 0===wf.knownAlliances&&NeptunesPride.gameConfig.alliances,NeptunesPride.gameConfig.alliances&&r>0)for(var o=Ef().sort((function(e,t){return t.tick-e.tick})),a=Tf(0),c=Tf(r),u=0;u<o.length;++u){var l=o[u];if(l.tick<=a)break;if(!(l.tick>=c)){if(l.p1==t&&l.p0==n&&"war"===l.war)return!1;if(l.p0==t&&l.p1==n&&"war"===l.war)return!1}}var h=e[t],d=e[n],f=(null==h?void 0:h.war)||(null==d?void 0:d.war)||{};return t==n||(!f[t]||!f[n])&&(0==f[t]||0==f[n]||(null===(s=null===(i=wf.knownAlliances)||void 0===i?void 0:i[t])||void 0===s?void 0:s[n]))},Sf={},kf=function(e){var t=NeptunesPride.universe.galaxy;return Cf(t,e)};function If(e){return af(e,"weapons").level}var Cf=function(e,t,n){var r,i,s,o;console.log("NEW ComputeCombatOutcomes called");var a=e.players,c=e.fleets,u=e.stars,l=[];for(var h in Sf={},c)if((b=c[h]).o&&b.o.length>0){var d=b.o[0][1],f=b.etaFirst;if(void 0!==n&&e.tick+f>n)continue;var p=null===(r=u[d])||void 0===r?void 0:r.n;if(!p)continue;l.push([f,"[[{0}]] [[{1}]] {2} → [[{3}]] [[Tick #{4}]]".format(b.puid,b.n,b.st,p,_f(e,f)),b])}l=l.sort((function(e,t){return e[0]-t[0]}));var g={},m=[],y=[],v=void 0===t?{}:t;for(var w in l){var b=l[w][2];0!==y.length&&y[y.length-1]===l[w][0]||y.push(l[w][0]);var _=[l[w][0],b.o[0][1]].toString();void 0!==g[_]?g[_].push(b):g[_]=[b]}var T=function(t){var n=[],r=g[t],l=t.split(","),h=parseInt(l[0]),d=l[1];if(!v[d]){var f=(A=a[u[d].puid])?If(A):0,p=u[d],y=f||0;"1"===u[d].v&&(y=Math.max.apply(Math,function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}([y],null==p?void 0:p.alliedDefenders.map((function(e){return If(a[e])})),!1)));for(var w=p.st,b={},_={},T=p.st,E=0,x=p.fleetsInOrbit;E<x.length;E++)T+=(D=x[E]).st;for(var S=0,k=p.fleetsInOrbit;S<k.length;S++)if((D=k[S]).o.length>0){var I=D.o[0][0];if(I>=h)if(b[D.uid]=D.st,w+=D.st,void 0===_[I-1])_[I-1]={leaving:D.st,origShips:T};else{var C=_[I-1].leaving+D.st;_[I-1]={leaving:C,origShips:T}}}else b[D.uid]=D.st,w+=D.st;v[d]={last_updated:0,ships:w,st:p.st,puid:p.puid,c:p.c||0,departures:_,weapons:y,production:p.shipsPerTick,fleetStrength:b}}if(-1==v[d].puid){var N=1e4,A=-1;for(var P in r){var D=r[P],M=lf(u[d],D);(M<N||-1==A)&&(A=D.puid,N=M)}v[d].puid=A}for(var P in r)D=r[P],xf(e.players,D.puid,v[d].puid,0)&&(y=Math.max(v[d].weapons,If(a[D.puid])),v[d].weapons=y);n.push("[[Tick #{0}]]: [[{1}]] [[{2}]] {3} ships".format(_f(e,h),v[d].puid,u[d].n,v[d].ships));var R=h-v[d].last_updated-1;if(R>0){var O=v[d].ships,L=v[d].last_updated;for(_=v[d].departures,P=L;P<L+R;++P)if(_[P]){var F=O/_[P].origShips,V=Math.ceil(_[P].leaving*F);v[d].ships-=V,n.push("  {0} depart".format(V))}if(v[d].ships<O&&(O=v[d].ships),v[d].last_updated=h-1,v[d].production){var U=v[d].c;v[d].ships+=v[d].production*R+U,v[d].st+=Math.trunc(v[d].production*R+U),v[d].c=v[d].ships-Math.trunc(v[d].ships),v[d].ships-=v[d].c,n.push("  {0}+{3} + {2}/h = {1}+{4}".format(O,v[d].ships,v[d].production,U,v[d].c))}}for(var P in r)if(D=r[P],xf(e.players,D.puid,v[d].puid,0)||-1==v[d].puid){O=v[d].ships,-1==v[d].puid?v[d].ships=D.st:v[d].ships+=D.st,v[d].fleetStrength[D.uid]=D.st;var B="  {0} + {2} on [[{3}]] = {1}".format(O,v[d].ships,D.st,D.n);n.push(B),B=B.substring(2)}for(var P in r)if(D=r[P],xf(e.players,D.puid,v[d].puid,0)){var j="{0} ships on {1}".format(Math.floor(v[d].ships),u[d].n);Sf[D.uid]={eta:"[[Tick #".concat(_f(e,D.etaFirst),"]]"),outcome:j,strength:D.st}}var q=0,$=0;for(var P in r)if(D=r[P],!xf(e.players,D.puid,v[d].puid,0)){var H=$;$+=D.st,n.push("  [[{4}]]! {0} + {2} on [[{3}]] = {1}".format(H,$,D.st,D.n,D.puid)),v[d].fleetStrength[D.uid]=D.st;var K=If(a[D.puid]);K>q&&(q=K)}for(var G=$,z=v[d].ships;$>0;){var W=v[d].weapons,Q=v[d].ships;for(n.push("  Combat! [[{0}]] defending".format(v[d].puid)),n.push("    Defenders {0} ships, WS {1}".format(Q,W)),n.push("    Attackers {0} ships, WS {1}".format($,q)),"proteus"!==NeptunesPride.gameVersion&&(W+=1),v[d].puid!==e.player_uid?wf.combatHandicap>0?(W+=wf.combatHandicap,n.push("    Defenders WS{0} = {1}".format(bf(""),W))):wf.combatHandicap<0&&(q-=wf.combatHandicap,n.push("    Attackers WS{0} = {1}".format(bf(""),q))):wf.combatHandicap>0?(q+=wf.combatHandicap,n.push("    Attackers WS{0} = {1}".format(bf(""),q))):wf.combatHandicap<0&&(W-=wf.combatHandicap,n.push("    Defenders WS{0} = {1}".format(bf(""),W))),e.player_uid===v[d].puid&&(Q=Math.trunc(Q));Q>0&&$>0&&!(($-=W)<=0);)Q-=q;var X=0,Y={},J=-1,Z=v[d].puid;if($>0){var ee=$;Q+=q-1;do{Q-=q,ee-=W}while(ee>0);n.push("  Attackers win with {0} ships remaining".format($,-Q)),n.push("  +{1} defenders needed to survive".format($,-Q));var te=Object.keys(v[d].fleetStrength).map((function(e){return[e,v[d].fleetStrength[e]]}));te.sort((function(e,t){return t[1]-e[1]}));var ne=0;for(P=0;P<te.length;++P){var re=te[P][0];if(void 0!==(D=c[re]))if(xf(e.players,D.puid,v[d].puid,h))v[d].fleetStrength[D.uid]=0;else{var ie=D.puid;if((ne+=(he=$*v[d].fleetStrength[re]/G)-(de=Math.floor(he)))>0&&(ne-=1,de++),v[d].fleetStrength[re]=de,X+=v[d].fleetStrength[re],Y[ie]?Y[ie]+=v[d].fleetStrength[re]:Y[ie]=v[d].fleetStrength[re],Y[ie]>J&&(J=Y[ie],Z=ie),n.push("    [[{0}]] has {1} on [[{2}]]".format(D.puid,v[d].fleetStrength[re],D.n)),v[d].fleetStrength[re]){var se="";(null===(i=Sf[D.uid])||void 0===i?void 0:i.outcome)&&(se=Sf[D.uid].outcome+"\n"),j="".concat(se,"Wins! {0} land\n+{1} to defend").format(v[d].fleetStrength[re],-Q),Sf[D.uid]={eta:"[[Tick #".concat(_f(e,D.etaFirst),"]]"),outcome:j,strength:v[d].fleetStrength[re]}}}else console.error("Failed to find fleet ".concat(re))}for(var oe in"proteus"===NeptunesPride.gameVersion&&v[d].puid!=Z&&(v[d].c=0,v[d].production=0),v[d].puid=Z,v[d].weapons=If(a[Z]),v[d].ships=0,v[d].st=0,$=X,v[d].fleetStrength)if(void 0!==(D=c[oe])){var ae=D.puid;if(xf(e.players,Z,ae,h)){$-=v[d].fleetStrength[oe],v[d].ships+=v[d].fleetStrength[oe];var ce=If(a[ae]),ue=v[d].weapons;v[d].weapons=Math.max(ce,ue)}}else console.error("failed to find fleet ".concat(oe))}else{var le=Q;$+=W-1;do{$-=W,le-=q}while(le>0);for(n.push("  +{0} more attackers needed".format(-$)),v[d].ships=Q,te=Object.keys(v[d].fleetStrength).map((function(e){return[e,v[d].fleetStrength[e]]})),te.push(["star",v[d].st]),te.sort((function(e,t){return t[1]-e[1]})),ne=0,P=0;P<te.length;++P){var he,de,fe=te[P][0],pe="star"!==fe?c[fe]:e.stars[d];void 0!==pe?xf(e.players,pe.puid,v[d].puid,h)?((ne+=(he=Q*("star"===fe?v[d].st:v[d].fleetStrength[fe])/z)-(de=Math.floor(he)))>0&&(ne-=1,de++),"star"===fe?v[d].st=de:v[d].fleetStrength[fe]=de,n.push("    [[{0}]] has {1} on [[{2}]]".format(pe.puid,de,pe.n))):v[d].fleetStrength[pe.uid]=0:console.error("failed to find fleet or star ".concat(fe))}for(var P in r)D=r[P],xf(e.players,D.puid,v[d].puid,h)&&(j="{0} ships on {1}".format(Math.floor(v[d].ships),u[d].n),Sf[D.uid]={eta:"[[Tick #".concat(_f(e,D.etaFirst),"]]"),outcome:j,strength:0});for(var ge in v[d].fleetStrength)void 0!==(D=c[ge])?(se="",(null===(s=Sf[D.uid])||void 0===s?void 0:s.outcome)&&(se=Sf[D.uid].outcome+"\n"),j="".concat(se,"Loses! {0} live\n+{1} to win").format(Q,-$),xf(e.players,null==D?void 0:D.puid,null===(o=v[d])||void 0===o?void 0:o.puid,h)&&(j="".concat(se,"Wins! ").concat(Q," remain")),-1===se.indexOf("Loses")&&(Sf[D.uid]={eta:"[[Tick #".concat(_f(e,D.etaFirst),"]]"),outcome:j,strength:0})):console.error("failed to find fleet ".concat(ge))}G=$}n.push("  [[{0}]] [[{1}]] {2} ships".format(v[d].puid,u[d].n,v[d].ships)),m.push(n)};for(var E in g)T(E);return m},Nf=function(){return Nf=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Nf.apply(this,arguments)},Af=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};function Pf(){for(var e=NeptunesPride.universe,t=NeptunesPride.universe.galaxy.players,n=0;n<Ld.game_event.length;++n){var r=Ld.game_event[n].payload;e.galaxy.tick>=r.tick&&r.template.startsWith("goodbye_to_player")&&(t[r.uid].exitTick=r.tick,t[r.uid].modTick=(e.galaxy.tick-r.tick)%4)}var i=["💡","👁","⏳","⏳"];for(var s in e.galaxy.players){var o=e.galaxy.players[s];o.alias=o.rawAlias.split(" ")[0],o.rawAlias=o.alias,1!==o.ai&&1!==o.ready||(o.alias+="".concat(" ").concat(i[o.modTick]," "))}}function Df(e){return"1"===e.v||1===e.v}var Mf=function(){return Mf=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Mf.apply(this,arguments)},Rf=function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},Of=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){o.label=a[1];break}if(6===a[0]&&o.label<i[1]){o.label=i[1],i=a;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(a);break}i[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},Lf=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,s=t.length;i<s;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};function Ff(){return NeptunesPride.gameNumber||NeptunesPride.gameId}!function(){var e,n,r,i,s,c=this;window.addEventListener("error",kd),window.addEventListener("unhandledrejection",kd);var f=t(),p=f.replace(/^.*v2/,"v2");console.log(f);var g=new ef("global_settings");g.newSetting("IBB API Key","ibbApiKey","");var m=["color","shape"];g.newSetting("Alliances by:","allianceDiscriminator",m[0],m);var y=["relative","eta","tickrel","tick"];function v(e,t){var n;(null===(n=null===NeptunesPride||void 0===NeptunesPride?void 0:NeptunesPride.np)||void 0===n?void 0:n.on)?NeptunesPride.np.on(e,t):(console.log("NP not initialied yet, defer trigger for ".concat(e)),window.setTimeout((function(){return v(e,t)}),100))}g.newSetting("Time Base","relativeTimes",y[0],y),g.newSetting("Territory Display","territoryOn",!0,[!0,!1]),g.newSetting("Recolor me","whitePlayer",!1,[!1,!0]),g.newSetting("Territory Style","territoryBrightness",1,[0,1,2,3]),g.newSetting("Auto Ruler Power","autoRulerPower",1),g.newSetting("Custom Colors","customColors","#3b55ce #79fffe #13ca91 #fec763 #ff8b8b #ffaa01 #fea0fe #ce96fb"),String.prototype.format||(String.prototype.format=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.replace(/{(\d+)}/g,(function(t,n){return"number"==typeof e[n]?Math.trunc(1e3*e[n])/1e3:void 0!==e[n]?e[n]:t}))});var w=function(){for(var e=NeptunesPride.universe,t=Hd()?1:0,n=0+t;n<64+t;++n)if(e.hyperlinkedMessageInserts[n]){var r=NeptunesPride.universe.galaxy.players[n];e.hyperlinkedMessageInserts["".concat(n)]=e.hyperlinkedMessageInserts[n]=r.hyperlinkedBox+r.hyperlinkedRawAlias,e.hyperlinkedMessageInserts["#".concat(n)]=r.hyperlinkedBox}},b="planets",_=!1,T=!1,E=null,x=null,S=function(){return NeptunesPride.npui.trigger("show_screen","new_fleet")},k=function(e){NeptunesPride.npui.trigger("show_screen",["new_fleet",Mf({kind:"npa_options"},e)])},I=function(e,t,n){var r,i,s;if((null===(r=NeptunesPride.npui.npaMenu)||void 0===r?void 0:r.isShowing)&&S(),_&&E&&e!==E.getValue()&&(E.setValue(e),E.onChange()),null!==x){var a=x.getValue().toLowerCase(),c=pf(ff(a),function(e){var t=NeptunesPride.universe.galaxy.players,n=[];for(var r in t)-1!==t[r].alias.toLowerCase().indexOf(e)&&(n.push(ff("(".concat(r,")"))),n.push(ff("(#".concat(r,")"))));return n.reduce(pf,(function(){return!1}))}(a));a&&(n?(i=n,s=c,n=function(e){return i(e)&&s(e)}):n=c)}b=e,o(function(e,t,n){return e=e.filter((function(e){return!Array.isArray(e)||void 0===t||(void 0!==n&&(e=e.map(n)),e.filter(t).length>0)})),e.flat().join("\n")}(t,n,(function(e){return Crux.format(e,{}).toLowerCase()})))};function C(){var e=NeptunesPride.universe.galaxy.players,t=NeptunesPride.universe.galaxy.stars,n=NeptunesPride.universe.galaxy.fleets,r={};for(var i in Object.keys(NeptunesPride.universe.galaxy.players).forEach((function(e){return r[e]=0})),n){var s=n[i],o=void 0===(null==s?void 0:s.ouid)||Hd()&&0===(null==s?void 0:s.ouid);s.o&&s.o.length>0&&o&&(r[s.puid]+=s.st)}var a=[];for(var c in e){var u=[],l=0;for(var h in u.push(["[[{0}]]".format(c)]),t){var d=t[h];d.puid==c&&d.shipsPerTick>=0&&uf(d)&&(u.push(["  [[#{5}]] [[{0}]] {1}/{2}/{3} {4} ships".format(d.n,d.e,d.i,d.s,d.totalDefenses,c)]),l+=d.totalDefenses)}if(u.length>1){var f=l+r[c];u[0]=["[[".concat(c,"]] ").concat(l," + ").concat(r[c]," in flight (").concat(f,"/").concat(e[c].total_strength,")")],a=a.concat(u)}}I("stars",a)}function N(){var e,t,n,r,i,s,o,a,c,u,l,h,d=[],f=[],p=NeptunesPride.universe.galaxy.tick,g=Math.max(p-NeptunesPride.gameConfig.productionTicks,1),m=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid;Pe={},d.push("Star ownership changes from [[Tick #".concat(g,"]] to [[Tick #").concat(p,"]]:")),f.push("Exploration report from [[Tick #".concat(g,"]] to [[Tick #").concat(p,"]]:"));for(var y={},v=null,w=new vf(F(),m);w.hasNext()&&g<=p;){w.next();var b=w.getScanData();if(!(b.tick<g)){if(b.tick===g){var _=b.stars;null===v&&(v=td(_));var T=b.tick;for(var E in _){var x=function(e){return-1!==e&&void 0!==e?"[[".concat(e,"]]"):"Abandoned"},S=function(e){return void 0===e||-1===e};if((null===(e=v[E])||void 0===e?void 0:e.puid)===(null===(t=_[E])||void 0===t?void 0:t.puid)||S(null===(n=v[E])||void 0===n?void 0:n.puid)&&!y[E])(null===(o=v[E])||void 0===o?void 0:o.puid)!==(null===(a=_[E])||void 0===a?void 0:a.puid)&&(C=x(null===(c=_[E])||void 0===c?void 0:c.puid),S(null===(u=_[E])||void 0===u?void 0:u.puid)||f.push("[[Tick #".concat(T,"]]  ").concat(C," [[").concat(_[E].n,"]]")));else{-1===(null===(r=_[E])||void 0===r?void 0:r.puid)&&(y[E]=!0);var k=x(null===(i=v[E])||void 0===i?void 0:i.puid),C=x(null===(s=_[E])||void 0===s?void 0:s.puid);d.push("[[Tick #".concat(T,"]] ").concat(k," →  ").concat(C," [[").concat(_[E].n,"]]"))}(null===(l=v[E])||void 0===l?void 0:l.puid)!==(null===(h=_[E])||void 0===h?void 0:h.puid)&&(v[E]=Mf({},_[E]))}}g++}}1===d.length&&1===f.length&&d.push("No API data found"),1===d.length&&(d=f),I("ownership",d.map((function(e){return[e]})))}function A(){var e=[];e.push("Trading Activity:");for(var t=new vf(F()),n=function(){t.next();var n=t.getScanData(),r={},i=null,s={},o=function(e,t){var o;i!==n.stars&&(i=n.stars,s={});var a="".concat(e,"->").concat(t);if(void 0!==s[a])return s[a];var c=parseInt(e),u=parseInt(t),l=cf(n.players[c]),h=function(e,t){return e.puid===c&&t.puid===u&&lf(e,t)<=l};if(null===(o=null==r?void 0:r[c])||void 0===o?void 0:o[u]){var d=r[c][u],f=d[0],p=d[1];if(h(n.stars[f],m=n.stars[p]))return s[a]=!0,!0}for(var g in n.stars){var m;if((m=n.stars[g]).puid===c)for(var y in n.stars){var v=n.stars[y];if(v.puid===u&&h(m,v))return void 0===r[c]&&(r[c]={}),r[c][u]=[g,y],s[a]=!0,!0}}return s[a]=!1,!1},a=t.getScanRecord();if(void 0!==a.back&&void 0===a.back.tick){var c=a.back.players;for(var u in c){var l=c[u];if(l.tech)for(var h in l.tech){var d=qe(h),f=n.players[u].tech[h].level,p="";for(var g in n.players)g!==u&&n.players[g].tech[h].level>=f&&(Ge()&&!o(g,u)||(p+=" [[#".concat(g,"]]")));e.push("[[Tick #".concat(n.tick,"]] [[").concat(u,"]] ← ").concat(d).concat(f," from ").concat(p))}}}};t.hasNext();)n();1===e.length&&e.push("No trade activity data found"),I("tradeactivity",e.map((function(e){return[e]})))}function P(){var e=[];e.push("Probable Combat Activity:");for(var t=new vf(F());t.hasNext();){t.next();var n=t.getScanData(),r=t.getScanRecord();if(void 0!==r.back){var i=r.back.players,s="",o=0;for(var a in i){var c=i[a];if(c.total_strength){var u=c.total_strength;n.players[a].total_strength<u&&(s+="[[#".concat(a,"]] "),o++)}}s&&(o<=2&&(s=s.replaceAll("#","").replaceAll("] [","] vs [")),e.push("[[Tick #".concat(n.tick,"]] ").concat(s)))}}1===e.length&&e.push("No combat activity data found"),I("combatactivity",e.map((function(e){return[e]})))}function D(){var e,t=[];if((null==rt?void 0:rt.length)&&"0"!=NeptunesPride.gameConfig.alliances){t.push("Formal Alliances: ");for(var n=rt.map((function(e){return new yf(e)})),r=[],i=0;i<n.length;++i)for(var s=n[i];s.hasNext();){s.next();var o=s.getScanData();if(null==o?void 0:o.fleets)for(var a in o.fleets){var c=o.fleets[a];if(void 0!==(null==c?void 0:c.ouid)){var u=o.stars[c.ouid];if(u){if(u.puid!==c.puid&&-1!==u.puid){r[u.puid]||(r[u.puid]=[]),r[c.puid]||(r[c.puid]=[]);var l=(null===(e=r[u.puid])||void 0===e?void 0:e[c.puid])||1e5,h=Math.min(o.tick,l);r[u.puid][c.puid]=h,r[c.puid][u.puid]=h}}else console.error("Orbit star missing for ".concat(c.n))}}}var d=Ef();for(var i in r)for(var f in r[i])if(i<f){var p=+i,g=+f,m=r[i][f];d.push({tick:m,p0:p,p1:g,war:"peace"})}for(d=d.sort((function(e,t){if(e.tick===t.tick){if(e.war<t.war)return-1;if(t.war<e.war)return 1}return e.tick-t.tick})),i=0;i<d.length;++i){var y=d[i],v=(p=y.p0,g=y.p1,y.war),w="&#9774;&#65039;";"war"===v?(void 0!==r[p]&&(r[p][g]=void 0),w="&#129686;"):"war_declared"===v?w="&#9888;&#65039;":"peace_agreement"===v&&(w="&#129309"),t.push("[[Tick #".concat(y.tick,"]] ").concat(w," [[").concat(p,"]] ⇔ [[").concat(g,"]]"))}wf.knownAlliances=r}else"0"!=NeptunesPride.gameConfig.alliances?t.push("No API keys to detect Formal Alliances."):t.push("No formal alliances in this game");I("fa",t.map((function(e){return[e]})))}function M(e,t,n){var r=NeptunesPride.universe,i=e.map((function(e){var t=Mf(Mf({},e),{originalStar:e,player:r.player,uce:0,uci:0,ucs:0,ucg:0,totaluce:0,totaluci:0,totalucs:0,totalucg:0});if(t.originalStar.uce=t.uce=r.calcUCE(t),t.originalStar.uci=t.uci=r.calcUCI(t),t.originalStar.ucs=t.ucs=r.calcUCS(t),t.originalStar.ucg=t.ucg=r.calcUCG(t),0===t.uce||0===t.uci||0===t.ucs)throw"Cost unset on star ".concat(t.n);return t})),s=function(e,t){return"I"===n?e.uci-t.uci:"S"===n?e.ucs-t.ucs:e.uce-t.uce};"terra"===t&&((i=i.map((function(e){return Mf(Mf({},e),{r:e.r+5})}))).forEach((function(e){return e.uce=r.calcUCE(e)})),i.forEach((function(e){return e.uci=r.calcUCI(e)})),i.forEach((function(e){return e.ucs=r.calcUCS(e)})),i.forEach((function(e){return e.ucg=r.calcUCG(e)}))),i=i.sort(s);for(var o=0;i[0].uce<=r.player.cash&&0<i.length;)"E"===n&&(i[0].totaluce+=i[0].uce,r.upgradeEconomy(i[0])),"I"===n&&(i[0].totaluci+=i[0].uci,r.upgradeIndustry(i[0])),"S"===n&&(i[0].totalucs+=i[0].ucs,r.upgradeScience(i[0])),o++,i=i.sort(s);return"bank"===t&&(r.player.cash+=75),{count:o,allMyStars:i}}function R(e,t){var n=NeptunesPride.universe,r=n.galaxy,i=Mf({},n.player).uid,s=Object.keys(r.stars).map((function(e){return Mf({},r.stars[e])})).filter((function(e){return e.puid===i}));return M(s,e,t).count}function O(){var e,t;return Rf(this,void 0,void 0,(function(){var n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,w,b,_,T,E,x,S,k,C,N,A,P,D,O,L,F,V,U,B,j,q,$,H,K,G,z,W,Q;return Of(this,(function(X){switch(X.label){case 0:return n=[],r=NeptunesPride.universe,i=Mf({},r.player),s=i.uid,o=null==i?void 0:i.cash,a=(null==i?void 0:i.cash)||1e3,r.player.cash=a,c=r.player.total_economy,u=r.player.total_industry,l=r.player.total_science,h=function(e,t){r.player.cash=e;var n=R(t,"E");r.player.cash=e;var i=R(t,"I");return r.player.cash=e,{e:n,i:i,s:R(t,"S")}},Hd()||(n.push("--- Economists Report for [[".concat(s,"]] ($").concat(a,") ---")),n.push(":--|--:|--:"),n.push("Technology|New Income (Balance)|Buys one of E/I/S"),d=R("none","E"),r.player.cash,f=10*d,p=10*r.player.total_economy+r.player.cash+75*af(r.player,"banking").level,g=h(p,"none"),m=g.e,y=g.i,F=g.s,n.push(["No Tech|$".concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(F)]),r.player.cash=a,r.player.total_economy=c,d=R("bank","E"),r.player.cash,f=10*d+75,p=10*r.player.total_economy+r.player.cash+75*af(r.player,"banking").level,G=h(p,"bank"),m=G.e,y=G.i,F=G.s,n.push(["Banking|$".concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(F)]),v=He(r.player.tech.banking.level+1),r.player.cash=a-v,r.player.total_economy=c,d=R("bank","E"),r.player.cash,f=10*d+75,p=10*r.player.total_economy+r.player.cash+75*r.player.tech.banking.level,z=h(p,"bank"),m=z.e,y=z.i,F=z.s,n.push(["Buy it ($".concat(v,")|$").concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(F)]),r.player.cash=a,r.player.total_economy=c,d=R("terra","E"),r.player.cash,f=10*d,p=10*r.player.total_economy+r.player.cash+75*r.player.tech.banking.level,W=h(p,"terra"),m=W.e,y=W.i,F=W.s,n.push(["Terraforming|$".concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(F)]),w=He(r.player.tech.terraforming.level+1),r.player.cash=a-w,r.player.total_economy=c,d=R("terra","E"),r.player.cash,f=10*d,p=10*r.player.total_economy+r.player.cash+75*r.player.tech.banking.level,Q=h(p,"terra"),m=Q.e,y=Q.i,F=Q.s,n.push(["Buy it ($".concat(w,")|$").concat(f," ($").concat(p,")|").concat(m,"/").concat(y,"/").concat(F)]),n.push("--- Economists Report for [[".concat(s,"]] (").concat(a,") ---"))),r.player.cash=o,[4,et()];case 1:(b=X.sent()).players,_=b.apiKeys,T=b.playerIndexes,E=[],kf(x={}),S=0,k={},C=0,X.label=2;case 2:return C<T.length?(N=T[C],[4,xe.get(_[C])]):[3,6];case 3:return A=X.sent(),[4,Je(A)];case 4:if(P=X.sent())for(D=P.players[N],k[D.uid]={cash:D.cash,totaluce:0},S+=D.cash,O=0,L=Object.values(P.stars);O<L.length;O++)F=L[O],V=F.puid,void 0!==(null===(e=x[F.uid])||void 0===e?void 0:e.puid)&&V===D.uid&&(V=+(null===(t=x[F.uid])||void 0===t?void 0:t.puid)),V===D.uid&&E.push(F);X.label=5;case 5:return++C,[3,2];case 6:for(q in r.player.cash=S,U=M(E,"none","E"),B=U.allMyStars,console.log("allMyStars",B,U.count),n.push("--- Communal Transfers ---"),n.push(":--|--:|--:|--:"),n.push("Empire|Current|Needed|Transfer"),B.forEach((function(e){k[e.originalStar.puid].totaluce+=e.totaluce})),j=k[r.player.uid].totaluce,k)$=k[q].cash,H=k[q].totaluce,n.push("[[".concat(q,"]]|[[cash:").concat(q,":").concat($,"]]|").concat(H,"|[[transfer:").concat(q,":").concat($,":").concat(H,":").concat(r.player.uid,":").concat(j,"]]"));return n.push("--- Communal Transfers ---"),n.push("--- Communal Economy ---"),n.push(":--|:--|--:|--:|--:"),n.push("P|Star|E|+E|$E"),K=[],B.forEach((function(e){var t=e.e-e.originalStar.e;if(t){e.originalStar;for(var r=0;r<t;r++)K.push(e.uid);n.push(["[[#".concat(e.originalStar.puid,"]]|[[").concat(e.n,"]]|").concat(e.originalStar.e,"|").concat(t,"|").concat(e.totaluce)])}})),n.push("--- Communal Economy ---"),n.push("[[upgrade:e:".concat(K.join(":"),"]]")),console.log("Reset player's cash to ".concat(o)),r.player.cash=o,r.player.total_economy=c,r.player.total_industry=u,r.player.total_science=l,I("economists",n),[2]}}))}))}l("`",S,"Bring up the NP Agent UI.<p>The Agent UI will show you the last report you put on the clipboard or viewed.","Open NPA UI"),l("ctrl+`",k,"Bring up the NP Agent Options.<p>The Agent Options lets you customize advanced settings.<p>In particular, if you want to upload screenshots, get an API key from api.imgbb.com and put it in the settings.","Open Options"),l("ctrl+a",(function(e){NeptunesPride.npui.trigger("show_screen",["new_fleet",Mf({kind:"npa_colours"},e)])}),"Configure colours and alliances.<p>You can set the colour of every player in the game to a different value than the default, and if you wish you can use the same colour for multiple players to configure who you think is allied with who in order to get better reports and a map that reflects the alliances in your game.","Colours"),l("*",C,"Generate a report on all stars in your scanning range, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","stars"),l(";",N,"Generate a report changes in star ownership and copy to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","ownership"),l("ctrl+;",A,"Generate a report on all definite trade activity between empires.","tradeactivity"),l("ctrl+'",P,"Generate a report on all probable combat between empires.","combatactivity"),l("ctrl+7",D,"Generate a report of observed Formal Alliance pairs.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","fa"),l("ctrl+4",O,"Your economists are keen to tell you about banking vs terraforming.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","economists");var L=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h;return Of(this,(function(d){switch(d.label){case 0:return b="generals",[4,Qd("game_event")];case 1:if(e=d.sent(),t=[],n=[],e){for(o in r={},i={},s={},NeptunesPride.universe.galaxy.players)r[a=o]=0,i[a]=0,s[a]=0;for(n.push("--- Combat history ---"),n.push(":--|:--|:--|--:|--:|--:|--:"),n.push("Tick|[[:star:]]|[[:carrier:]]|Kills|Losses|$|E"),c=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid,u=function(e){var t=Ld.game_event[e];if("combat_mk_ii"===t.payload.template){var o=t.payload.tick,a=t.payload.star.puid,u=t.payload.star.name,l=+t.payload.looter,h=0,d=0,f=0,p=0,g=t.payload.star.puid===c;t.payload.loot>0&&(i[l]+=t.payload.loot,l===c&&(h+=t.payload.loot));var m=function(){var e=0;return Object.keys(t.payload.defenders).forEach((function(n){var i=t.payload.defenders[n].ss-t.payload.defenders[n].es;r[t.payload.defenders[n].puid]+=i,e+=i})),e};g?(d+=t.payload.loot/10,p+=t.payload.star.ss-t.payload.star.es,p+=m()):(f+=t.payload.star.ss-t.payload.star.es,f+=m()),void 0!==t.payload.star.puid&&(r[+t.payload.star.puid]+=t.payload.star.ss=t.payload.star.es),s[+t.payload.star.puid]+=t.payload.loot/10;var y=Object.keys(t.payload.attackers),v={};y.forEach((function(e){var n="[[#".concat(t.payload.attackers[e].puid,"]]");void 0===v[n]&&(v[n]=0),v[n]+=t.payload.attackers[e].ss;var i=t.payload.attackers[e].ss-t.payload.attackers[e].es;r[+t.payload.attackers[e].puid]+=i,g?f+=i:t.payload.attackers[e].puid===c&&(p+=i)}));var w=Object.keys(v).map((function(e){return"".concat(e)})).join("");n.push(["[[Tick #".concat(o,"]]|[[#").concat(a,"]][[").concat(u,"]]|").concat(w,"|").concat(f,"|").concat(p,"|").concat(h,"|").concat(d)])}},l=0;l<Ld.game_event.length;++l)u(l);for(h in n.push("--- Combat history ---"),t.push("--- Combat Summary ---"),t.push(":--|--:|--:"),t.push("Empire|Losses|$|E"),r)t.push(["[[".concat(h,"]]|").concat(r[h],"|").concat(i[h],"|").concat(s[h])]);t.push("--- Combat Summary ---\n")}else console.error("Updating message cache failed"),n.push("Message cache stale!");return I("generals",Lf(Lf([],t,!0),n,!0)),[2]}}))}))};function F(){var e=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid;return rt.filter((function(t){var n;return(null===(n=ld[mf(t)])||void 0===n?void 0:n.puid)===e}))}function V(){var e,t,n=[],r=NeptunesPride.universe.galaxy.tick;n.push("Activity report up to [[Tick #".concat(r,"]]:"));var i={},s=0,o=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid,a=null,c=NeptunesPride.universe.galaxy.players;for(var u in c)i[u]=["--- [[".concat(u,"]] ---")],i[u].push(":--|---|---|---|--:|--:"),i[u].push("Time|E|I|S|Fleets|Stars");var l=(null===(e=NeptunesPride.universe.selectedSpaceObject)||void 0===e?void 0:e.puid)>=0?null===(t=NeptunesPride.universe.selectedSpaceObject)||void 0===t?void 0:t.puid:NeptunesPride.universe.player.uid,h=(new Date).getTime();Pe={};var d=F();do{var f=d.map((function(e){return Me(s,e,s?"forwards":"back")})).filter((function(e){return e&&e.tick===s}));if(console.log("Got ".concat(f.length," scans for tick #").concat(s),f),f.length>0){var p=f.filter((function(e){return e.player_uid===o})),g=p.length>0?p[0]:f[0],m=Mf(Mf({},g.players),{tick:g.tick});null===a&&(a=m);var y=function(e,t,n){if(e.total_economy>t.total_economy)return!0;if(e.total_fleets>t.total_fleets)return!0;var r=e.total_stars===t.total_stars||n;return!!(e.total_industry>t.total_industry&&r)||!!(e.total_science>t.total_science&&r)};for(var v in c)y(m[v],a[v],m.tick===a.tick)&&i[v].push("[[Tick #".concat(g.tick,"]]|").concat(m[v].total_economy,"|").concat(m[v].total_industry,"|").concat(m[v].total_science,"|").concat(m[v].total_fleets,"|").concat(m[v].total_stars));a=m}s++}while(s<=r);for(var u in i){if(3===i[u].length&&i[u].push("No activity: AFK?"),i[u].length>15){var w=i[u],b=w.slice(0,3),_=w.length,T=_-5,E=w.slice(T,_);i[u]=Lf(Lf([],b,!0),E,!0)}i[u].push("--- [[".concat(u,"]] ---")),0===c[u].conceded&&l!==u&&n.push(i[u])}var x=(new Date).getTime();n.push("Time required ".concat(x-h,"ms")),I("activity",n)}l("ctrl+w",L,"The generals report summarizes the state of your military operations. Use it to assess how you're faring against your enemies.","generals"),l("shift+;",V,"Generate a report of current player activity.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","activity"),l("x",(function(){var e=NeptunesPride.universe,t=NeptunesPride.npui;if(e.selectedStar&&-1!==e.selectedStar.puid){var n=e.selectedStar;e.player=e.galaxy.players[n.puid];for(var r=100001;e.galaxy.fleets[r];)r++;var i={l:0,lx:n.x,ly:n.y,x:n.x,y:n.y,ouid:n.uid,n:"Fake Enemy Fleet ".concat(r-1e5),o:[],puid:n.puid,st:n.st,uid:r,w:!1};n.st=0,NeptunesPride.np.onNewFleetResponse(null,i)}else if(e.selectedFleet){var s=e.selectedFleet;e.player=e.galaxy.players[s.puid],t.trigger("start_edit_waypoints",{fleet:s})}}),"Set fleet orders for an enemy fleet. These orders won't really happen but you can use them to explore attack or defense options your opponents have. First, select an enemy star, then press x to create and set orders for the fleet. Youcan then also route any other fleets that player controls.","Route Enemy");var U=function(e,t){return t<10&&(t="0".concat(t)),e<12?(0==e&&(e=12),"{0}:{1} AM".format(e,t)):"{0}:{1} PM".format(e>12?e-12:e,t)},B=0,j=function(e){void 0!==e.players[1].shape&&ue&&(ue=ue.map((function(t,n){var r=n+(Hd()?1:0);if(void 0!==e.players[r]){var i=e.players[r].color;return void 0===i||e.players[r].colorStyle?e.players[r].colorStyle||e.players[r].originalColor:ce[i]}return ue[n]}))),void 0!==e.players[1].shape&&le&&(le=le.map((function(t,n){var r=n+(Hd()?1:0);return void 0!==e.players[r]?e.players[r].shape:le[n]}))),null==ue||ue.forEach((function(e,t){var n=t+(Hd()?1:0);if(NeptunesPride.universe.galaxy.players[n]){if(g.whitePlayer&&n===NeptunesPride.universe.player.uid)return;ve(n,e)}}))},q=function(e,t){B=t.tick,j(t),Ae=-1};function $(){var e=NeptunesPride.universe.galaxy;return e.tick_rate||e.tickRate}function H(e){var t=void 0!==e?e:NeptunesPride.universe.galaxy;return t.tick_fragment||t.tickFragment}v("order:full_universe",q),void 0!==(null===(n=null===(e=null===NeptunesPride||void 0===NeptunesPride?void 0:NeptunesPride.universe)||void 0===e?void 0:e.galaxy)||void 0===n?void 0:n.tick)&&q(0,NeptunesPride.universe.galaxy);var K=function(e,t){var n=NeptunesPride.universe,r=0,i=H(),s=n.locTimeCorrection;return n.galaxy.paused||(r=(new Date).valueOf()-n.now.valueOf()),(t||n.galaxy.turn_based)&&(r=0,i=0,s=0),1e3*e*60*$()-1e3*i*60*$()-r-s},G=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],z=function(){console.log("rebuild",{showingOurOptions:T,showingOurUI:_}),T&&NeptunesPride.np.trigger("refresh_interface"),NeptunesPride.np.trigger("map_rebuild")};function W(){I("combats",kf())}function Q(){var e,t=null===(e=NeptunesPride.universe.selectedSpaceObject)||void 0===e?void 0:e.n;void 0===t?I("filteredcombats",["Select a fleet or star."]):(t="(".concat(t,")"),I("filteredcombats",kf(),ff(t)))}function X(){I("onlycombats",kf(),ff("Combat!"))}function Y(){var e,t=NeptunesPride.universe.galaxy.fleets,n=NeptunesPride.universe.galaxy.stars,r=[],i={};for(var s in Object.keys(NeptunesPride.universe.galaxy.players).forEach((function(e){return i[e]=0})),t){var o=t[s];if(o.o&&o.o.length>0){var a=o.o[0][1],c=o.etaFirst;if(!(null===(e=n[a])||void 0===e?void 0:e.n))continue;i[o.puid]+=o.st,r.push([c,"[[{0}]] [[{1}]] {2} → [[{3}]] {4}".format(o.puid,o.n,o.st,n[a].n,"[[Tick #".concat(Tf(c),"]]"))])}}r=r.sort((function(e,t){return e[0]-t[0]}));var u=[];Object.keys(NeptunesPride.universe.galaxy.players).forEach((function(e){return i[e]>0?u.push(["[[".concat(e,"]] ").concat(i[e]," ships in flight")]):0})),I("fleets",Lf(Lf([],r.map((function(e){return[e[1]]})),!0),u,!0))}l("ctrl+8",(function(){if(g.territoryOn){var e=(g.territoryBrightness-1)%4;e<0&&(e=2),g.territoryBrightness=e,z()}else ye()}),"Adjust territory display style.","- Territory Brightness"),l("ctrl+9",(function(){g.territoryOn?(g.territoryBrightness=(g.territoryBrightness+1)%4,z()):ye()}),"Adjust territory display style.","+ Territory Brightness"),l("8",(function(){var e=g.autoRulerPower-1;e<0&&(e=0),g.autoRulerPower=e,z()}),"Decrease number of distances shown by the auto ruler.","- Rulers"),l("9",(function(){g.autoRulerPower+=1,z()}),"Increase number of distances shown by the auto ruler.","+ Rulers"),l(".",(function(){wf.combatHandicap+=1,NeptunesPride.np.trigger("map_rebuild"),NeptunesPride.np.trigger("refresh_interface")}),"Change combat calculation to credit your enemies with +1 weapons. Useful if you suspect they will have achieved the next level of tech before a battle you are investigating.<p>In the lower left of the HUD, an indicator will appear reminding you of the weapons adjustment. If the indicator already shows an advantage for defenders, this hotkey will reduce that advantage first before crediting weapons to your opponent.","+ Handicap"),l(",",(function(){wf.combatHandicap-=1,NeptunesPride.np.trigger("map_rebuild"),NeptunesPride.np.trigger("refresh_interface")}),"Change combat calculation to credit yourself with +1 weapons. Useful when you will have achieved the next level of tech before a battle you are investigating.<p>In the lower left of the HUD, an indicator will appear reminding you of the weapons adjustment. When indicator already shows an advantage for attackers, this hotkey will reduce that advantage first before crediting weapons to you.","- Handicap"),l("&",W,"Generate a detailed fleet report on all carriers in your scanning range, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","combats"),l("D",Q,"Generate a detailed report on fleet movements involving the selected fleet or star, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","filteredcombats"),l("d",X,"Generate a detailed combat report on all visible combats, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","onlycombats"),l("^",Y,"Generate a summary fleet report on all carriers in your scanning range, and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown.","fleets");var J=function(e,t,n){var r=g.getProperties().filter(t),i=r.length,s=Crux.Widget("rel").size(480,50*i).roost(e);r.forEach((function(t,r){return Rf(c,void 0,void 0,(function(){var i,o,a,c,u,l,h,d;return Of(this,(function(f){return i="npa_".concat(t.name),Crux.templates[i]=t.displayName,o=(null==n?void 0:n.missingKey)===t.name?"txt_warn_bad":"",Crux.Text(i,"pad12 ".concat(o)).grid(0,3*r,20,3).roost(s),c=(a=g)[t.name],t.allowableValues?(u={},l="0",t.allowableValues.forEach((function(e,t){u[t]=e,e===c&&(l="".concat(t))})),h="setting_change_".concat(t.name),Crux.DropDown(l,u,h).grid(15,3*r,15,3).roost(s),e.on(h,(function(e,n){a[t.name]=u[n],z()}))):((d=Crux.TextInput("single").grid(15,3*r,15,3).roost(s)).setValue(c),d.eventKind="text_entry",e.on(d.eventKind,(function(e,n){d.getValue()!==a[t.name]&&("number"===t.type?a[t.name]=+d.getValue()||a[t.name]:"boolean"===t.type?a[t.name]="true"===d.getValue():a[t.name]=d.getValue(),z())}))),[2]}))}))}))},Z=function(){var e=NeptunesPride.universe.player;o("[[colorscheme:".concat(e.alias," Tick #").concat(B,":").concat(ue.join(" "),":").concat(le.join(" "),"]]")),console.log("clip: ",a())},ee=0,te=0;v("set_colorscheme_api",(function(e,t){var n=null==t?void 0:t.split(":");if(n){var r=n[0],i=n[1];xe.set("colorMap",r),xe.set("shapeMap",i),_e()}}));var ne=function(){var e=NeptunesPride.npui.map,t=g.ibbApiKey;if(t){var n=e.canvas[0].toDataURL("image/webp",.45),r=n.indexOf(",")+1,i={expiration:2592e3,key:t,image:n.substring(r)};return fetch("https://api.imgbb.com/1/upload",{method:"POST",redirect:"follow",body:new URLSearchParams(i)}).then((function(e){return e.json().then((function(e){var t;if(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.url)o("[[".concat(e.data.url,"]]"));else{var n="Error: ".concat(JSON.stringify(e));Id(n),o(n)}}))}))}k({missingKey:"ibbApiKey"})};l("#",ne,"Create a data: URL of the current map. Paste it into a browser window to view. This is likely to be removed.","Screenshot");var re=function(){var e=NeptunesPride.universe.galaxy.players,t=[];for(var n in e){var r=e[n].home;r?t.push("Player #{0} is [[{0}]] home {2} [[{1}]]".format(n,r.n,n==r.puid?"is":"was")):t.push("Player #{0} is [[{0}]] home unknown".format(n))}I("planets",t.map((function(e){return[e]})))};l("!",re,"Generate a player summary report and copy it to the clipboard.<p>This same report can also be viewed via the menu; enter the agent and choose it from the dropdown. It is most useful for discovering player numbers so that you can write [[#]] to reference a player in mail.","planets"),l("$",(function(){var e=NeptunesPride.universe.galaxy.players,t=[],n=["alias","total_stars","shipsPerTick","total_strength","total_economy","total_fleets","total_industry","total_science"];t.push(n.join(","));var r=function(r){var i=n.map((function(t){return e[r][t]}));t.push(i.join(","))};for(var i in e)r(i);o(t.join("\n"))}),"Generate a player summary mean to be made into a spreadsheet.<p>The clipboard should be pasted into a CSV and then imported.","Summary CSV");var ie=function(e,t,n,r){var i=Crux.format(e,{linkTimes:!1}),s=NeptunesPride.npui.map.context;s.fillStyle=r||"#00ff00",s.fillText(i,t,n)},se=function(e,t,n,r,i){var s=Crux.format(t,{linkTimes:!1});e.fillStyle="#000000";for(var o=1;o<4;++o)e.fillText(s,n+o,r+o),e.fillText(s,n-o,r+o),e.fillText(s,n-o,r-o),e.fillText(s,n+o,r-o);e.fillStyle=i||"#00ff00",e.fillText(s,n,r)},oe=function(e,t){var n=NeptunesPride.universe.galaxy.stars,r=NeptunesPride.universe,i=cf(r.galaxy.players[e]);for(var s in n){var o=n[s];if(o.puid==e&&r.distance(o.x,o.y,t.x,t.y)<=i)return!0}return!1},ae=!1,ce=["#0000ff","#009fdf","#40c000","#ffc000","#df5f00","#c00000","#c000c0","#6000c0"],ue=ce.flatMap((function(e){return ce})),le=ue.map((function(e,t){return Math.floor(t/8)}));function he(e){return ue[e.uid-(Hd()?1:0)]}function de(e){return le[e.uid-(Hd()?1:0)]}var fe=function(){for(var e={},t=0;t<document.styleSheets.length;++t)try{for(var n=document.styleSheets[t].cssRules,r=0;r<n.length;++r)if(n[r].type===CSSRule.STYLE_RULE){var i=n[r];e[i.selectorText]=i}}catch(e){console.log(e)}return e}(),pe=void 0;function ge(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,b,_,E;return Of(this,(function(x){switch(x.label){case 0:for(l in e=NeptunesPride.npui.map,void 0===pe&&((pe=new Image).src=e.starSrc.src),(t=document.createElement("canvas")).width=1024,t.height=576,(n=t.getContext("2d")).drawImage(pe,0,0),r=NeptunesPride.universe.galaxy.players){if(b=r[l],s=he(b),parseInt(l)<8)try{fe[".bgpc_".concat(b.uid)].style.backgroundColor=s}catch(e){console.error("Underbar style not found")}(o=document.createElement("canvas")).width=o.height=576,a=o.getContext("2d"),d=void 0!==b.shapeIndex?b.shapeIndex:b.shape,i=64*(d-de(b)),a.drawImage(pe,i,0),a.globalCompositeOperation="source-in",a.fillStyle=s,h=b.uid,f=d,p=Math.floor(h%8)+1,void 0!==b.shape&&(f=b.shape,p=b.color+1),g=64*f,m=64*p,a.fillRect(g,m,64,64),n.clearRect(g,m,64,64),n.drawImage(o,0,0)}for(l in r)b=r[l],s=he(b),(o=document.createElement("canvas")).width=o.height=576,(a=o.getContext("2d")).drawImage(e.starSrc,0,0),a.globalCompositeOperation="source-in",a.fillStyle=s,h=b.uid,d=void 0!==b.shapeIndex?b.shapeIndex:b.shape,c=d,f=8,p=Math.floor(h%8)+1,void 0!==b.shape&&(c=b.shape,p=b.color+1),g=64*f,m=64*p,a.fillRect(g,m,64,64),n.clearRect(g+64*c,m,64,64),n.drawImage(o,64*c,0);return u=NeptunesPride.npui.map.createSpritesStars,NeptunesPride.npui.map.createSpritesStars=function(){u(),NeptunesPride.npui.map.sortedStarSprites.forEach((function(e){if(e.gate&&e.puid>=0){var t=NeptunesPride.universe.galaxy.players[e.puid].shape,n=void 0!==t?t:Math.floor(e.puid/8);e.gate.spriteX=512+64*n}}))},e.starSrc.src=t.toDataURL(),[4,e.starSrc.decode()];case 1:for(l in x.sent(),r)b=r[l],h=b.uid,d=void 0!==b.shapeIndex?b.shapeIndex:b.shape,f=d,p=Math.floor(h%8)+1,void 0!==b.shape&&(f=b.shape,p=b.color+1),g=64*f,m=64*p,Hd()||(fe[".pci_48_".concat(b.uid)].style.background='url("'.concat(e.starSrc.src,'") -').concat(g+8,"px -").concat(m+8,"px"));for(v in(y=NeptunesPride.universe).galaxy.players)b=y.galaxy.players[v],_="style='color: ".concat(he(b),";'"),E=de(b),b.colourBox="<span class='playericon_font pc_".concat(b.colorIndex,"' ").concat(_,">").concat(E,"</span>"),b.hyperlinkedBox="<a onClick=\"Crux.crux.trigger('show_player_uid', '".concat(b.uid,"' )\">").concat(b.colourBox,"</a>");return w(),console.log("Recreating star and fleet sprites"),T||NeptunesPride.np.trigger("refresh_interface"),z(),window.setTimeout((function(){return NeptunesPride.np.trigger("map_rebuild")}),500),[2]}}))}))}var me=function(){var e=NeptunesPride.npui.map;function t(e,t,n,r,i){e.save(),e.translate(t,n),e.scale(r,r),e.moveTo(0,0),e.arc(0,0,i,0,2*Math.PI),e.restore()}function n(){var e=NeptunesPride.universe.player;return cf(e)/(af(e,"scanning").level+2)}function r(e){var t=wf.combatHandicap;return cf(e)+t*n()}function i(e){var t=wf.combatHandicap,r=function(e){return Hd()?NeptunesPride.universe.calcRangeValue(e):e.tech.propulsion.value}(e)+t*n();return r}function s(t){return e.worldToScreenX(Math.abs(t))-e.worldToScreenX(0)}function o(n,o,a){var c=e.worldToScreenX(o.x),u=e.worldToScreenY(o.y),l=r(o.player),h=i(o.player),d=Math.max(l,h),f=!1;return a?h===d&&(f=!0):l===d&&(f=!0),f?(o.x<e.worldViewport.left-h||o.x>e.worldViewport.right+h||o.y<e.worldViewport.top-h||o.y>e.worldViewport.bottom+h||t(n,c,u,1,s(.98*h)),!1):(o.x<e.worldViewport.left-l||o.x>e.worldViewport.right+l||o.y<e.worldViewport.top-l||o.y>e.worldViewport.bottom+l||t(n,c,u,1,s(.98*l)),!0)}function c(n,r){var i;t(n,e.worldToScreenX(r.x),e.worldToScreenY(r.y),((i=e.scale/400)<.35&&(i=.35),i>1&&(i=1),i*e.pixelRatio),24)}var h=function(e,t){var n=e.x-t.x,r=e.y-t.y,i=(null==e?void 0:e.ga)*(null==t?void 0:t.ga)*9||1;if(("proteus"===NeptunesPride.gameVersion||Hd())&&i>1){var s=n*n+r*r,o=12*NeptunesPride.universe.galaxy.fleet_speed,a=o*o;return Math.min(s,a)}return(n*n+r*r)/i},m=e.drawStars,w=document.createElement("canvas");e.drawStars=function(){var t,n=NeptunesPride.universe;if((null===(t=n.selectedStar)||void 0===t?void 0:t.player)&&g.territoryOn){var s=e.context,a=n.selectedStar.player.uid,u=!1,l=function(){u=!u,w.width=s.canvas.width,w.height=s.canvas.height;var t=g.territoryBrightness,l=3===t?s:w.getContext("2d");if(null==l)return console.error("Failed to create canvas context for territory"),"break";t%=3;var h=function(){var s;l.beginPath();var h=!1,d=r(n.selectedStar.player),f=i(n.selectedStar.player);for(var p in n.galaxy.stars){var g=n.galaxy.stars[p];if((null===(s=g.player)||void 0===s?void 0:s.uid)==a)h=o(l,g,u);else{var m=u?Math.max(d,f):Math.min(d,f),y=NeptunesPride.universe.galaxy;of(a,m,g,y)&&c(l,g)}}var v=he(n.galaxy.players[a]),w=parseInt(v.substring(1,3).toUpperCase(),16)/255,b=parseInt(v.substring(3,5).toUpperCase(),16)/255,_=parseInt(v.substring(5,7).toUpperCase(),16)/255,T=.299*w+.587*b+.114*_,E=Math.max((1-T)/4,.1)*t,x=function(e){return Math.floor(255*e)},S="rgba(".concat(x(w),", ").concat(x(b),", ").concat(x(_),", ").concat(E,")");l.fillStyle=S,l.strokeStyle="".concat(v,"aa"),l.lineWidth=2*e.pixelRatio,0===t?"destination-out"===l.globalCompositeOperation?(l.fillStyle="#fff",l.fill()):(h&&(l.setLineDash([4*e.pixelRatio,6*e.pixelRatio]),l.strokeStyle="".concat(v,"ff")),l.stroke(),l.setLineDash([])):"source-over"===l.globalCompositeOperation&&l.fill(),l.closePath()};l.globalCompositeOperation="source-over",h(),l.globalCompositeOperation="destination-out",h(),l.globalCompositeOperation="source-over",s!==l&&s.drawImage(l.canvas,0,0)};do{if("break"===l())break}while(u)}m()};var S=NeptunesPride.npui.map.drawText;NeptunesPride.npui.map.drawText=function(){var e,t,n=NeptunesPride.universe,r=NeptunesPride.npui.map,s=Object.keys(n.galaxy.players).map((function(e){return n.galaxy.players[e].huid}));NeptunesPride.npui.map.sortedStarSprites.forEach((function(e){-1!==s.indexOf(e.uid)&&-1===e.playerAlias.indexOf("Homeworld")&&(e.playerAlias+=" (Homeworld)")})),S(),r.context.font="".concat(14*r.pixelRatio,"px OpenSansRegular, sans-serif"),r.context.fillStyle="#FF0000",r.context.textAlign="right",r.context.textBaseline="middle";var o=p;0!==wf.combatHandicap&&(o="".concat(bf()," ").concat(o)),se(r.context,o,r.viewportWidth-10,r.viewportHeight-16*r.pixelRatio),void 0===NeptunesPride.originalPlayer&&(NeptunesPride.originalPlayer=null===(e=n.player)||void 0===e?void 0:e.uid);var a="";if(NeptunesPride.originalPlayer!==n.galaxy.player_uid&&void 0!==n.galaxy.player_uid&&(a=n.galaxy.players[n.galaxy.player_uid].alias),n.galaxy.player_uid!=n.player.uid){var c=n.player.alias;a+=" controlling ".concat(c)}if(Ae>-1){var u=NeptunesPride.universe.galaxy.tick;if(Ae===u){var l=NeptunesPride.universe.galaxy.futureTime?"Future Time @ ":"Time Machine @ ";a="".concat(l," [[Tick #").concat(Ae,"#]] ").concat(a)}else a="Time machine @ [[Tick #".concat(u,"#]] MISSING DATA for [[Tick #").concat(Ae,"#]] ").concat(a)}else a="".concat(a," [[Tick #").concat(B,"#a]]");if(n.batchedRequests.length>0&&(a="".concat(n.batchedRequests.length," orders pending (").concat(n.batchedRequestTimeout,"s) ").concat(a)),a&&(r.context.textAlign="right",se(r.context,a,r.viewportWidth-10,r.viewportHeight-32*r.pixelRatio)),n.selectedFleet&&n.selectedFleet.path.length>0){r.context.font="".concat(14*r.pixelRatio,"px OpenSansRegular, sans-serif"),r.context.fillStyle="#FF0000",r.context.textAlign="left",r.context.textBaseline="middle";var d=n.selectedFleet.y-n.selectedFleet.ly,f=n.selectedFleet.x-n.selectedFleet.lx;d=n.selectedFleet.path[0].y-n.selectedFleet.y,f=n.selectedFleet.path[0].x-n.selectedFleet.x;var m=16*r.pixelRatio,y=.056*r.scale*r.pixelRatio,v=Math.atan(d/f);if((A=y*Math.cos(v))>0&&f>0&&(A*=-1),(P=y*Math.sin(v))>0&&d>0&&(P*=-1),A<0&&f<0&&(A*=-1),P<0&&d<0&&(P*=-1),kf(),null===(t=Sf[n.selectedFleet.uid])||void 0===t?void 0:t.eta){var w=Sf[n.selectedFleet.uid].eta,b=Sf[n.selectedFleet.uid].outcome.split("\n"),_=r.worldToScreenX(n.selectedFleet.x)+A,T=r.worldToScreenY(n.selectedFleet.y)+P;A<0&&(r.context.textAlign="right"),se(r.context,w,_,T);for(var E=0;E<b.length;++E)se(r.context,b[E],_,T+(E+1)*m)}}if(!NeptunesPride.gameConfig.turnBased&&n.timeToTick(1).length<3&&(m=16*r.pixelRatio,r.context.font="".concat(14*r.pixelRatio,"px OpenSansRegular, sans-serif"),r.context.fillStyle="#FF0000",r.context.textAlign="left",r.context.textBaseline="middle",w="Tick < 10s away!","0s"===n.timeToTick(1)&&(w="Tick passed. Click production countdown to refresh."),se(r.context,w,1e3,m)),n.selectedStar&&n.selectedStar.puid!=n.player.uid&&-1!==n.selectedStar.puid){r.context.textAlign="left",r.context.textBaseline="middle";var x=26*r.pixelRatio,k=NeptunesPride.universe.galaxy.fleets;for(var I in k){var C=k[I];if(xf(NeptunesPride.universe.galaxy.players,C.puid,n.player.uid,0)){f=n.selectedStar.x-C.x,d=n.selectedStar.y-C.y;var N=Math.sqrt(f*f+d*d),A=x,P=0;if(_=r.worldToScreenX(C.x)+A,T=r.worldToScreenY(C.y)+P,N>cf(n.galaxy.players[n.selectedStar.puid])&&C.path&&C.path.length>0&&(f=C.path[0].x-n.selectedStar.x,d=C.path[0].y-n.selectedStar.y,(N=Math.sqrt(f*f+d*d))<cf(n.galaxy.players[n.selectedStar.puid]))){var D=NeptunesPride.universe.galaxy.fleet_speed;C.warpSpeed&&(D*=3),f=C.x-C.path[0].x,d=C.y-C.path[0].y,v=Math.atan(d/f);var M=D*Math.cos(v),R=D*Math.sin(v);M>0&&f>0&&(M*=-1),R>0&&d>0&&(R*=-1),M<0&&f<0&&(M*=-1),R<0&&d<0&&(R*=-1);var O=0;do{var L=O*M+Number(C.x),F=O*R+Number(C.y);f=L-n.selectedStar.x,d=F-n.selectedStar.y,N=Math.sqrt(f*f+d*d),O+=1}while(N>cf(n.galaxy.players[n.selectedStar.puid])&&O<=C.etaFirst+1);O-=1;var V="#00ff00";oe(n.selectedStar.puid,C)&&(V="#888888"),se(r.context,"Scan [[Tick #".concat(Tf(O),"]]"),_,T,V)}}}}2==n.ruler.stars.length&&(n.ruler.stars[0].puid,n.ruler.stars[1].puid),function(){var e,t,n=NeptunesPride.universe,r=NeptunesPride.npui.map;if((null===(e=n.selectedStar)||void 0===e?void 0:e.alliedDefenders)&&g.autoRulerPower>0&&r.scale>=200){var s=NeptunesPride.gameConfig.turnBased?NeptunesPride.gameConfig.turnJumpTicks:1,o=NeptunesPride.universe.galaxy.fleet_speed,a=o*o,c=n.selectedStar,u=Math.ceil(g.autoRulerPower/2),l=g.autoRulerPower%2==0,d=function(e,t){var n=NeptunesPride.npui.map,r=NeptunesPride.universe.galaxy.stars,i=e,s=e,o=n.sortedStarSprites.map((function(e){return r[e.uid]}));o.sort((function(t,n){return h(e,n)-h(e,t)}));var a=o.length;do{var c=o[a-=1],u=xf(NeptunesPride.universe.galaxy.players,c.puid,e.puid,0);!u&&(i===e||t>0)?(i=c,t--):u&&s===e&&(s=c)}while((i===e||s===e||t>0)&&a>0);for(var l=h(e,i),d=[],f=0;f<o.length;++f)c=r[o[f].uid],h(e,c)<=l&&c!==i&&c!==s&&c!==e&&d.push(c);return[i,s,d]}(c,u),f=d[0],p=d[1],m=d[2],y="#f3172d",v="#888888",w="#00ff00",b=function(e,t,a){var c=Math.sqrt(h(e,t)),u=Math.ceil(c/o),l=r.worldToScreenX((e.x+t.x)/2),d=r.worldToScreenY((e.y+t.y)/2),f=0;-1!==t.puid&&(f=function(r){for(var s=wf.combatHandicap,o=NeptunesPride.universe.galaxy.players[t.puid],a=i(o),c=n.distance(e.x,e.y,t.x,t.y);c>a&&wf.combatHandicap-s<5;)wf.combatHandicap++,a=i(o);var u=wf.combatHandicap-s;return wf.combatHandicap=s,u}(t.puid))>0&&(a=v),r.context.save(),r.context.globalAlpha=1,r.context.strokeStyle=a,r.context.shadowColor="black",r.context.shadowOffsetX=2,r.context.shadowOffsetY=2,r.context.shadowBlur=2,r.context.fillStyle=a,r.context.lineWidth=2*r.pixelRatio,r.context.lineCap="round",r.context.translate(l,d);var p=function(e,t){var n=e.x-t.x,r=e.y-t.y,i=n<0,s=Math.PI*(i?1:0);return{angle:Math.atan2(r,n)+s,flipped:i}}(e,t),g=p.angle,m=p.flipped;r.context.rotate(g);var y=r.worldToScreenX(s*o)-r.worldToScreenX(0),b=(r.worldToScreenX(c)-r.worldToScreenX(0))/2,_=r.worldToScreenX(c-2*o)-r.worldToScreenX(0),T=r.worldToScreenX(c)-r.worldToScreenX(0),E=r.worldToScreenX(c-2*o)-r.worldToScreenX(0);if(_>0&&E>0){r.context.beginPath(),r.context.moveTo(-_/2,0),r.context.lineTo(E/2,0),r.context.stroke(),r.context.beginPath();var x=m?-1:1;if(r.context.moveTo(x*E/2,0),r.context.lineTo(x*E/2-5*x*r.pixelRatio,5*r.pixelRatio),r.context.lineTo(x*E/2-5*x*r.pixelRatio,-5*r.pixelRatio),r.context.closePath(),r.context.fill(),y-b-E/2+1<=1){r.context.beginPath();var S=8*Math.PI/y,k=m?Math.PI:0,I=m?b:-b;r.context.arc(I,0,y,k-S,k+S),r.context.stroke()}}r.context.textAlign="center",r.context.translate(0,-8*r.pixelRatio);var C=a===v?v:w;return ie("[[Tick #".concat(Tf(u),"]]"),0,0,C),y-T+1>1?(r.context.translate(0,18*r.pixelRatio),ie("invisible",0,0,C)):-1!==t.puid&&(f>0?(r.context.translate(0,18*r.pixelRatio),ie("range +".concat(f),0,0,C)):(r.context.translate(0,18*r.pixelRatio),ie("".concat(uf(t)?t.totalDefenses:"?"," ship").concat(1!==t.totalDefenses?"s":""),0,0,C))),r.context.setLineDash([]),r.context.restore(),u},_=b(c,f,y),T=Math.ceil(Math.sqrt(h(c,p)/a)),E=0,x=1,S=c.totalDefenses,k=NeptunesPride.universe.galaxy.players,I=Math.max.apply(Math,Lf([1,(null===(t=k[c.puid])||void 0===t?void 0:t.tech)?If(k[c.puid]):0],null==c?void 0:c.alliedDefenders.map((function(e){return If(k[e])})),!1)),C=!0;-1!==f.puid&&(C=C&&uf(f),E+=f.totalDefenses,x=Math.max(x,If(k[f.puid]))),_-s>=T?(b(c,p,w),-1!==p.puid&&(C=C&&uf(p),S+=p.totalDefenses,I=Math.max(I,If(k[p.puid])))):b(c,p,v);for(var N=0;l&&N<m.length;++N){var A=m[N];if(xf(NeptunesPride.universe.galaxy.players,A.puid,c.puid,0)){var P=Math.ceil(Math.sqrt(h(c,A)/a));_-s>=P?(b(c,A,w),-1!==A.puid&&(C=C&&uf(A),S+=A.totalDefenses,I=Math.max(I,If(k[A.puid])))):b(c,A,v)}else b(c,A,y),-1!==A.puid&&(C=C&&uf(A),E+=A.totalDefenses,x=Math.max(x,If(k[A.puid])))}for("proteus"!==NeptunesPride.gameVersion&&(I+=1);S>0&&E>0&&!((E-=I)<=0);)S-=x;var D=E<=0?"".concat(S," live"):"".concat(E," land");C||(D+="?");var M=r.worldToScreenX(c.x+.125),R=r.worldToScreenY(c.y)-9*r.pixelRatio;r.context.textAlign="left",ie(D,M,R,"#00ff00");var O=!0;for(E<=0&&(S-=x,O=!1);S>0||E>0;)E-=I,S-=x;var L=18*r.pixelRatio;O?(S=Math.min(-1,S),ie("".concat(-S," needed"),M,R+L,"#00ff00")):(E=Math.min(-1,E),ie("".concat(-E," needed"),M,R+L,"#00ff00"))}}()};var k=-1,I=!1;function M(e){return e.replaceAll(/[^\w\d]/g,"_").toLowerCase()}NeptunesPride.npui.status.on("one_second_tick",(function(){if(-1===k){var e=K(1),t=ye(e,!0,!0,!0).split(" ");k=parseInt(t[t.length-1].replaceAll("s",""))+1}29==(k-=1)&&"relative"===g.relativeTimes&&_?(NeptunesPride.np.trigger("map_rebuild"),NeptunesPride.np.trigger("refresh_interface")):(NeptunesPride.universe.batchedRequests.length>0||I)&&(I=NeptunesPride.universe.batchedRequests.length>0,NeptunesPride.np.trigger("map_rebuild"))})),v("sort_table",(function(e,t){var n=t.split(","),r=n[0],i=parseInt(n[1]),s=document.getElementById("".concat(r,":").concat(i));if(s){var o,a=s.innerHTML.replaceAll(/[↑↓]/g,""),c="↓";o=-1!==s.innerHTML.indexOf("↑")?c:-1!==s.innerHTML.indexOf(c)?"":"↑";for(var u=0;;u++){var l=document.getElementById("".concat(r,":").concat(u));if(!l)break;l.innerHTML=l.innerHTML.replaceAll(/[↑↓]/g,"")}s.innerHTML="".concat(a).concat(o);for(var h=[],d=0;;++d){var f="".concat(r,":row#").concat(d),p=document.getElementById(f);if(!p)break;h.push(p)}var g=h.map((function(e){var t=e.getElementsByTagName("TD")[i],n=parseInt(e.id.split("#")[1]),r=t.innerText;return[r,""!==o?+r:n,e.id,e]}));if(g.length>1){var m=g[0][3],y=function(e){return/^[0-9-]/.test(e)?e.match?+e.match(/^([0-9-]*(\.[0-9]+)?)/)[0]:+e:e},v=0===g.filter((function(e){return isNaN(y(e[1]))})).length;v?o===c?g.sort((function(e,t){return y(t[1])-y(e[1])})):g.sort((function(e,t){return y(e[1])-y(t[1])})):(g.sort(),o===c&&g.reverse());var w=g[g.length-1][3],b=g[0][3].parentNode;b.insertBefore(w,m),g.reduce((function(e,t){return b.insertBefore(t[3],e[3]),e}),g[g.length-1])}}}));var R=["ctrl+a","ctrl+`"];Crux.format=function(e,t){var n,r,i,s,o,a=Crux.formatTime;if(!1===(null==t?void 0:t.linkTimes)&&(a=we,t.linkTimes=void 0),!e)return"error";n=0,r=0,i=0,s="",o="";for(var c=function(){if(n+=1,r=e.indexOf("[["),i=e.indexOf("]]"),-1===r)return"break";if(s=e.slice(r+2,i),o="[[".concat(s,"]]"),s=s.replaceAll("&#x3A;",":"),void 0!==t[s])e=e.replace(o,t[s]);else if(/^upgrade:[eisg](:[0-9]+)+$/.test(s)){var c=(k=s.split(":"))[1],u=NeptunesPride.universe.galaxy.stars,l=NeptunesPride.universe.player.uid,h=k.slice(2).map((function(e){return u[+e]})).filter((function(e){return e&&e.puid===l})),f=h.map((function(e){return"Crux.crux.trigger('star_dir_upgrade_".concat(c,"', '").concat(e.uid,"')")})).join(";"),p='<span class="button button_up pad8" style="display: inline-block; margin: 3px 0;" onClick="event.preventDefault();'.concat(f,'"  >Buy ').concat(h.length," ").concat({e:"economy",i:"industry",s:"science",g:"warp gates"}[c],"</span>");e=e.replace(o,p)}else if(/^colorscheme(:[^:]+){3}$/.test(s)){var m=(k=s.split(":"))[1],y=k[2],v=k[3];p='<span class="button button_up pad8" style="display: inline-block; margin: 3px 0;" onClick=\'event.preventDefault();Crux.crux.trigger("set_colorscheme_api", "'.concat(y,":").concat(v,'")\'"  >Import Color Scheme ').concat(m,"</span>"),e=e.replace(o,p)}else if(/^cash:[0-9]+:[0-9]+$/.test(s)){var w=+(k=s.split(":"))[1],b=+k[2],_=void 0!==(null==(G=NeptunesPride.universe.galaxy.players[w])?void 0:G.cash)?G.cash:b;p="".concat(_),e=e.replace(o,p)}else if(/^transfer(:[0-9]+){5}$/.test(s)){w=+(k=s.split(":"))[1],b=+k[2];var T=+k[3],E=+k[4]===NeptunesPride.universe.player.uid?+k[5]:0,x=(_=void 0!==(null==(G=NeptunesPride.universe.galaxy.players[w])?void 0:G.cash)?G.cash:b,Math.max(0,NeptunesPride.universe.player.cash-E)),S=Math.min(x,Math.max(0,T-_));p=w===NeptunesPride.universe.player.uid?T-_:Crux.format("[[sendcash:".concat(w,":").concat(S,":").concat(S,"]]"),t),e=e.replace(o,p)}else if(/^Tick #\d\d*(#a?)?$/.test(s)){var k=s.split("#"),I=parseInt(k[1]),C=I-NeptunesPride.universe.galaxy.tick;if("a"===k[2])e=e.replace(o,"Tick #".concat(I));else{3===k.length&&-1!==g.relativeTimes.indexOf("rel")&&(C+=NeptunesPride.universe.galaxy.tick-B);var N=K(C,!1);e=e.replace(o,a(N,!0))}}else if(/^https:&#x2F;&#x2F;(i\.ibb\.co|i\.imgur\.com)&#x2F;[-#;\.\w&]{3,200}$/.test(s))e=e.replace(o,'<img  width="100%" src=\''.concat(s,"' />"));else if(/^https:&#x2F;&#x2F;www\.youtube\.com&#x2F;watch\?v=[-\w]{6,50}$/.test(s)){var A=s.replace("watch?v=","embed/");console.log({embedURL:A}),e=e.replace(o,'<p align="center"><iframe width="280" height="158" src="'.concat(A,'" title="YouTube video player" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; web-share" allowfullscreen></iframe><br/><a href=').concat(s,' target="_blank">Open Youtube in a new tab</a></p>'))}else if(/^api:\w{6}$/.test(s)||/^api(:|&#x3A;)\w{12}$/.test(s)){var P='<a onClick=\'Crux.crux.trigger("switch_user_api", "'.concat(s,"\")'> View as ").concat(s,"</a>");P+=' or <a onClick=\'Crux.crux.trigger("merge_user_api", "'.concat(s,"\")'> Merge ").concat(s,"</a>"),e=e.replace(o,P)}else if(/^apiv:\w{6}$/.test(s)||/^apiv:\w{12}$/.test(s))P='<a onClick=\'Crux.crux.trigger("switch_user_api", "'.concat(s,"\")'>").concat(s,"</a>"),e=e.replace(o,P);else if(/^apim:\w{6}$/.test(s)||/^apim:\w{12}$/.test(s))P='<a onClick=\'Crux.crux.trigger("merge_user_api", "'.concat(s,"\")'>").concat(s,"</a>"),e=e.replace(o,P);else if(/^viewgame:[0-9]+:.+$/.test(s)){var D=s.split(":"),M='<a onClick=\'Crux.crux.trigger("view_game", "'.concat(s,"\")'>").concat(D[1]," ").concat(D[2],"</a>");e=e.replace(o,M)}else if(/^hotkey:[^:]+$/.test(s)||/^goto:[^:]/.test(s)){var O=(D=s.split(":"))[1],L=d(O),F=(null==L?void 0:L.button)||"Trigger ".concat(s);H[F]&&(F=H[F]);var V="goto"!==D[0]||R.includes(O)?"":';Mousetrap.trigger("`")',U='<span class="button button_up pad8" onClick=\'{Mousetrap.trigger("'.concat(O,'")').concat(V,"}'>").concat(F,"</span>");e=e.replace(o,U)}else if(/^mail:([0-9]+:?)+$/.test(s)){D=s.split(":");var j="NeptunesPride.inbox.clearDraft();".concat(D.slice(1).map((function(e){return"NeptunesPride.inbox.draft.to.push(".concat(e,")")})).join(";")),q='<span class="button button_up icon-button pad8" onClick=\''.concat(j,';Crux.crux.trigger("show_screen", "compose")\'><span class="icon-mail"/></span>');e=e.replace(o,q)}else if(/^footer:-?[\w- \.][\w- \.]*$/.test(s)){var $=(D=s.split(":"))[1];e=e.replace(o,"<b>".concat($,"</b>"))}else if(/^sub:-?[\w-\.,()][\w-\.,()]*$/.test(s))$=(D=s.split(":"))[1],e=e.replace(o,'<sub style="font-size: 50%">'.concat($,"</sub>"));else if(/^good:-?[\w-\.][\w-\.]*$/.test(s))$=(D=s.split(":"))[1],e=e.replace(o,'<span class="txt_warn_good">'.concat($,"</span>"));else if(/^bad:[\w-\.][\w-\.]*$/.test(s))$=(D=s.split(":"))[1],e=e.replace(o,'<span class="txt_warn_bad">'.concat($,"</span>"));else if(/^sendtech:\d\d*:\w\w*:-?[\w-\.][\w-\.]*$/.test(s)){D=s.split(":");var G=parseInt(D[1]),z=D[2],W=(F=D[3],'<span class="txt_warn_good" onClick=\'{NeptunesPride.sendTech('.concat(G,', "').concat(z,"\")}'>").concat(F,"</span>"));e=e.replace(o,W)}else if(/^sendalltech:\d\d*:-?[\w-\.][\w-\.]*$/.test(s))D=s.split(":"),G=parseInt(D[1]),F=D[2],W='<span class="txt_warn_good" onClick=\'{NeptunesPride.sendAllTech('.concat(G,")}'>").concat(F,"</span>"),e=e.replace(o,W);else if(/^sendcash:\d\d*:\d\d*:-?[\w-\.][\w-\.]*$/.test(s)){D=s.split(":"),G=parseInt(D[1]);var Q=parseInt(D[2]);F=D[3],W='<span class="txt_warn_bad" onClick=\'{NeptunesPride.sendCash('.concat(G,', "').concat(Q,"\")}'>").concat(F,"</span>"),e=e.replace(o,W)}else e=s.startsWith("data:")?e.replace(o,'<div width="100%" class="screenshot"><img class="screenshot" src="'.concat(s,'"/></div>')):e.replace(o,"(".concat(s,")"))};r>=0&&n<1e4&&"break"!==c(););for(var u=e.split(/<br ?\/?>/),l=[],h="",f="",p=!1,m=!1,y=!1,v=0,w=[],b=0;b<u.length;++b){var _=u[b];if(0===_.indexOf("---")&&-1!==_.indexOf("---",3))m=p=!p,h=_.substring(4,_.length-4),f=M(h),p?(l.push('<table id="'.concat(f,'" class="combat_result">')),l.push('<tr><th style="padding: 12px" colspan="10">'.concat(h,"</th></tr>"))):l.push("</table>");else if(p&&m&&(_.startsWith("--")||_.startsWith(":-"))){var T=_.split("|");w=T.map((function(e){return e.startsWith(":")?"left":-1!==e.indexOf(":")?"right":"center"})),m=!1,y=!0}else if(p){(m||y)&&(m=!1,y=!0,v=b+1);var E=b-v,x=E>=0?"id='".concat(f,":row#").concat(E,"'"):"";(T=_.split("|")).length&&-1!==T[0].indexOf("<b>")&&(x=""),l.push("<tr ".concat(x,' class="combat_result_teams_heading">')),T.forEach((function(e,t){var n="",r="";y&&(n='onclick=\'Crux.crux.trigger("sort_table", "'.concat(f,",").concat(t,"\")'"),r="id='".concat(f,":").concat(t,"'")),l.push("<td ".concat(n," ").concat(r,' style="text-align: ').concat(w[t],'" class="equal_cols">').concat(e,"</td>"))})),l.push("</tr>"),y=!1}else l.push(_),b<u.length-1&&l.push("<br>")}return l.join("\n")};var F=NeptunesPride.npui;Crux.templates.n_p_a="NP Agent",Crux.templates.npa_report_type="Filter:",Crux.templates.npa_paste="Intel",Crux.templates.npa_screenshot="Screenshot";var j=F.NewMessageCommentBox,q={empires:"icon-users",signatures:"icon-users",accounting:"icon-dollar",trading:"icon-right-open",research:"icon-beaker",ownership:"icon-star-1",tradeactivity:"icon-chart-line",combatactivity:"icon-chart-line",activity:"icon-chart-line",planets:"icon-star-1",fleets:"icon-rocket",combats:"icon-rocket",filteredcombats:"icon-rocket",onlycombats:"icon-rocket",stars:"icon-star-1",economists:"icon-dollar",generals:"icon-rocket",fa:"icon-beaker",api:"icon-flash",controls:"icon-help",help:"icon-help"},H={empires:"Empires",signatures:"Tech by Empire",accounting:"Accounting",trading:"Trading",research:"Research",fleets:"Fleets (short)",combats:"Fleets (long)",filteredcombats:"Fleets (filtered)",onlycombats:"All Combats",planets:"Home Planets",stars:"Stars",ownership:"Ownership",tradeactivity:"Trade Activity",combatactivity:"Combat Activity",activity:"Activity",economists:"Economists",generals:"Generals",api:"API Keys",games:"Past Games",fa:"Formal Alliances",controls:"Controls",help:"Help"};v("paste_report",(function(e,t){var n=function(){var e=NeptunesPride.inbox;e.commentDrafts[e.selectedMessage.key]+="\n"+a(),e.trigger("show_screen","diplomacy_detail")};if("screenshot"===t){var r=ne();r&&r.then(n)}else n()})),F.NewMessageCommentBox=function(){var e=j();return Crux.Button("npa_paste","paste_report","intel").grid(9.5,12,4.5,3).roost(e),Crux.Button("npa_screenshot","paste_report","screenshot").grid(13.5,12,7,3).roost(e),e};var fe=F.sideMenu.children[F.sideMenu.children.length-1];F.sideMenu.removeChild(fe),F.SideMenuItem("icon-eye","n_p_a","show_screen","new_fleet").roost(F.sideMenu),F.SideMenuItem("icon-left-open","main_menu","browse_to","/").roost(F.sideMenu),F.NpaMenuItem=function(e,t,n,r){var i=Crux.Clickable(n,r).addStyle("rel side_menu_item").configStyles("side_menu_item_up","side_menu_item_down","side_menu_item_hover","side_menu_item_disabled").size(292,40);Crux.Text("","pad12 txt_center").addStyle(e).grid(0,-.25,3,2.5).rawHTML("").roost(i),Crux.Text(t,"pad12").grid(2,-.25,18,2.5).roost(i);var s=u[r];return Crux.Text("","pad12 txt_right").grid(0,-.25,18,4).rawHTML("<span float='right'>".concat(s,"</span>")).roost(i),i};var pe=function(e,t){console.log("SHOW: ".concat(t)),b=t,F.trigger("show_screen","new_fleet")};F.npaMenu=function(){var e=Crux.Widget("col_accent side_menu").size(292,0);for(var t in e.isShowing=!1,e.pinned=!1,e.rows=11,F.sideMenuItemSize=40,e.spacer=Crux.Widget("rel").size(160,48).roost(e),e.showBtn=Crux.IconButton("icon-menu","hide_side_menu").grid(0,0,3,3).roost(e),e.showBtn=Crux.IconButton("icon-eye","hide_side_menu").grid(2.5,0,3,3).roost(e),Crux.Text("","pad12 txt_right").grid(0,-.25,18,4.5).rawHTML("<span float='right'>Hotkey</span>").roost(e),H){var n=q[t],r="npa_key_".concat(t);Crux.templates[r]=H[t],F.NpaMenuItem(n,r,"show_report",t).roost(e)}return e.pin=function(){e.show(),e.showBtn.hide(),e.spacer.hide(),e.pinned=!0,e.addStyle("fixed")},e.unPin=function(){e.pinned=!1,e.showBtn.show(),e.spacer.show(),e.removeStyle("fixed"),e.hide()},e.onPopUp=function(){e.pinned||(F.sideMenu.hide(),e.isShowing=!0,e.show(),e.trigger("play_sound","selection_open"),e.trigger("hide_section_menu"),e.trigger("hide_screen"),e.trigger("cancel_fleet_orders"))},e.onPopDown=function(){e.pinned||(e.isShowing=!1,e.hide())},e.on("show_report",pe),e.on("show_npa_help",at),e.on("show_npa_menu",e.onPopUp),e.on("hide_side_menu",e.onPopDown),e.onPopDown(),e}().roost(F),F.status.npaMenuBtn=Crux.IconButton("icon-eye","show_npa_menu").grid(2.5,0,3,3).roost(F.status),l("m",(function(){F.npaMenu.isShowing?F.npaMenu.onPopDown():F.npaMenu.onPopUp()}),"Toggle the display of the NPA menu.","NPA Menu");var me=F.NewFleetScreen;v("show_screen",(function(e,t,n){_="new_fleet"===t&&void 0===n,T="new_fleet"===t&&"npa_options"===(null==n?void 0:n.kind)})),F.NewFleetScreen=function(e){return void 0===e?function(){var e=F.Screen("n_p_a");Crux.Text("","rel pad12 txt_center col_black  section_title").rawHTML(f).roost(e),Crux.IconButton("icon-help","show_screen","help").grid(24.5,0,3,3).roost(e).onClick=at;var t=Crux.Widget("rel  col_accent").size(480,48),n=Crux.Widget("rel").nudge(-24,0);Crux.Text("npa_report_type","pad12").roost(t),E=Crux.DropDown(b,H,"exec_report").grid(15,0,15,3).roost(t),(x=Crux.TextInput("single").grid(5,0,10,3).roost(t)).eventKind="exec_report";var r=Crux.Text("","pad12 rel txt_selectable").size(432).pos(48).rawHTML("Choose a report from the dropdown.");r.roost(n),t.roost(e),n.roost(e);var i=function(e,t){return Rf(this,void 0,void 0,(function(){var e;return Of(this,(function(n){switch(n.label){case 0:return void 0===t&&(t=b),"help"===t?(at(),[2]):(b=t,"planets"!==t?[3,1]:(re(),[3,30]));case 1:return"fleets"!==t?[3,2]:(Y(),[3,30]);case 2:return"combats"!==t?[3,3]:(W(),[3,30]);case 3:return"onlycombats"!==t?[3,4]:(X(),[3,30]);case 4:return"filteredcombats"!==t?[3,5]:(Q(),[3,30]);case 5:return"stars"!==t?[3,6]:(C(),[3,30]);case 6:return"ownership"!==t?[3,7]:(N(),[3,30]);case 7:return"tradeactivity"!==t?[3,8]:(A(),[3,30]);case 8:return"combatactivity"!==t?[3,9]:(P(),[3,30]);case 9:return"fa"!==t?[3,10]:(D(),[3,30]);case 10:return"economists"!==t?[3,12]:[4,O()];case 11:return n.sent(),[3,30];case 12:return"activity"!==t?[3,13]:(V(),[3,30]);case 13:return"trading"!==t?[3,15]:[4,ze()];case 14:return n.sent(),[3,30];case 15:return"empires"!==t?[3,17]:[4,Xe()];case 16:return n.sent(),[3,30];case 17:return"signatures"!==t?[3,19]:[4,Ye()];case 18:return n.sent(),[3,30];case 19:return"generals"!==t?[3,21]:[4,L()];case 20:return n.sent(),[3,30];case 21:return"research"!==t?[3,23]:[4,tt()];case 22:return n.sent(),[3,30];case 23:return"accounting"!==t?[3,25]:[4,nt()];case 24:return n.sent(),[3,30];case 25:return"controls"!==t?[3,26]:(pt(),[3,30]);case 26:return"games"!==t?[3,28]:[4,ot()];case 27:return n.sent(),[3,30];case 28:return"api"!==t?[3,30]:[4,it()];case 29:n.sent(),n.label=30;case 30:return e=a().replace(/\n/g,"<br>"),e=NeptunesPride.inbox.hyperlinkMessage(e),r.rawHTML(e),[2]}}))}))};return i(0,b),e.on("exec_report",i),e}():"npa_options"===(null==e?void 0:e.kind)?function(e){var t=NeptunesPride.npui;Crux.templates.npa_options="NPA Settings ".concat(p.replaceAll(/ .*$/g,""));var n=t.Screen("npa_options");return Crux.IconButton("icon-help","show_screen","help").grid(24.5,0,3,3).roost(n).onClick=at,J(n,(function(e){return!0}),e),n}(e):"npa_colours"===(null==e?void 0:e.kind)?function(e){var t=NeptunesPride.npui;Crux.templates.npa_colours="Colours and Shapes";var n=t.Screen("npa_colours");Crux.IconButton("icon-help","show_screen","help").grid(24.5,0,3,3).roost(n).onClick=at,J(n,(function(e){return"allianceDiscriminator"===e.name}));var r=NeptunesPride.universe.galaxy,i=Object.keys(r.players).map((function(e){return r.players[e]})),s=i.length,o=g.customColors.split(" "),a=Math.ceil(o.length/10),c=Crux.Widget("rel").size(480,50*(s+a)+48).roost(n);return o.forEach((function(e,t){var n=t%10*3,r=3*Math.floor(t/10),i="text-align: center; vertical-align: middle; border-radius: 5px; width: ".concat(28,"px; height: ").concat(28,"px; background-color: ").concat(e,"; display: inline-block"),s=t===ee?"✓":"";Crux.Text("","pad12").rawHTML("<span onClick=\"Crux.crux.trigger('set_cc', ".concat(t,")\" style='").concat(i,"'>").concat(s,"</span>")).grid(n,r,3,3).roost(c).on("set_cc",(function(e,t){ee!==t&&(ee=t,NeptunesPride.np.trigger("refresh_interface"))}))})),[0,1,2,3,4,5,6,7].forEach((function(e,t){var n=3*t,r=3*a,i=o[ee],s="text-align: center; vertical-align: middle; border-radius: 5px; color: ".concat(i,";");s+="padding: 4px; padding-top: 6px; padding-right: 5px;",s+="background-color: black; ",s+=t===te?"border: 2px solid white; ":"border: 2px solid grey; ",Crux.Text("","pad12").rawHTML("<span class='playericon_font' style='".concat(s,"' onClick=\"Crux.crux.trigger('set_cs', ").concat(t,')">').concat(e,"</span>")).grid(n,r,3,3).roost(c).on("set_cs",(function(e,t){te!==t&&(te=t,NeptunesPride.np.trigger("refresh_interface"))}))})),i.forEach((function(e,t){var r=e.alias,i=he(e),s=de(e),u=3*t+3*a+3;Crux.Text("","pad12").rawHTML(r).grid(0,u,20,3).roost(c);var l=Crux.TextInput("single").grid(16,u,3,3).roost(c);l.node.addClass("playericon_font"),l.node.css("color",i),l.setValue(s);var h=Crux.TextInput("single").grid(19,u,6,3).roost(c);h.setValue(i),h.eventKind="text_entry";var d=function(){var t=!1;if(/^#[0-9a-fA-F]{6}$/.test(h.getValue())&&h.getValue()!=i){var n=h.getValue();ve(e.uid,n),-1===o.indexOf(n)&&-1===ce.indexOf(n)&&(ee=o.length,o.push(n),g.customColors=o.join(" ")),t=!0}if(/^[0-7]$/.test(l.getValue())&&l.getValue()!=s){var r=+l.getValue();console.log("set ".concat(e.uid," to shape ").concat(r)),le[e.uid+(Hd()?-1:0)]=r,t=!0}t&&(console.log("before: ".concat(le.join(","))),ge(),console.log("set: ".concat(le.join(","))),xe.set("colorMap",ue.join(" ")),xe.set("shapeMap",le.join(" ")),console.log("recolor: ".concat(le.join(","))),NeptunesPride.np.trigger("refresh_interface"),console.log("mapre: ".concat(le.join(","))),z(),console.log("preclip: ".concat(le.join(","))),Z())};h.node.on("focus",(function(){var e=o[ee];h.setValue(e),d()})),l.node.on("focus",(function(){var e=te;l.setValue(e),d()})),n.on(h.eventKind,(function(e,t){d()}));var f="reset_cc_".concat(e.uid);Crux.Button(f,f,e).rawHTML("Reset").grid(25,u,5,3).roost(c).on(f,(function(t,n){var r=void 0!==e.shapeIndex?e.shapeIndex:e.shape;!e.prevColor||h.getValue()===e.originalColor&&l.getValue()==r||(h.setValue(e.originalColor),l.setValue(r),d())}))})),Z(),n}():me(e)};var ye=Crux.formatTime,we=function(e,t,n){if("relative"===g.relativeTimes)return e<0?"-".concat(ye(-e,t,n)):ye(e,t,n);if("eta"===g.relativeTimes)return NeptunesPride.gameConfig.turnBased?function(e,t){var n=e/(60*$()*1e3),r=Math.ceil(n/NeptunesPride.gameConfig.turnJumpTicks);return"".concat(r," turn").concat(1!==r?"s":"")}(e):function(e,t){var n=(new Date).getTime()+NeptunesPride.universe.locTimeCorrection,r=new Date(n),i=new Date(r.getTime()+e),s=void 0!==t?t:"ETA ",o=s+U(i.getHours(),i.getMinutes());return i.getDay()!=r.getDay()&&(o="".concat(s).concat(G[i.getDay()]," @ ").concat(U(i.getHours(),i.getMinutes()))),o}(e,"");if("tick"===g.relativeTimes){var r=e/(60*$()*1e3);return"Tick #".concat(Math.ceil(r)+NeptunesPride.universe.galaxy.tick)}return"tickrel"===g.relativeTimes?(r=e/(60*$()*1e3),"".concat(Math.ceil(r)," ticks")):void 0};Crux.formatTime=function(e,t,n){var r=we(e,t,n),i=e/(60*$()*1e3),s=Math.ceil(i)+NeptunesPride.universe.galaxy.tick;return'<a onClick=\'Crux.crux.trigger("warp_time", "'.concat(s,"\")'>").concat(r,"</a>")},l("%",(function(){var e=(y.indexOf(g.relativeTimes)+1)%y.length;g.relativeTimes=y[e],NeptunesPride.np.trigger("refresh_interface"),NeptunesPride.npui.rulerToolbar&&NeptunesPride.np.trigger("show_ruler_toolbar"),NeptunesPride.np.trigger("map_rebuild")}),"Change the display of ETAs from relative times to absolute clock times. Makes predicting important times of day to sign in and check much easier especially for multi-leg fleet movements. Sometimes you will need to refresh the display to see the different times.","Timebase"),window.chrome?(Object.defineProperty(Crux,"touchEnabled",{get:function(){return!1}}),Object.defineProperty(NeptunesPride.npui.map,"ignoreMouseEvents",{get:function(){return!1}})):Oe()&&(Crux.crux.onTouchDown=function(){Crux.touchEnabled=!1},Crux.crux.one("touchstart",Crux.crux.onTouchDown));var be=function(){if(NeptunesPride.gameConfig.turnBased){var e=jQuery(':contains("Submit Turn")');return 9!==e.length&&11!==e.length&&(e=jQuery(':contains("Submitted")')),9===e.length&&e[7]&&e[7].style?(e[7].style.zIndex=0,!0):!(11!==e.length||!e[9]||!e[9].style||(e[9].style.zIndex=0,0))}return!0};be(),v("refresh_interface",be);var _e=NeptunesPride.universe,Te=_e.timeToTick;_e.timeToTick=function(e,t){var n=t&&"eta"!==g.relativeTimes;return Te(e,n)},ae=!0},ye=function(){g.territoryOn=!g.territoryOn,z()};l(")",ye,"Toggle the territory display. Range and scanning for all stars of the selected empire are shown.","Toggle Territory");var ve=function(e,t){var n=NeptunesPride.universe.galaxy.players[e];ue[n.uid+(Hd()?-1:0)]=t,"proteus"===NeptunesPride.gameVersion||Hd()?(n.originalColor||(n.originalColor=n.colorStyle),n.colorStyle=he(n)):(n.originalColor||(n.originalColor=n.color),n.prevColor=n.color,n.color=he(n))},we=function(){var e=NeptunesPride.universe.player;g.whitePlayer=!g.whitePlayer,g.whitePlayer?ve(e.uid,"#ffffff"):"proteus"===NeptunesPride.gameVersion||Hd()?ve(e.uid,ce[e.color]):void 0!==e.prevColor&&ve(e.uid,e.prevColor),ge()};function be(){if(NeptunesPride.universe.galaxy.tick_rate)console.log("*skip REDEFINE PROPERTIES");else{for(var e in console.log("REDEFINE PROPERTIES"),NeptunesPride.universe.galaxy.players){var t=NeptunesPride.universe.galaxy.players[e];void 0===t.total_stars?df(t.alias,t):console.log("skip inside for ${p.alias}")}df(0,NeptunesPride.universe.galaxy),void 0===NeptunesPride.universe.player_achievements&&df(0,NeptunesPride.universe)}}l("w",we,"Toggle between my color and white on the map display.","Whiteout"),window.setTimeout((function(){g.whitePlayer&&(g.whitePlayer=!1,we())}),1e3);var _e=function(){var e;(null===(e=NeptunesPride.universe)||void 0===e?void 0:e.galaxy)&&NeptunesPride.npui.map?(function(){var e=NeptunesPride.universe,t=NeptunesPride.universe.galaxy.fleets;for(var n in t){var r=t[n],i='<a onClick=\'Crux.crux.trigger("show_fleet_uid", "'.concat(r.uid,"\")'>").concat(r.n,"</a>");e.hyperlinkedMessageInserts[r.n]=i}e.hyperlinkedMessageInserts[":carrier:"]='<span class="icon-rocket"></span>',e.hyperlinkedMessageInserts[":star:"]='<span class="icon-star-1"></span>',e.hyperlinkedMessageInserts[":mail:"]='<span class="icon-mail"></span>'}(),w(),console.log("Fleet linking complete."),ae?console.log("HUD setup already done; skipping."):(me(),console.log("HUD setup complete.")),xe.get("colorMap").then((function(e){e.split(" ").forEach((function(e,t){var n=t+(Hd()?1:0);NeptunesPride.universe.galaxy.players[n]&&ve(n,e)})),xe.get("shapeMap").then((function(e){le=e.split(" ").map((function(e){return+e})),ge(),NeptunesPride.np.trigger("refresh_interface"),z()}))})).catch((function(e){var t;(null===(t=null===NeptunesPride||void 0===NeptunesPride?void 0:NeptunesPride.universe)||void 0===t?void 0:t.galaxy)&&j(NeptunesPride.universe.galaxy)})),be(),console.log("hook for all accessors"),v("order:full_universe",be)):console.log("Game not fully initialized yet; wait.",NeptunesPride.universe)};l("@",_e,"Reinitialize Neptune's Pride Agent. Use the @ hotkey if the version is not being shown on the map after dragging.","Reload NPA");var Te=void 0,Ee=Ff(),xe=new ef(Ee),Se=NeptunesPride.np.onServerResponse;NeptunesPride.np.onServerResponse=function(e){Se(e),"order:player_achievements"===e.event?(console.log("Initial load complete. Reinstall."),Id("achievements_init"),_e()):"order:full_universe"===e.event?(console.log("Universe received. Reinstall."),NeptunesPride.originalPlayer=NeptunesPride.universe.player.uid,Id("universe_init"),_e()):!ae&&NeptunesPride.npui.map&&(console.log("Hooks need loading and map is ready. Reinstall."),Id("".concat(e.event,"_init")),_e())};var ke=function(e,t){return Rf(this,void 0,void 0,(function(){var e,n;return Of(this,(function(r){switch(r.label){case 0:return void 0===NeptunesPride.originalPlayer&&(NeptunesPride.originalPlayer=NeptunesPride.universe.player.uid),e=(null==t?void 0:t.split(":")[1])||Te,(Te=e)?[4,Je(e)]:[3,2];case 1:if(n=r.sent(),!Ie(e,n))return[2];console.log("SCAN: ",{scan:n}),NeptunesPride.np.onFullUniverse(null,n),NeptunesPride.npui.onHideScreen(null,!0),NeptunesPride.np.trigger("select_player",[NeptunesPride.universe.player.uid,!0]),Id("switchuser_init"),_e(),r.label=2;case 2:return[2]}}))}))},Ie=function(e,t){if(!((null==t?void 0:t.player_uid)>=0))return"badkey"!==Te&&xe.keys().then((function(t){var n=t.filter((function(e){return e.startsWith("API:")}));n.forEach((function(t){xe.get(t).then((function(n){n===e&&xe.set(t,"badkey")}))}))})),!1;var n="API:".concat(t.player_uid);return xe.get(n).then((function(t){t&&t===Te||xe.set(n,e)})),!0},Ce=function(e){var t=NeptunesPride.universe;if(Pf(),-1!==Ae||(NeptunesPride.universe.galaxy.player_uid,NeptunesPride.originalPlayer&&NeptunesPride.originalPlayer,NeptunesPride.originalPlayer!==t.galaxy.player_uid||e.player_uid!==t.galaxy.player_uid)){t.galaxy.players[e.player_uid]=Mf(Mf({},e.players[e.player_uid]),t.galaxy.players[e.player_uid]);var n=Mf({},e.stars),r=Mf({},e.fleets);if(Hd())for(var i in n)if(void 0!==t.galaxy.stars[i]){var s=n[i].x-t.galaxy.stars[i].x,o=n[i].y-t.galaxy.stars[i].y;if(0!==s||0!==o){for(var a in n)(l=n[a]).x-=s,l.y-=o;for(var c in r)(d=r[c]).x-=s,d.y-=o}break}for(var u in t.galaxy.stars=Mf(Mf({},n),t.galaxy.stars),n){var l;(uf(l=n[u])&&!uf(t.galaxy.stars[u])||l.puid===e.player_uid)&&(t.galaxy.stars[u]=Mf(Mf({},t.galaxy.stars[u]),l))}for(var h in t.galaxy.fleets=Mf(Mf({},r),t.galaxy.fleets),r){var d;(d=r[h]).puid==e.player_uid&&(t.galaxy.fleets[h]=Mf(Mf({},t.galaxy.fleets[h]),d))}var f=1-K(1)/(60*$()*1e3);t.galaxy.tick_fragment=f,t.galaxy.tickFragment=f}},Ne=function(e,t){return Rf(this,void 0,void 0,(function(){var e,n;return Of(this,(function(r){switch(r.label){case 0:return void 0===NeptunesPride.originalPlayer&&(NeptunesPride.originalPlayer=NeptunesPride.universe.player.uid),e=(null==t?void 0:t.split(":")[1])||Te,(Te=e)?[4,Je(e)]:[3,2];case 1:if(n=r.sent(),!Ie(e,n))return[2];Ce(n),NeptunesPride.np.onFullUniverse(null,NeptunesPride.universe.galaxy),NeptunesPride.npui.onHideScreen(null,!0),Id("mergeuser_init"),_e(),r.label=2;case 2:return[2]}}))}))};l(">",ke,"Switch views to the last user whose API key was used to load data. The HUD shows the current user when it is not your own alias to help remind you that you aren't in control of this user.","Next User"),l("|",Ne,"Merge the latest data from the last user whose API key was used to load data. This is useful after a tick passes and you've reloaded, but you still want the merged scan data from two players onscreen.","Merge User"),v("switch_user_api",ke),v("merge_user_api",Ne),v("view_game",(function(e,t){return Rf(this,void 0,void 0,(function(){var e,n,r,i,s,o=this;return Of(this,(function(a){switch(a.label){case 0:return e=null==t?void 0:t.split(":"),n=e[1],NeptunesPride.gameNumber=n,[4,st()];case 1:return r=a.sent(),function(){for(var e in hd)delete hd[e]}(),i=void 0!==r[n]?r[n]:[e[2]],rt=i.map((function(e){return"[[api:".concat(e,"]]")})),s=0,i.forEach((function(e){return Rf(o,void 0,void 0,(function(){var t,n;return Of(this,(function(r){switch(r.label){case 0:return[4,_d(e)];case 1:return r.sent(),(t=dd(e))>0?(console.log("".concat(t," scans for ").concat(e," cached")),n=Sd(e,t-1),console.log({lastScan:n}),(null==n?void 0:n.tick)>s&&(s=n.tick,console.log("New maxtick found: ".concat(s)),B=s)):console.log("No scans found for ".concat(e)),[2]}}))}))})),Le(null,"0"),[2]}}))}))}));var Ae=-1,Pe={},De=function(e){var t=60*$()*1e3,n=H(e)*t,r=e.now-n;return Mf(Mf({},e),{now:r,tick_fragment:0,tickFragment:0})},Me=function(e,t,n){var r=mf(t);if(!dd(r))return null;var i="back"===n?dd(r)-1:0;void 0!==Pe[t]&&(i=Pe[t]);var s=Sd(r,i);if((s=De(s)).tick<e)for(;s.tick<e&&"forwards"===n;){if(++i===dd(r))return Pe[t]=void 0,null;s=Sd(r,i),s=De(s)}else if(s.tick>e)for(;s.tick>e&&"back"===n;){if(--i<0)return Pe[t]=void 0,null;s=Sd(r,i),s=De(s)}return Pe[t]=i,td(s)},Re=function(e){if(Ae>B){if("forwards"===e){var t=Ae-NeptunesPride.universe.galaxy.tick;Pf();var n=function(e,t){var n,r,i,s,o=Nf(Nf({},e),{futureTime:!0});if(t<=0)return console.error("Future time machine going backwards NIY"),Id("error_back_to_the_future"),o;var a=Nf({},o.stars),c=Nf({},o.fleets),u=Nf({},o.players);Hd()&&df(0,o);for(var l=0;l<t;++l){var h={};for(var d in Cf(o,h,o.tick+1),o.tick+=1,o.production_counter+=1,o.now+=60*e.tick_rate*1e3,a){var f=a[d];if(Df(j=Nf({},f))&&Df(f)&&j.i>0){var p=o.production_rate,g=j.i*(af(u[f.puid],"manufacturing").level+5)/p,m=void 0!==j.c?j.c:j.yard;j.st+=g+m,j.c=j.st-Math.floor(j.st),j.st=Math.floor(j.st),j.totalDefenses+=j.st-f.st,a[d]=j}void 0!==(G=h[d])&&(Df(j)&&(j.st=G.st),j.puid=G.puid,a[d]=j)}for(var y in c){var v=Nf(Nf({},c[y]),{l:c[y].loop});if(c[y].o.length>0&&void 0!==a[c[y].o[0][1]]){var w=c[y].o[0],b=w[0],_=w[1],T=w[2],E=w[3],x=a[_];(null==v?void 0:v.orbiting)&&(Df(v.orbiting)&&Df(x)&&(v.warpSpeed=v.orbiting.ga===x.ga?x.ga:0),v.w=v.warpSpeed,v.uid===(null===(r=NeptunesPride.universe.selectedFleet)||void 0===r?void 0:r.uid)&&console.log("Fleet ".concat(v.n," @ warp ").concat(v.w," ETA ").concat(v.etaFirst," to ").concat(_)));var S=[parseFloat(x.x),parseFloat(x.y)],k=S[0],I=S[1],C=[v.x,v.y],N=C[0],A=C[1];if(v.etaFirst>1){if(b>0)v.o=Af([],v.o,!0),v.o[0]=[b-1,_,T,E];else{var P=[parseFloat(v.x),parseFloat(v.y)],D=P[0],M=P[1],R=[k-D,I-M],O=R[0],L=R[1];v.uid===(null===(i=NeptunesPride.universe.selectedFleet)||void 0===i?void 0:i.uid)&&console.log("Fleet ".concat(v.n," flying @ warp ").concat(v.w," ETA ").concat(v.etaFirst," to ").concat(x.n," @ ").concat(O,",").concat(L," ").concat(o.fleet_speed));var F=(K=o.fleet_speed*(v.warpSpeed?3:1))/Math.sqrt(O*O+L*L),V=[O*F,L*F],U=V[0],B=V[1];v.x=String(D+U),v.y=String(M+B),v.ouid=void 0}v.etaFirst-=1,v.eta-=1}else{var j=Nf({},x);v.x=String(k),v.y=String(I);var q=v.o[0];if(v.o=v.o.slice(1),1===v.l&&v.o.push(q),void 0!==(null==(G=h[_])?void 0:G.fleetStrength[v.uid])&&(v.st=G.fleetStrength[v.uid]),v.ouid=_,v.puid===j.puid&&v.st>0&&Df(j)){var $=0;switch(T){case Yd.Nothing:break;case Yd.CollectAll:$=-j.st;break;case Yd.Collect:$=-E;break;case Yd.CollectAllBut:$=Math.min(0,-j.st+E);break;case Yd.DropAll:$=v.st;break;case Yd.Drop:$=E;break;case Yd.DropAllBut:$=Math.max(0,v.st-E);break;case Yd.Garrison:$=-j.st+E}$=Math.max(-j.st,$),$=Math.min(v.st-1,$),v.st-=$,j.st+=$}if(v.o.length>0){var H=a[c[y].o[0][1]];Df(H)&&Df(x)&&(v.warpSpeed=H.ga===x.ga?H.ga:0),v.w=v.warpSpeed;var K=o.fleet_speed*(v.warpSpeed?3:1);v.etaFirst=b+Math.ceil(lf(x,H)/K),v.uid===(null===(s=NeptunesPride.universe.selectedFleet)||void 0===s?void 0:s.uid)&&console.log("Fleet ".concat(v.n," @ warp ").concat(v.w," ETA ").concat(v.etaFirst," to ").concat(H.n))}else v.etaFirst=0;a[_]=j}n=[N,A],v.lx=n[0],v.ly=n[1],c[y]=v}else if(c[y].orbiting){var G;void 0!==(null==(G=h[c[y].ouid])?void 0:G.fleetStrength[v.uid])&&(v.st=G.fleetStrength[v.uid],c[y]=v)}0===c[y].st&&delete c[y]}for(var z in u)if(void 0!==u[z].researching){(X=u[z]=Nf({},u[z])).tech=Nf({},X.tech),df(X.alias,X);var W=X.tech[X.researching]=Nf({},X.tech[X.researching]);W.research+=X.total_science;var Q=hf(Nf(Nf({},W),{brr:W.brr,level:W.level+(Hd()?0:1)}));W.research>=Q&&(W.research-=Q,W.level+=1,X.researching=X.researching_next)}if(o.production_counter>=o.production_rate){for(var z in u){var X;void 0!==u[z].cash&&((X=u[z]=Nf({},u[z])).cashPerDay?X.cash+=X.cashPerDay:X.cash+=10*X.total_economy+75*af(X,"banking").level)}o.production_counter=0}}return o.stars=a,o.fleets=c,o.players=u,o}(NeptunesPride.universe.galaxy,t);NeptunesPride.np.onFullUniverse(null,n)}else"back"===e&&Le(null,"".concat(B));return NeptunesPride.np.trigger("map_rebuild"),!1}var r=rt.map((function(t){return function(e,t){return Me(Ae,e,t)}(t,e)})).filter((function(e){return e&&e.tick===Ae}));if(0===r.length)return NeptunesPride.np.trigger("map_rebuild"),!1;var i=NeptunesPride.originalPlayer?NeptunesPride.originalPlayer:NeptunesPride.universe.galaxy.player_uid,s=r.filter((function(e){return e.player_uid===i})),o=s.length>0?s[0]:r[0];NeptunesPride.np.onFullUniverse(null,o),NeptunesPride.gameConfig.name=NeptunesPride.universe.galaxy.name,console.log("RESET game name to ".concat(NeptunesPride.gameConfig.name)),r.forEach((function(e){Ce(e)})),NeptunesPride.np.onFullUniverse(null,NeptunesPride.universe.galaxy),Id("timetravel_init"),_e()},Le=function(e,t){Ae=parseInt(t);var n=NeptunesPride.universe.galaxy.tick;Ae<n?Re("back"):Ae>n&&Re("forwards")};v("warp_time",Le),l("ctrl+,",(function(){-1===Ae&&(Ae=NeptunesPride.universe.galaxy.tick),NeptunesPride.gameConfig.turnBased?Ae-=NeptunesPride.gameConfig.turnJumpTicks:Ae-=1,Ae<0&&(Ae=0),Re("back")}),"Go back a tick in time.","Time Machine: Back"),l("ctrl+.",(function(){NeptunesPride.gameConfig.turnBased?Ae+=NeptunesPride.gameConfig.turnJumpTicks:(-1===Ae&&(Ae=NeptunesPride.universe.galaxy.tick),Ae+=1),Re("forwards")}),"Go forward a tick in time.","Time Machine: Forward"),l("ctrl+m",(function(){-1===Ae&&(Ae=NeptunesPride.universe.galaxy.tick),(Ae-=NeptunesPride.gameConfig.productionTicks)<0&&(Ae=0),Re("back")}),"Go back in time a full cycle (".concat(NeptunesPride.gameConfig.productionTicks," ticks)."),"Time Machine: -".concat(NeptunesPride.gameConfig.productionTicks," ticks")),l("ctrl+/",(function(){Ae+=NeptunesPride.gameConfig.productionTicks,Re("forwards")}),"Go forward a full cycle (".concat(NeptunesPride.gameConfig.productionTicks," ticks)."),"Time Machine: +".concat(NeptunesPride.gameConfig.productionTicks," ticks"));var Fe="";v("order:api_code",(function(e,t){var n;return Rf(this,void 0,void 0,(function(){var e,r,i,s;return Of(this,(function(o){switch(o.label){case 0:return[4,Je(t)];case 1:return e=o.sent(),Ie(t,e)?(Fe=t,r=null===(n=NeptunesPride.account)||void 0===n?void 0:n.user_id,wd(Fe,r),i=NeptunesPride.universe.player.color,s="Your new API key is ".concat(t,".\n\n[[api:").concat(t,"]]"),NeptunesPride.inbox.trigger("server_request",{type:"create_game_message",from_color:i,to_uids:"",to_aliases:"",to_colors:"",subject:"API Key Generated",body:s})):(console.error("Failed to load our own scan data?"),Fe=""),[2]}}))}))}));var Ve=0,Ue=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o;return Of(this,(function(a){switch(a.label){case 0:return(e=(new Date).getTime())-Ve<3e5?(console.log("refreshScanData called too recently, STOP"),j(NeptunesPride.universe.galaxy),[2]):(Ve=e,[4,xe.keys()]);case 1:t=a.sent(),n=t.filter((function(e){return e.startsWith("API:")})),r=n.map((function(e){return parseInt(e.substring(4))})),i=0,a.label=2;case 2:return i<r.length?[4,xe.get(n[i])]:[3,5];case 3:s=a.sent(),Je(s),o=r[i],NeptunesPride.originalPlayer&&NeptunesPride.originalPlayer==o&&(Fe=s),NeptunesPride.originalPlayer||NeptunesPride.universe.player.uid!=o||(Fe=s),a.label=4;case 4:return++i,[3,2];case 5:return j(NeptunesPride.universe.galaxy),[2]}}))}))};v("refresh_interface",Ue);var Be={bank:"Banking",manu:"Manu",prop:"Range",rese:"Exp",scan:"Scan",terr:"Terra",weap:"Weapons",0:"Banking",1:"Exp",2:"Manu",3:"Range",4:"Scan",5:"Weapons",6:"Terra"},je={bank:"💰",manu:"🔧",prop:"🚀",rese:"🧪",scan:"📡",terr:"🌎",weap:"⚔️",0:"💰",1:"🧪",2:"🔧",3:"🚀",4:"📡",5:"⚔️",6:"🌎"},qe=function(e){return Be[void 0!==e.substring?e.substring(0,4):e]},$e=function(e){return console.log("name key [".concat(e,"]")),je[e.substring(0,4)]},He=function(e){return"proteus"===NeptunesPride.gameVersion?e*e*5:e*(NeptunesPride.gameConfig.tradeCost||NeptunesPride.universe.galaxy.config.tradeCost)},Ke=function(e,t,n){e.push("--- ".concat(n," ---"));for(var r=":--",i=0;i<t.length;++i)r+="|--";e.push(r);var s=NeptunesPride.universe.player.uid;r="Technology|[[#".concat(s,"]]|[[#").concat(s,"]]");var o={},a={},c=[];for(i=0;i<t.length;++i){var u=t[i];u!==s&&(r+="|[[#".concat(u,"]]"),o[u]=0,a[u]=0,c.push(u))}e.push(r);var l=[],h=NeptunesPride.universe.player.tech;c.forEach((function(e){var t=NeptunesPride.universe.galaxy.players[e],n=t.tech;Object.keys(t.tech).map((function(t,r){l[r]||(l[r]=qe(t),l[r]+="|".concat(h[t].level),l[r]+="|".concat(h[t].research,"/").concat(hf(h[t])));var i=n[t].level;if(i<h[t].level){l[r]+="|[[sendtech:".concat(e,":").concat(t,":").concat(i,"]]");for(var s=i;s<h[t].level;++s)a[e]+=He(s+1)}else if(i>h[t].level){var c=He(h[t].level+1);for(l[r]+="|[[sendcash:".concat(e,":").concat(c,":").concat(i,"]]"),s=i;s>h[t].level;--s)o[e]+=He(s)}else l[r]+="|".concat(i)}))}));var d=Lf(["[[footer:Pay for all]]","",""],c.map((function(e){return o[e]>0?"[[sendcash:".concat(e,":").concat(o[e],":").concat(o[e],"]]"):""})),!0),f=Lf(["[[footer:Send all]]","",""],c.map((function(e){return a[e]>0?"[[sendalltech:".concat(e,":").concat(a[e],"]]"):""})),!0);l.forEach((function(t){return e.push([t])})),e.push([d.join("|")]),e.push([f.join("|")]),e.push("--- ".concat(n," ---"))},Ge=function(){var e,t;return NeptunesPride.gameConfig.tradeScanned||"proteus"===NeptunesPride.gameVersion||(null===(t=null===(e=NeptunesPride.universe.galaxy)||void 0===e?void 0:e.config)||void 0===t?void 0:t.tradeScanned)},ze=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c;return Of(this,(function(u){switch(u.label){case 0:return b="trading",[4,et()];case 1:for(e=u.sent(),t=e.players,n=e.playerIndexes,Ke(r=[],n,"Allied Technology"),i=Object.keys(t),s=Ge()?"Scanned ":"",Ge()&&(i=i.filter((function(e){return Hd()?NeptunesPride.universe.player.scannedPlayers[t[e].uid]:NeptunesPride.universe.player.scannedPlayers.indexOf(t[e].uid)>=0}))),o=0;o<i.length;)a=i.slice(o,o+5),c=a.map((function(e){return t[e].uid})),Ke(r,c,"".concat(s,"Players ").concat(o," - ").concat(o-1+a.length)),o+=a.length;return I("trading",r),[2]}}))}))};l("e",ze,"The trading report lets you review where you are relative to others and provides shortcuts to ease trading of tech as needed.","trading");var We=function(e,t,n){var r=[["total_stars","[[:star:]]"],["total_strength","[[:carrier:]]"],["shipsPerTick","[[:carrier:]]/h"],["cashPerDay","$"],["total_economy","E"],["total_industry","I"],["total_science","S"]];Hd()||(r=r.filter((function(e){return"cashPerDay"!==e[0]})));var i=[],s=r.map((function(e){return 0}));i.push("--- ".concat(n," ---"));for(var o=":--",a=0;a<r.length;++a)o+="|--";for(i.push(o),o="Empire",a=0;a<r.length;++a)o+="|".concat(r[a][1]);i.push(o);var c=NeptunesPride.universe.player;t.forEach((function(e){var t=["[[".concat(e,"]]")],n=NeptunesPride.universe.galaxy.players[e];r.map((function(e){return e[0]})).forEach((function(e,r){var i=+c[e],o=+n[e];s[r]+=o,o<i?t.push("[[good:".concat(o,"]]")):o>i?t.push("[[bad:".concat(o,"]]")):t.push("".concat(o))})),i.push([t.join("|")])}));var u=s.map((function(e){return Math.trunc(e)}));return i.push([Lf(["[[footer:Total]]"],u,!0).join("|")]),i.push("--- ".concat(n," ---")),e.push(i.flat()),Lf(["".concat(n)],u,!0)},Qe=function(){var e=NeptunesPride.universe.galaxy.players,t=Object.keys(NeptunesPride.universe.galaxy.players),n=void 0!==e[0]?0:1,r="color"===g.allianceDiscriminator?ue.slice(0,t.length):le.slice(0,t.length);if("color"===g.allianceDiscriminator&&g.whitePlayer){var i=NeptunesPride.universe.player;r[i.uid]=i.prevColor}var s=r.map((function(e,t){return[e,t+n]})).sort(),o={};return s.forEach((function(t){var n=e[t[1]];(n.total_stars||n.total_strength)&&(void 0===o[t[0]]?o[t[0]]=[t[1]]:o[t[0]].push(t[1]))})),o},Xe=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,w;return Of(this,(function(_){switch(_.label){case 0:return b="empires",e=[],t=[],n=function(e,n,r){var i=We(e,n,r);t.push(i)},[4,et()];case 1:for(c in r=_.sent(),i=r.players,(s=r.playerIndexes).length>1&&We(e,s,"Allied Empires"),o=[],a=Qe())1===(u=a[c]).length?o.push(u[0]):-1!==ce.indexOf(c)?o.push.apply(o,u):(l=u.filter((function(e){return 1!==i[e].ai})),h="[[mail:".concat(u.join(":"),"]] Alliance ").concat(u.map((function(e){return"[[#".concat(e,"]]")})).join("")),d=l.length>0?h:"AI",n(e,u,d));return We(e,o,"Unallied Empires"),f=Object.keys(NeptunesPride.universe.galaxy.players),p=f.filter((function(e){return i[e].total_strength>0})).map((function(e){return+e})),e.length>0&&(g="--- All Alliances [[Tick #".concat(NeptunesPride.universe.galaxy.tick,"]] ---"),(m=[g]).push(e[0][1]),m.push(e[0][2].replace("Empire","Alliance")),y=NeptunesPride.universe.player,v="[[#".concat(y.uid,"]]"),w=[],t.forEach((function(e){-1!==e[0].indexOf(v)&&w.push.apply(w,e)})),t.forEach((function(e){for(var t=e[0],n=1;n<e.length;++n){var r=e[n],i=w[n],s=r<i?"[[good:".concat(r,"]]"):r>i?"[[bad:".concat(r,"]]"):"".concat(r);t+="|".concat(s)}m.push(t)})),m.push(g),e.push(m.map((function(e){return e.replace(/..mail.*]] Alliance /,"")})))),We(e,p,"All Surviving Empires"),I("empires",e),[2]}}))}))};l("ctrl+l",Xe,"The empires report summarizes all key empire stats. It's meant to be a better leaderboard for seeing how the individual empires are doing.","empires");var Ye=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h;return Of(this,(function(d){switch(d.label){case 0:return b="signatures",e=[],t=function(e,t,n){var r=NeptunesPride.universe.player,i=Object.keys(r.tech).map((function(e){return[e,$e(e)]})),s=[];s.push("--- ".concat(n," ---"));for(var o=":--",a=0;a<i.length;++a)o+="|--";for(s.push(o),o="Empire",a=0;a<i.length;++a)o+="|".concat(i[a][1]);s.push(o);var c={levels:{},medians:{},summary:[]};i.map((function(e){return e[0]})).forEach((function(e){return c.levels[e]=[]})),t.forEach((function(e){var t=NeptunesPride.universe.galaxy.players[e].tech;i.map((function(e){return e[0]})).forEach((function(e){c.levels[e].push(t[e].level)}))})),i.map((function(e){return e[0]})).forEach((function(e){c.levels[e].sort((function(e,t){return+e-+t}));var t=Math.ceil(c.levels[e].length/2);c.medians[e]=c.levels[e][t],c.summary.push(c.medians[e])})),t.forEach((function(e){var t=["[[".concat(e,"]]")],n=NeptunesPride.universe.galaxy.players[e].tech;i.map((function(e){return e[0]})).forEach((function(e,r){var i=c.medians[e],s=n[e].level;s<i?t.push("[[bad:".concat(s,"]]")):s>i?t.push("[[good:".concat(s,"]]")):t.push("".concat(s))})),s.push([t.join("|")])})),s.push([Lf(["[[footer:Signature]]"],c.summary,!0).join("|")]),s.push("--- ".concat(n," ---")),e.push(s.flat())},[4,et()];case 1:for(s in n=d.sent().players,r=[],i=Qe())1===(o=i[s]).length?r.push(o[0]):-1!==ce.indexOf(s)?r.push.apply(r,o):(a=o.filter((function(e){return 1!==n[e].ai})),c="[[mail:".concat(o.join(":"),"]] Alliance ").concat(o.map((function(e){return"[[#".concat(e,"]]")})).join("")),u=a.length>0?c:"AI",t(e,o,u));return l=Object.keys(NeptunesPride.universe.galaxy.players),h=l.filter((function(e){return n[e].total_strength>0})).map((function(e){return+e})),t(e,h,"All Empires"),I("signatures",e),[2]}}))}))};l("ctrl+g",Ye,"The group tech report summarizes the technology levels of all empires. Use it to double check alliaces or look for trading partners.","signatures"),NeptunesPride.sendTech=function(e,t){var n=NeptunesPride.universe,r=n.galaxy.players;n.selectedPlayer=r[e];var i=NeptunesPride.npui.EmpireTrade(n.selectedPlayer);i.techSelection.setValue(t),i.onPreTradeTech()},NeptunesPride.sendAllTech=function(e){Crux.templates.confirm_send_bulktech="Are you sure you want to send<br>[[alias]]<br>[[techs]]?";var t=NeptunesPride.npui,n=NeptunesPride.universe.galaxy.players[e],r=[],i=NeptunesPride.universe.player.tech,s=n.tech;r=Object.keys(n.tech).filter((function(e){return s[e].level<i[e].level})),t.trigger("hide_screen");var o={message:"confirm_send_bulktech",messageTemplateData:{techs:r.map(qe).join(", "),alias:(n.colourBox||n.colorBox)+n.hyperlinkedRawAlias},eventKind:"send_bulktech",eventData:{targetPlayer:n,techs:r},notification:!1,returnScreen:"empire"};t.trigger("show_screen",["confirm",o])},v("send_bulktech",(function(e,t){for(var n=NeptunesPride.universe,r=NeptunesPride.np,i=t.targetPlayer,s=NeptunesPride.universe.player,o=0;o<t.techs.length;++o)for(var a=t.techs[o];i.tech[a].level<s.tech[a].level;){var c=(i.tech[a].level+1)*n.galaxy.trade_cost;if(!(n.player.cash>=c))break;i.tech[a].level+=1,n.player.cash-=c,r.trigger("server_request",{type:"order",order:"share_tech,".concat(i.uid,",").concat(a)})}n.selectPlayer(i),r.trigger("refresh_interface")})),NeptunesPride.sendCash=function(e,t){Crux.templates.confirm_send_cash="Are you sure you want to send<br>[[alias]]<br>$[[amount]] credits?";var n=NeptunesPride.npui,r=NeptunesPride.universe.galaxy.players[e];n.trigger("hide_screen");var i={message:"confirm_send_cash",messageTemplateData:{amount:t,alias:(r.colourBox||r.colorBox)+r.hyperlinkedRawAlias},eventKind:"send_money",eventData:{targetPlayer:r,amount:t},notification:!1,returnScreen:"empire"};n.trigger("show_screen",["confirm",i])};var Je=function(e){return Rf(this,void 0,void 0,(function(){var t,n,r,i,s,o,a,c;return Of(this,(function(u){switch(u.label){case 0:return t="CACHED_".concat(e),[4,xe.get(t)];case 1:return(n=u.sent())?(r=(new Date).getTime()-n.now,i=(1-H(n))*$()*60*1e3,(s=r<i&&r<3e5)?[4,Xd(n.now)]:[3,3]):[3,4];case 2:s=!u.sent(),u.label=3;case 3:return s?(console.log("Cache hit! ".concat(t)),df(0,n),[2,n]):[3,5];case 4:if(console.log("Cache miss! ".concat(t)),"badkey"===e)return[2,void 0];Id("unexpected_cache_miss_".concat(t)),u.label=5;case 5:return o={game_number:Ee,api_version:"0.1",code:e},Hd()?[4,Pd("https://neptunespride4.appspot.com/api",o)]:[3,7];case 6:return c=u.sent(),[3,9];case 7:return[4,Ad("https://np.ironhelmet.com/api",o)];case 8:c=u.sent(),u.label=9;case 9:return a=c,[4,xe.set(t,a.scanning_data)];case 10:return u.sent(),a.scanning_data?df(0,a.scanning_data):console.error("failed to get scanning data for ".concat(o.code)),[2,a.scanning_data]}}))}))},Ze=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r;return Of(this,(function(i){switch(i.label){case 0:return[4,xe.keys()];case 1:return e=i.sent(),t=NeptunesPride.universe.galaxy.players,n=e.filter((function(e){return e.startsWith("API:")&&0===t[(n=e,parseInt(n.substring(4)))].conceded;var n})),r=n.map((function(e){return parseInt(e.substring(4))})),[2,{players:t,apiKeys:n,playerIndexes:r}]}}))}))},et=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h;return Of(this,(function(d){switch(d.label){case 0:return e=NeptunesPride.universe.galaxy,t=e.players[e.player_uid],n=Qe(),[4,Ze()];case 1:for(i in r=d.sent(),n)if(-1!==(s=n[i]).indexOf(t.uid)){for(console.log("Alliance should be ".concat(i,": "),s),o=NeptunesPride.universe.galaxy.players,a=[],c=[],u=0;u<r.playerIndexes.length;++u)l=r.playerIndexes[u],h=r.apiKeys[u],-1!==s.indexOf(l)&&(c.push(l),a.push(h));return c.length!==s.length&&console.error("Missing API key for an alliance member.",c,r),[2,{players:o,apiKeys:a,playerIndexes:c}]}return[2,r]}}))}))},tt=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v,w,_,T,E,x,S,k;return Of(this,(function(C){switch(C.label){case 0:return b="research",[4,et()];case 1:e=C.sent(),t=e.players,n=e.apiKeys,r=e.playerIndexes,(i=[]).push("--- Alliance Research Progress ---"),i.push(":--|:--|--:|--:|--:|--"),i.push("Empire|Tech|ETA|Progress|Sci|⬆S"),s=function(e){var s,o,a,c,u,l,h,d,f,p,g,m,y,v,w,b,_;return Of(this,(function(T){switch(T.label){case 0:return s=r[e],o=t[s],[4,xe.get(n[e])];case 1:return a=T.sent(),[4,Je(a)];case 2:if(c=T.sent()){for(u=c.players[s],l=u.tech[u.researching],h=l.research,d=hf(l),f=d-h,p=o.total_science,g=function(e){return"proteus"===NeptunesPride.gameVersion?e*u.tech.research.level:e},m=Math.ceil(f/g(p)),y=c.tick+m,v="",w=1;w<10;++w)if((b=Math.ceil(f/g(p+w)))<m){v="".concat(w,"[[sub:").concat(m-b,"]]");break}_=qe(u.researching),i.push(["[[".concat(s,"]]|").concat(_,"|[[Tick #").concat(y,"]]|").concat(h,"/").concat(d,"|").concat(o.total_science,"|").concat(v)])}return[2]}}))},p=0,C.label=2;case 2:return p<r.length?[5,s(p)]:[3,5];case 3:C.sent(),C.label=4;case 4:return++p,[3,2];case 5:for(i.push("--- Alliance Research Progress ---"),o=NeptunesPride.universe.player,a=Object.keys(o.tech),c={},u=0,l=a;u<l.length;u++)x=l[u],c[x]={level:1,research:0};p=0,C.label=6;case 6:return p<r.length?(g=r[p],t[g],[4,xe.get(n[p])]):[3,10];case 7:return m=C.sent(),[4,Je(m)];case 8:if(!(y=C.sent()))return[3,9];for(h=y.players[g],w="[[".concat(g,"]]"),d=0,f=a;d<f.length;d++)E=f[d],(x=h.tech[E]).level===c[E].level?c[E].research=Math.max(c[E].research,x.research):x.level>c[E].level&&(c[E].level=x.level,c[E].research=x.research);C.label=9;case 9:return++p,[3,6];case 10:i.push("--- All Alliance Research ---"),i.push(":--|".concat(a.map((function(){return"--:"})).join("|"))),i.push("Empire|".concat(a.map((function(e){return"[[sub:L".concat(c[e].level,"]] ").concat($e(e))})).join("|"))),p=0,C.label=11;case 11:return p<r.length?(g=r[p],t[g],[4,xe.get(n[p])]):[3,15];case 12:return m=C.sent(),[4,Je(m)];case 13:if(!(y=C.sent()))return[3,14];for(v=y.players[g],w="[[".concat(g,"]]"),_=0,T=a;_<T.length;_++)E=T[_],x=v.tech[E],S=x.research,x.level===c[E].level?x.research===c[E].research&&(S="[[good:".concat(S,"]]")):S="[[bad:".concat(S,"]]"),w+="| ".concat(S),k=[],v.researching==E&&k.push(1),v.researching_next!=E&&v.researchingNext!=E||k.push(2),k.length>0&&(w+="[[sub:".concat(k.join(","),"]]")),x.level<c[E].level&&(w+="<div>[[sub:(L".concat(x.level,")]]</div>"));i.push([w]),C.label=14;case 14:return++p,[3,11];case 15:return i.push("--- All Alliance Research ---"),I("research",i),[2]}}))}))};l("E",tt,"The research report shows you tech progress for allies. The ↑S column tells you how much science is needed to reduce delivery time by at least one tick.","research");var nt=function(){var e;return Rf(this,void 0,void 0,(function(){var t,n,r,i,s,o,a,c,u,l,h,d,f,p,g,m,y,v;return Of(this,(function(w){switch(w.label){case 0:return b="accounting",[4,Qd("game_event")];case 1:if(t=w.sent(),n=[],r=[],t){for(o in i={},s={},NeptunesPride.universe.galaxy.players)i[a=o]=0,s[a]=0;for(r.push("--- Cash transaction history ---"),r.push(":--|:--"),u=0;u<Ld.game_event.length;++u)"money_sent"===(l=Ld.game_event[u]).payload.template&&(h=l.payload.tick,d=l.payload.from_puid,f=l.payload.to_puid,p=l.payload.amount,d===NeptunesPride.universe.player.uid?i[f]-=p:i[d]+=p,d===NeptunesPride.universe.player.uid?r.push(["[[Tick #".concat(h,"]]|Sent $").concat(p," → [[").concat(f,"]]")]):r.push(["[[Tick #".concat(h,"]]|[[").concat(d,"]] → $").concat(p)]));for(r.push("--- Cash transaction history ---"),r.push("--- Tech transaction history ---"),r.push(":--|:--"),c={},u=0;u<Ld.game_event.length;++u)l=Ld.game_event[u],(null===(e=l.payload.template)||void 0===e?void 0:e.startsWith("peace"))&&(console.log("Peace: ",l.payload),l.payload.price?(f=l.payload.to_puid,d=l.payload.from_puid,p=l.payload.price,c[f]&&(p/=2),d===NeptunesPride.universe.player.uid?i[f]-=p:i[d]+=p,h=l.payload.tick,r.push(["[[Tick #".concat(h,"]]|Alliance Costs $").concat(p," → [[").concat(f,"]]")])):(d=l.payload.from_puid,c[d]=!0,h=l.payload.tick,r.push(["[[Tick #".concat(h,"]]|Alliance accepted by [[").concat(d,"]]")]))),"shared_technology"===l.payload.template&&(h=l.payload.tick,d=l.payload.from_puid,f=l.payload.to_puid,p=l.payload.price,g=l.payload.level,d===NeptunesPride.universe.player.uid?(i[f]-=p,s[f]-=g):(i[d]+=p,s[d]+=g),m=l.payload.name,y=qe(m),d===NeptunesPride.universe.player.uid?r.push(["[[Tick #".concat(h,"]]|").concat(y).concat(g," $").concat(p," → [[").concat(f,"]]")]):r.push(["[[Tick #".concat(h,"]]|[[").concat(d,"]] → ").concat(y).concat(g," $").concat(p)]));for(v in r.push("--- Tech transaction history ---"),n.push("--- Ledger ---"),n.push(":--|--:|--:"),n.push("Empire|Tech Levels|Credits"),i)0!==i[v]&&(i[v]>0?n.push(["[[".concat(v,"]]|").concat(s[v],"|[[sendcash:").concat(v,":").concat(i[v],":").concat(i[v],"]]")]):n.push(["[[".concat(v,"]]|").concat(s[v],"|[[good:").concat(i[v],"]]")]));n.push("--- Ledger ---\n")}else console.error("Updating message cache failed"),r.push("Message cache stale!");return I("accounting",Lf(Lf([],n,!0),r,!0)),[2]}}))}))};l("a",nt,"Perform accounting and display status.","accounting");var rt=[],it=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r,i,s,o,a;return Of(this,(function(c){switch(c.label){case 0:return b="api",[4,xe.keys()];case 1:e=c.sent(),t=e.filter((function(e){return e.startsWith("API:")})),n=[],(r=[]).push("--- Allied API Keys ---"),r.push(":--|--:|--:"),r.push("Empire|View|Merge"),i=0,c.label=2;case 2:return i<t.length?(s=t[i],o=s.substring(4),[4,xe.get(s)]):[3,5];case 3:a=c.sent(),n.push(a),r.push(["[[".concat(o,"]]|[[apiv:").concat(a,"]]|[[apim:").concat(a,"]]")]),c.label=4;case 4:return++i,[3,2];case 5:return r.push("--- Allied API Keys ---"),r.push("--- All Seen Keys ---"),r.push(":--|--:|--:"),r.push("Empire|Merge|Last?"),rt.forEach((function(e){var t="Unknown",n="❌",i=mf(e);if(dd(i)>0){var s=dd(i)-1,o=Sd(i,s),a=null==o?void 0:o.eof,c=null==o?void 0:o.player_uid;for(n="[[Tick #".concat(null==o?void 0:o.tick,"]]");(void 0===c||a)&&--s>0;){var u=Sd(i,s);a=null==u?void 0:u.eof,void 0!==(c=null==u?void 0:u.player_uid)&&(n="Dead @ [[Tick #".concat(u.tick,"]]"))}t="[[".concat(c,"]]")}var l=e.replace(":","m:");r.push(["".concat(t,"|").concat(l,"|").concat(n)])})),r.push("--- All Seen Keys ---"),I("api",r),[2]}}))}))};l("k",it,"Show known API keys.","api");var st=function(){var e;return Rf(this,void 0,void 0,(function(){var t,n,r,i,s,o,a,c,u,l,h;return Of(this,(function(d){switch(d.label){case 0:return[4,indexedDB.databases()];case 1:for(s in t=d.sent(),n={},t.forEach((function(e){if(/^[0-9]+:[0-9A-Za-z]{6}$/.test(e.name)){var t=e.name.match(/^[0-9]+/)[0],r=e.name.match(/[0-9A-Za-z]+$/)[0];n[t]||(n[t]=[]),n[t].push(r)}})),i=[],r=n)i.push(s);o=0,d.label=2;case 2:if(!(o<i.length))return[3,7];if(!((s=i[o])in r))return[3,6];c=0,u=n[a=s],d.label=3;case 3:return c<u.length?(l=u[c],void 0!==n[a].name?[3,5]:[4,md(+a,l,"scanCache")]):[3,6];case 4:h=d.sent(),n[a].name=null===(e=null==h?void 0:h.cached)||void 0===e?void 0:e.name,d.label=5;case 5:return c++,[3,3];case 6:return o++,[3,2];case 7:return[2,n]}}))}))},ot=function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r;return Of(this,(function(i){switch(i.label){case 0:return b="games",(e=[]).push("Past Games: "),[4,st()];case 1:for(n in t=i.sent())r=t[n].name,e.push("[[viewgame:".concat(n,":").concat(r,"]]"));return I("games",e),[2]}}))}))};l("ctrl+g",ot,"Show past games.","games"),l("(",(function(){return Rf(this,void 0,void 0,(function(){var e,t,n,r;return Of(this,(function(i){switch(i.label){case 0:return[4,xe.keys()];case 1:e=i.sent(),t=e.filter((function(e){return e.startsWith("API:")})),n=0,i.label=2;case 2:return n<t.length?(r=t[n],[4,xe.get(r)]):[3,5];case 3:Te=i.sent(),Ne(),i.label=4;case 4:return++n,[3,2];case 5:return[2]}}))}))}),"Merge all data from known API keys.","Merge All");var at=function(){var e=["<H1>".concat(f,"</H1>")];e.push(" Neptune's Pride Agent is meant to help you focus on"),e.push(" diplomacy and spend less time doing tedious calculations"),e.push(" or manually sharing information."),e.push("<h1>Hotkey Reference</h1>"),h().forEach((function(t){var n=d(t),r=Crux.format("[[goto:".concat(t,"]]"),{});"?"===t&&(r=Crux.format("[[hotkey:".concat(t,"]]"),{})),e.push("<h2>Hotkey: ".concat(t," ").concat(r,"</h2>")),n.help?e.push(n.help):e.push("<p>No documentation yet.<p><code>".concat(n.toLocaleString(),"</code>"))})),NeptunesPride.universe.helpHTML=e.join(""),NeptunesPride.np.trigger("show_screen","help")};l("?",at,"Display this help screen.","help");var ct,ut,lt,ht,dt,ft,pt=function(){var e=[];e.push("--- Controls ---"),e.push(":--|--|--:"),e.push("Button||Hotkey");var t=document.createElement("div");h().forEach((function(n){var r="[[goto:".concat(n,"]]");"?"===n&&(r="[[hotkey:".concat(n,"]]")),"<"===n?n="&lt;":">"===n?n="&gt;":"&"===n?n="&amp;":1===n.length?n="&#".concat(n.charCodeAt(0),";"):(console.log({key:n}),t.innerText=n,n=t.innerHTML);var i="".concat(r,"||").concat(n);e.push([i])})),e.push("--- Controls ---"),I("controls",e)};l("~",pt,"Generate NPA Buttons.","controls"),ct=document.body,ut=NeptunesPride,lt=function(){return Fe},ht=0,dt=null,ft=function(){dt=null},ct.addEventListener("keyup",(function(e){var t=e.target;if("textarea"===t.type){var n=e.key;if("]"!=n&&ft(),"]"===n||":"===n){if(ht<=0){if((ht=t.value.lastIndexOf("[[",t.selectionStart-1)+2)<=1)return void(ht=0);var r=t.value.indexOf("[[",ht),i=t.value.indexOf("]]",ht);if(i>-1&&(-1==r||i<r))return void(ht=0)}var s=ht,o=t.selectionStart;"]"===n&&(o-=1);var a=t.value.substring(s,o),c=a.match(/^[0-9][0-9]*$/);if(null==c?void 0:c.length){var u=Number(a),l=t.selectionEnd,h="".concat(u,"]] ").concat(ut.universe.galaxy.players[u].alias);t.value=t.value.substring(0,s)+h+t.value.substring(l,t.value.length),t.selectionStart=s+h.length,t.selectionEnd=s+h.length,ht=0}else if("]"===n){if(null===dt){dt=[];var d=function(e){return e.toLocaleLowerCase().substring(0,a.length)==a.toLocaleLowerCase()};for(var f in ut.universe.galaxy.stars){var p=ut.universe.galaxy.stars[f];d(p.n)&&dt.push({matchPriority:1,matchText:p.n,completion:"[[".concat(p.n,"]]")})}for(var g in ut.universe.galaxy.players){var m=ut.universe.galaxy.players[g];d(m.alias)&&dt.push({matchPriority:0,matchText:m.alias,completion:"[[".concat(g,"]] ").concat(m.alias)})}dt.sort((function(e,t){return e.matchPriority===t.matchPriority?e.matchText<t.matchText?-1:e.matchText>t.matchText?1:0:e.matchPriority-t.matchPriority}))}if(dt.length>0){var y=dt.shift();return l=t.selectionEnd,t.value=t.value.substring(0,s-2)+y.completion+t.value.substring(l,t.value.length),t.selectionStart=s-2+y.completion.length,t.selectionEnd=s-2+y.completion.length,void dt.push(y)}}ht=0,(null==(c=a.match(/api:/))?void 0:c.length)&&lt()&&(h="api:".concat(lt(),"]]"),l=t.selectionEnd,t.value=t.value.substring(0,s)+h+t.value.substring(l,t.value.length),t.selectionStart=s+h.length,t.selectionEnd=s+h.length)}else if(t.selectionStart>1){s=t.selectionStart-2;var v=t.value.substring(s,s+2);ht="[["===v?t.selectionStart:0}}})),ct.addEventListener("blur",ft),qd("game_event").then((function(){return Qd("game_event")})).then((function(){return Qd("game_diplomacy")})).then((function(){window.setTimeout((function(){return Rf(c,void 0,void 0,(function(){var e,t,n,r,i,s,o,a,c=this;return Of(this,(function(u){switch(u.label){case 0:return[4,xe.keys()];case 1:e=u.sent(),t=e.filter((function(e){return e.startsWith("API:")})),rt=(null===(a=Fd.api)||void 0===a?void 0:a.flatMap((function(e){var t;return(e.message.body||(null===(t=e.message.payload)||void 0===t?void 0:t.body)).match(/\[\[api:\w\w\w\w\w\w\]\]/)})).filter((function(e){return e})).filter((function(e,t,n){return n.indexOf(e)===t})))||[],console.log("Probable API Keys: ",rt),n=0,r=t,u.label=2;case 2:return n<r.length?(i=r[n],[4,xe.get(i)]):[3,5];case 3:s=u.sent(),o="[[api:".concat(s,"]]"),-1===rt.indexOf(o)&&rt.push(o),u.label=4;case 4:return n++,[3,2];case 5:return console.log("Probable API Keys II: ",rt),rt.forEach((function(e){return Rf(c,void 0,void 0,(function(){var t;return Of(this,(function(n){switch(n.label){case 0:return[4,_d(t=mf(e))];case 1:return n.sent(),dd(t)>0?(console.log("Scans for ".concat(t," cached")),[2]):(console.log("Scans for ".concat(t," not cached yet, register for them")),wd(t),[2])}}))}))})),[2]}}))}))}),1e3)})),void 0!==(null===(i=null===(r=NeptunesPride.universe)||void 0===r?void 0:r.player)||void 0===i?void 0:i.uid)&&(console.log("Universe already loaded, refresh scan data."),Ue().then((function(){Fe?(console.log("Loading scan data for key ".concat(Fe)),_d(Fe)):console.log("API Key unknown. No scan history.")})));var gt=window.setTimeout;window.setTimeout=function(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return-1!==(null==e?void 0:e.toLocaleString().indexOf("autocompleteTrigger"))?(console.log("SAT duplicate code detected. Ignore it."),0):gt(e,t,n)},(null===(s=NeptunesPride.universe)||void 0===s?void 0:s.galaxy)&&NeptunesPride.npui.map?(console.log("Universe already loaded. Hyperlink fleets & load hooks."),Id("loaded_init"),_e()):console.log("Universe not loaded. Rely on onServerResponse."),console.log("Neptune's Pride Agent injection fini.")}()}()}();
